<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>經緯度轉地址工具</title>

  <!-- Leaflet CSS + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    body { font-family: system-ui, "Helvetica Neue", Arial; margin: 0; }
    .container {
	  display: grid;
	  grid-template-columns: 420px 1fr;
	  height: 100vh;
	  position: relative;
	}

	.resize-handle {
	  position: absolute;
	  right: calc(var(--scrollbar-width, 0px) * -1);
	  top: 0;
	  width: 16px;
	  height: 100%;
	  cursor: ew-resize;
	  z-index: 9999;
	  background: transparent;
	}

    .card { background: #fff; border-right:1px solid #ddd; padding:12px; overflow-y:auto; position: relative; }
	.card::-webkit-scrollbar {
	  width: 8px;
	}
	.card::-webkit-scrollbar-thumb {
	  background-color: rgba(0,0,0,0.3);
	  border-radius: 4px;
	}
	.card::-webkit-scrollbar-track {
	  background: transparent;
	}
    h1 { font-size:20px; font-weight:bold; margin-bottom:12px; white-space:nowrap; }
    fieldset { border:1px solid #ccc; margin-bottom:12px; padding:10px; border-radius:8px; }
    legend { font-weight:bold; }
    label { display:block; font-size:14px; margin-top:8px; color:#333; }
    input[type="text"], input[type="email"], input[type="file"], input[type="number"], input[type="color"] { width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
    button { margin-top:8px; padding:8px 10px; border-radius:6px; border:0; background:#2b7cff; color:#fff; cursor:pointer; }
    #map { height: 100%; width: 100%; }
    #address { margin-top:10px; font-size:15px; color:#111; word-break:break-word; white-space:pre-line; }
    #address .title { font-size:20px; font-weight:bold; color:darkred; margin-top:6px; }
    .muted { color:#666; font-size:13px; margin-top:6px; }
    .error { color: #c00; margin-top:8px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    progress { width: 100%; height: 20px; margin-top: 8px; }
    .marker-label { border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:bold; color:white; }
    .row { display:flex; gap:6px; }
    .batch-container { margin-bottom:16px; border-bottom:1px dashed #eee; padding-bottom:10px; position:relative; }
    .batch-list { max-height:160px; overflow-y:auto; border:1px solid #eee; margin-top:8px; padding:6px; font-size:13px; }
    .batch-list.hidden { display:none !important; }
    .batch-list div { padding:4px 6px; cursor:pointer; border-radius:4px; }
    .batch-list div.active { background: #ffecec; font-weight:bold; }
    .batch-title-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      position:relative;
      gap: 5px;
    }
    .batch-visible-checkbox {
      width: 20px;
      height: 20px;
      margin-right: 4px;
      accent-color: #2b7cff;
      cursor: pointer;
    }
    .color-mini {
      width:36px; height:26px;
      border-radius:8px;
      border:1.5px solid #ccc;
      cursor:pointer;
      display:inline-block;
      margin-right: 4px;
      vertical-align:middle;
    }
    .batch-title {
      font-weight:bold;
      font-size:15px;
      width:100%;
      padding:6px;
      border-radius:6px;
      border:1px solid #ddd;
      box-sizing:border-box;
      margin-top:0;
      padding-right: 72px;
    }
    .delete-batch-btn {
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      border-radius: 50%;
      background: #c00;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 5;
      transition: background 0.2s;
      /*position: absolute;*/
      right: 0;
      top: 0;
      margin-top: 0;
      margin-right: 0;
    }
    .delete-batch-btn.hidden { display: none !important; }
    .delete-batch-btn:hover { background:#900; }
    .hidden { display:none !important; }

    /* 標題列與功能說明按鈕 */
    .title-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
    }

	/* 共用按鈕樣式 */
	.title-row-top-btn-common {
	  margin-top: 0;
	  background: linear-gradient(to bottom, #555, #333); /* 漸變背景 */
	  color: #fff;
	  font-size: 12px;
	  padding: 6px 10px;
	  border-radius: 6px;
	  white-space: nowrap;
	  text-decoration: none;
	  display: inline-block;
	  cursor: pointer;
	  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
	  transition: background 0.2s, transform 0.1s, box-shadow 0.1s;
	}

	.title-row-top-btn-common:hover {
	  background: linear-gradient(to bottom, #666, #444);
	}

	.title-row-top-btn-common:active {
	  transform: translateY(1px); /* 按下去的位移感 */
	  box-shadow: 0 1px 2px rgba(0,0,0,0.2); /* 陰影變小 */
	}
	
	.help-btn {
	  margin-left: auto;
    }

    /* 功能說明遮罩 */
    .overlay-mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .overlay-content {
      background: #fff;
      color: #111;
      width: min(760px, 92vw);
      max-height: 80vh;
      overflow: auto;
      border-radius: 12px;
      padding: 20px 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .overlay-content h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: #111;
    }
    .overlay-content p { margin: 6px 0; line-height: 1.6; }
    .overlay-content b { font-weight: 700; }
    .overlay-content .emph { color: #2b7cff; font-weight: 700; }
    .overlay-actions {
      display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px;
    }
    .overlay-close {
      background: #2b7cff;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      border: none;
    }

    /* Resize handle */
    /*.resize-handle {
      position: absolute;
      right: -4px;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize; 
      z-index: 10;
    }*/

    /* Email 格式錯誤視覺 */
    .input-invalid {
      background: #ffecec;
      border-color: #c00 !important;
    }
    .field-error {
      color: #c00;
      font-size: 12px;
      margin-top: 4px;
      min-height: 16px;
      line-height: 16px;
    }

    /* 清單收合/展開按鈕（位於清單最下方） */
    .list-toggle-btn {
      display: inline-block;
      background: #f2f2f2;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      /*margin: 0px 173px;*/
      padding: 0px 4px;
      user-select: none;
	  
	  position: absolute;
	  left: 50%;
	  transform: translateX(-50%);

	  margin-top: -8px;
    }

    /* 拖曳排序手把（4個灰點）*/
    .drag-handle {
      width: 22px;
      height: 18px;
      background-image:
        radial-gradient(#bbb 2px, transparent 3px),
        radial-gradient(#bbb 2px, transparent 3px),
        radial-gradient(#bbb 2px, transparent 3px),
        radial-gradient(#bbb 2px, transparent 3px),
        radial-gradient(#bbb 2px, transparent 3px),
        radial-gradient(#bbb 2px, transparent 3px);
      background-size: 8px 8px;
      background-position:
        0 0, 8px 0, 16px 0,
        0 8px, 8px 8px, 16px 8px;
      background-repeat: no-repeat;
      cursor: move; /* 顯示四向箭頭 */
      margin-right: 4px;
      align-self: flex-start; /* 置於標題輸入框上方 */
      margin-top: 8px; /* 加入 margin-top: 8px */
    }
    .drag-placeholder {
      border: 2px dashed #bbb;
      min-height: 40px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="consolePanel">
    <div class="resize-handle" id="resizeHandle"></div>

      <header class="title-row">
        <h1>經緯度轉地址工具</h1>
        <button class="title-row-top-btn-common help-btn" id="helpBtn" type="button" aria-label="開啟功能說明">功能說明</button>
		<button onclick="location.href='https://mygodcatisfat.github.io'" class="title-row-top-btn-common" id="homeBtn" type="button" title="回到首頁">回到首頁</button>
      </header>

      <label for="email" style="margin-bottom:0;margin-top:0;">聯絡 Email (必填以符合政策)</label>
      <input id="email" type="email" placeholder="輸入你的 email" 
        required style="margin-bottom:4px;" 
        aria-label="聯絡 Email" 
        autocomplete="email" />
      <div id="emailError" class="field-error"></div>

      <!-- 批次(可複製多組) -->
      <fieldset id="batchArea">
        <legend>批次匯入查詢（可重複新增）</legend>
        <div class="batch-container">
          <div class="batch-title-row">
            <input type="checkbox" class="batch-visible-checkbox" id="batchVisible_0" name="batchVisible_0" checked title="顯示本批次點位於地圖" />
            <div class="color-mini" style="background:#0000ff;" title="點擊可選擇顏色"></div>
            <!-- 第一個子區塊不顯示拖曳手把，之後動態加入 -->
            <input type="text" class="batch-title" id="batchTitle_0" name="batchTitle_0" placeholder="批次標題（可留空）" />
            <button class="delete-batch-btn hidden" tabindex="-1" aria-label="刪除本批次">X</button>
          </div>
          <label class="import-label" for="batchFile">匯入檔案 (.txt 或 .csv)</label>
          <input id="batchFile" type="file" class="fileInput" accept=".txt,.csv" />
		  <!-- 批次錯誤訊息：預設隱藏，出錯時以紅字顯示 -->
		  <div class="batchError error hidden"></div>
		  <!-- 檔案格式範例說明 -->
		  <div class="batchFormatHint muted">
			範例：<br>
			TXT：每行 <code>緯度,經度</code>（例如：<code>25.0330,121.5654</code>）<br>
			CSV：第9欄經度、第10欄緯度
		  </div>
          <div class="row batch-controls hidden" style="margin-top:6px;">
            <button class="stopBtn" style="background:#c00;">終止查詢</button>
            <div style="flex:1"></div>
          </div>
          <progress class="progressBar hidden" value="0" max="100"></progress>
          <div class="batchStatus muted hidden"></div>
          <div class="batch-list hidden"></div>
          <!-- 清單最下方扁按鈕（初始隱藏，載入清單後顯示） -->
          <button class="list-toggle-btn hidden" type="button">▲</button>
        </div>
      </fieldset>

      <!-- 單點查詢 -->
      <fieldset>
        <legend>單點地址查詢</legend>
        <form id="geoForm" novalidate aria-label="單點地址查詢表單">
		  <label for="lat">緯度 (Latitude)</label>
		  <input id="lat" name="lat" type="text" value="25.0330" aria-describedby="latHint" />

		  <label for="lon">經度 (Longitude)</label>
		  <input id="lon" name="lon" type="text" value="121.5654" aria-describedby="latHint" />

		  <div id="latHint" class="muted">提示：緯度 -90~90，經度 -180~180。</div>

		  <button type="submit" aria-label="執行經緯度轉換">轉換地址</button>
		</form>
        <div id="address" class="hidden">
          <div class="title">好看地址</div>
          <div id="niceAddr"></div>
          <div class="title">資料地址</div>
          <div id="rawAddr"></div>
        </div>
        <pre id="raw" class="muted"></pre>
        <div id="error" class="error"></div>
      </fieldset>
    </div>

    <div id="map"></div>
  </div>

  <!-- 功能說明遮罩 -->
  <div id="helpOverlay" class="overlay-mask" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="overlay-content">
      <h2 id="helpTitle">功能說明</h2>
      <p><b>經緯度轉地址工具：</b>輸入緯度與經度，呼叫反向地理編碼服務，取得對應的地址資訊，並於地圖上以標記呈現。</p>
      <p><b class="emph">聯絡 Email：</b>用於服務識別與政策需求。格式需正確，否則無法進行查詢。</p>
      <p><b class="emph">左側控制台寬度調整：</b>將滑鼠移至左側控制台右緣，游標變成左右雙箭頭，即可拖曳調整寬度。</p>
      <p><b class="emph">批次匯入查詢：</b>可載入 .txt（每行「lat, lon」）或 .csv（第9欄經度、第10欄緯度）進行多筆轉換，並自動下載結果。</p>
      <p><b class="emph">顏色選擇：</b>點擊色塊變更本批次的標記與路徑顏色。</p>
      <p><b class="emph">顯示切換：</b>勾選可在地圖顯示/隱藏本批次的標記與路徑。</p>
      <p><b class="emph">清單收合鍵：</b>點擊清單底部的「▲/▼」可收合或展開清單。</p>
      <p><b class="emph">拖曳排序：</b>在批次標題列的灰點手把可拖曳調整各批次區塊的順序。</p>
      <div class="overlay-actions">
        <button class="overlay-close" id="helpCloseBtn" type="button">關閉</button>
      </div>
    </div>
  </div>

  <div id="userAgent" style="display:none;"></div>

  <!-- Leaflet + MarkerCluster + PapaParse -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    
	function updateScrollbarWidth() {
	  const scrollDiv = document.createElement('div');
	  scrollDiv.style.width = '100px';
	  scrollDiv.style.height = '100px';
	  scrollDiv.style.overflowY = 'scroll';
	  scrollDiv.style.position = 'absolute';
	  scrollDiv.style.top = '-9999px';
	  document.body.appendChild(scrollDiv);

	  const scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;
	  document.body.removeChild(scrollDiv);

	  // 設定到 CSS 變數
	  document.documentElement.style.setProperty('--scrollbar-width', `${scrollbarWidth}px`);
	}

	// 頁面載入時執行一次
	updateScrollbarWidth();

	// 如果視窗大小改變（可能影響滾輪寬度），重新計算
	window.addEventListener('resize', updateScrollbarWidth);

    (function(){
      const resizeHandle = document.getElementById('resizeHandle');
      const container = document.querySelector('.container');
      let dragging = false;
      resizeHandle.addEventListener('mousedown', function(e){
        dragging = true;
        document.body.style.cursor = 'ew-resize';
        e.preventDefault();
      });
      document.addEventListener('mousemove', function(e){
        if (!dragging) return;
        let min = 320;
        let max = Math.max(window.innerWidth * 0.8, 600);
        let x = e.clientX;
        if (x < min) x = min;
        if (x > max) x = max;
        container.style.gridTemplateColumns = `${x}px 1fr`;
		//resizeHandle.style.left = `${x}px`;
      });
      document.addEventListener('mouseup', function(){
        if (dragging) {
          dragging = false;
          document.body.style.cursor = '';
        }
      });
    })();

    // 功能說明遮罩開關
    (function(){
      const helpBtn = document.getElementById('helpBtn');
      const overlay = document.getElementById('helpOverlay');
      const closeBtn = document.getElementById('helpCloseBtn');
      function openOverlay(){ overlay.style.display = 'flex'; }
      function closeOverlay(){ overlay.style.display = 'none'; }
      helpBtn.addEventListener('click', openOverlay);
      closeBtn.addEventListener('click', closeOverlay);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeOverlay(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeOverlay(); });
    })();

    // 基本地圖與全域變數
    const map = L.map('map').setView([23.5, 121], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    document.getElementById('userAgent').textContent = navigator.userAgent;

    // 已被用過的顏色（避免重複）
    let usedColors = new Set(['#0000ff','#ff0000','#00aa00']);

    // 檢查經緯度
    // 修改：加入型別檢查與更嚴謹正則
	function isValidCoord(lat, lon){
	  if (typeof lat !== 'number' || typeof lon !== 'number') return false;
	  if (!isFinite(lat) || !isFinite(lon)) return false;
	  return /^-?\d+(\.\d+)?$/.test(String(lat)) &&
			 /^-?\d+(\.\d+)?$/.test(String(lon)) &&
			 lat >= -90 && lat <= 90 &&
			 lon >= -180 && lon <= 180;
	}

	function isValidEmail(email) {
	  if (typeof email !== 'string') return false;
	  // RFC 5322 簡化版
	  const re = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z]{2,})+$/;
	  return re.test(email.trim());
	}

    const emailInput = document.getElementById('email');
    const emailError = document.getElementById('emailError');

    function showEmailError() {
      const val = emailInput.value.trim();
      if (val !== '' && !isValidEmail(val)) {
        emailInput.classList.add('input-invalid');
        emailError.textContent = '格式錯誤';
        return true;
      } else {
        emailInput.classList.remove('input-invalid');
        emailError.textContent = '';
        return false;
      }
    }
    emailInput.addEventListener('blur', showEmailError);
    emailInput.addEventListener('input', showEmailError);

    function buildExportLine(r){
      const idxStr = String(r.idx).padStart(3,'0');
      let hn = r.house_number || '';
      if (hn && !hn.includes('號')) hn = hn + '號';
      let tail = '';
      if ((r.village && r.village.trim()!=='') || (r.office && r.office.trim()!=='')) {
        tail = '-' + (r.village || '') + (r.office || '');
      }
      const addrPart = (r.postcode||'') + (r.country||'') + (r.city||'') + (r.suburb||'') + (r.neighbourhood||'') + (r.road||'') + (hn||'') + tail;
      return `${idxStr}\t${r.lat}, ${r.lon}\t${addrPart}`;
    }

    function niceAddressFromR(r){
      return buildExportLine(r).split('\t')[2] || '';
    }

    async function fetchAddress(lat, lon, email) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
      const resp = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': `${navigator.userAgent} (${email})`
        }
      });
      return resp.json();
    }

    // API 查詢快取
    let addressCache = {};
	try {
	  const savedCache = localStorage.getItem('addressCache');
	  if (savedCache) {
		addressCache = JSON.parse(savedCache);
	  }
	} catch (e) {
	  console.warn('讀取快取失敗', e);
	  addressCache = {};
	}

    async function fetchAddress(lat, lon, email) {
      const key = `${lat},${lon}`;
      if (addressCache[key]) {
        return addressCache[key];
      }
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
      const resp = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': `${navigator.userAgent} (${email})`
        }
      });
      const data = await resp.json();
      addressCache[key] = data;
	  try {
  	    localStorage.setItem('addressCache', JSON.stringify(addressCache));
	  } catch (e) {
		console.warn('儲存快取失敗', e);
	  }
	  return data;
    }
	
    // 單筆查詢
    const geoForm = document.getElementById('geoForm');
    const niceAddrDiv = document.getElementById('niceAddr');
    const rawAddrDiv = document.getElementById('rawAddr');
    const rawPre = document.getElementById('raw');
    const errorDiv = document.getElementById('error');
    const addressBlock = document.getElementById('address');
    let singleMarker = null;
    addressBlock.classList.add('hidden');
	
	['lat', 'lon'].forEach(id => {
	  const input = document.getElementById(id);
	  let isComposing = false; // 是否正在組字
	  let lastValid = input.value;

	  input.addEventListener('compositionstart', () => {
		isComposing = true;
	  });

	  input.addEventListener('compositionend', () => {
		isComposing = false;
		filterAndClamp(); // 組字結束後再做過濾與範圍檢查
	  });

	  input.addEventListener('input', () => {
		if (isComposing) return; // 組字中不處理
		filterAndClamp();
	  });

	  function filterAndClamp() {
		let val = input.value;
		val = val.replace(/[^0-9.\-]/g, '');
		const parts = val.split('.');
		if (parts.length > 2) {
		  val = parts[0] + '.' + parts.slice(1).join('');
		}
		val = val.replace(/(?!^)-/g, '');

		if (val !== '' && !isNaN(val)) {
		  const num = parseFloat(val);
		  if (id === 'lat' && (num < -90 || num > 90)) {
			val = Math.max(-90, Math.min(90, num)).toString();
		  }
		  if (id === 'lon' && (num < -180 || num > 180)) {
			val = Math.max(-180, Math.min(180, num)).toString();
		  }
		  lastValid = val;
		}
		input.value = val;
	  }
	});

    geoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.textContent = '';
      niceAddrDiv.textContent = '查詢中…';
      rawAddrDiv.textContent = '';
      rawPre.textContent = '';
      addressBlock.classList.add('hidden');

      const lat = parseFloat(document.getElementById('lat').value.trim());
      const lon = parseFloat(document.getElementById('lon').value.trim());
      const email = emailInput.value.trim();
      if (!isValidCoord(lat, lon)) { errorDiv.textContent = '經緯度錯誤'; niceAddrDiv.textContent=''; return; }
      if (!email) { errorDiv.textContent = '請輸入 Email'; niceAddrDiv.textContent=''; return; }
      if (showEmailError()) { errorDiv.textContent = 'Email 格式不正確'; niceAddrDiv.textContent=''; return; }
      localStorage.setItem('geoEmail', email);

      try {
        const data = await fetchAddress(lat, lon, email);
        if (!data || !data.display_name) throw '無結果';
        const addr = data.address || {};
        const r = { idx: 1, lat: lat, lon: lon, ...addr };
        niceAddrDiv.textContent = niceAddressFromR(r);
        rawAddrDiv.textContent = data.display_name;
        rawPre.textContent = JSON.stringify(data, null, 2);

        addressBlock.classList.remove('hidden');

        const ll = [parseFloat(data.lat), parseFloat(data.lon)];
        map.setView(ll, 14);
        if (singleMarker) {
          singleMarker.setLatLng(ll).setPopupContent(niceAddressFromR(r));
        }
        else singleMarker = L.marker(ll).addTo(map).bindPopup(niceAddressFromR(r));
        singleMarker.openPopup();
      } catch (err) {
        errorDiv.textContent = '錯誤：' + (err.message || err);
      }
    });

    if (localStorage.getItem('geoEmail')) emailInput.value = localStorage.getItem('geoEmail');

    // ========= 批次處理系統 =========

    let batchArea = document.getElementById('batchArea');
    let templateDiv = batchArea.querySelector('.batch-container');
    let batchUID = 0;

    // 跨子區塊僅允許一個選項變色
    function clearAllActives() {
      document.querySelectorAll('.batch-list .active').forEach(el => el.classList.remove('active'));
    }

    // 拖曳排序
    let draggingInfo = null;
    function enableDrag(container) {
      let handle = container.querySelector('.drag-handle');
      if (!handle) {
        // 插入在標題輸入框上方（同一列中，置於 batch-title 前）
        const row = container.querySelector('.batch-title-row');
        const titleInput = row.querySelector('.batch-title');
        const h = document.createElement('div');
        h.className = 'drag-handle';
        row.insertBefore(h, titleInput);
        handle = h;
      }
      handle.onmousedown = function(e) {
        e.preventDefault();
        const rect = container.getBoundingClientRect();
        const placeholder = document.createElement('div');
        placeholder.className = 'drag-placeholder';
        placeholder.style.height = rect.height + 'px';
        draggingInfo = {
          container,
          placeholder,
          startY: e.clientY,
          offsetY: e.clientY - rect.top
        };
        container.parentNode.insertBefore(placeholder, container.nextSibling);
        container.style.width = rect.width + 'px';
        container.style.position = 'absolute';
        container.style.left = rect.left + 'px';
        container.style.top = rect.top + 'px';
        container.style.zIndex = 1000;
        container.style.pointerEvents = 'none';
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
      };
    }
    function onDragMove(e) {
      if (!draggingInfo) return;
      const { container } = draggingInfo;
      container.style.top = (e.clientY - draggingInfo.offsetY) + 'px';

      // 找到目前滑過的 batch-container，決定插入位置
      const siblings = Array.from(batchArea.querySelectorAll('.batch-container')).filter(c => c !== container);
      let target = null;
      for (const sib of siblings) {
        const r = sib.getBoundingClientRect();
        const mid = r.top + r.height / 2;
        if (e.clientY < mid) { target = sib; break; }
      }
      if (target) {
        batchArea.insertBefore(draggingInfo.placeholder, target);
      } else {
        batchArea.appendChild(draggingInfo.placeholder);
      }
    }
    function onDragEnd() {
      if (!draggingInfo) return;
      const { container, placeholder } = draggingInfo;
      container.style.position = '';
      container.style.left = '';
      container.style.top = '';
      container.style.width = '';
      container.style.zIndex = '';
      container.style.pointerEvents = '';
      batchArea.insertBefore(container, placeholder);
      placeholder.remove();
      draggingInfo = null;
      document.removeEventListener('mousemove', onDragMove);
      document.removeEventListener('mouseup', onDragEnd);
      refreshDragHandles();
    }
    function refreshDragHandles() {
      const containers = Array.from(batchArea.querySelectorAll('.batch-container'));
      containers.forEach((c, idx) => {
        let handle = c.querySelector('.drag-handle');
        if (idx === 0) {
          if (handle) handle.classList.add('hidden');
        } else {
          if (!handle) enableDrag(c);
          handle = c.querySelector('.drag-handle');
          if (handle) handle.classList.remove('hidden');
        }
      });
    }

    function bindBatch(container) {
      let fileInput = container.querySelector('.fileInput');
      const stopBtn = container.querySelector('.stopBtn');
      const progressBar = container.querySelector('.progressBar');
      const status = container.querySelector('.batchStatus');
      const listDiv = container.querySelector('.batch-list');
      const listToggleBtn = container.querySelector('.list-toggle-btn'); 
      const batchTitleInput = container.querySelector('.batch-title');
      const deleteBtn = container.querySelector('.delete-batch-btn');
      const colorMini = container.querySelector('.color-mini');
      const visibleCheckbox = container.querySelector('.batch-visible-checkbox');
      const batchControls = container.querySelector('.batch-controls');
      const importLabel = container.querySelector('.import-label');
	  const formatHint = container.querySelector('.batchFormatHint'); 

      let colorValue = colorMini.style.background || '#0000ff';
      let stopFlag = false, processing = false, stopped = false;
      let markersCluster = L.markerClusterGroup();
      let markersList = [], polyline = null, path = [];

      function updateMarkersPolylineColor(){
        markersList.forEach((m,i)=>{
          if (!m) return;
          const html = `<div class="marker-label" style="background:${colorValue}; width:32px; height:32px;">${i+1}</div>`;
          m.setIcon(L.divIcon({className:'', html:html, iconSize:[32,32], iconAnchor:[16,16]}));
        });
        if (polyline) polyline.setStyle({color: colorValue});
      }

      colorMini.addEventListener('click', ()=>{
        const picker = document.createElement('input');
        picker.type = 'color';
        picker.value = rgbToHex(colorMini.style.background);
        picker.style.display = 'none';
        document.body.appendChild(picker);
        picker.click();
        picker.addEventListener('input', ()=>{
          colorValue = picker.value;
          colorMini.style.background = colorValue;
          updateMarkersPolylineColor();
          document.body.removeChild(picker);
        });
      });
      function rgbToHex(rgb) {
        if (!rgb) return '#0000ff';
        if (rgb[0]==='#') return rgb;
        const m = rgb.match(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/);
        if (!m) return '#0000ff';
        return '#' + [1,2,3].map(i=>parseInt(m[i]).toString(16).padStart(2,'0')).join('');
      }

      visibleCheckbox.addEventListener('change', ()=>{
        if (visibleCheckbox.checked) {
          map.addLayer(markersCluster);
          if (polyline) map.addLayer(polyline);
        } else {
          map.removeLayer(markersCluster);
          if (polyline) map.removeLayer(polyline);
        }
      });

      if (deleteBtn) {
        deleteBtn.onclick = function(){
          try { markersCluster.clearLayers(); } catch(e){}
          try { if (polyline && map.hasLayer(polyline)) map.removeLayer(polyline); } catch(e){}
          // 修改：釋放顏色
          if (colorValue && usedColors.has(colorValue)) {
              usedColors.delete(colorValue);
          }

          container.parentNode.removeChild(container);
          refreshDragHandles();
        };
      }

      stopBtn.onclick = function(){
        stopFlag = true;
        stopped = true;
        status.textContent = '使用者已終止該批次';
        processing = false;
		
		// 顯示範例字樣（與匯入檔案顯示時機一致）
		if (formatHint) formatHint.classList.remove('hidden');

		// 如果要同時讓匯入檔案按鈕回來，也可以加上：
		fileInput.classList.remove('hidden');
		importLabel.classList.remove('hidden');
      };

      function clearBatchContent() {
        listDiv.innerHTML = '';
        markersCluster.clearLayers();
        markersList = [];
        path = [];
        if (polyline && map.hasLayer(polyline)) { map.removeLayer(polyline); polyline = null; }
        progressBar.value = 0;
        status.textContent = '';
        if (visibleCheckbox.checked) {
          map.removeLayer(markersCluster);
          if (polyline) map.removeLayer(polyline);
        }
      }

      // 讓同名檔案可正常觸發change
      function resetFileInput(oldInput) {
        const newInput = oldInput.cloneNode();
        newInput.value = "";
        oldInput.parentNode.replaceChild(newInput, oldInput);
        fileInput = newInput;
        bindFileInput(newInput);
        return newInput;
      }

      // 匯入前隱藏控制列/狀態/列表/扁鈕
      batchControls.classList.add('hidden');
      progressBar.classList.add('hidden');
      status.classList.add('hidden');
      listDiv.classList.add('hidden');
      fileInput.classList.remove('hidden');
      importLabel.classList.remove('hidden');
      if (listToggleBtn) {
        listToggleBtn.classList.add('hidden');
        listToggleBtn.textContent = '▲';
      }

      function bindFileInput(fileInput) {
        fileInput.addEventListener('click', function() {
          this.value = "";
        });

        fileInput.addEventListener('change', async (ev) => {
          stopFlag = false;
          stopped = false;
          clearBatchContent();
          batchControls.classList.remove('hidden');
          progressBar.classList.remove('hidden');
          status.classList.remove('hidden');
          listDiv.classList.remove('hidden');
          if (listToggleBtn) listToggleBtn.classList.remove('hidden');
		  if (formatHint) formatHint.classList.add('hidden'); 

          const file = ev.target.files[0];
          if (!file) return;
		  
		  // === 新增功能：自動填入檔名到批次標題 ===
		  if (batchTitleInput.value.trim() === '') {
			  batchTitleInput.value = file.name.replace(/\.[^/.]+$/, '');
		  }
          
		  const email = emailInput.value.trim();
          if (!email) { alert('請先輸入 Email'); fileInput.value = ''; return; }
          if (!isValidEmail(email)) { alert('Email 格式不正確'); fileInput.value = ''; return; }
          localStorage.setItem('geoEmail', email);

          let coords = [];
		  let hadError = false;

		  await new Promise((resolve) => {
			Papa.parse(file, {
			  complete: function(results) {
				if (file.name.toLowerCase().endsWith('.txt')) {
				  results.data.forEach((row, idx) => {
					if (!row || row.length < 2) return;
					const lat = parseFloat(row[0]);
					const lon = parseFloat(row[1]);
					if (!isValidCoord(lat, lon)) {
					  alert('經緯度無效：' + row.join(','));
					  hadError = true;
					  return;
					}
					coords.push([lat, lon]);
				  });
				} else if (file.name.toLowerCase().endsWith('.csv')) {
				  results.data.forEach((row, idx) => {
					if (idx === 0 || !row || row.length < 10) return; // 跳過標題列
					const lon = parseFloat(row[8]);
					const lat = parseFloat(row[9]);
					if (!isValidCoord(lat, lon)) {
					  alert('經緯度無效：' + row.join(','));
					  hadError = true;
					  return;
					}
					coords.push([lat, lon]);
				  });
				} else {
				  alert('不支援的檔案格式');
				  hadError = true;
				}
				resolve();
			  }
			});
		  });
          if (!hadError && coords.length) {
            await doBatchQuery(coords, email);
          }
          resetFileInput(fileInput);
		  
		  if (hadError || !coords.length) {
		    if (formatHint) formatHint.classList.remove('hidden'); 
		  }
        });
      }
      bindFileInput(fileInput);

      // 功能3：清單收合/展開按鈕
      if (listToggleBtn) {
        listToggleBtn.addEventListener('click', () => {
          const collapsed = !listDiv.classList.contains('hidden') && listDiv.offsetParent !== null;
          if (collapsed) {
            listDiv.classList.add('hidden');
            listToggleBtn.textContent = '▼';
          } else {
            listDiv.classList.remove('hidden');
            listToggleBtn.textContent = '▲';
          }
        });
      }

      async function doBatchQuery(coords, email) {
		progressBar.classList.remove('hidden');
		status.classList.remove('hidden');
		listDiv.classList.remove('hidden');
		if (listToggleBtn) listToggleBtn.classList.remove('hidden');

		const results = [];
		if (visibleCheckbox.checked) {
		  map.addLayer(markersCluster);
		}

		let totalTime = 0; // 累計耗時
		let countDone = 0;

		for (let i = 0; i < coords.length; i++) {
		  if (stopFlag) { status.textContent = '已終止'; processing = false; stopped = true; break; }
		  const [lat, lon] = coords[i];
		  const start = Date.now();
		  try {
		    if (stopFlag || stopped) break;
		    const data = await fetchAddress(lat, lon, email);
		    if (stopFlag || stopped) break;
		    const addr = data.address || {};
		    const r = {
			  idx: i + 1,
			  lat: lat,
			  lon: lon,
			  postcode: addr.postcode || '',
			  country: addr.country || '',
			  city: addr.city || addr.town || addr.village || '',
			  suburb: addr.suburb || '',
			  neighbourhood: addr.neighbourhood || '',
			  road: addr.road || '',
			  house_number: addr.house_number || '',
			  village: addr.village || '',
			  office: addr.office || ''
		    };
		    results.push(r);

			// marker
			const html = `<div class="marker-label" style="background:${colorValue}; width:32px; height:32px;">${i+1}</div>`;
			const m = L.marker([lat, lon], { icon: L.divIcon({ className:'', html: html, iconSize:[32,32], iconAnchor:[16,16] }) })
					  .bindPopup(niceAddressFromR(r));
			m.on('click', () => {
			  clearAllActives();     // 功能4：先清除其他子區塊選中
			  highlightIndex(i);
			  map.setView([lat, lon], Math.max(14, map.getZoom()));
			});
			markersCluster.addLayer(m);
			markersList.push(m);

			// polyline
			path.push([lat, lon]);
			if (!polyline) {
			  polyline = L.polyline(path, { color: colorValue });
			  if (visibleCheckbox.checked) map.addLayer(polyline);
			} else {
			  polyline.setLatLngs(path); // 更新路徑
			  polyline.setStyle({ color: colorValue }); // 確保顏色同步
			}
			if (path.length === 1) map.setView([lat, lon], 14);
			else map.fitBounds(polyline.getBounds());


			// list
			const item = document.createElement('div');
			item.textContent = `${i+1}. ${niceAddressFromR(r)}`;
			item.addEventListener('click', () => {
			  clearAllActives();     // 功能4：先清除其他子區塊選中
			  highlightIndex(i);
			  map.setView([lat, lon], Math.max(14, map.getZoom()));
			});
			listDiv.appendChild(item);
		  } catch (err) {
			console.error(err);
		  }
		  const elapsed = Date.now() - start;
		  totalTime += elapsed;
		  countDone++;

		  // 計算剩餘時間
		  const safeCount = countDone > 0 ? countDone : 1;
		  let avgTime = totalTime / safeCount;
		  if (avgTime < 50) { // 小於 50ms 視為快取命中，給一個基準值
		    avgTime = 50; // 50ms 當作單筆查詢時間
		  }
		  const remaining = coords.length - countDone;
		  const remainingMs = avgTime * remaining;
		  let remainingText = '';
		  // 修改後
		  if (remainingMs >= 60000) {
			const mins = Math.floor(remainingMs / 60000);
			const secs = Math.round((remainingMs % 60000) / 1000);
			remainingText = `預估剩餘時間：約 ${mins} 分 ${secs} 秒`;
		  } else {
			remainingText = `預估剩餘時間：約 ${Math.round(remainingMs / 1000)} 秒`;
		}

		  progressBar.value = ((i + 1) / coords.length) * 100;
		  status.textContent = `進度 ${i+1}/${coords.length}　${remainingText}`;
			
		  if (elapsed < 1000) await new Promise(r => setTimeout(r, 1000 - elapsed));
		}
		if (!stopFlag && !stopped) {
		  status.textContent = `批次完成，共 ${results.length} 筆`;
		  downloadResults(results);
		  if (colorValue && /^#[0-9A-Fa-f]{6}$/.test(colorValue)) usedColors.add(colorValue);
		  finishBatch();
		  addNewBatchArea();
		} else {
		  status.textContent = '批次被使用者中止';
		}
 	  }

      function highlightIndex(idx) {
        Array.from(listDiv.children).forEach((el,i)=>el.classList.toggle('active', i === idx));
        markersList.forEach((m,i)=>{
          if (!m) return;
          const html = `<div class="marker-label" style="background:${colorValue}; width:32px;height:32px; font-size:13px;">${i+1}</div>`;
          m.setIcon(L.divIcon({className:'', html:html, iconSize:[32,32], iconAnchor:[16,16]}));
        });
      }

      function downloadResults(results) {
        if (!results || results.length === 0) return;
        let filename = 'batch_results.txt';
        const title = batchTitleInput.value.trim();
        if (title) filename = title + '.txt';
        const txt = results.map(buildExportLine).join('\n');
        const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }

      function finishBatch() {
        fileInput.classList.add('hidden');
        importLabel.classList.add('hidden');
        batchControls.classList.add('hidden');
        progressBar.classList.add('hidden');
        status.classList.add('hidden');
        if (formatHint) formatHint.classList.add('hidden');
		if (deleteBtn) deleteBtn.classList.remove('hidden');
      }
    }

    function addNewBatchArea() {
      const clone = templateDiv.cloneNode(true);
      clone.querySelector('.progressBar').value = 0;
      clone.querySelector('.batchStatus').textContent = '';
      clone.querySelector('.batch-list').innerHTML = '';
      clone.querySelector('.batch-list').classList.add('hidden');
      clone.querySelector('.batch-title').value = '';
      clone.querySelector('.batch-visible-checkbox').checked = true;
      // 隱藏刪除鈕
      if (clone.querySelector('.delete-batch-btn')) {
        clone.querySelector('.delete-batch-btn').classList.add('hidden');
      }
      // 匯入檔案區預設顯示
      clone.querySelector('.fileInput').classList.remove('hidden');
      clone.querySelector('.import-label').classList.remove('hidden');
      // 隱藏控制列/狀態/列表
      clone.querySelector('.row.batch-controls').classList.add('hidden');
      clone.querySelector('.progressBar').classList.add('hidden');
      clone.querySelector('.batchStatus').classList.add('hidden');
      // 清單扁鈕重置
      const listToggle = clone.querySelector('.list-toggle-btn');
      if (listToggle) {
        listToggle.classList.add('hidden');
        listToggle.textContent = '▲';
      }
	  // 匯入前顯示範例字樣
	  const cloneFormatHint = clone.querySelector('.batchFormatHint');
	  if (cloneFormatHint) cloneFormatHint.classList.remove('hidden');


      // 顏色避免重複
      let nextColor = '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
      let attempts = 0;
      while (usedColors.has(nextColor) && attempts < 20) {
        nextColor = '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
        attempts++;
      }
      const colorMini = clone.querySelector('.color-mini');
      colorMini.style.background = nextColor;
      ++batchUID;
	  const visibleCheckbox = clone.querySelector('.batch-visible-checkbox');
	  visibleCheckbox.id = `batchVisible_${batchUID}`;
	  visibleCheckbox.name = `batchVisible_${batchUID}`;

	  const batchTitle = clone.querySelector('.batch-title');
	  batchTitle.id = `batchTitle_${batchUID}`;
	  batchTitle.name = `batchTitle_${batchUID}`;

      const fileInput = clone.querySelector('.fileInput');
      fileInput.value = '';
      fileInput.setAttribute('data-batch-uid', batchUID);

      batchArea.appendChild(clone);
      bindBatch(clone);
      refreshDragHandles(); // 第二個開始顯示拖曳手把
    }

    bindBatch(templateDiv);
    // 初始：第一個不顯示拖曳手把
    refreshDragHandles();
  </script>
</body>
</html>
