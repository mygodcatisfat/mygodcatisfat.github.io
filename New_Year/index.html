<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ´ å“å–¬é‚€æ‚¨é‡‘é¦¬å¥”é¨°æ¥ç´…åŒ… ğŸ´</title>
    <style>
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            touch-action: none; 
            -webkit-user-select: none; 
            user-select: none;
            -webkit-touch-callout: none; 
        }

        body {
            background: linear-gradient(135deg, #FF512F, #DD2476);/*-*/
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            transition: background 0.5s ease;
        }

        body.game-running {
            background: #111 !important;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px;
            box-sizing: border-box; display: flex; justify-content: space-between;
            z-index: 50; 
            font-size: 1.2rem; font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            pointer-events: none; 
        }
        .ui-layer > * { pointer-events: auto; }

        #score-display, #time-display {
            color: #fff; 
        }

        #music-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #FFD700; color: #FFD700;
            border-radius: 50%; width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; cursor: pointer; transition: transform 0.2s;
        }
        #music-btn:active { transform: scale(0.9); }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; text-align: center; padding: 20px; box-sizing: border-box;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; opacity: 0; }

        h1 { 
            color: #FFD700; margin: 0 0 15px 0; 
            text-shadow: 0 0 15px #ff0000; 
            font-size: 2.2rem; line-height: 1.2;
        }
        
        #leaderboard-screen h2 {
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        p { margin: 10px 0; font-size: 1.1rem; color: #eee; }

        .btn {
            background: linear-gradient(to bottom, #FFD700, #ff8c00);
            border: none; padding: 15px 40px; font-size: 1.3rem;
            border-radius: 50px; color: #8E0E00; font-weight: bold;
            cursor: pointer; margin: 10px; min-width: 180px;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.5);
            touch-action: manipulation;
        }
        .btn:active { transform: scale(0.95); }
        .btn-secondary { background: #444; color: #fff; box-shadow: none; border: 1px solid #666; }

        .instruction-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px; padding: 15px; margin: 15px 0;
            width: 90%; max-width: 350px; border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .rule-row {
            display: flex; justify-content: space-between; align-items: center;
            margin: 8px 0; font-size: 1.1rem; border-bottom: 1px dashed rgba(255,255,255,0.2);
            padding-bottom: 5px;
        }
        .rule-row:last-child { border-bottom: none; }
        .rule-icon { font-size: 1.5rem; width: 40px; }
        .rule-score { color: #FFD700; font-weight: bold; }
        .rule-desc { flex-grow: 1; text-align: left; padding-left: 10px; font-size: 0.9rem; color: #fff;}

        .item { 
            position: absolute; 
            font-size: 3.5rem; 
            padding: 25px; 
            margin: -25px; 
            border-radius: 50%;
            animation: fall linear forwards; 
            z-index: 5; 
            cursor: pointer; 
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        .item:active { transform: scale(0.9); filter: brightness(1.2); }

        @media (max-width: 600px) { .item { font-size: 3rem; } h1 { font-size: 1.8rem; } }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }
        
        .pop { 
            position: absolute; font-size: 1.8rem; 
            color: #FFD700; font-weight: bold; text-shadow: 1px 1px 2px #000;
            animation: popUp 0.6s ease-out forwards; z-index: 15; pointer-events: none;
        }
        @keyframes popUp { 0% { transform: scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }

        input {
            padding: 12px; font-size: 1.2rem; border-radius: 8px; border: none;
            margin: 10px 0; width: 80%; max-width: 250px; text-align: center;
            background: rgba(255,255,255,0.9);
        }

        #blessing-box {
            background: #fff; color: #d31027; padding: 15px;
            border-radius: 15px; margin: 15px 0; border: 4px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); max-width: 85%; position: relative;
        }
        .blessing-title {
            display: block; font-size: 1.5rem; color: #d31027; margin-bottom: 8px;
            border-bottom: 2px dashed #ffcc00; padding-bottom: 5px; font-weight: 900;
        }
        .blessing-content { font-size: 1.3rem; color: #333; font-weight: bold; }

        #leaderboard-list {
            width: 95%; max-width: 500px; height: 50vh; overflow-y: auto;
            background: rgba(0,0,0,0.5); border-radius: 10px; border: 1px solid #FFD700; margin-bottom: 15px;
        }
        .rank-header {
            display: grid; grid-template-columns: 50px 1fr 80px; padding: 10px;
            background-color: #333; color: #FFD700; font-weight: bold;
            border-bottom: 1px solid #FFD700; position: sticky; top: 0; z-index: 2;
        }
        .rank-item {
            display: grid; grid-template-columns: 50px 1fr 80px; padding: 12px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1); align-items: center; text-align: left;
        }
        .rank-item:nth-child(even) { background: rgba(255,255,255,0.05); }
        
        .rank-num { 
            text-align: center; 
            font-weight: bold; 
            font-size: 1.2em;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            color: #CD7F32;
        }
        .rank-name { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 10px; color: #fff}
        .rank-score { text-align: right; color: #FFD700; font-family: monospace; font-size: 1.1em;}
        
        .rank-item:nth-child(2) .rank-num { color: #FFD700; text-shadow: 0 0 8px gold; } 
        .rank-item:nth-child(3) .rank-num { color: #C0C0C0; text-shadow: 0 0 8px silver; } 
        .rank-item:nth-child(4) .rank-num { color: #CD7F32; text-shadow: 0 0 8px orange; }
    </style>
</head>
<body>

<audio id="bgm" loop autoplay>
    <source src="https://mygodcatisfat.github.io/New_Year/new-year-song.mp3" type="audio/mpeg">
</audio>

<div id="game-container">
    <div class="ui-layer">
        <div style="display:flex; gap:10px;">
            <span id="score-display">ğŸ’° åˆ†æ•¸: 0</span>
            <span id="time-display">â³ 30s</span>
        </div>
        <div id="music-btn" onclick="toggleMusic()">ğŸ”‡</div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>ğŸ´å“å–¬é‚€æ‚¨é‡‘é¦¬å¥”é¨°æ¥ç´…åŒ…ğŸ´</h1>
        <p>æº–å‚™å¥½ä½ çš„æ‰‹æŒ‡ï¼Œä¸€èµ·æ¶å¥½é‹ï¼</p>
        <div class="instruction-box">
            <div class="rule-row"><span class="rule-icon">ğŸ§§</span><span class="rule-desc">å¤§ç´…åŒ…</span><span class="rule-score">+10</span></div>
            <div class="rule-row"><span class="rule-icon">ğŸ¥•</span><span class="rule-desc">ç´…è˜¿è”” (é¦¬å…’æ„›åƒ)</span><span class="rule-score">+20</span></div>
            <div class="rule-row"><span class="rule-icon">ğŸ´</span><span class="rule-desc">é‡‘é¦¬ (ç¨€æœ‰ï¼)</span><span class="rule-score">+50</span></div>
            <div class="rule-row"><span class="rule-icon">ğŸ§¨</span><span class="rule-desc">é­ç‚® (å°å¿ƒï¼)</span><span class="rule-score" style="color:#ff4d4d;">-20</span></div>
        </div>
        <button class="btn" onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
        <button class="btn btn-secondary" onclick="showLeaderboard()">ğŸ† æŸ¥çœ‹æ‰€æœ‰æ’å</button>
    </div>

    <div id="input-screen" class="overlay hidden">
        <h1>â° æ™‚é–“åˆ°ï¼</h1>
        <p>ä½ çš„å¾—åˆ†</p>
        <div style="font-size: 3rem; color: #FFD700; font-weight: bold; margin: 5px 0;" id="final-score">0</div>
        <div id="blessing-box">
            <span class="blessing-title">å“å–¬ç¥ç¦æ‚¨</span>
            <span id="blessing-content" class="blessing-content">è¼‰å…¥ä¸­...</span>
        </div>
        <p style="margin-top:20px; font-size:0.9rem;">è¼¸å…¥æš±ç¨±ä¸Šå‚³æ’è¡Œæ¦œï¼š</p>
        <input type="text" id="username" placeholder="ä¾‹ï¼šå¸¥æ°£è¡¨å“¥" maxlength="8">
        <button class="btn" onclick="submitScore()">é€å‡ºæˆç¸¾</button>
        <button class="btn btn-secondary" onclick="returnToStart()">è¿”å›é¦–é </button>
        <p id="submit-status" style="color:#aaa; font-size:0.8rem; height:1rem;"></p>
    </div>

    <div id="leaderboard-screen" class="overlay hidden">
        <h2>ğŸ† é¢¨é›²æ¦œ ğŸ†</h2>
        <div id="leaderboard-list">
            <div class="rank-header"><span>åæ¬¡</span><span>æš±ç¨±</span><span>åˆ†æ•¸</span></div>
            <div id="rank-content"></div>
        </div>
        <button class="btn" onclick="returnToStart()">è¿”å›é¦–é </button>
    </div>
</div>

<script>
    
    document.addEventListener('touchstart', function(event) {
        if (event.touches.length > 1) event.preventDefault(); 
    }, { passive: false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) event.preventDefault();
        lastTouchEnd = now;
    }, { passive: false });

    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4_K6xu2-KK3rEXaIy4qCLYWbLAqQkXA7SmMROErLi5txdcmZeSTfjZrzk-X068vuDRw/exec'; 
 
    let score = 0;
    let timeLeft = 30;
    let gameInterval, spawnInterval;
    let isPlaying = false;
    let isMusicOn = false; 

    const bgm = document.getElementById('bgm');
    const musicBtn = document.getElementById('music-btn');

    const items = [
        { symbol: 'ğŸ§§', val: 10, prob: 0.55 },
        { symbol: 'ğŸ¥•', val: 20, prob: 0.30 },
        { symbol: 'ğŸ´', val: 50, prob: 0.05 },
        { symbol: 'ğŸ§¨', val: -20, prob: 0.10 }
    ];

    const horseBlessings = [
        { min: 0, text: "é¦¬å¹´å¹³å®‰ï¼å¥åº·å°±æ˜¯æœ€å¤§çš„è²¡å¯Œï¼" },
        { min: 250, text: "ä¸€é¦¬ç•¶å…ˆï¼ä»Šå¹´é‹å‹¢è·‘ç¬¬ä¸€ï¼" },
        { min: 500, text: "é¾é¦¬ç²¾ç¥ï¼æ´»åŠ›æ»¿æ»¿è³ºå¤§éŒ¢ï¼" },
        { min: 750, text: "é¦¬åˆ°æˆåŠŸï¼å¿ƒæƒ³äº‹æˆè¬äº‹é †ï¼" },
        { min: 1000, text: "è¬é¦¬å¥”é¨°ï¼æ°£å‹¢å¦‚è™¹ï¼Œç„¡äººèƒ½æ“‹ï¼" }
    ];

    function toggleMusic() {
        if (bgm.paused) { playBgm(); } else { pauseBgm(); }
    }

    function playBgm() {
        bgm.play().then(() => {
            isMusicOn = true;
            musicBtn.innerText = "ğŸ”Š"; musicBtn.style.borderColor = "#00ff00";
        }).catch(err => { console.log("Autoplay blocked:", err); });
    }

    function pauseBgm() {
        bgm.pause();
        isMusicOn = false;
        musicBtn.innerText = "ğŸ”‡"; musicBtn.style.borderColor = "#FFD700";
    }

    function startGame() {
        if (!isMusicOn && bgm.paused) playBgm();
        score = 0; timeLeft = 30; isPlaying = true;
        
        document.body.classList.add('game-running');
        document.getElementById('score-display').innerText = `ğŸ’° åˆ†æ•¸: ${score}`;
        document.getElementById('time-display').innerText = `â³ ${timeLeft}s`;
        
        hideAllScreens();
        document.querySelectorAll('.item, .pop').forEach(e => e.remove());

        gameInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('time-display').innerText = `â³ ${timeLeft}s`;
            if (timeLeft <= 0) endGame();
        }, 1000);

        spawnInterval = setInterval(spawnItem, 200);
    }

    function spawnItem() {
        if (!isPlaying) return;
        
        const r = Math.random();
        let currentProb = 0;
        let selectedItem = items[0];
        for (let item of items) {
            currentProb += item.prob;
            if (r < currentProb) { selectedItem = item; break; }
        }

        const el = document.createElement('div');
        el.classList.add('item');
        el.innerText = selectedItem.symbol;
        el.style.left = (Math.random() * 80 + 10) + '%';
        
        // ä¿®æ”¹éœ€æ±‚ï¼šé€Ÿåº¦æœ‰å¿«æœ‰æ…¢ï¼ŒåŸæœ¬æ˜¯ 2~3.5sï¼Œæ”¹ç‚º 1.2s~4.0s
        const speed = (Math.random() * 2.8 + 1.2).toFixed(2);
        el.style.animationDuration = speed + 's';
        
        el.onpointerdown = (e) => {
            e.preventDefault();
            if (el.classList.contains('clicked')) return;
            el.classList.add('clicked');
            score += selectedItem.val;
            document.getElementById('score-display').innerText = `ğŸ’° åˆ†æ•¸: ${score}`;
            if (navigator.vibrate) navigator.vibrate(selectedItem.val > 0 ? 50 : 200);
            showEffect(e.clientX, e.clientY, selectedItem.val);
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 100);
        };

        if (selectedItem.symbol === 'ğŸ§¨') {
            const originalHandler = el.onpointerdown;
            el.onpointerdown = (e) => {
                originalHandler(e);
                document.body.style.backgroundColor = '#500';
                setTimeout(()=> { if(isPlaying) document.body.style.backgroundColor = '#111'; }, 100);
            }
        }

        document.getElementById('game-container').appendChild(el);
        el.addEventListener('animationend', () => el.remove());
    }

    function showEffect(x, y, val) {
        const div = document.createElement('div');
        div.classList.add('pop');
        div.innerText = (val > 0 ? '+' : '') + val;
        div.style.color = val > 0 ? '#FFD700' : '#ff4d4d';
        div.style.left = x + 'px'; div.style.top = y + 'px';
        document.getElementById('game-container').appendChild(div);
        setTimeout(() => div.remove(), 600);
    }

    function endGame() {
        isPlaying = false;
        clearInterval(gameInterval);
        clearInterval(spawnInterval);
        document.body.classList.remove('game-running');
        document.getElementById('final-score').innerText = score;
        let msg = horseBlessings[0].text;
        for(let i = horseBlessings.length - 1; i >= 0; i--) {
            if(score >= horseBlessings[i].min) { msg = horseBlessings[i].text; break; }
        }
        document.getElementById('blessing-content').innerText = msg;
        showScreen('input-screen');
    }

    function submitScore() {
        const name = document.getElementById('username').value.trim();
        if (!name) { alert("è«‹è¼¸å…¥æš±ç¨±ï¼"); return; }
        if (/[<>]/.test(name)) { alert("æš±ç¨±ä¸èƒ½åŒ…å«ç‰¹æ®Šç¬¦è™Ÿ"); return; }
        const statusBtn = document.getElementById('submit-status');
        const submitBtn = document.querySelector('#input-screen .btn');
        statusBtn.innerText = "è³‡æ–™ä¸Šå‚³ä¸­...";
        submitBtn.disabled = true;
        fetch(`${SCRIPT_URL}?action=save&name=${encodeURIComponent(name)}&score=${score}`)
            .then(res => res.json())
            .then(data => { if(data.result === 'success') showLeaderboard(); else alert("ä¸Šå‚³å¤±æ•—"); })
            .catch(err => alert("é€£ç·šéŒ¯èª¤"))
            .finally(() => { statusBtn.innerText = ""; submitBtn.disabled = false; });
    }

    function showLeaderboard() {
        showScreen('leaderboard-screen');
        const contentDiv = document.getElementById('rank-content');
        contentDiv.innerHTML = '<div style="padding:20px; text-align:center; color: white;">æ­£åœ¨æŠ“å–æœ€æ–°æ’å...</div>';
        fetch(`${SCRIPT_URL}?action=read`)
            .then(res => res.json())
            .then(data => {
                contentDiv.innerHTML = '';
                if (data.length === 0) {
                    contentDiv.innerHTML = '<div style="padding:10px; color: white;">ç›®å‰é‚„æ²’æœ‰äººæŒ‘æˆ°ï¼</div>';
                    return;
                }
                data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = 'rank-item';
                    let rankDisplay = index + 1;
                    if(index === 0) rankDisplay = 'ğŸ¥‡';
                    else if(index === 1) rankDisplay = 'ğŸ¥ˆ';
                    else if(index === 2) rankDisplay = 'ğŸ¥‰';
                    div.innerHTML = `
                        <div class="rank-num">${rankDisplay}</div>
                        <div class="rank-name">${user.name}</div>
                        <div class="rank-score">${user.score}</div>
                    `;
                    contentDiv.appendChild(div);
                });
            })
            .catch(err => { contentDiv.innerHTML = '<div style="color:white;">ç„¡æ³•è¼‰å…¥æ’è¡Œæ¦œ</div>'; });
    }

    function returnToStart() {
        document.body.classList.remove('game-running');
        document.querySelectorAll('.item, .pop').forEach(e => e.remove());
        showScreen('start-screen');
    }

    function showScreen(id) {
        hideAllScreens();
        const el = document.getElementById(id);
        el.classList.remove('hidden');
        setTimeout(() => el.style.opacity = '1', 10);
    }

    function hideAllScreens() {
        document.querySelectorAll('.overlay').forEach(el => {
            el.classList.add('hidden');
            el.style.opacity = '0';
        });
    }

    window.addEventListener('load', function() {
        playBgm();
    });

    // 2. å‚™æ¡ˆï¼šå¦‚æœç€è¦½å™¨é˜»æ“‹è‡ªå‹•æ’­æ”¾ï¼Œè¨­å®šã€Œé»æ“Šä»»æ„è™•ã€ç«‹å³è§¸ç™¼
    function unlockAudio() {
        if (!isMusicOn) {
            playBgm();
        }
        // æˆåŠŸè§¸ç™¼å¾Œç§»é™¤ç›£è½ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
        document.removeEventListener('click', unlockAudio);
        document.removeEventListener('touchstart', unlockAudio);
        document.removeEventListener('keydown', unlockAudio);
    }

    // ç›£è½å„ç¨®äº’å‹•äº‹ä»¶ä¾†è§£é–éŸ³æ•ˆ
    document.addEventListener('click', unlockAudio);
    document.addEventListener('touchstart', unlockAudio);
    document.addEventListener('keydown', unlockAudio);
</script>
</body>
</html>
