<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>經緯度轉地址工具</title>

  <!-- Leaflet CSS + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    body { font-family: system-ui, "Helvetica Neue", Arial; margin: 0; }
    .container { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    .card { background: #fff; border-right:1px solid #ddd; padding:12px; overflow-y:auto; position: relative; }
    h1 { font-size:20px; font-weight:bold; margin-bottom:12px; white-space:nowrap; }
    fieldset { border:1px solid #ccc; margin-bottom:12px; padding:10px; border-radius:8px; }
    legend { font-weight:bold; }
    label { display:block; font-size:14px; margin-top:8px; color:#333; }
    input[type="text"], input[type="email"], input[type="file"], input[type="number"], input[type="color"] { width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
    button { margin-top:8px; padding:8px 10px; border-radius:6px; border:0; background:#2b7cff; color:#fff; cursor:pointer; }
    #map { height: 100%; width: 100%; }
    #address { margin-top:10px; font-size:15px; color:#111; word-break:break-word; white-space:pre-line; }
    #address .title { font-size:20px; font-weight:bold; color:darkred; margin-top:6px; }
    .muted { color:#666; font-size:13px; margin-top:6px; }
    .error { color: #c00; margin-top:8px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    progress { width: 100%; height: 20px; margin-top: 8px; }
    .marker-label { border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:bold; color:white; }
    .row { display:flex; gap:6px; }
    .batch-container { margin-bottom:16px; border-bottom:1px dashed #eee; padding-bottom:10px; position:relative; }
    .batch-list { max-height:160px; overflow-y:auto; border:1px solid #eee; margin-top:8px; padding:6px; font-size:13px; }
    .batch-list.hidden { display:none !important; }
    .batch-list div { padding:4px 6px; cursor:pointer; border-radius:4px; }
    .batch-list div.active { background: #ffecec; font-weight:bold; }
    .batch-title-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      position:relative;
      gap: 8px;
    }
    .batch-visible-checkbox {
      width: 20px;
      height: 20px;
      margin-right: 4px;
      accent-color: #2b7cff;
      cursor: pointer;
    }
    .color-mini {
      width:36px; height:26px;
      border-radius:8px;
      border:1.5px solid #ccc;
      cursor:pointer;
      display:inline-block;
      margin-right: 4px;
      vertical-align:middle;
    }
    .batch-title { font-weight:bold; font-size:15px; width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; margin-top:0; }
    .delete-batch-btn {
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      border-radius: 50%;
      background: #c00;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 5;
      transition: background 0.2s;
      position: absolute;
      right: 0;
      top: 0;
      margin-top: 0;
      margin-right: 0;
    }
    .delete-batch-btn.hidden { display: none !important; }
    .delete-batch-btn:hover { background:#900; }
    .hidden { display:none !important; }
    /* Resize handle */
    .resize-handle {
      position: absolute;
      right: -4px;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="consolePanel">
      <div class="resize-handle" id="resizeHandle"></div>
      <h1>經緯度轉地址工具</h1>
      <label for="email" style="margin-bottom:0;margin-top:0;">聯絡 Email (必填以符合政策)</label>
      <input id="email" type="email" placeholder="輸入你的 email" required style="margin-bottom:12px;" />

      <!-- 批次(可複製多組) -->
      <fieldset id="batchArea">
        <legend>批次匯入查詢（可重複新增）</legend>
        <div class="batch-container">
          <div class="batch-title-row">
            <input type="checkbox" class="batch-visible-checkbox" checked title="顯示本批次點位於地圖" />
            <div class="color-mini" style="background:#0000ff;" title="點擊可選擇顏色"></div>
            <input type="text" class="batch-title" placeholder="批次標題（可留空）" />
            <button class="delete-batch-btn hidden" tabindex="-1" aria-label="刪除本批次">X</button>
          </div>
          <label class="import-label">匯入檔案 (.txt 或 .csv)</label>
          <input type="file" class="fileInput" accept=".txt,.csv" />
          <div class="row batch-controls hidden" style="margin-top:6px;">
            <button class="stopBtn" style="background:#c00;">終止查詢</button>
            <div style="flex:1"></div>
          </div>
          <progress class="progressBar hidden" value="0" max="100"></progress>
          <div class="batchStatus muted hidden"></div>
          <div class="batch-list hidden"></div>
        </div>
      </fieldset>

      <!-- 單點查詢 -->
      <fieldset>
        <legend>單點地址查詢</legend>
        <form id="geoForm">
          <label>緯度 (Latitude)</label>
          <input id="lat" name="lat" type="text" value="25.0330" />
          <label>經度 (Longitude)</label>
          <input id="lon" name="lon" type="text" value="121.5654" />
          <div class="muted">提示：緯度 -90~90，經度 -180~180。</div>
          <button type="submit">轉換地址</button>
        </form>
        <div id="address" class="hidden">
          <div class="title">好看地址</div>
          <div id="niceAddr"></div>
          <div class="title">資料地址</div>
          <div id="rawAddr"></div>
        </div>
        <pre id="raw" class="muted"></pre>
        <div id="error" class="error"></div>
      </fieldset>
    </div>

    <div id="map"></div>
  </div>

  <div id="userAgent" style="display:none;"></div>

  <!-- Leaflet + MarkerCluster -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // Resize handle for the console panel
    (function(){
      const consolePanel = document.getElementById('consolePanel');
      const resizeHandle = document.getElementById('resizeHandle');
      const container = document.querySelector('.container');
      let dragging = false;
      resizeHandle.addEventListener('mousedown', function(e){
        dragging = true;
        document.body.style.cursor = 'ew-resize';
        e.preventDefault();
      });
      document.addEventListener('mousemove', function(e){
        if (!dragging) return;
        let min = 320;
        let max = Math.max(window.innerWidth * 0.8, 600);
        let x = e.clientX;
        if (x < min) x = min;
        if (x > max) x = max;
        container.style.gridTemplateColumns = `${x}px 1fr`;
      });
      document.addEventListener('mouseup', function(e){
        if (dragging) {
          dragging = false;
          document.body.style.cursor = '';
        }
      });
    })();

    // 基本地圖與全域變數
    const map = L.map('map').setView([23.5, 121], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    document.getElementById('userAgent').textContent = navigator.userAgent;

    // 已被用過的顏色（避免重複）
    let usedColors = ['#0000ff','#ff0000','#00aa00'];

    // 檢查經緯度
    function isValidCoord(lat, lon){
      return !(isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180);
    }

    function buildExportLine(r){
      const idxStr = String(r.idx).padStart(3,'0');
      let hn = r.house_number || '';
      if (hn && !hn.includes('號')) hn = hn + '號';
      let tail = '';
      if ((r.village && r.village.trim()!=='') || (r.office && r.office.trim()!=='')) {
        tail = '-' + (r.village || '') + (r.office || '');
      }
      const addrPart = (r.postcode||'') + (r.country||'') + (r.city||'') + (r.suburb||'') + (r.neighbourhood||'') + (r.road||'') + (hn||'') + tail;
      return `${idxStr}\t${r.lat}, ${r.lon}\t${addrPart}`;
    }

    function niceAddressFromR(r){
      return buildExportLine(r).split('\t')[2] || '';
    }

    async function fetchAddress(lat, lon, email) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
      const resp = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': `${navigator.userAgent} (${email})`
        }
      });
      return resp.json();
    }

    // 單筆查詢
    const geoForm = document.getElementById('geoForm');
    const niceAddrDiv = document.getElementById('niceAddr');
    const rawAddrDiv = document.getElementById('rawAddr');
    const rawPre = document.getElementById('raw');
    const errorDiv = document.getElementById('error');
    const addressBlock = document.getElementById('address');
    let singleMarker = null;
    addressBlock.classList.add('hidden');

    geoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.textContent = '';
      niceAddrDiv.textContent = '查詢中…';
      rawAddrDiv.textContent = '';
      rawPre.textContent = '';
      addressBlock.classList.add('hidden');

      const lat = parseFloat(document.getElementById('lat').value.trim());
      const lon = parseFloat(document.getElementById('lon').value.trim());
      const email = document.getElementById('email').value.trim();
      if (!isValidCoord(lat, lon)) { errorDiv.textContent = '經緯度錯誤'; niceAddrDiv.textContent=''; return; }
      if (!email) { errorDiv.textContent = '請輸入 Email'; niceAddrDiv.textContent=''; return; }
      localStorage.setItem('geoEmail', email);

      try {
        const data = await fetchAddress(lat, lon, email);
        if (!data || !data.display_name) throw '無結果';
        const addr = data.address || {};
        const r = { idx: 1, lat: lat, lon: lon, ...addr };
        niceAddrDiv.textContent = niceAddressFromR(r);
        rawAddrDiv.textContent = data.display_name;
        rawPre.textContent = JSON.stringify(data, null, 2);

        addressBlock.classList.remove('hidden');

        const ll = [parseFloat(data.lat), parseFloat(data.lon)];
        map.setView(ll, 14);
        if (singleMarker) {
          singleMarker.setLatLng(ll).setPopupContent(niceAddressFromR(r));
        }
        else singleMarker = L.marker(ll).addTo(map).bindPopup(niceAddressFromR(r));
        singleMarker.openPopup();
      } catch (err) {
        errorDiv.textContent = '錯誤：' + (err.message || err);
      }
    });

    if (localStorage.getItem('geoEmail')) document.getElementById('email').value = localStorage.getItem('geoEmail');

    // ========= 批次處理系統 =========

    let batchArea = document.getElementById('batchArea');
    let templateDiv = batchArea.querySelector('.batch-container');
    let batchUID = 0;

    function bindBatch(container) {
      let fileInput = container.querySelector('.fileInput');
      const stopBtn = container.querySelector('.stopBtn');
      const progressBar = container.querySelector('.progressBar');
      const status = container.querySelector('.batchStatus');
      const listDiv = container.querySelector('.batch-list');
      const batchTitleInput = container.querySelector('.batch-title');
      const deleteBtn = container.querySelector('.delete-batch-btn');
      const colorMini = container.querySelector('.color-mini');
      const visibleCheckbox = container.querySelector('.batch-visible-checkbox');
      const batchControls = container.querySelector('.batch-controls');
      const importLabel = container.querySelector('.import-label');
      let colorValue = colorMini.style.background || '#0000ff';
      let stopFlag = false, processing = false, stopped = false;
      let markersCluster = L.markerClusterGroup();
      let markersList = [], polyline = null, path = [];

      function updateMarkersPolylineColor(){
        markersList.forEach((m,i)=>{
          if (!m) return;
          const html = `<div class="marker-label" style="background:${colorValue}; width:32px; height:32px;">${i+1}</div>`;
          m.setIcon(L.divIcon({className:'', html:html, iconSize:[32,32], iconAnchor:[16,16]}));
        });
        if (polyline) polyline.setStyle({color: colorValue});
      }

      colorMini.addEventListener('click', ()=>{
        const picker = document.createElement('input');
        picker.type = 'color';
        picker.value = rgbToHex(colorMini.style.background);
        picker.style.display = 'none';
        document.body.appendChild(picker);
        picker.click();
        picker.addEventListener('input', ()=>{
          colorValue = picker.value;
          colorMini.style.background = colorValue;
          updateMarkersPolylineColor();
          document.body.removeChild(picker);
        });
      });
      function rgbToHex(rgb) {
        if (rgb[0]==='#') return rgb;
        const m = rgb.match(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/);
        if (!m) return '#0000ff';
        return '#' + [1,2,3].map(i=>parseInt(m[i]).toString(16).padStart(2,'0')).join('');
      }

      visibleCheckbox.addEventListener('change', ()=>{
        if (visibleCheckbox.checked) {
          map.addLayer(markersCluster);
          if (polyline) map.addLayer(polyline);
        } else {
          map.removeLayer(markersCluster);
          if (polyline) map.removeLayer(polyline);
        }
      });

      if (deleteBtn) {
        deleteBtn.onclick = function(){
          try { markersCluster.clearLayers(); } catch(e){}
          try { if (polyline && map.hasLayer(polyline)) map.removeLayer(polyline); } catch(e){}
          container.parentNode.removeChild(container);
        };
      }

      stopBtn.onclick = function(){
        stopFlag = true;
        stopped = true;
        status.textContent = '使用者已終止該批次';
        processing = false;
      };

      function clearBatchContent() {
        listDiv.innerHTML = '';
        markersCluster.clearLayers();
        markersList = [];
        path = [];
        if (polyline && map.hasLayer(polyline)) { map.removeLayer(polyline); polyline = null; }
        progressBar.value = 0;
        status.textContent = '';
        if (visibleCheckbox.checked) {
          map.removeLayer(markersCluster);
          if (polyline) map.removeLayer(polyline);
        }
      }

      // 讓同名檔案可正常觸發change
      function resetFileInput(oldInput) {
        // 1. clone，2. bind，3. replace
        const newInput = oldInput.cloneNode();
        newInput.value = "";
        oldInput.parentNode.replaceChild(newInput, oldInput);
        fileInput = newInput;
        bindFileInput(newInput);
        return newInput;
      }

      // -- 匯入前隱藏控制列/狀態/列表
      batchControls.classList.add('hidden');
      progressBar.classList.add('hidden');
      status.classList.add('hidden');
      listDiv.classList.add('hidden');
      fileInput.classList.remove('hidden');
      importLabel.classList.remove('hidden');

      function bindFileInput(fileInput) {
        fileInput.addEventListener('click', function() {
          // reset file input value on click, always allow change
          this.value = "";
        });

        fileInput.addEventListener('change', async (ev) => {
          // step1: always clean up on change, even for same filename
          stopFlag = false;
          stopped = false;
          clearBatchContent();
          batchControls.classList.remove('hidden');
          progressBar.classList.remove('hidden');
          status.classList.remove('hidden');
          listDiv.classList.remove('hidden');

          // step2: parse file and run query
          const file = ev.target.files[0];
          if (!file) return;
          const email = document.getElementById('email').value.trim();
          if (!email) { alert('請先輸入 Email'); fileInput.value = ''; return; }
          localStorage.setItem('geoEmail', email);

          const text = await file.text();
          const coords = [];
          let hadError = false;
          if (file.name.toLowerCase().endsWith('.txt')) {
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            for (let line of lines) {
              const parts = line.split(',');
              if (parts.length !== 2) { alert('格式錯誤：' + line); hadError = true; break; }
              const lat = parseFloat(parts[0].trim()), lon = parseFloat(parts[1].trim());
              if (!isValidCoord(lat, lon)) { alert('經緯度無效：' + line); hadError = true; break; }
              coords.push([lat, lon]);
            }
          } else if (file.name.toLowerCase().endsWith('.csv')) {
            const lines = text.split(/\r?\n/);
            for (let i = 1; i < lines.length; i++) {
              if (!lines[i] || lines[i].trim() === '') continue;
              const parts = lines[i].split(',');
              if (parts.length < 11) { alert('CSV 欄位錯誤：' + lines[i]); hadError = true; break; }
              const lon = parseFloat(parts[8].trim()), lat = parseFloat(parts[9].trim());
              if (!isValidCoord(lat, lon)) { alert('經緯度無效：' + lines[i]); hadError = true; break; }
              coords.push([lat, lon]);
            }
          } else {
            alert('不支援的檔案格式');
            fileInput.value = '';
            // always allow next change for same filename
            resetFileInput(fileInput);
            return;
          }
          if (!hadError && coords.length) {
            await doBatchQuery(coords, email);
          }
          // step3: always allow next change for same filename
          resetFileInput(fileInput);
        });
      }
      bindFileInput(fileInput);

      async function doBatchQuery(coords, email) {
        progressBar.classList.remove('hidden');
        status.classList.remove('hidden');
        listDiv.classList.remove('hidden');
        const results = [];
        if (visibleCheckbox.checked) {
          map.addLayer(markersCluster);
        }
        for (let i = 0; i < coords.length; i++) {
          if (stopFlag) { status.textContent = '已終止'; processing = false; stopped = true; break; }
          const [lat, lon] = coords[i];
          const start = Date.now();
          try {
            if (stopFlag || stopped) break;
            const data = await fetchAddress(lat, lon, email);
            if (stopFlag || stopped) break;
            const addr = data.address || {};
            const r = {
              idx: i + 1,
              lat: lat,
              lon: lon,
              postcode: addr.postcode || '',
              country: addr.country || '',
              city: addr.city || addr.town || addr.village || '',
              suburb: addr.suburb || '',
              neighbourhood: addr.neighbourhood || '',
              road: addr.road || '',
              house_number: addr.house_number || '',
              village: addr.village || '',
              office: addr.office || ''
            };
            results.push(r);

            // marker
            const html = `<div class="marker-label" style="background:${colorValue}; width:32px; height:32px;">${i+1}</div>`;
            const m = L.marker([lat, lon], { icon: L.divIcon({ className:'', html: html, iconSize:[32,32], iconAnchor:[16,16] }) })
                      .bindPopup(niceAddressFromR(r));
            m.on('click', () => {
              highlightIndex(i);
              map.setView([lat, lon], Math.max(14, map.getZoom()));
            });
            markersCluster.addLayer(m);
            markersList.push(m);

            // polyline
            path.push([lat, lon]);
            if (polyline && map.hasLayer(polyline)) map.removeLayer(polyline);
            polyline = L.polyline(path, { color: colorValue });
            if (visibleCheckbox.checked) map.addLayer(polyline);
            if (path.length === 1) map.setView([lat, lon], 14);
            else map.fitBounds(polyline.getBounds());

            // list
            const item = document.createElement('div');
            item.textContent = `${i+1}. ${niceAddressFromR(r)}`;
            item.addEventListener('click', () => {
              highlightIndex(i);
              map.setView([lat, lon], Math.max(14, map.getZoom()));
            });
            listDiv.appendChild(item);
          } catch (err) {
            console.error(err);
          }
          progressBar.value = ((i + 1) / coords.length) * 100;
          status.textContent = `進度 ${i+1}/${coords.length}`;
          const elapsed = Date.now() - start;
          if (elapsed < 1000) await new Promise(r => setTimeout(r, 1000 - elapsed));
        }
        if (!stopFlag && !stopped) {
          status.textContent = `批次完成，共 ${results.length} 筆`;
          downloadResults(results);
          if (colorValue && /^#[0-9A-Fa-f]{6}$/.test(colorValue)) usedColors.push(colorValue);
          finishBatch();
          addNewBatchArea();
        } else {
          status.textContent = '批次被使用者中止';
        }
      }

      function highlightIndex(idx) {
        Array.from(listDiv.children).forEach((el,i)=>el.classList.toggle('active', i === idx));
        markersList.forEach((m,i)=>{
          if (!m) return;
          const html = `<div class="marker-label" style="background:${colorValue}; width:32px;height:32px; font-size:13px;">${i+1}</div>`;
          m.setIcon(L.divIcon({className:'', html:html, iconSize:[32,32], iconAnchor:[16,16]}));
        });
      }

      function downloadResults(results) {
        if (!results || results.length === 0) return;
        let filename = 'batch_results.txt';
        const title = batchTitleInput.value.trim();
        if (title) filename = title + '.txt';
        const txt = results.map(buildExportLine).join('\n');
        const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }

      function finishBatch() {
        fileInput.classList.add('hidden');
        importLabel.classList.add('hidden');
        batchControls.classList.add('hidden');
        progressBar.classList.add('hidden');
        status.classList.add('hidden');
        if (deleteBtn) deleteBtn.classList.remove('hidden');
      }
    }

    function addNewBatchArea() {
      const clone = templateDiv.cloneNode(true);
      clone.querySelector('.progressBar').value = 0;
      clone.querySelector('.batchStatus').textContent = '';
      clone.querySelector('.batch-list').innerHTML = '';
      clone.querySelector('.batch-list').classList.add('hidden');
      clone.querySelector('.batch-title').value = '';
      clone.querySelector('.batch-visible-checkbox').checked = true;
      // 隱藏刪除鈕
      if (clone.querySelector('.delete-batch-btn')) {
        clone.querySelector('.delete-batch-btn').classList.add('hidden');
      }
      // 匯入檔案區預設顯示（重要修正！）
      clone.querySelector('.fileInput').classList.remove('hidden');
      clone.querySelector('.import-label').classList.remove('hidden');
      // 隱藏控制列/狀態/列表
      clone.querySelector('.row.batch-controls').classList.add('hidden');
      clone.querySelector('.progressBar').classList.add('hidden');
      clone.querySelector('.batchStatus').classList.add('hidden');
      let nextColor = '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
      let attempts = 0;
      while (usedColors.includes(nextColor) && attempts < 20) {
        nextColor = '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
        attempts++;
      }
      const colorMini = clone.querySelector('.color-mini');
      colorMini.style.background = nextColor;
      ++batchUID;
      const fileInput = clone.querySelector('.fileInput');
      fileInput.value = '';
      fileInput.setAttribute('data-batch-uid', batchUID);
      bindBatch(clone);
      batchArea.appendChild(clone);
    }

    bindBatch(templateDiv);
  </script>
</body>
</html>
