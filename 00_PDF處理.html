<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 編輯工具</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb; 
            --primary-light: #93c5fd;
            --primary-bg: #eff6ff;
            
            --success: #22c55e;
            --success-hover: #16a34a;
            --success-light: #86efac;
            
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fca5a5;
            
            --warning: #eab308;
            --warning-hover: #ca8a04;
            --warning-light: #fde047;

            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            --font-main: 'Inter', sans-serif;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: var(--font-main);
            background-color: var(--gray-100);
            color: var(--gray-800);
            padding: 2rem;
            margin: 0;
        }

        .container {
            max-width: 72rem;
            margin: 0 auto;
        }

        .card {
            background-color: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
        }
        @media (min-width: 768px) {
            .card { padding: 2.5rem; }
        }

        .main-title {
            font-size: 1.875rem; 
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary-hover);
        }

        .section-header {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .section-title {
            font-size: 1.25rem; 
            font-weight: 600;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { display: flex; flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .justify-start { justify-content: flex-start; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .font-medium { font-weight: 500; }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-gray-700 { color: var(--gray-700); }
        
        .drop-zone {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            text-align: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone label {
            cursor: pointer;
            color: var(--primary);
        }
        .drop-zone label:hover {
            color: var(--primary-hover);
        }
        .drop-zone-text-main {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .drop-zone.border-blue-500 { border-color: var(--primary); }
        .drop-zone.bg-blue-50 { background-color: var(--primary-bg); }

        .tabs-container {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        .tab-button {
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--gray-600);
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            color: white;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:disabled {
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-lg { padding: 0.75rem 1.5rem; }

        .btn-blue { background-color: var(--primary); }
        .btn-blue:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-blue:disabled { background-color: var(--primary-light); }

        .btn-red { background-color: var(--danger); }
        .btn-red:hover:not(:disabled) { background-color: var(--danger-hover); }
        .btn-red:disabled { background-color: var(--danger-light); }

        .btn-yellow { background-color: var(--warning); }
        .btn-yellow:hover:not(:disabled) { background-color: var(--warning-hover); }
        .btn-yellow:disabled { background-color: var(--warning-light); }
        
        .btn-green { background-color: var(--success); }
        .btn-green:hover:not(:disabled) { background-color: var(--success-hover); }
        .btn-green:disabled { background-color: var(--success-light); }
        
        .btn-gray { background-color: var(--gray-500); }
        .btn-gray:hover { background-color: var(--gray-600); }

        .form-input {
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            transition: all 0.2s;
            outline: none;
        }
        .form-input:focus {
            ring: 2px;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* blue-400 */
            border-color: rgba(59, 130, 246, 0.5);
        }
        .w-24 { width: 6rem; }
        
        .thumb-container {
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            scrollbar-width: thin;
        }
        .thumb-container::-webkit-scrollbar {
            height: 8px;
        }
        .thumb-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .thumb-container::-webkit-scrollbar-track {
            background-color: #e2e8f0;
            border-radius: 4px;
        }

        .punc-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            color: var(--gray-700);
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .punc-btn:hover { background-color: var(--gray-50); }
        .punc-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .punc-btn.active:hover { background-color: var(--primary-hover); }

        .cut-marker {
            width: 1.5rem;
            height: 1.5rem;
            background-color: white;
            border: 2px solid #60a5fa; /* Blue-400 */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin: 0 0.5rem;
            flex-shrink: 0;
        }
        .cut-marker:hover {
            transform: scale(1.1);
        }
        .cut-marker.active {
            background-color: var(--success);
            border-color: var(--success);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .info-tooltip-container {
            position: relative;
        }
        .info-tooltip-icon {
            display: inline-block; 
            width: auto;
            height: auto;
        }

        #mergeFileList li {
            list-style-type: none;
        }

        .preview-canvas {
            filter: blur(5px);
            opacity: 0.6;
            transition: filter 0.4s ease, opacity 0.4s ease;
            display: block;
        }
        .preview-canvas.loaded {
            filter: blur(0);
            opacity: 1;
        }

        .sortable-item {
            cursor: grab;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: white;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
        }
        .sortable-item:hover { background-color: var(--gray-50); }
        .sortable-item:active { cursor: grabbing; }

        .ring-2 { box-shadow: 0 0 0 2px var(--primary); }
        .ring-blue-500 { /* Helper for JS compatibility */ }
        .selected-thumbnail { box-shadow: 0 0 0 2px var(--primary); }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
			background-color: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(2px);
        }
        .overlay-bg {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            max-width: 24rem;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .split-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .split-overlay-content { position: relative; }
        .overlay-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            z-index: 110;
            border: none;
        }
        .overlay-nav-button.left { left: 20px; }
        .overlay-nav-button.right { right: 20px; }
        #previewImage {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        #tooltipModal {
            background-color: rgba(17, 24, 39, 0.7); /* gray-900 opacity 70 */
            backdrop-filter: blur(4px);
        }
        .tooltip-card {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            max-width: 32rem; /* lg */
            width: 100%;
        }
        .tooltip-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-hover);
            margin-bottom: 1rem;
        }
        .prose p { margin-bottom: 0.5em; }
        .prose ul { margin-left: 1.5em; list-style-type: disc; }
        .text-green-500 { color: var(--success); }
        .text-blue-500 { color: var(--primary); }
        .text-red-500 { color: var(--danger); }
        .text-orange-500 { color: #f97316; }

        .back-home-btn {
            position: fixed;
            right: 16px;
            top: 10px;
            z-index: 300;
            background: #2563eb;
            color: #fff;
            padding: 6px 8px;
            border-radius: 9px;
            box-shadow: 0 4px 14px rgba(37,99,235,0.18);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            gap: 0.5em;
            text-decoration: none;
        }
        .back-home-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 6px 18px rgba(37,99,235,0.28);
        }

        #copyNotification {
            position: fixed;
            top: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--gray-800);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 300;
            opacity: 0;
            transition: opacity 1s;
        }

        #ocrResultText {
            width: 100%;
            height: 16rem;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: var(--gray-50);
            resize: vertical;
            box-sizing: border-box;
            outline: none;
        }
        .ocr-progress-container {
            width: 100%;
            background-color: var(--gray-200);
            border-radius: 9999px;
            height: 0.625rem;
            margin-bottom: 1rem;
        }
        .ocr-progress-bar {
            background-color: var(--primary-hover);
            height: 0.625rem;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        .fieldset-border {
            border: 1px solid var(--gray-300);
            padding: 0.75rem;
            border-radius: var(--radius-md);
        }
        legend { font-size: 0.875rem; font-weight: 500; color: var(--gray-700); padding: 0 0.5rem; }

        .thumb-wrapper {
            position: relative;
            flex-shrink: 0;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
        }
		
        .ml-auto { margin-left: auto; }

        .btn-text-red {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: background-color 0.2s;
        }
        .btn-text-red:hover {
            background-color: #fee2e2;
        }
		
        .btn-text-yellow {
            background: none;
            border: none;
            color: var(--warning-hover); 
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: background-color 0.2s;
        }
        .btn-text-yellow:hover {
            background-color: #fef9c3; 
        }

        .remove-file-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 1.5rem;
            height: 1.5rem;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transition: transform 0.2s, background-color 0.2s;
        }
        .remove-file-btn:hover {
            background-color: var(--danger-hover);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="main-title">PDF 編輯工具</h1>

            <div id="dropZone" class="drop-zone">
                <label for="fileInput">
                    <p class="drop-zone-text-main">點擊此處或拖曳檔案至此</p>
                    <p id="fileStatus" class="text-sm text-gray-500">支援 .pdf 格式</p>
                </label>
                <input type="file" id="fileInput" class="hidden" multiple accept=".pdf">
            </div>

            <div class="tabs-container">
                <button id="tabSplit" class="tab-button active">裁切</button>
                <button id="tabMerge" class="tab-button">合成</button>
                <button id="tabPageNumber" class="tab-button">編頁碼</button>
                <button id="tabRotate" class="tab-button">旋轉</button>
                <button id="tabOcr" class="tab-button">文字辨識(前端)</button>
            </div>

            <div id="sectionSplit" class="tool-section">
                <div class="section-header">
                    <h2 class="section-title">裁切功能</h2>
                    <button class="btn-text-yellow info-tooltip-icon ml-auto" data-tooltip="split">功能說明</button>
                    <button id="clearSplit" class="btn-text-red">清除資料</button>
                </div>
                
                <div id="splitTextInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">從第</label>
                        <input type="number" id="splitStartPage" placeholder="頁碼" class="form-input w-24">
                        <label class="font-medium text-gray-700">頁裁切到第</label>
                        <input type="number" id="splitEndPage" placeholder="頁碼" class="form-input w-24">
                        <label class="font-medium text-gray-700">頁</label>
                    </div>
                </div>

                <div id="splitImageSelection" class="mb-6">
                    <div id="splitThumbnails" class="thumb-container">
                        </div>
                </div>

                <div id="splitAction" class="flex justify-end mt-8">
                    <button id="splitNext" class="btn btn-blue btn-lg" disabled>下一步</button>
                </div>
            </div>

            <div id="sectionMerge" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">合成功能</h2>
                    <button class="btn-text-yellow info-tooltip-icon ml-auto" data-tooltip="merge">功能說明</button>
                    <button id="clearMerge" class="btn-text-red">清除資料</button>
                </div>

                <div class="mb-6">
                    <h3 class="section-title mb-4">檔案清單</h3>
                    <ul id="mergeFileList" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[100px] space-y-2" style="background-color: var(--gray-50); border-radius: var(--radius-lg); border: 1px solid var(--gray-200); min-height: 100px; padding: 1rem;">
                        <li class="text-gray-400 text-center py-4">請匯入 PDF 檔案以進行合成</li>
                    </ul>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="deleteFile" class="btn btn-red" disabled>刪除</button>
                    <button id="mergeNext" class="btn btn-blue btn-lg" disabled>下一步</button>
                </div>
            </div>

            <div id="sectionPageNumber" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">編頁碼功能</h2>
                    <button class="btn-text-yellow info-tooltip-icon ml-auto" data-tooltip="pageNumber">功能說明</button>
                    <button id="clearPageNumber" class="btn-text-red">清除資料</button>
                </div>
				
                <div id="pageNumberInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">起始數字：</label>
                        <input type="number" id="pageNumberStart" placeholder="1" value="1" class="form-input w-24">
                    </div>
					
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">從第幾頁開始編：</label>
                        <input type="number" id="pageNumberFromPage" placeholder="頁碼" class="form-input w-24">
                    </div>
					
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">起始頁碼位置：</label>
                        <select id="pageNumberPosition" class="form-input">
                            <option value="left">左</option>
                            <option value="right">右</option>
                        </select>
                    </div>
					
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">頁碼呈現類型：</label>
                        <select id="pageNumberType" class="form-input">
                            <option value="same">同側</option>
                            <option value="alternate">交叉</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="pageNumberNext" class="btn btn-blue btn-lg" disabled>下一步</button>
                </div>
            </div>

            <div id="sectionRotate" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">旋轉功能</h2>
                    <button class="btn-text-yellow info-tooltip-icon ml-auto" data-tooltip="rotate">功能說明</button>
                    <button id="clearRotate" class="btn-text-red">清除資料</button>
                </div>

                <div class="mb-4">
                    <button id="rotatePageBtn" class="btn btn-yellow" disabled>旋轉</button>
                </div>

                <div id="rotateImageSelection" class="mb-6">
                    <div id="rotateThumbnails" class="thumb-container">
                    </div>
                </div>

                <div id="rotateAction" class="flex justify-end space-x-4 mt-8">
                    <button id="rotateNext" class="btn btn-blue btn-lg" disabled>下一步</button>
                </div>
            </div>

            <div id="sectionOcr" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">文字辨識功能 (OCR)</h2>
                    <button class="btn-text-yellow info-tooltip-icon ml-auto" data-tooltip="ocr">功能說明</button>
                    <button id="clearOcr" class="btn-text-red">清除資料</button>
                </div>

                <div id="ocrTextInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">從第</label>
                        <input type="number" id="ocrStartPage" placeholder="頁碼" class="form-input w-24">
                        <label class="font-medium text-gray-700">頁辨識到第</label>
                        <input type="number" id="ocrEndPage" placeholder="頁碼" class="form-input w-24">
                        <label class="font-medium text-gray-700">頁</label>
                    </div>
                </div>
                <div id="ocrImageSelection" class="mb-6">
                    <div id="ocrThumbnails" class="thumb-container" style="background-color: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-lg); min-height: 100px;">
                    </div>
                </div>
                <div id="ocrAction" class="flex justify-start space-x-4 mt-8">
                     <button id="ocrStartBtn" class="btn btn-blue" disabled>開始辨識</button>
                </div>
                <div id="ocrStatus" class="my-4 text-gray-600 hidden">
                </div>
                <div id="ocrProgressContainer" class="ocr-progress-container hidden">
                    <div id="ocrProgressBar" class="ocr-progress-bar" style="width: 0%"></div>
                </div>
                <div id="ocrResultTools" class="my-4 space-y-2 hidden">
                    <fieldset class="fieldset-border">
                        <legend>標點符號改為全型</legend>
                        <div id="punctuationSubButtons" class="flex space-x-2">
                            <button id="btnPuncColon" class="punc-btn" data-type="colon">冒號 ( : )</button>
                            <button id="btnPuncComma" class="punc-btn" data-type="comma">逗號 ( , )</button>
                            <button id="btnPuncParen" class="punc-btn" data-type="paren">括號 ( )</button>
                        </div>
                    </fieldset>
                </div>
                <div id="ocrResultAreaWrapper" class="mb-6">
                    <label class="font-medium text-gray-700 mb-2 block">辨識結果：</label>
                    <textarea id="ocrResultText" readonly placeholder="辨識結果將顯示於此..."></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="copyOcrTextBtn" class="btn btn-green text-sm" disabled>複製文字</button>
                    </div>
                </div>
            </div>

            <div id="messageBox" class="overlay hidden">
                <div class="overlay-bg">
                    <p id="messageText" class="text-lg font-medium mb-4"></p>
                    <button id="messageOk" class="btn btn-blue">確定</button>
                </div>
            </div>

            <div id="splitSelectionBox" class="overlay hidden">
                <div class="overlay-bg">
                    <p class="text-lg font-medium mb-4">已選擇超過兩個裁切點，請選擇操作：</p>
                    <div class="flex flex-col space-y-2">
                        <button id="selectFirst" class="btn btn-blue">刪除前裁切點</button>
                        <button id="selectLast" class="btn btn-yellow">刪除後裁切點</button>
                        <button id="selectCancel" class="btn btn-gray">取消</button>
                    </div>
                </div>
            </div>
            
            <div id="tooltipModal" class="overlay hidden">
                <div class="tooltip-card">
                    <h3 id="tooltipTitle" class="tooltip-title"></h3>
                    <div id="tooltipContentArea" class="prose text-gray-800">
                        </div>
                    <div class="mt-6 text-right">
                        <button id="tooltipOk" class="btn btn-blue">關閉</button>
                    </div>
                </div>
            </div>
            
            <div id="copyNotification" style="display: none;">
                已複製文字！
            </div>

            <div id="fullScreenPreview" class="split-overlay hidden">
                <div class="split-overlay-content">
                    <button id="previewPrev" class="overlay-nav-button left">❮</button>
                    <img id="previewImage" src="" alt="PDF Preview">
                    <button id="previewNext" class="overlay-nav-button right">❯</button>
                </div>
            </div>
        </div>

        <a href="https://mygodcatisfat.github.io" class="back-home-btn" title="回到首頁">
            回到首頁
        </a>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js" integrity="sha256-H8KU7v2mAuWRoGwdWvNhyuI3VrWjNPwkIdX5rMzgOOU=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" integrity="sha256-D5pcrQeUHwgmWGyU4InYm5GMRuXBfPLVo8b2ZuO8aU8=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
	pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    const fileInput = document.getElementById('fileInput');
    const tabs = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('.tool-section');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageOk = document.getElementById('messageOk');
    const fileStatus = document.getElementById('fileStatus');
    const splitTextInput = document.getElementById('splitTextInput');
    const splitImageSelection = document.getElementById('splitImageSelection');
    const splitStartPage = document.getElementById('splitStartPage');
    const splitEndPage = document.getElementById('splitEndPage');
    const splitThumbnails = document.getElementById('splitThumbnails');
    const splitNextBtn = document.getElementById('splitNext');
    const splitSelectionBox = document.getElementById('splitSelectionBox');
    const mergeFileList = document.getElementById('mergeFileList');
    const deleteFileBtn = document.getElementById('deleteFile');
    const mergeNextBtn = document.getElementById('mergeNext');
    const pageNumberStart = document.getElementById('pageNumberStart');
    const pageNumberFromPage = document.getElementById('pageNumberFromPage');
    const pageNumberPosition = document.getElementById('pageNumberPosition');
	const pageNumberType = document.getElementById('pageNumberType'); 
    const pageNumberNextBtn = document.getElementById('pageNumberNext');
    const rotateThumbnails = document.getElementById('rotateThumbnails');
    let rotatePageBtn = document.getElementById('rotatePageBtn');
    let rotateNextBtn = document.getElementById('rotateNext');
    const tooltipModal = document.getElementById('tooltipModal');
    const tooltipTitle = document.getElementById('tooltipTitle');
    const tooltipContentArea = document.getElementById('tooltipContentArea');
    const tooltipOk = document.getElementById('tooltipOk');
    const fullScreenPreview = document.getElementById('fullScreenPreview');
    const previewImage = document.getElementById('previewImage');
    const previewPrevBtn = document.getElementById('previewPrev');
    const previewNextBtn = document.getElementById('previewNext');
	let currentRenderId = 0; 

    let currentMode = 'split';
    let loadedPDF = null;
    let splitPoints = [];
    let filesForMerge = [];
    let selectedFileIndex = -1;
    let fullScreenPDF = null;
    let fullScreenPage = 0;
    let rotateRotations = [];
    let selectedRotatePage = -1;
	let ocrSplitPoints = []; 
	let singleLoadedFile = null;
    let ocrWorker = null; 
    let originalOcrText = ""; 
    let puncToggles = { colon: false, comma: false, paren: false }; 
	
	// 建立 IntersectionObserver 用於延遲載入
	const thumbnailObserver = new IntersectionObserver((entries, observer) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				const container = entry.target;
				// 執行預先綁定的渲染函式
				if (container.renderFunction) {
					container.renderFunction();
					// 渲染後就不需要再觀察了，釋放資源
					container.renderFunction = null; 
				}
				observer.unobserve(container);
			}
		});
	}, {
		root: null, 
		rootMargin: '100px', // 預先載入視窗邊緣外 100px 的內容
		threshold: 0.01
	});

    const tooltipData = {
        split: {
            title: '裁切功能說明',
            content: `
                <p>匯入 PDF 後，您可以透過<strong class="text-green-500">圖像介面</strong>或<strong class="text-green-500">輸入框</strong>選擇裁切範圍，兩者會自動同步。</p>
                <p>點擊<strong class="text-green-500">綠色標記</strong>或在輸入框中輸入頁碼來選擇裁切點。</p>
                <p>當您選擇超過兩個裁切點時，系統會提示您選擇保留<strong class="text-blue-500">最前</strong>或<strong class="text-red-500">最後</strong>的裁切點。</p>
                <p><strong class="text-green-500">裁切點標記</strong>：</p>
                <ul class="list-disc list-inside">
                    <li>第一頁**前**的裁切點代表從第一頁開始。</li>
                    <li>最後一頁**後**的裁切點代表裁切到最後一頁。</li>
                </ul>
            `
        },
        merge: {
            title: '合成功能說明',
            content: `
                <p>您可以匯入<strong class="text-blue-500">多個</strong> PDF 檔案。</p>
                <p>透過**點擊**或**拖曳**清單來調整檔案順序。</p>
                <p>點擊清單中的檔案可展開<strong class="text-green-500">預覽</strong>。</p>
                <p>預覽圖支援**橫向滾動**，點擊可開啟**全螢幕預覽**。</p>
                <p>使用<strong class="text-green-500">鍵盤</strong>快捷鍵：</p>
                <ul class="list-disc list-inside">
                    <li>按 <strong class="text-red-500">Delete</strong> 鍵：刪除選取的檔案。</li>
                    <li>按 <strong class="text-blue-500">上/下箭頭</strong> 鍵：移動選取檔案的順序。</li>
                </ul>
            `
        },
        pageNumber: {
            title: '編頁碼功能說明',
            content: `
                <p>請匯入 PDF 檔案，然後設定編碼的**起始數字**、**起始頁碼**、**頁碼位置**及**頁碼呈現類型**。</p>
                <p>頁碼位置預設為<strong class="text-green-500">「同側」</strong>：不論頁碼編到哪一頁，都會固定在您選擇的起始位置。</p>
                <p>若選擇<strong class="text-blue-500">「交叉」</strong>：頁碼會從您指定的頁碼開始依序編寫，並在頁面左右<strong class="text-red-500">交替出現</strong>。</p>
                <p>例如：若起始位置設定為「左」，呈現類型為「交叉」，則第一組頁碼會出現在左下角，第二組會出現在右下角，依此類推。</p>
            `
        },
        rotate: {
            title: '旋轉功能說明',
            content: `
                <p>請匯入 PDF 檔案，然後點擊頁面縮圖來選取。</p>
                <p>點擊<strong class="text-green-500">「旋轉」</strong>按鈕或按下鍵盤 **<strong class="text-red-500">R</strong>** 鍵**，即可將選取的頁面順時針旋轉 90 度。</p>
                <p>您可以重複操作來達到所需的旋轉角度。</p>
            `
        },
		ocr: {
            title: '文字辨識功能 (OCR) 說明',
            content: `
                <p>匯入 PDF 後，您可以透過<strong class="text-green-500">圖像介面</strong>或<strong class="text-green-500">輸入框</strong>選擇辨識的<strong class="text-blue-500">頁碼區間</strong>。</p>
                <p>此功能會使用 Tesseract.js 引擎來辨識頁面上的<strong class="text-green-500">繁體中文</strong>與<strong class="text-green-500">英文</strong>。</p>
                <p>辨識完成後，您可以使用<strong class="text-orange-500">「標點符號改為全型」</strong>功能，將半型標點轉換為全型。</p>
                <p>辨識需要一些時間，請耐心等候。辨識結果將顯示在下方的文字框中。</p>
                <p><strong class="text-red-500">注意：</strong>辨識複雜排版或低解析度圖片時，準確度可能會下降。</p>
            `
        }
    };

    // 顯示訊息框
    function showMessage(text) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
    }

    messageOk.addEventListener('click', () => {
        messageBox.classList.add('hidden');
    });

    // 顯示提示彈窗
    function showTooltip(mode) {
        const data = tooltipData[mode];
        if (data) {
            tooltipTitle.textContent = data.title;
            tooltipContentArea.innerHTML = data.content;
            tooltipModal.classList.remove('hidden');
        }
    }

    // 關閉提示彈窗
    tooltipOk.addEventListener('click', () => {
        tooltipModal.classList.add('hidden');
    });

    // 處理提示圖示點擊事件
    document.querySelectorAll('.info-tooltip-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            const mode = icon.dataset.tooltip;
            showTooltip(mode);
        });
    });

    // 切換頁籤
    tabs.forEach(tab => {
        tab.addEventListener('click', async () => {
            if (ocrWorker && currentMode === 'ocr' && tab.id !== 'tabOcr') {
                console.log('Terminating OCR worker...');
                await ocrWorker.terminate();
                ocrWorker = null;
                const ocrStatus = document.getElementById('ocrStatus');
                if (ocrStatus) {
                    ocrStatus.classList.add('hidden');
                    ocrStatus.textContent = '';
                }
				ocrSplitPoints = [];
            }
			
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            sections.forEach(s => s.classList.add('hidden'));
            const sectionId = `section${tab.id.replace('tab', '')}`;
            document.getElementById(sectionId).classList.remove('hidden');
            currentMode = tab.id.replace('tab', '').toLowerCase();
            fileStatus.textContent = '支援 .pdf 格式';
            fileInput.value = '';
			singleLoadedFile = null;
			
			if (currentMode === 'merge') {
                fileInput.multiple = true;
            } else {
                fileInput.multiple = false;
            }
            
            if (currentMode === 'pagenumber') {
                pageNumberNextBtn.disabled = loadedPDF === null;
            } else if (currentMode === 'merge') {
                mergeNextBtn.disabled = filesForMerge.length === 0;
            } else if (currentMode === 'split') {
                splitNextBtn.disabled = loadedPDF === null || splitPoints.length !== 2;
            } else if (currentMode === 'rotate') {
                rotateNextBtn.disabled = loadedPDF === null;
            } else if (currentMode === 'ocr') {
                const ocrBtn = document.getElementById('ocrStartBtn');
                if (ocrBtn) ocrBtn.disabled = loadedPDF === null;
                
                const ocrThumbs = document.getElementById('ocrThumbnails');
                if (ocrThumbs) ocrThumbs.innerHTML = ''; 
                ocrSplitPoints = []; // 修改此行
                document.getElementById('ocrResultTools').classList.add('hidden');
            }
        });
    });

	// ==================== 裁切功能 ====================
    async function processFiles(files) {
        if (!files.length) {
            fileStatus.textContent = '支援 .pdf 格式';
            return;
        }
		
		currentRenderId++;
        
        if (currentMode === 'split' || currentMode === 'pagenumber' || currentMode === 'rotate' || currentMode === 'ocr') {
            if (files.length > 1) {
                showMessage('此功能一次只能處理一個PDF檔案。');
                fileInput.value = '';
                singleLoadedFile = null; 
                return;
            }
            
            singleLoadedFile = files[0]; 
            loadedPDF = null;
            const arrayBuffer = await singleLoadedFile.arrayBuffer(); 
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            loadedPDF = pdfDoc;
            fileStatus.textContent = `已載入檔案：${singleLoadedFile.name}`; 
            
            if (currentMode === 'split') {
                splitPoints = [];
                await renderSplitThumbnails(pdfDoc);
                updateSplitUI();
            } else if (currentMode === 'pagenumber') {
                pageNumberNextBtn.disabled = false;
                pageNumberFromPage.placeholder = `1 - ${loadedPDF.numPages}`;
            } else if (currentMode === 'rotate') {
                rotateRotations = Array(loadedPDF.numPages).fill(0);

                const rotateActionArea = document.getElementById('rotateAction');
                rotateActionArea.innerHTML = `
                    <button id="rotateNext" class="btn btn-blue btn-lg" disabled>下一步</button>
                `;

                rotateNextBtn = document.getElementById('rotateNext');
                rotateNextBtn.addEventListener('click', () => {
                    const actionArea = document.getElementById('rotateNext').parentNode;
                    actionArea.innerHTML = `
                        <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                            <div class="flex items-center space-x-2">
                                <label class="font-medium text-gray-700">檔案名稱:</label>
                                <input type="text" id="rotateFilename" class="form-input" value="旋轉-${formatDate(new Date())}">
                            </div>
                            <button id="exportRotate" class="btn btn-green w-full md:w-auto">匯出檔案</button>
                        </div>
                    `;
                    document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
                });

                await renderRotateThumbnails(pdfDoc);
                rotateNextBtn.disabled = false;
                
                // 因為 rotatePageBtn 已經在外部，所以它會保留，我們只需要更新它的狀態
                rotatePageBtn.disabled = true;
            
            } else if (currentMode === 'ocr') {
				ocrSplitPoints = [];
                await renderOcrThumbnails(pdfDoc);
                updateOcrUI();
				document.getElementById('ocrResultText').value = '';
                document.getElementById('ocrStatus').classList.add('hidden');
                document.getElementById('ocrResultTools').classList.add('hidden');
            }

        } else if (currentMode === 'merge') {
            await handleMergeFiles(files);
            fileStatus.textContent = `已載入 ${files.length} 個檔案。`;
        } else {
            showMessage('請選擇頁籤來匯入檔案。');
            fileInput.value = '';
            singleLoadedFile = null; 
        }
    }
	
    fileInput.addEventListener('change', async (event) => {
        await processFiles(event.target.files); 
    });
	
	const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (event) => {
        event.preventDefault(); 
        dropZone.classList.add('border-blue-500', 'bg-blue-50'); 
    });

    dropZone.addEventListener('dragleave', (event) => {
        event.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50'); 
    });

    dropZone.addEventListener('drop', async (event) => {
        event.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50'); 
        const files = event.dataTransfer.files;   
        fileInput.value = '';
        await processFiles(files);
    });

	async function renderSplitThumbnails(pdfDoc) {
		splitThumbnails.innerHTML = '';
		const numPages = pdfDoc.numPages;
		
		const thisRenderId = currentRenderId;

		const cutMarkerStart = document.createElement('div');
		cutMarkerStart.className = 'cut-marker';
		cutMarkerStart.dataset.page = 0;
		cutMarkerStart.addEventListener('click', () => toggleSplitPoint(0));
		splitThumbnails.appendChild(cutMarkerStart);

		for (let i = 1; i <= numPages; i++) {
			if (thisRenderId !== currentRenderId) return;
			
			// 建立容器
			const thumbWrapper = document.createElement('div');
			thumbWrapper.className = 'thumb-wrapper';
			// 設定固定高度或最小高度，確保卷軸能正確產生，這對 Lazy Load 很重要
			thumbWrapper.style.minHeight = '150px'; 
			thumbWrapper.style.minWidth = '120px';
			thumbWrapper.style.display = 'flex';
			thumbWrapper.style.flexDirection = 'column';
			thumbWrapper.style.alignItems = 'center';
			thumbWrapper.style.justifyContent = 'center';

			const pageNum = document.createElement('div');
			pageNum.textContent = i;
			pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
			
			// 定義渲染邏輯，但不立即執行
			thumbWrapper.renderFunction = async () => {
				if (thisRenderId !== currentRenderId) return; // 再次檢查 ID 防止非同步衝突
				try {
					const page = await pdfDoc.getPage(i);
					const viewport = page.getViewport({ scale: 0.3 });
					const canvas = document.createElement('canvas');
					canvas.width = viewport.width;
					canvas.height = viewport.height;
					const context = canvas.getContext('2d');
					
					// 點擊預覽
					canvas.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));
					
					// 渲染
					await page.render({ canvasContext: context, viewport: viewport }).promise;
					
					// 將 canvas 插入 wrapper 最前面
					thumbWrapper.prepend(canvas);
					
					// 移除最小寬高限制，讓內容撐開
					thumbWrapper.style.minHeight = '';
					thumbWrapper.style.minWidth = '';
				} catch (e) {
					console.error(`Page ${i} render error`, e);
				}
			};

			thumbWrapper.appendChild(pageNum);
			splitThumbnails.appendChild(thumbWrapper);
			
			// 加入觀察清單
			thumbnailObserver.observe(thumbWrapper);

			if (i < numPages) {
				const cutMarker = document.createElement('div');
				cutMarker.className = 'cut-marker';
				cutMarker.dataset.page = i;
				cutMarker.addEventListener('click', () => toggleSplitPoint(parseInt(cutMarker.dataset.page)));
				splitThumbnails.appendChild(cutMarker);
			}
		}

		const cutMarkerEnd = document.createElement('div');
		cutMarkerEnd.className = 'cut-marker';
		cutMarkerEnd.dataset.page = numPages;
		cutMarkerEnd.addEventListener('click', () => toggleSplitPoint(numPages));
		splitThumbnails.appendChild(cutMarkerEnd);
	}

    function toggleSplitPoint(page) {
        const index = splitPoints.indexOf(page);
        if (index > -1) {
            splitPoints.splice(index, 1);
        } else {
            if (splitPoints.length >= 2) {
                splitSelectionBox.classList.remove('hidden');
                document.getElementById('selectFirst').onclick = () => {
                    splitPoints.shift();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectLast').onclick = () => {
                    splitPoints.pop();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectCancel').onclick = () => {
                    splitSelectionBox.classList.add('hidden');
                };
                return;
            }
            splitPoints.push(page);
            splitPoints.sort((a, b) => a - b);
        }
        updateSplitUI();
    }

    function updateSplitUI() {
        const cutMarkers = document.querySelectorAll('.cut-marker');
        cutMarkers.forEach(marker => {
            const page = parseInt(marker.dataset.page);
            if (splitPoints.includes(page)) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });

        if (splitPoints.length === 2) {
            splitStartPage.value = splitPoints[0] + 1;
            splitEndPage.value = splitPoints[1];
        } else {
            splitStartPage.value = '';
            splitEndPage.value = '';
        }
        splitNextBtn.disabled = splitPoints.length !== 2;
    }
    
    splitStartPage.addEventListener('input', updateSplitPointsFromText);
    splitEndPage.addEventListener('input', updateSplitPointsFromText);

    function updateSplitPointsFromText() {
        if (!loadedPDF) {
            showMessage('請先匯入 PDF 檔案。');
            splitStartPage.value = '';
            splitEndPage.value = '';
            splitNextBtn.disabled = true;
            return;
        }

        const start = parseInt(splitStartPage.value);
        const end = parseInt(splitEndPage.value);
        const numPages = loadedPDF.numPages;

        splitPoints = [];

        if (isNaN(start) || start < 1 || start > numPages) {
            splitNextBtn.disabled = true;
            return;
        }
        if (isNaN(end) || end < 1 || end > numPages) {
            splitNextBtn.disabled = true;
            return;
        }
        if (start > end) {
            showMessage('結束頁碼不能小於起始頁碼。');
            splitNextBtn.disabled = true;
            return;
        }
        splitPoints.push(start - 1);
        splitPoints.push(end);
        updateSplitUI();
    }

    splitNextBtn.addEventListener('click', async () => {
        const file = singleLoadedFile;
        if (!file || splitPoints.length !== 2) {
            showMessage('請匯入PDF檔案並選擇2個裁切點。');
            return;
        }

        const startPage = splitPoints[0] + 1;
        const endPage = splitPoints[1];

        if (startPage > endPage) {
            showMessage('起始頁碼不能大於結束頁碼。');
            return;
        }

        const actionArea = document.getElementById('splitAction');
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">檔案名稱:</label>
                    <input type="text" id="splitFilename" class="form-input" value="分割-${formatDate(new Date())}">
                </div>
                <button id="exportSplit" class="btn btn-green w-full md:w-auto">匯出檔案</button>
            </div>
        `;

        document.getElementById('exportSplit').onclick = async () => {
            try {
                const fileToUse = singleLoadedFile;
				if (!fileToUse) {
					showMessage('找不到已載入的檔案，請重新匯入 PDF。');
					return;
				}

				let startPage, endPage;
				if (Array.isArray(splitPoints) && splitPoints.length === 2) {
					startPage = splitPoints[0] + 1;
					endPage = splitPoints[1];
				} else {
					startPage = parseInt(splitStartPage.value, 10);
					endPage = parseInt(splitEndPage.value, 10);
				}

				if (isNaN(startPage) || isNaN(endPage)) {
					showMessage('請選擇或輸入有效的起始與結束頁碼。');
					return;
				}
				if (startPage > endPage) {
					showMessage('起始頁碼不能大於結束頁碼。');
					return;
				}
			
				const pdfBytes = await fileToUse.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const newPdfDoc = await PDFLib.PDFDocument.create();
                const pagesToKeep = Array.from({ length: endPage - startPage + 1 }, (_, i) => i + startPage - 1);
                const pages = await newPdfDoc.copyPages(pdfDoc, pagesToKeep);
                pages.forEach(page => newPdfDoc.addPage(page));
                const newPdfBytes = await newPdfDoc.save();
                const filename = document.getElementById('splitFilename').value;
                downloadPDF(newPdfBytes, filename);
                showMessage('PDF 裁切並匯出成功！');
            } catch (error) {
                console.error('Error splitting PDF:', error);
                showMessage('PDF 裁切時發生錯誤。');
            }
        };
    });

    // ==================== 合成功能 ====================
    async function handleMergeFiles(files) {
        for (const file of files) {
            filesForMerge.push(file);
        }
        renderMergeFileList();
        mergeNextBtn.disabled = filesForMerge.length === 0;
    }

    function renderMergeFileList() {
        mergeFileList.innerHTML = '';
        if (filesForMerge.length === 0) {
            mergeFileList.innerHTML = '<li class="text-gray-400 text-center py-4">請匯入 PDF 檔案以進行合成</li>';
            deleteFileBtn.disabled = true;
            mergeNextBtn.disabled = true;
            return;
        }

        filesForMerge.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'sortable-item';
            li.draggable = true;
            li.dataset.index = index;
			li.style.position = 'relative';
			
			const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = '移除此檔案';
            
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                filesForMerge.splice(index, 1);
                
                if (selectedFileIndex === index) {
                    selectedFileIndex = -1;
                } else if (selectedFileIndex > index) {
                    selectedFileIndex--;
                }
                
                renderMergeFileList();
            });
            
            li.appendChild(removeBtn);

            const fileHeader = document.createElement('div');
            fileHeader.className = 'flex items-center justify-between mb-2';

            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            
            const orderNumber = document.createElement('div');
            orderNumber.className = 'flex items-center justify-center font-bold text-lg mr-4 flex-shrink-0';
            
            orderNumber.style.backgroundColor = 'var(--primary)';
            orderNumber.style.color = 'white';
            orderNumber.style.width = '2rem';
            orderNumber.style.height = '2rem';
            orderNumber.style.borderRadius = '6px';
            
            orderNumber.textContent = index + 1;
            const fileNameSpan = document.createElement('span');
            fileNameSpan.textContent = file.name;
            fileInfo.appendChild(orderNumber);
            fileInfo.appendChild(fileNameSpan);

            fileHeader.appendChild(fileInfo);
            li.appendChild(fileHeader);
            
            const previewContainer = document.createElement('div');
            previewContainer.className = 'thumb-container hidden';
            li.appendChild(previewContainer);

            li.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', index); });
            li.addEventListener('dragover', (e) => e.preventDefault());
            li.addEventListener('drop', (e) => {
                 e.preventDefault();
                 const fromIndex = e.dataTransfer.getData('text/plain');
                 const toIndex = index;
                 const fileToMove = filesForMerge.splice(fromIndex, 1)[0];
                 filesForMerge.splice(toIndex, 0, fileToMove);
                 renderMergeFileList();
            });

            li.addEventListener('click', async (event) => {
                event.stopPropagation();
                const isSelected = li.classList.contains('ring-2');

                document.querySelectorAll('.sortable-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-blue-500');
                    const container = item.querySelector('.thumb-container');
                    if (container) {
                        container.classList.add('hidden');
                    }
                });
                
                if (!isSelected) {
                    li.classList.add('ring-2', 'ring-blue-500');
                    selectedFileIndex = index;
                    deleteFileBtn.disabled = false;
                    renderPreviewThumbnails(file, previewContainer);
                    previewContainer.classList.remove('hidden');
                } else {
                    selectedFileIndex = -1;
                    deleteFileBtn.disabled = true;
                }
            });
            mergeFileList.appendChild(li);
        });
        
        if (selectedFileIndex !== -1 && filesForMerge.length > 0) {
             document.querySelectorAll('.sortable-item')[selectedFileIndex].classList.add('ring-2', 'ring-blue-500');
        } else {
             selectedFileIndex = -1;
             deleteFileBtn.disabled = true;
        }
    }

	async function renderPreviewThumbnails(file, container) {
		currentRenderId++;
		const thisRenderId = currentRenderId;
		container.innerHTML = '';
		
		try {
			const arrayBuffer = await file.arrayBuffer();
			const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
			
			// 原本限制 5 頁，現在因為有效能優化，您可以考慮放寬，
			// 但為了保持介面簡潔，維持 5 頁或適度增加皆可。
			const maxPreviewPages = 5; 
			const numPagesToPreview = Math.min(pdfDoc.numPages, maxPreviewPages);

			for (let i = 1; i <= numPagesToPreview; i++) {
				if (thisRenderId !== currentRenderId) return;

				const thumbWrapper = document.createElement('div');
				thumbWrapper.style.flexShrink = '0';
				thumbWrapper.style.padding = '0.5rem';
				thumbWrapper.style.border = '1px solid var(--gray-200)';
				thumbWrapper.style.borderRadius = 'var(--radius-md)';
				thumbWrapper.style.cursor = 'pointer';
				thumbWrapper.style.transition = 'background-color 0.2s';
				thumbWrapper.style.width = '120px'; 
				thumbWrapper.style.height = '160px';
				thumbWrapper.style.display = 'flex';
				thumbWrapper.style.flexDirection = 'column';
				thumbWrapper.style.alignItems = 'center';
				thumbWrapper.style.justifyContent = 'center';

				thumbWrapper.onmouseover = function() { this.style.backgroundColor = 'var(--gray-100)'; };
				thumbWrapper.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

				const pageNum = document.createElement('div');
				pageNum.textContent = `頁碼 ${i}`;
				pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';

				// 延遲渲染邏輯
				thumbWrapper.renderFunction = async () => {
					if (thisRenderId !== currentRenderId) return;
					try {
						const page = await pdfDoc.getPage(i);
						const targetScale = 0.2;
						const viewport = page.getViewport({ scale: targetScale });
						const canvas = document.createElement('canvas');
						canvas.width = viewport.width;
						canvas.height = viewport.height;
						
						const ctx = canvas.getContext('2d');
						await page.render({ canvasContext: ctx, viewport: viewport }).promise;
						
						// 點擊事件
						thumbWrapper.addEventListener('click', (e) => {
							e.stopPropagation(); 
							showFullScreenPreview(pdfDoc, i);
						});
						
						// 插入 canvas (放在 pageNum 之前)
						thumbWrapper.insertBefore(canvas, pageNum);
						
						// 移除佔位樣式
						thumbWrapper.style.width = '';
						thumbWrapper.style.height = '';
					} catch(e) { console.error(e); }
				};

				thumbWrapper.appendChild(pageNum);
				container.appendChild(thumbWrapper);
				
				// 加入觀察
				thumbnailObserver.observe(thumbWrapper);
			}

			if (pdfDoc.numPages > numPagesToPreview) {
				const moreInfo = document.createElement('div');
				moreInfo.className = 'flex items-center justify-center p-2 text-sm text-gray-500';
				moreInfo.textContent = `(尚有 ${pdfDoc.numPages - numPagesToPreview} 頁)`;
				container.appendChild(moreInfo);
			}

		} catch (error) {
			console.error('Error loading PDF for preview:', error);
			if (container.children.length === 0) {
				 showMessage('預覽檔案時發生錯誤。');
			}
		}
	}

    async function drawPageAsync(page, canvas, targetViewport, renderId) {
        try {
            // 如果發現控制台印出 "Render ID is NaN"，請檢查變數宣告
            if (Number.isNaN(renderId)) {
                console.warn('Render ID is NaN! 請檢查 let currentRenderId = 0;');
            }

            const ctx = canvas.getContext('2d');

            // 極速渲染 (模糊版)
            const lowResScale = targetViewport.scale / 5; 
            const lowResViewport = page.getViewport({ scale: lowResScale });
            
            canvas.width = lowResViewport.width;
            canvas.height = lowResViewport.height;

            await page.render({ canvasContext: ctx, viewport: lowResViewport }).promise;
            
            // 延遲後渲染清晰版
            setTimeout(async () => {
                // 檢查：如果 renderId 有值且與當前 ID 不符，才停止
                // (這裡加上防呆：如果 renderId 是無效的，我們選擇繼續畫，避免永遠模糊)
                if (renderId !== undefined && !Number.isNaN(renderId) && renderId !== currentRenderId) {
                    return;
                }

                // 重設尺寸 (這會清空畫布)
                canvas.width = targetViewport.width;
                canvas.height = targetViewport.height;
                
                // 渲染清晰圖
                await page.render({ canvasContext: ctx, viewport: targetViewport }).promise;
                
                // 移除模糊濾鏡
                canvas.classList.add('loaded');
            }, 50);

        } catch (err) {
            console.warn('Page render error:', err);
        }
    }

    // 刪除檔案
    deleteFileBtn.addEventListener('click', () => {
        if (selectedFileIndex !== -1) {
            filesForMerge.splice(selectedFileIndex, 1);
            selectedFileIndex = -1;
            renderMergeFileList();
        }
    });

    mergeNextBtn.addEventListener('click', async () => {
        if (filesForMerge.length === 0) {
            showMessage('請匯入至少一個檔案進行合成。');
            return;
        }

        const actionArea = document.getElementById('mergeNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">檔案名稱:</label>
                    <input type="text" id="mergeFilename" class="form-input" value="合成-${formatDate(new Date())}">
                </div>
                <div id="mergeProgress" class="text-sm text-blue-600 font-medium hidden">準備中...</div>
                <button id="exportMerge" class="btn btn-green w-full md:w-auto">匯出檔案</button>
            </div>
        `;

        document.getElementById('exportMerge').addEventListener('click', async () => {
            const btn = document.getElementById('exportMerge');
            const progressDiv = document.getElementById('mergeProgress');
            const filename = document.getElementById('mergeFilename').value;
            
            // 鎖定按鈕並顯示進度
            btn.disabled = true;
            btn.textContent = '處理中...';
            progressDiv.classList.remove('hidden');

            try {
                const mergedPdf = await PDFLib.PDFDocument.create();
                
                for (let i = 0; i < filesForMerge.length; i++) {
                    const file = filesForMerge[i];
                    
                    progressDiv.textContent = `正在處理第 ${i + 1} / ${filesForMerge.length} 個檔案：${file.name}`;
                    
                    await new Promise(resolve => setTimeout(resolve, 10));

                    const pdfBytes = await file.arrayBuffer();
                    const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                    const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }
                
                progressDiv.textContent = '正在儲存檔案...';
                await new Promise(resolve => setTimeout(resolve, 10)); 

                const mergedPdfBytes = await mergedPdf.save();
                downloadPDF(mergedPdfBytes, filename);
                
                showMessage('PDF 合成並匯出成功！');
            } catch (error) {
                console.error('Error merging PDFs:', error);
                showMessage('PDF 合成時發生錯誤。');
            } finally {
                // 恢復按鈕狀態
                btn.disabled = false;
                btn.textContent = '匯出檔案';
                progressDiv.classList.add('hidden');
            }
        });
    });
    
    // ==================== 編頁碼功能 ====================
    // 當檔案載入後，才啟用「下一步」按鈕
    fileInput.addEventListener('change', () => {
        if (currentMode === 'pagenumber' && fileInput.files.length > 0) {
            pageNumberNextBtn.disabled = false;
        } else if (currentMode === 'pagenumber') {
            pageNumberNextBtn.disabled = true;
        }
    });

    pageNumberNextBtn.addEventListener('click', () => {
        if (!loadedPDF) {
            showMessage('請先匯入PDF檔案。');
            return;
        }
        const actionArea = document.getElementById('pageNumberNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">檔案名稱:</label>
                    <input type="text" id="pageNumberFilename" class="form-input" value="頁碼-${formatDate(new Date())}">
                </div>
                <button id="exportPageNumber" class="btn btn-green w-full md:w-auto">匯出檔案</button>
            </div>
        `;
        document.getElementById('exportPageNumber').addEventListener('click', handlePageNumberExport);
    });

    async function handlePageNumberExport() {
        if (!loadedPDF || !singleLoadedFile) { 
            showMessage('請先匯入PDF檔案。');
            return;
        }
        const startNumber = parseInt(pageNumberStart.value) || 1;
        const fromPage = parseInt(pageNumberFromPage.value);
        const position = pageNumberPosition.value;
		const type = pageNumberType.value; 
        const filename = document.getElementById('pageNumberFilename').value;

        if (isNaN(fromPage) || fromPage < 1 || fromPage > loadedPDF.numPages) {
            showMessage('請輸入有效的起始頁碼。');
            return;
        }

        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await singleLoadedFile.arrayBuffer());
            const pages = pdfDoc.getPages();
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            
            const startPageIndex = fromPage - 1;

            for (let i = startPageIndex; i < pages.length; i++) {
                const page = pages[i];
                const { width, height } = page.getSize();
                const pageNum = startNumber + (i - startPageIndex);
                const text = pageNum.toString();
                const textSize = 18;
                const textWidth = font.widthOfTextAtSize(text, textSize);
                const margin = 30;
                let xPosition;
				
				if (type === 'same') {
					// 「同側」：固定在起始位置
					xPosition = (position === 'left') ? margin : width - textWidth - margin;
				} else {
					// 「交叉」：交替出現 (奇數頁/偶數頁決定)
					const isOddPage = (pageNum % 2 !== 0);
					
					if (position === 'left') {
						// Start on left, then alternate (Odd=Left, Even=Right)
						xPosition = isOddPage ? margin : width - textWidth - margin;
					} else {
						// Start on right, then alternate (Odd=Right, Even=Left)
						xPosition = isOddPage ? width - textWidth - margin : margin;
					}
				}

                page.drawText(text, {
                    x: xPosition,
                    y: margin,
                    size: textSize,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('頁碼編寫並匯出成功！');

        } catch (error) {
            console.error('Error adding page numbers:', error);
            showMessage('頁碼編寫時發生錯誤。');
        }
    }
    
    // ==================== 旋轉功能 ====================
	async function renderRotateThumbnails(pdfDoc) {
		rotateThumbnails.innerHTML = '';
		const numPages = pdfDoc.numPages;
		const thisRenderId = currentRenderId;
		
		for (let i = 1; i <= numPages; i++) {
			if (thisRenderId !== currentRenderId) return;

			const thumbWrapper = document.createElement('div');
			thumbWrapper.className = `thumb-wrapper`;
			thumbWrapper.style.cursor = 'pointer';
			thumbWrapper.style.minHeight = '150px';
			thumbWrapper.style.minWidth = '120px';
			thumbWrapper.style.display = 'flex';
			thumbWrapper.style.flexDirection = 'column';
			thumbWrapper.style.alignItems = 'center';
			
			thumbWrapper.onmouseover = function() { this.style.backgroundColor = 'var(--gray-100)'; };
			thumbWrapper.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

			thumbWrapper.dataset.page = i - 1;
			const pageNum = document.createElement('div');
			pageNum.textContent = i;
			pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
			
			// 延遲渲染邏輯
			thumbWrapper.renderFunction = async () => {
				if (thisRenderId !== currentRenderId) return;
				try {
					const page = await pdfDoc.getPage(i);
					const viewport = page.getViewport({ scale: 0.3, rotation: rotateRotations[i - 1] });
					const canvas = document.createElement('canvas');
					canvas.width = viewport.width;
					canvas.height = viewport.height;
					const context = canvas.getContext('2d');
					await page.render({ canvasContext: context, viewport: viewport }).promise;
					
					thumbWrapper.prepend(canvas);
					thumbWrapper.style.minHeight = '';
					thumbWrapper.style.minWidth = '';
				} catch (e) {
					console.error(e);
				}
			};

			thumbWrapper.appendChild(pageNum);
			rotateThumbnails.appendChild(thumbWrapper);

			// 綁定點擊事件 (選取頁面)
			thumbWrapper.addEventListener('click', () => {
				document.querySelectorAll('#rotateThumbnails .selected-thumbnail').forEach(t => t.classList.remove('selected-thumbnail'));
				thumbWrapper.classList.add('selected-thumbnail');
				selectedRotatePage = i - 1;
				rotatePageBtn.disabled = false;
			});

			// 加入觀察
			thumbnailObserver.observe(thumbWrapper);
		}
		
		// 如果有已選取的頁面，重新標記
		if (selectedRotatePage !== -1) {
			// 這裡需要稍微延遲或等待 DOM 更新，簡單處理即可
			setTimeout(() => {
				const currentSelectedThumb = document.querySelector(`[data-page="${selectedRotatePage}"]`);
				if (currentSelectedThumb) {
					currentSelectedThumb.classList.add('selected-thumbnail');
				}
			}, 100);
		}
	}

    rotatePageBtn.addEventListener('click', async () => {
        if (selectedRotatePage === -1) {
            showMessage('請先選擇要旋轉的頁面。');
            return;
        }
        
        // 更新旋轉角度
        rotateRotations[selectedRotatePage] = (rotateRotations[selectedRotatePage] + 90) % 360;

        // 找到當前被選中的縮圖包裝 (父元素)
        const thumbWrapper = document.querySelector(`#rotateThumbnails .selected-thumbnail`);
        
        if (!thumbWrapper || thumbWrapper.dataset.page != selectedRotatePage) {
            console.warn('Selected thumbnail sync issue, falling back to full render.');
            await renderRotateThumbnails(loadedPDF);
            return;
        }

        const oldCanvas = thumbWrapper.querySelector('canvas');
        if (!oldCanvas) {
            console.error('No canvas found in selected thumbnail.');
            await renderRotateThumbnails(loadedPDF); // Fallback
            return;
        }

        try {
            const pageNum = selectedRotatePage + 1;
            const page = await loadedPDF.getPage(pageNum);
            const newRotation = rotateRotations[selectedRotatePage];
            const viewport = page.getViewport({ scale: 0.3, rotation: newRotation });
            const newCanvas = document.createElement('canvas');
			
            newCanvas.width = viewport.width;
            newCanvas.height = viewport.height;
            
            const context = newCanvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            
            await page.render(renderContext).promise;

            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);

        } catch (error) {
            console.error('Error re-rendering single rotated thumbnail:', error);
            await renderRotateThumbnails(loadedPDF);
        }
    });

    rotateNextBtn.addEventListener('click', () => {
        const actionArea = document.getElementById('rotateNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">檔案名稱:</label>
                    <input type="text" id="rotateFilename" class="form-input" value="旋轉-${formatDate(new Date())}">
                </div>
                <button id="exportRotate" class="btn btn-green w-full md:w-auto">匯出檔案</button>
            </div>
        `;
        document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
    });

    async function handleRotateExport() {
        if (!loadedPDF || !singleLoadedFile) {
            showMessage('請先匯入PDF檔案。');
            return;
        }

        const filename = document.getElementById('rotateFilename').value;
        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await singleLoadedFile.arrayBuffer());
            const pages = pdfDoc.getPages();
            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                if (rotateRotations[i] !== 0) {
                    const existingRotation = page.getRotation();
                    const newRotation = (existingRotation.angle + rotateRotations[i]) % 360;
                    page.setRotation(PDFLib.degrees(newRotation));
                }
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('PDF 旋轉並匯出成功！');

        } catch (error) {
            console.error('Error rotating PDF:', error);
            showMessage('PDF 旋轉時發生錯誤。');
        }
    }
	
	// ==================== OCR 縮圖渲染 ====================
	async function renderOcrThumbnails(pdfDoc) {
		const ocrThumbnails = document.getElementById('ocrThumbnails');
		ocrThumbnails.innerHTML = '';
		const numPages = pdfDoc.numPages;
		const thisRenderId = currentRenderId;

		const cutMarkerStart = document.createElement('div');
		cutMarkerStart.className = 'cut-marker';
		cutMarkerStart.dataset.page = 0;
		cutMarkerStart.addEventListener('click', () => toggleOcrSplitPoint(0));
		ocrThumbnails.appendChild(cutMarkerStart);

		for (let i = 1; i <= numPages; i++) {
			if (thisRenderId !== currentRenderId) return;
			
			const thumbWrapper = document.createElement('div');
			thumbWrapper.className = 'thumb-wrapper';
			thumbWrapper.style.minHeight = '150px';
			thumbWrapper.style.minWidth = '120px';
			thumbWrapper.style.display = 'flex';
			thumbWrapper.style.flexDirection = 'column';
			thumbWrapper.style.alignItems = 'center';

			const pageNum = document.createElement('div');
			pageNum.textContent = i;
			pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
			
			// 延遲渲染邏輯
			thumbWrapper.renderFunction = async () => {
				if (thisRenderId !== currentRenderId) return;
				try {
					const page = await pdfDoc.getPage(i);
					const viewport = page.getViewport({ scale: 0.3 });
					const canvas = document.createElement('canvas');
					canvas.width = viewport.width;
					canvas.height = viewport.height;
					const context = canvas.getContext('2d');
					
					canvas.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));
					
					await page.render({ canvasContext: context, viewport: viewport }).promise;
					
					thumbWrapper.prepend(canvas);
					thumbWrapper.style.minHeight = '';
					thumbWrapper.style.minWidth = '';
				} catch (e) { console.error(e); }
			};
			
			thumbWrapper.appendChild(pageNum);
			ocrThumbnails.appendChild(thumbWrapper);
			
			// 加入觀察
			thumbnailObserver.observe(thumbWrapper);

			if (i < numPages) {
				const cutMarker = document.createElement('div');
				cutMarker.className = 'cut-marker';
				cutMarker.dataset.page = i;
				cutMarker.addEventListener('click', () => toggleOcrSplitPoint(parseInt(cutMarker.dataset.page)));
				ocrThumbnails.appendChild(cutMarker);
			}
		}

		const cutMarkerEnd = document.createElement('div');
		cutMarkerEnd.className = 'cut-marker';
		cutMarkerEnd.dataset.page = numPages;
		cutMarkerEnd.addEventListener('click', () => toggleOcrSplitPoint(numPages));
		ocrThumbnails.appendChild(cutMarkerEnd);
		
		updateOcrUI();
	}

    function toggleOcrSplitPoint(page) {
        const index = ocrSplitPoints.indexOf(page);
        if (index > -1) {
            ocrSplitPoints.splice(index, 1);
        } else {
            if (ocrSplitPoints.length >= 2) {
                splitSelectionBox.classList.remove('hidden');
                document.getElementById('selectFirst').onclick = () => {
                    ocrSplitPoints.shift();
                    ocrSplitPoints.push(page);
                    ocrSplitPoints.sort((a, b) => a - b);
                    updateOcrUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectLast').onclick = () => {
                    ocrSplitPoints.pop();
                    ocrSplitPoints.push(page);
                    ocrSplitPoints.sort((a, b) => a - b);
                    updateOcrUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectCancel').onclick = () => {
                    splitSelectionBox.classList.add('hidden');
                };
                return;
            }
            ocrSplitPoints.push(page);
            ocrSplitPoints.sort((a, b) => a - b);
        }
        updateOcrUI();
    }

    function updateOcrUI() {
        const ocrStartPage = document.getElementById('ocrStartPage');
        const ocrEndPage = document.getElementById('ocrEndPage');
        const ocrStartBtn = document.getElementById('ocrStartBtn');
        
        const cutMarkers = document.querySelectorAll('#ocrThumbnails .cut-marker');
        cutMarkers.forEach(marker => {
            const page = parseInt(marker.dataset.page);
            if (ocrSplitPoints.includes(page)) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });

        if (ocrSplitPoints.length === 2) {
            ocrStartPage.value = ocrSplitPoints[0] + 1;
            ocrEndPage.value = ocrSplitPoints[1];
        } else {
            ocrStartPage.value = '';
            ocrEndPage.value = '';
        }

        ocrStartBtn.disabled = ocrSplitPoints.length !== 2;
    }
    
    // 綁定文字輸入框
    document.getElementById('ocrStartPage').addEventListener('input', updateOcrSplitPointsFromText);
    document.getElementById('ocrEndPage').addEventListener('input', updateOcrSplitPointsFromText);

    function updateOcrSplitPointsFromText() {
        if (!loadedPDF) {
            showMessage('請先匯入 PDF 檔案。');
            document.getElementById('ocrStartPage').value = '';
            document.getElementById('ocrEndPage').value = '';
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }

        const start = parseInt(document.getElementById('ocrStartPage').value);
        const end = parseInt(document.getElementById('ocrEndPage').value);
        const numPages = loadedPDF.numPages;

        ocrSplitPoints = [];

        if (isNaN(start) || start < 1 || start > numPages) {
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }
        if (isNaN(end) || end < 1 || end > numPages) {
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }
        if (start > end) {
            showMessage('結束頁碼不能小於起始頁碼。');
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }

        ocrSplitPoints.push(start - 1);
        ocrSplitPoints.push(end);
        updateOcrUI();
    }
	
	const ocrPageNumber = document.getElementById('ocrPageNumber');
    const ocrStartBtn = document.getElementById('ocrStartBtn');
    const ocrStatus = document.getElementById('ocrStatus');
    const ocrResultText = document.getElementById('ocrResultText');

    async function initializeOcrWorker() {
        ocrStatus.classList.remove('hidden');
        ocrStatus.textContent = '正在初始化辨識引擎... (這在首次使用時需要幾秒鐘)';
		
		const progressContainer = document.getElementById('ocrProgressContainer');
        const progressBar = document.getElementById('ocrProgressBar');
        
        ocrWorker = await Tesseract.createWorker('eng+chi_tra', 1, {
            logger: m => {
                console.log(m);
				ocrStatus.classList.remove('text-green-500');
                if (m.status === 'recognizing text') {
                    // 顯示進度條並更新寬度
                    progressContainer.classList.remove('hidden');
                    const progressValue = (m.progress * 100).toFixed(0);
                    progressBar.style.width = `${progressValue}%`;
                    ocrStatus.textContent = `辨識中... (${progressValue}%)`;
                    
                } else if (m.status === 'loading language training data' || m.status === 'initializing api') {
                    // 載入模型時隱藏進度條 (因為這沒有進度百分比)
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    ocrStatus.textContent = `正在載入語言模型...`;
                } else {
                    progressContainer.classList.add('hidden');
                    ocrStatus.textContent = `狀態: ${m.status}`;
                }
            }
        });

        ocrStatus.textContent = '辨識引擎準備就緒。';
		ocrStatus.classList.remove('text-green-500');
        progressContainer.classList.add('hidden');
        progressBar.style.width = '0%';
        
        return ocrWorker;
    }

    ocrStartBtn.addEventListener('click', async () => {
        // 驗證頁碼區間
        let startPageNum, endPageNum;
        if (ocrSplitPoints.length === 2) {
            startPageNum = ocrSplitPoints[0] + 1;
            endPageNum = ocrSplitPoints[1];
        } else {
            startPageNum = parseInt(document.getElementById('ocrStartPage').value);
            endPageNum = parseInt(document.getElementById('ocrEndPage').value);
        }

        if (isNaN(startPageNum) || isNaN(endPageNum) || startPageNum < 1 || endPageNum > loadedPDF.numPages || startPageNum > endPageNum) {
            showMessage(`請選擇有效的頁碼區間 (1 - ${loadedPDF.numPages})。`);
            return;
        }

        const progressContainer = document.getElementById('ocrProgressContainer');
        const progressBar = document.getElementById('ocrProgressBar');

        ocrStartBtn.disabled = true;
        ocrResultText.value = '';
        originalOcrText = '';
        ocrStatus.classList.remove('text-green-500'); 
        document.getElementById('ocrResultTools').classList.add('hidden'); 
        document.getElementById('copyOcrTextBtn').disabled = true;

        puncToggles = { colon: false, comma: false, paren: false };
        document.querySelectorAll('.punc-btn').forEach(btn => btn.classList.remove('active'));

        let fullText = ""; // 用於儲存所有頁面的文字

        try {
            // 初始化 Tesseract Worker
            if (!ocrWorker) {
                ocrWorker = await initializeOcrWorker();
            }
            
            ocrStatus.classList.remove('hidden');

            // 迴圈辨識每一頁
            for (let i = startPageNum; i <= endPageNum; i++) {
                ocrStatus.textContent = `正在渲染第 ${i} / ${endPageNum} 頁...`;
                ocrStatus.classList.remove('text-green-500');
                
                const page = await loadedPDF.getPage(i);
                const scale = 3.0; 
                const viewport = page.getViewport({ scale: scale });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                ocrStatus.textContent = `正在辨識第 ${i} / ${endPageNum} 頁...`;
                const { data: { text } } = await ocrWorker.recognize(canvas);

                fullText += `--- 辨識頁碼 ${i} ---\n\n`;
                fullText += text.replace(/ /g, '') + "\n\n";
            }

            // 顯示最終結果
            originalOcrText = fullText; 
            applyPunctuationFilters(); 
            
            ocrStatus.textContent = '辨識完成。';
            ocrStatus.classList.add('text-green-500'); 
            
            progressBar.style.width = '100%';
            document.getElementById('ocrResultTools').classList.remove('hidden'); // 顯示標點按鈕
            document.getElementById('copyOcrTextBtn').disabled = originalOcrText.length === 0;

        } catch (error) {
            console.error('OCR Error:', error);
            showMessage('文字辨識時發生錯誤。');
            ocrStatus.textContent = `錯誤: ${error.message || '未知錯誤'}`;
            ocrStatus.classList.remove('text-green-500');
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        } finally {
            ocrStartBtn.disabled = false;
        }
    });
    
    // 應用過濾器並更新 textarea
    function applyPunctuationFilters() {
        let tempText = originalOcrText;
        
        if (puncToggles.colon) {
            tempText = tempText.replace(/:/g, '：');
        }
        if (puncToggles.comma) {
            tempText = tempText.replace(/,/g, '，');
        }
        if (puncToggles.paren) {
            tempText = tempText.replace(/\(/g, '（').replace(/\)/g, '）');
        }
        
        ocrResultText.value = tempText;
    }

    document.querySelectorAll('.punc-btn').forEach(button => {
        button.addEventListener('click', () => {
            const type = button.dataset.type;
            if (type in puncToggles) {
                puncToggles[type] = !puncToggles[type];
                button.classList.toggle('active', puncToggles[type]);
                applyPunctuationFilters();
            }
        });
    });
	
    const copyOcrTextBtn = document.getElementById('copyOcrTextBtn');
    copyOcrTextBtn.addEventListener('click', () => {
        const textToCopy = document.getElementById('ocrResultText').value;
        if (!textToCopy) {
            showMessage('沒有文字可複製。');
            return;
        }

        navigator.clipboard.writeText(textToCopy).then(() => {
            const notification = document.getElementById('copyNotification');
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);

            // 1秒後開始淡化
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 1010); // 10ms + 1000ms

            // 再1秒後消失
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2010); // 1010ms + 1000ms
            
        }).catch(err => {
            console.error('無法複製文字: ', err);
            showMessage('複製文字失敗。');
        });
    });

    document.addEventListener('keydown', (event) => {
        const targetElement = event.target;
        if (targetElement) {
            const tagName = targetElement.tagName.toUpperCase();
            if (tagName === 'INPUT' || tagName === 'TEXTAREA' || tagName === 'SELECT') {
                return;
            }
        }

        if (currentMode === 'merge') {
            if (event.key === 'Delete' && selectedFileIndex !== -1) {
                deleteFileBtn.click();
            } else if (event.key === 'ArrowUp' && selectedFileIndex > 0) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex - 1, 0, fileToMove);
                selectedFileIndex--;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            } else if (event.key === 'ArrowDown' && selectedFileIndex < filesForMerge.length - 1 && selectedFileIndex !== -1) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex + 1, 0, fileToMove);
                selectedFileIndex++;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            }
        } else if (currentMode === 'rotate' && (event.key === 'r' || event.key === 'R') && selectedRotatePage !== -1) {
            rotatePageBtn.click();
        }
    });

    // 全螢幕預覽功能
    async function showFullScreenPreview(pdfDoc, pageNum) {
        fullScreenPDF = pdfDoc;
        fullScreenPage = pageNum;
        await renderFullScreenPage();
        fullScreenPreview.classList.remove('hidden');

        // 綁定鍵盤事件
        document.addEventListener('keydown', handleFullScreenKeys);
    }
    
    async function renderFullScreenPage() {
        if (!fullScreenPDF) return;

        const page = await fullScreenPDF.getPage(fullScreenPage);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const context = canvas.getContext('2d');
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        previewImage.src = canvas.toDataURL();
    }

    function closeFullScreenPreview() {
        fullScreenPreview.classList.add('hidden');
        fullScreenPDF = null;
        fullScreenPage = 0;
        document.removeEventListener('keydown', handleFullScreenKeys);
    }

    function handleFullScreenKeys(e) {
        if (e.key === 'Escape') {
            closeFullScreenPreview();
        } else if (e.key === 'ArrowLeft') {
            navigatePreview(-1);
        } else if (e.key === 'ArrowRight') {
            navigatePreview(1);
        }
    }

    function navigatePreview(direction) {
        const newPage = fullScreenPage + direction;
        if (newPage >= 1 && newPage <= fullScreenPDF.numPages) {
            fullScreenPage = newPage;
            renderFullScreenPage();
        }
    }

    previewPrevBtn.addEventListener('click', () => navigatePreview(-1));
    previewNextBtn.addEventListener('click', () => navigatePreview(1));

    fullScreenPreview.addEventListener('click', (e) => {
        if (e.target === fullScreenPreview) {
            closeFullScreenPreview();
        }
    });

    function downloadPDF(pdfBytes, filename) {
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function formatDate(date) {
        const yyyy = date.getFullYear().toString();
        const mm = (date.getMonth() + 1).toString().padStart(2, '0');
        const dd = date.getDate().toString().padStart(2, '0');
        const hh = date.getHours().toString().padStart(2, '0');
        const min = date.getMinutes().toString().padStart(2, '0');
        const ss = date.getSeconds().toString().padStart(2, '0');
        return `${yyyy}${mm}${dd}${hh}${min}${ss}`;
    }
	
    function resetFileStatus() {
		currentRenderId++;
        loadedPDF = null;
        singleLoadedFile = null;
        fileInput.value = '';
        fileStatus.textContent = '支援 .pdf 格式';
    }

    // 清除裁切 (Split) 資料
    const clearSplitBtn = document.getElementById('clearSplit');
    if (clearSplitBtn) {
        clearSplitBtn.addEventListener('click', () => {
            // 重置全域檔案狀態
            resetFileStatus();
            
            // 清空縮圖容器 (視覺上移除 PDF)
            splitThumbnails.innerHTML = '';
            
            // 重置輸入框與變數
            document.getElementById('splitStartPage').value = '';
            document.getElementById('splitEndPage').value = '';
            splitPoints = [];
            
            // 禁用按鈕
            splitNextBtn.disabled = true;
        });
    }

    // 清除合成 (Merge) 資料
    const clearMergeBtn = document.getElementById('clearMerge');
    if (clearMergeBtn) {
        clearMergeBtn.addEventListener('click', () => {
            // 合成模式有自己的檔案陣列，需獨立處理
            filesForMerge = [];
            selectedFileIndex = -1;
            
            // 重置清單顯示
            renderMergeFileList(); // 這會自動顯示「請匯入 PDF...」
            
            // 重置狀態文字與 Input
            fileStatus.textContent = '支援 .pdf 格式';
            fileInput.value = '';
            
            // 禁用按鈕
            mergeNextBtn.disabled = true;
        });
    }

    // 清除頁碼 (PageNumber) 資料
    const clearPageNumberBtn = document.getElementById('clearPageNumber');
    if (clearPageNumberBtn) {
        clearPageNumberBtn.addEventListener('click', () => {
            // 重置全域檔案狀態
            resetFileStatus();
            
            // 重置輸入框為預設值
            document.getElementById('pageNumberStart').value = '1';
            document.getElementById('pageNumberFromPage').value = '';
            document.getElementById('pageNumberFromPage').placeholder = '頁碼'; // 重置 placeholder
            document.getElementById('pageNumberPosition').value = 'left';
            document.getElementById('pageNumberType').value = 'same';
            
            // 禁用按鈕
            pageNumberNextBtn.disabled = true;
        });
    }

    // 清除旋轉 (Rotate) 資料
    const clearRotateBtn = document.getElementById('clearRotate');
    if (clearRotateBtn) {
        clearRotateBtn.addEventListener('click', () => {
            // 重置全域檔案狀態
            resetFileStatus();
            
            // 清空縮圖容器
            rotateThumbnails.innerHTML = '';
            
            // 重置變數
            rotateRotations = [];
            selectedRotatePage = -1;
            
            // 重置操作區域 (如果已經變成匯出介面，要還原回「下一步」按鈕)
            const rotateActionArea = document.getElementById('rotateAction');
            rotateActionArea.innerHTML = `
                <button id="rotateNext" class="btn btn-blue btn-lg" disabled>下一步</button>
            `;
            // 重新抓取 DOM 並綁定事件 (因為被 innerHTML 覆蓋了)
            rotateNextBtn = document.getElementById('rotateNext');
            // 綁定事件邏輯 (與原本邏輯相同)
            rotateNextBtn.addEventListener('click', () => {
                const actionArea = document.getElementById('rotateNext').parentNode;
                actionArea.innerHTML = `
                    <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                        <div class="flex items-center space-x-2">
                            <label class="font-medium text-gray-700">檔案名稱:</label>
                            <input type="text" id="rotateFilename" class="form-input" value="旋轉-${formatDate(new Date())}">
                        </div>
                        <button id="exportRotate" class="btn btn-green w-full md:w-auto">匯出檔案</button>
                    </div>
                `;
                document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
            });

            // 禁用按鈕
            rotatePageBtn.disabled = true;
            rotateNextBtn.disabled = true;
        });
    }

    // 清除 OCR 資料
    const clearOcrBtn = document.getElementById('clearOcr');
    if (clearOcrBtn) {
        clearOcrBtn.addEventListener('click', () => {
            // 重置全域檔案狀態
            resetFileStatus();
            
            // 清空縮圖容器
            document.getElementById('ocrThumbnails').innerHTML = '';
            
            // 重置輸入框與變數
            document.getElementById('ocrStartPage').value = '';
            document.getElementById('ocrEndPage').value = '';
            ocrSplitPoints = [];
            
            // 清空結果與隱藏工具列
            const ocrResultText = document.getElementById('ocrResultText');
            if (ocrResultText) ocrResultText.value = '';
            originalOcrText = '';
            
            document.getElementById('ocrStatus').classList.add('hidden');
            document.getElementById('ocrStatus').textContent = '';
            document.getElementById('ocrResultTools').classList.add('hidden');
            document.getElementById('copyOcrTextBtn').disabled = true;
            document.getElementById('ocrProgressContainer').classList.add('hidden');
            document.getElementById('ocrProgressBar').style.width = '0%';

            // 重置標點符號按鈕
            puncToggles = { colon: false, comma: false, paren: false };
            document.querySelectorAll('.punc-btn').forEach(btn => btn.classList.remove('active'));
            
            // 禁用開始按鈕
            document.getElementById('ocrStartBtn').disabled = true;
        });
    }
</script>
</body>
</html>
