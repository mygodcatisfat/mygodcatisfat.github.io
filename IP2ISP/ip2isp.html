<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP è³‡æ–™è™•ç†è‡ªå‹•åŒ–å·¥å…·</title>
    <style>
        :root { --label-width: 280px;}
		body { background-color: #f8f9fa; padding: 20px; font-family: system-ui, -apple-system, sans-serif; color: #212529; }
        * { box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; }
        .row { display: flex; flex-wrap: wrap; margin-right: -10px; margin-left: -10px; }
        .col-md-8, .col-md-4 { padding: 0 10px; }
        .col-md-8 { flex: 0 0 66.666667%; max-width: 66.666667%; }
        .col-md-4 { flex: 0 0 33.333333%; max-width: 33.333333%; }
        .mb-2 { margin-bottom: 0.5rem; } .mb-3 { margin-bottom: 1rem; } .mb-4 { margin-bottom: 1.5rem; }
        .pb-3 { padding-bottom: 1rem; } .mt-1 { margin-top: 0.25rem; } .me-2 { margin-right: 0.5rem; }
        .d-flex { display: flex; } .justify-content-between { justify-content: space-between; } .align-items-center { align-items: center; }
        .d-block { display: block; } .w-100 { width: 100%; }

        .card { background-color: #fff; border: 1px solid rgba(0,0,0,.125); border-radius: 0.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { padding: 0.5rem 1rem; margin-bottom: 0; background-color: #fff; border-bottom: 1px solid rgba(0,0,0,.125); font-weight: bold; }
        .card-body { padding: 1rem; }
        .bg-light { background-color: #f8f9fa!important; }
        .rounded { border-radius: 0.25rem!important; }
        .border-bottom { border-bottom: 1px solid #dee2e6!important; }

        .form-label { margin-bottom: 0.5rem; display: inline-block; }
        .form-select { display: block; width: 100%; padding: 0.375rem 2.25rem 0.375rem 0.75rem; font-size: 1rem; font-weight: 400; line-height: 1.5; color: #212529; background-color: #fff; border: 1px solid #ced4da; border-radius: 0.25rem; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .form-select-sm { padding-top: 0.25rem; padding-bottom: 0.25rem; padding-left: 0.5rem; font-size: .875rem; }
        .form-check { display: block; min-height: 1.5rem; padding-left: 1.5em; margin-bottom: 0.125rem; margin-right: 10px; }
        .form-check-input { float: left; margin-left: -1.5em; margin-top: 0.25em; }
        .text-muted { color: #6c757d!important; }
        .text-danger { color: #dc3545!important; }
        .small { font-size: .875em; }

        .btn { display: inline-block; font-weight: 400; line-height: 1.5; text-align: center; text-decoration: none; vertical-align: middle; cursor: pointer; -webkit-user-select: none; user-select: none; border: 1px solid transparent; padding: 0.375rem 0.75rem; font-size: 1rem; border-radius: 0.25rem; transition: color .15s ease-in-out,background-color .15s ease-in-out; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: .875rem; border-radius: 0.2rem; }
        .btn-primary { color: #fff; background-color: #0d6efd; border-color: #0d6efd; }
        .btn-primary:disabled { background-color: #0d6efd; opacity: 0.65; cursor: not-allowed; }
        .btn-success { color: #fff; background-color: #198754; border-color: #198754; }
        .btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
        .btn-warning { color: #000; background-color: #ffc107; border-color: #ffc107; }

        .table-responsive { overflow-x: auto; }
        .table { width: 100%; margin-bottom: 1rem; color: #212529; vertical-align: top; border-color: #dee2e6; border-collapse: collapse; }
        .table-bordered > :not(caption) > * { border-width: 1px 0; }
        .table-bordered > :not(caption) > * > * { border-width: 0 1px; border: 1px solid #dee2e6; padding: 0.5rem; }
        .table-sm > :not(caption) > * > * { padding: 0.25rem; }
        .table-striped > tbody > tr:nth-of-type(odd) > * { --bs-table-accent-bg: rgba(0, 0, 0, 0.05); box-shadow: inset 0 0 0 9999px var(--bs-table-accent-bg); }
        .table-light { --bs-table-bg: #f8f9fa; background-color: var(--bs-table-bg); }
        thead { display: table-header-group; vertical-align: middle; border-color: inherit; }

        .progress { display: flex; height: 1rem; overflow: hidden; font-size: .75rem; background-color: #e9ecef; border-radius: 0.25rem; margin-top: 5px;}
        .progress-bar { display: flex; flex-direction: column; justify-content: center; overflow: hidden; color: #fff; text-align: center; white-space: nowrap; background-color: #0d6efd; transition: width .6s ease; }
        .progress-bar-striped { background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem; }

        .drag-area { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 5px; background: #fff; cursor: pointer; }
        .drag-area:hover { background-color: #f1f1f1; border-color: #999; }
        #fileNameDisplay { font-size: 0.8em; color: #888; margin-top: 5px; min-height: 1.2em; }

        .preview-table { font-size: 0.9em; }
        .result-section, .mapping-section, #progressContainer { display: none; }
        
        .original-data { color: #888; font-size: 0.85em; display: block; margin-bottom: 2px; }
        .converted-data { font-weight: bold; color: #000; }
        
        .link-icon { text-decoration: none; margin-left: 6px; font-size: 0.9em; cursor: pointer; }
        .link-icon:hover { opacity: 0.7; }

        .has-value {
            background-color: #d1e7dd !important;
            border-color: #198754 !important;
        }
		
        .settings-group {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 15px;
            margin-bottom: 15px;
        }
        .settings-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: #495057;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 5px;
        }

        .col-idx { width: 50px; text-align: center; }
        .col-time { white-space: nowrap; }
		
        .tag-original {
            display: inline-block;
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 8px;
            margin-bottom: 4px;
        }
        .text-visual {
            color: #6c757d;
            font-size: 0.85em;
        }
		
        .time-group {
            display: flex;
            border-top: 1px solid #dee2e6;
            padding-top: 4px;
            margin-top: 2px;
        }
        .time-cell-half {
            flex: 1;
            width: 50%;
            word-break: break-all;
        }
        .time-cell-half:first-child {
            border-right: 1px solid #dee2e6;
            padding-right: 8px;
        }
        .time-cell-half:last-child {
            padding-left: 8px;
        }
		
        .preview-table th { white-space: nowrap; }

        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fff; padding: 25px; border-radius: 8px;
            max-width: 600px; width: 90%; max-height: 80vh;
            overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .help-btn-trigger {
            font-size: 0.9rem; margin-left: 10px; cursor: pointer;
            color: #0d6efd; border: 1px solid #0d6efd; background: transparent;
            padding: 2px 8px; border-radius: 15px; transition: all 0.2s;
        }
        .help-btn-trigger:hover { background-color: #0d6efd; color: white; }
        
        .help-section-title { font-weight: bold; color: #0d6efd; margin-top: 15px; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .help-list { padding-left: 20px; margin-bottom: 10px; font-size: 0.95rem; }
        .help-list li { margin-bottom: 6px; }
		
		.highlight-column { background-color: #d1e7dd !important; transition: background-color 0.2s; }
		
		.toast-notify {
			position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
			background: rgba(0, 0, 0, 0.8); color: white; padding: 15px 30px;
			border-radius: 8px; z-index: 10001; display: none; opacity: 1; transition: opacity 1s;
		}

		.preview-table td, .preview-table th, #resultTable td, #resultTable th { white-space: nowrap !important; }

		.btn-action-group { display: flex; flex-direction: column; gap: 4px; }
		
		.btn-action-sm {
			padding: 4px 8px; font-size: 0.75rem; border-radius: 4px;
			width: 100%; display: block; cursor: pointer;
		}

		.btn-retry { background-color: #997404; color: white; border: none; margin-bottom: 4px; }
		.btn-retry:hover { background-color: #826203; color: white; }
        .btn-retry:disabled { opacity: 0.6; cursor: not-allowed; }

		.btn-delete { background-color: #bb2d3b; color: white; border: none; }
		.btn-delete:hover { background-color: #a52834; color: white; }
		
		.delete-modal-content { max-width: 400px; text-align: center; }
		.btn-confirm-delete { background-color: #bb2d3b; color: white; margin-right: 10px; }
		.btn-cancel-delete { background-color: #6c757d; color: white; }

        .timeline-section { margin-top: 20px; border-top: 2px solid #e9ecef; padding-top: 15px; display: none; }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .timeline-controls { display: flex; gap: 10px; font-size: 0.9em; }
        
        .timeline-container { 
            border: 1px solid #dee2e6; background: #fff; border-radius: 4px; 
            overflow-y: auto; overflow-x: auto; max-height: 400px; position: relative; 
        }

        .timeline-row { 
            display: flex; height: 18px; border-bottom: 1px solid #f2f2f2; align-items: center; position: relative; width: 100%;
            min-width: max-content; 
        }
        .timeline-row:last-child { border-bottom: none; }
        
        .timeline-label { 
            width: var(--label-width);
            min-width: var(--label-width);
            padding: 0; font-size: 0.7rem; 
            background: #f8f9fa; border-right: 1px solid #dee2e6; height: 100%; 
            display: flex; align-items: center; font-weight: bold; color: #495057;
            position: sticky; left: 0; z-index: 10; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            white-space: nowrap; overflow: hidden;
        }
        .tl-idx { 
            width: 35px; min-width: 35px; text-align: center; border-right: 1px solid #dee2e6; 
            color: #6c757d; background: #e9ecef; height: 100%; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .tl-key { 
            padding: 0 8px; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
        }

        .timeline-track-area { flex-grow: 1; position: relative; height: 100%; min-width: 200px; }
        
        .tl-bar { 
            position: absolute; height: 4px; top: 7px; background-color: #ffc107; 
            border-radius: 2px; opacity: 0.7; z-index: 1; cursor: pointer;
        }
        .tl-dot { 
            position: absolute; width: 5px; height: 5px; top: 6.5px; background-color: #198754; 
            border-radius: 50%; z-index: 3; transform: translateX(-50%); box-shadow: 0 0 1px #fff; cursor: pointer;
        }
        .tl-overlap {
            position: absolute; height: 4px; top: 7px; background-color: #8B0000; 
            border-radius: 2px; z-index: 2; opacity: 0.9; cursor: pointer;
        }
        .timeline-legend { font-size: 0.75rem; margin-top: 5px; color: #6c757d; }
        .legend-item { display: inline-flex; align-items: center; margin-right: 15px; }
        .legend-box { width: 12px; height: 12px; margin-right: 5px; border-radius: 2px; }

        .timeline-axis-row {
            display: flex; height: 25px; border-bottom: 2px solid #ccc; position: sticky; top: 0; 
            background: #fff; z-index: 20; width: 100%;
            min-width: max-content; 
        }
        .timeline-axis-label-area {
            width: var(--label-width);
            min-width: var(--label-width);
            border-right: 1px solid #dee2e6; background: #f8f9fa; 
            z-index: 21; position: sticky; left: 0; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex; align-items: center;
            position: relative;
        }
        .timeline-axis-track { flex-grow: 1; position: relative; height: 100%; min-width: 200px; }
        
        .timeline-resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            background-color: transparent;
            z-index: 100;
            transition: background-color 0.2s;
        }
        .timeline-resizer:hover, .timeline-resizer.resizing {
            background-color: #0d6efd;
        }
		
		.axis-tick {
            position: absolute; bottom: 0; 
            height: 6px; 
            border-left: 1px solid #999; 
            pointer-events: none;
        }
        .axis-tick-text {
            position: absolute; bottom: 8px; left: 2px;
            font-size: 10px; color: #666; white-space: nowrap;
        }

        .savings-section {
            background-color: #f1f8e9;
            border: 1px solid #c5e1a5;
            border-radius: 0.5rem;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .savings-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #dcedc8;
            padding-bottom: 10px;
        }
        .savings-title {
            color: #2e7d32;
            font-weight: bold;
            font-size: 1.1rem;
            margin: 0;
        }
        .savings-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #198754;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }
        .savings-details-box {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            font-size: 0.9rem;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .btn-money-saver {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 10px;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-money-saver:hover {
            background-color: #1b5e20;
            color: white;
            transform: translateY(-1px);
        }
        
        .original-time-stack {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
		
        .floating-sidebar {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 300px;
            max-height: calc(100vh - 100px);
            background: #fff;
            border: 1px solid #dee2e6;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .sidebar-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
			cursor: grab; user-select: none;
        }
		.sidebar-header:active { cursor: grabbing; }
        .sidebar-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.85rem;
        }
        .isp-group-item {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
            background: #fff;
        }
        .isp-group-item.is-error {
            border-color: #f5c6cb;
            background-color: #f8d7da;
        }
        .isp-raw-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 4px;
            word-break: break-all;
        }
        .isp-edit-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            margin-bottom: 6px;
        }
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
			max-height: 110px; 
            overflow-y: auto;
        }
        .idx-tag {
            background: #e9ecef;
            color: #495057;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .idx-tag:hover { background: #dee2e6; }
		
		/* æ–°å¢ï¼šåŒ¯å‡ºè¨­å®šå€å¡Šèª¿æ•´ï¼Œä½¿å…¶å¯ä»¥å‚ç›´æ’åˆ— */
        .export-settings-container {
            display: flex;
            flex-direction: column;
            margin-right: 15px;
            font-size: 0.85rem;
        }
        .export-row {
            display: flex;
            align-items: center;
        }
        .result-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .result-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .result-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-controls {
            display: flex;
            align-items: stretch; /* ç¢ºä¿å…§å®¹ç­‰é«˜ */
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden; /* ç¢ºä¿åœ“è§’ */
        }
        .export-group {
            position: relative; /* ç‚ºäº†è®“æ¨™é¡Œçµ•å°å®šä½ */
            display: flex;
            flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ—ä»¥å®¹ç´å…§å®¹ */
            justify-content: center;
            padding: 16px 12px 6px 12px; /* ä¸Šæ–¹é ç•™ç©ºé–“çµ¦æ¨™é¡Œ */
            border-right: 1px solid #dee2e6;
            font-size: 0.85rem;
            min-height: 50px; /* è¨­å®šæœ€å°é«˜åº¦ç¢ºä¿è¦–è¦ºä¸€è‡´ */
        }
        .export-group:last-child {
            border-right: none;
        }
		.group-title {
            position: absolute;
            top: 2px;
            left: 8px;
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: bold;
            line-height: 1;
        }
		.group-content-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-input-num {
            width: 50px;
            padding: 2px 4px;
            font-size: 0.85rem;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
        }

        /* æ–°å¢ï¼šç¸®å°å¾Œçš„å°ç²¾éˆåœ“åœˆæ¨£å¼ */
        .minimized-sprite {
            position: fixed;
            width: 70px; /* ç¨å¾®åŠ å¤§ä»¥å®¹ç´æ–‡å­— */
            height: 70px;
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: grab; /* æç¤ºå¯æ‹–æ›³ */
            z-index: 1001; 
            user-select: none;
            line-height: 1.2;
            padding: 5px;
            border: 2px solid #fff;
            font-weight: bold;
        }
		.minimized-sprite:active {
            cursor: grabbing;
        }
        .minimized-sprite:hover {
            background-color: #0b5ed7;
            transform: scale(1.05);
        }
		
		.savings-list-container {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .savings-list-item {
            display: flex;
            flex-direction: column; /* æ”¹ç‚ºå‚ç›´å †ç–Š */
            padding: 10px;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }
        .savings-list-item:last-child { border-bottom: none; }
        .savings-list-item:hover { background-color: #f8f9fa; }
        .savings-row-top { margin-bottom: 4px; }
        .savings-row-bottom { display: flex; align-items: center; }
		
        .savings-info { display: flex; flex-direction: column; }
        .savings-ip { font-weight: bold; color: #495057; font-size: 0.9rem; }
        .savings-desc { font-size: 0.8rem; color: #6c757d; margin-top: 2px; }
        
        .savings-badge-group { text-align: right; }
        .savings-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #0f5132;
            background-color: #d1e7dd;
            margin-right: 8px; /* èˆ‡å¾Œæ–¹æ–‡å­—ä¿æŒè·é›¢ */
        }
		
		
        @media (min-width: 1600px) {
            .container { margin-left: 340px; }
        }
    </style>
</head>
<body>
<div id="minimizedSprite" class="minimized-sprite">ISP<br>å°ç…§èˆ‡åˆ†çµ„</div>

<div class="floating-sidebar" id="ispSidebar" style="display:none;">
    <div class="sidebar-header" id="sidebarHeader">
        <span>ISP å°ç…§èˆ‡åˆ†çµ„</span>
        <button type="button" class="btn-close small" onclick="toggleSidebar(false)" aria-label="Close">Ã—</button>
    </div>
    <div class="sidebar-body" id="ispSidebarContent">
    </div>
</div>

<div class="container">
    <div class="d-flex align-items-center mb-4">
        <h3 class="mb-0">IP è³‡æ–™æŸ¥è©¢èˆ‡è™•ç†å·¥å…·</h3>
        <button type="button" class="help-btn-trigger" id="btnHelp">? ä½¿ç”¨èªªæ˜</button>
    </div>

    <div class="card">
        <div class="card-header">1. åŒ¯å…¥è³‡æ–™ (æ”¯æ´ .csv, .xls, .xlsx)</div>
        <div class="card-body">
            <div class="drag-area" id="dropZone">
                <p class="mb-0">é»æ“Šé¸æ“‡æª”æ¡ˆ æˆ– å°‡æª”æ¡ˆæ‹–æ›³è‡³æ­¤</p>
                <div id="fileNameDisplay"></div>
                <input type="file" id="fileInput" title="é¸æ“‡åŒ¯å…¥æª”æ¡ˆ" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display: none;">
            </div>
        </div>
    </div>

    <div class="card mapping-section" id="mappingSection">
        <div class="card-header">2. åŒ¯å…¥è³‡æ–™é è¦½èˆ‡è¨­å®š</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5>è³‡æ–™é è¦½ (å‰ 5 ç­†)</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm preview-table" id="previewTable"></table>
                    </div>

                    <div class="timeline-section" id="timelineSection">
                        <div class="timeline-header">
                            <h6 class="mb-0">æ™‚é–“åºåˆ†æ (å‰å¾Œ30åˆ†é˜)</h6>
                            <div class="timeline-controls">
                                <div class="form-check form-check-inline m-0">
                                    <input class="form-check-input" type="radio" name="timelineMode" id="modeFit" value="fit">
                                    <label class="form-check-label" for="modeFit">é©æ‡‰å¯¬åº¦ (Fit)</label>
                                </div>
                                <div class="form-check form-check-inline m-0">
                                    <input class="form-check-input" type="radio" name="timelineMode" id="modeScale" value="scale" checked>
                                    <label class="form-check-label" for="modeScale">åˆ†é˜åˆ»åº¦ (Scale)</label>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-legend">
                            <span class="legend-item"><span class="legend-box" style="background:#198754; border-radius:50%; width:10px; height:10px;"></span>åŒ¯å…¥æ™‚é–“é»</span>
                            <span class="legend-item"><span class="legend-box" style="background:#ffc107; opacity:0.7;"></span>å‰å¾Œ30åˆ†é˜</span>
                            <span class="legend-item"><span class="legend-box" style="background:#8B0000;"></span>é‡è¤‡æ™‚é–“æ®µ</span>
                        </div>
                        <div class="timeline-container" id="timelineContainer">
                            </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="settings-group">
                        <div class="settings-title">æª”æ¡ˆè®€å–è¨­å®š</div>
                        <div class="mb-2">
                            <label class="form-label small">æª”æ¡ˆç·¨ç¢¼ï¼š</label>
                            <select class="form-select form-select-sm" id="encodingSelect" title="é¸æ“‡æª”æ¡ˆç·¨ç¢¼">
                                <option value="UTF-8">UTF-8</option>
                                <option value="Big5" selected>Big5</option>
                                <option value="ISO-8859-1">ISO-8859-1</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="headerCheck" checked>
                            <label class="form-check-label small" for="headerCheck">
                                æˆ‘çš„è³‡æ–™ç¬¬ä¸€åˆ—æ˜¯æ¬„ä½åç¨±
                            </label>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">æ¬„ä½å°æ‡‰è¨­å®š</div>
                        <div class="mb-3">
                            <label class="form-label text-danger small">â˜… IP æ¬„ä½ (å¿…é¸)</label>
                            <select class="form-select" id="selectIP" title="é¸æ“‡IPæ¬„ä½"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-danger small">â˜… æ™‚é–“ æ¬„ä½ (å¿…é¸)</label>
                            <select class="form-select" id="selectTime" title="é¸æ“‡æ™‚é–“æ¬„ä½"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Port æ¬„ä½ (å¯é¸)</label>
                            <select class="form-select" id="selectPort" title="é¸æ“‡Portæ¬„ä½">
                                <option value="">(ç„¡ / æœªæä¾›)</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary w-100" id="btnProcess">åŸå§‹è™•ç† (APIæŸ¥è©¢ä¸­è«‹å‹¿é—œé–‰)</button>
                    </div>

                    <div class="savings-section" id="savingsSection" style="display:none;">
                        <div class="savings-header">
                            <h6 class="savings-title">çœéŒ¢æ¨¡å¼åˆ†æ</h6>
                        </div>
                        
                        <div class="savings-stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="savingsMin">0</div>
                                <div class="stat-label">é è¨ˆç¯€çœåˆ†é˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="savingsCount">0</div>
                                <div class="stat-label">æ¸›å°‘æŸ¥è©¢æ¬¡æ•¸</div>
                            </div>
                        </div>

                        <div class="savings-details-box" id="savingsDetailsList">
                            </div>
                        
                        <button type="button" class="btn btn-money-saver w-100" id="btnMoneyProcess">çœéŒ¢è™•ç† (APIæŸ¥è©¢ä¸­è«‹å‹¿é—œé–‰)</button>
                    </div>

                    <button type="button" class="btn btn-warning w-100 mt-2" id="btnPause" style="display: none;">â¸ æš«åœè™•ç†</button>

                    <div id="progressContainer">
                        <label class="small mt-2">è™•ç†é€²åº¦: <span id="progressText">0/0</span></label>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%" title="è™•ç†é€²åº¦"></div>
                        </div>
                        <small id="delayNotice" class="text-muted d-block mt-1" style="font-size: 0.75rem;">â€» ç‚ºé˜²æ­¢è¢«é– IPï¼Œæ¯ç­†æŸ¥è©¢é–“éš” 1.5 ç§’ã€‚</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card result-section" id="resultSection">
        <div class="card-header result-header-container">
            <div class="result-header-left">
                <div class="d-flex align-items-center">
                    <span class="fw-bold">3. è™•ç†çµæœé è¦½</span>
                    <span id="currentApiStatus" class="small text-muted ms-3" style="border-left: 1px solid #ccc; padding-left: 10px;">
                        ç­‰å¾…è™•ç†ä¸­...
                    </span>
                </div>
            </div>

            <div class="result-header-right">
                <div class="export-controls">
                    <div class="export-group">
                        <span class="group-title">IPv6</span>
                        <div class="group-content-row">
                            <div class="form-check form-check-inline m-0 p-0">
                                <input class="form-check-input" type="checkbox" id="chkIpv6Pad" checked>
                                <label class="form-check-label" for="chkIpv6Pad">è£œ0</label>
                            </div>
                            <div class="form-check form-check-inline m-0 p-0">
                                <input class="form-check-input" type="checkbox" id="chkIpv6Upper" checked>
                                <label class="form-check-label" for="chkIpv6Upper">å¤§å¯«</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="export-group">
                        <span class="group-title">æª”æ¡ˆåˆ†å‰²</span>
                        <div class="group-content-row">
                            <div class="form-check form-check-inline m-0 p-0">
                                <input class="form-check-input" type="checkbox" id="chkSplitFile" checked>
                                <label class="form-check-label me-1" for="chkSplitFile">ä»¥</label>
                            </div>
                            <input type="number" id="txtSplitBase" class="export-input-num" value="200" min="1" style="margin-bottom: 10px;">
                            <span class="ms-1" style="margin-bottom: 10px;">ç­†ç‚ºåŸºæ•¸è£½æª”</span>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-success btn-sm" onclick="exportFile('xlsx')">ä¸‹è¼‰ .xlsx</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="exportFile('csv')">ä¸‹è¼‰ .csv</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-sm" id="resultTable">
                    <thead class="table-light">
                        <tr>
                            <th class="col-idx">#</th>
                            <th>é¡åˆ¥</th>
                            <th>é›»ä¿¡æ¥­è€…</th>
                            <th>IP:Port</th>
                            <th class="col-time" style="width: 160px;">æ™‚é–“-30åˆ†</th>
                            <th class="col-time" style="width: 160px;">æ™‚é–“+30åˆ†</th>
                            <th>å‚™è¨»</th>
							<th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal-mask" id="helpModal">
    <div class="modal-content">
        <h4 class="mb-3">ä½¿ç”¨èªªæ˜</h4>
        
        <div class="help-section-title">1. æª”æ¡ˆåŒ¯å…¥èˆ‡è¨­å®š</div>
        <ul class="help-list">
            <li><strong>æ”¯æ´æ ¼å¼ï¼š</strong>å¯ä¸Šå‚³ .xlsx, .xls, .csv æª”æ¡ˆï¼Œç³»çµ±è‡ªå‹•åˆ¤è®€å…§å®¹ã€‚</li>
            <li><strong>è‡ªå‹•é‡ç½®ï¼š</strong>æ¯æ¬¡åŒ¯å…¥æ–°æª”æ¡ˆï¼ˆç„¡è«–æª”åæ˜¯å¦ç›¸åŒï¼‰ï¼Œç³»çµ±çš†æœƒæ¸…ç©ºèˆŠæœ‰è³‡æ–™ï¼Œç¢ºä¿è³‡æ–™æ­£ç¢ºæ€§ã€‚</li>
            <li><strong>æ¬„ä½å°æ‡‰ï¼š</strong>è«‹å‹™å¿…é¸å– IP èˆ‡ æ™‚é–“æ¬„ä½ï¼ŒPort ç‚ºé¸å¡«ã€‚è‹¥æ›´æ”¹ Port æ¬„ä½ï¼Œç³»çµ±æœƒå³æ™‚é‡æ–°è¨ˆç®—åˆ†çµ„ã€‚</li>
            <li><strong>æ¨™é¡Œåˆ—ï¼š</strong>è‹¥å‹¾é¸ã€Œæˆ‘çš„è³‡æ–™ç¬¬ä¸€åˆ—æ˜¯æ¬„ä½åç¨±ã€ï¼Œç³»çµ±æœƒé‡æ–°åŠƒåˆ†æ¨™é¡Œèˆ‡è³‡æ–™åˆ—ï¼Œä¸¦å³æ™‚æ›´æ–°é è¦½ã€‚</li>
        </ul>

        <div class="help-section-title">2. æ™‚é–“åºåˆ†æèˆ‡çœéŒ¢æ¨¡å¼ (é è¦½)</div>
        <ul class="help-list">
            <li><strong>æ™‚åºåœ–åˆ†æï¼š</strong>æ¬„ä½é¸æ“‡å®Œæˆå¾Œï¼Œå³æ™‚ç¹ªè£½ç”˜ç‰¹åœ–ã€‚
                <ul>
                    <li><span style="color:#198754">â—</span> ç¶ é»ï¼šåŸå§‹åŒ¯å…¥çš„æ™‚é–“é»ã€‚</li>
                    <li><span style="color:#ffc107">â– </span> é»ƒæ¢ï¼šæ™‚é–“é»å‰å¾Œ 30 åˆ†é˜çš„æœ‰æ•ˆå€é–“ã€‚</li>
                    <li><span style="color:#8B0000">â– </span> ç´…æ¢ï¼šä¸åŒæ™‚é–“é»é‡ç–Šçš„æ™‚æ®µã€‚</li>
                </ul>
            </li>
            <li><strong>æª¢è¦–æ¨¡å¼ï¼š</strong>é è¨­ç‚ºã€Œåˆ†é˜åˆ»åº¦ã€æ¨¡å¼ï¼Œå¯å·¦å³æ²å‹•æŸ¥çœ‹ç´°ç¯€ï¼›äº¦å¯åˆ‡æ›è‡³ã€Œé©æ‡‰å¯¬åº¦ã€æŸ¥çœ‹æ•´é«”åˆ†ä½ˆã€‚</li>
            <li><strong>çœéŒ¢æ¨¡å¼åˆ†æï¼š</strong>ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—è‹¥å°‡é‡ç–Šæ™‚é–“åˆä½µæŸ¥è©¢ï¼Œé è¨ˆå¯ç¯€çœçš„æŸ¥è©¢æ¬¡æ•¸èˆ‡æ™‚é–“æˆæœ¬ã€‚</li>
        </ul>
		
		<div class="help-section-title">3. è™•ç†èˆ‡ ISP ç·¨è¼¯åŠŸèƒ½ <span style="color:red; font-size:0.8em;">(NEW)</span></div>
        <ul class="help-list">
            <li><strong>ISP æ‡¸æµ®çª—ï¼š</strong>é é¢å·¦å´æœƒé¡¯ç¤ºæ‰€æœ‰åˆ¤æ–·å‡ºçš„ ISP åˆ—è¡¨ã€‚</li>
            <li><strong>å³æ™‚ç·¨è¼¯ï¼š</strong>è‹¥ API å›å‚³çš„åç¨±ä¸ç¬¦åˆéœ€æ±‚ï¼Œæˆ–é¡¯ç¤ºç‚º Errorï¼Œæ‚¨å¯åœ¨å·¦å´è¼¸å…¥æ¡†ç›´æ¥ä¿®æ”¹ä¸­æ–‡åç¨±ï¼Œå³å´è¡¨æ ¼èˆ‡åŒ¯å‡ºæª”æ¡ˆå°‡å³æ™‚æ›´æ–°ã€‚</li>
            <li><strong>Tag å°èˆªï¼š</strong>é»æ“Šæ‡¸æµ®çª—å…§çš„æ•¸å­—æ¨™ç±¤ï¼Œå¯å¿«é€Ÿæ²å‹•è‡³è©²ç­†è³‡æ–™ã€‚</li>
        </ul>

        <div class="help-section-title">4. åŒ¯å‡ºè¨­å®š <span style="color:red; font-size:0.8em;">(NEW)</span></div>
        <ul class="help-list">
            <li><strong>IPV6 æ ¼å¼åŒ–ï¼š</strong>åœ¨ä¸‹è¼‰æŒ‰éˆ•æ—å¯å‹¾é¸ã€ŒIPV6è£œ0ã€èˆ‡ã€ŒIPV6å¤§å¯«ã€ï¼Œæ­¤è¨­å®šåƒ…å½±éŸ¿åŒ¯å‡ºçš„ Excel/CSV å…§å®¹ï¼Œä¸å½±éŸ¿ç¶²é é¡¯ç¤ºã€‚</li>
        </ul>

        <div class="help-section-title">5. æŸ¥è©¢è™•ç†</div>
        <ul class="help-list">
            <li><strong>åŸå§‹è™•ç†ï¼š</strong>é‡å°æ¯ä¸€ç­†åŸå§‹è³‡æ–™ï¼Œé€ä¸€é€²è¡Œ API æŸ¥è©¢ï¼Œä¸é€²è¡Œåˆä½µã€‚</li>
            <li><strong>çœéŒ¢è™•ç†ï¼š</strong>æ ¹æ“šåˆ†æçµæœï¼Œå°‡é‡ç–Šçš„æ™‚é–“å€æ®µè‡ªå‹•åˆä½µç‚ºå–®ä¸€ç­†æŸ¥è©¢ï¼Œå¤§å¹…æ¸›å°‘ API å‘¼å«æ¬¡æ•¸ã€‚çµæœè¡¨æ ¼æœƒé¡¯ç¤ºåˆä½µå¾Œçš„èµ·è¨–æ™‚é–“ï¼Œä¸¦æ¨™è¨»åˆä½µç­†æ•¸ã€‚</li>
            <li><strong>æš«åœåŠŸèƒ½ï¼š</strong>è™•ç†éç¨‹ä¸­å¯éš¨æ™‚æš«åœèˆ‡ç¹¼çºŒï¼Œé¿å…èª¤æ“ä½œæˆ–ç¶²è·¯ä¸ç©©ã€‚</li>
        </ul>

        <div class="help-section-title">6. çµæœè¼¸å‡º</div>
        <ul class="help-list">
            <li><strong>æ“ä½œåŠŸèƒ½ï¼š</strong>å¯é‡å°å–®ç­†çµæœé€²è¡Œã€Œé‡å‘¼ã€(é‡æ–°æŸ¥è©¢) æˆ–ã€Œåˆªé™¤ã€è©²ç­†è³‡æ–™ã€‚</li>
            <li><strong>åŒ¯å‡ºæª”æ¡ˆï¼š</strong>æ”¯æ´ä¸‹è¼‰ .xlsx æˆ– .csv æ ¼å¼ã€‚çœéŒ¢æ¨¡å¼ä¸‹ï¼ŒåŒ¯å‡ºçš„å‚™è¨»æ¬„ä½çµ±ä¸€æ¨™ç¤ºç‚ºã€Œé€šè¨Šä½¿ç”¨è€…è³‡æ–™ã€ï¼Œèˆ‡åŸå§‹è™•ç†ä¸€è‡´ã€‚</li>
        </ul>

        <div class="text-center mt-4">
            <small class="text-muted">é»æ“Šä»»æ„è™•å³å¯é—œé–‰è¦–çª—</small>
        </div>
    </div>
</div>

<div class="modal-mask" id="deleteConfirmModal">
    <div class="modal-content delete-modal-content">
        <h4 class="mb-3">ç¢ºèªåˆªé™¤</h4>
        <p>æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­† IP è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚</p>
        <div class="mt-4">
            <button type="button" class="btn btn-confirm-delete" id="btnDoDelete">ç¢ºèªåˆªé™¤</button>
            <button type="button" class="btn btn-cancel-delete" id="btnCancelDelete">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="toastNotify" class="toast-notify"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://raw.githack.com/SheetJS/js-codepage/master/dist/cptable.full.js" integrity="sha512-DbGpYRMWqvjKfwmyVt7VO+f+jdsTr10lTFC/MSlDO0b91F7CNoYOMu/91BQr48/RQY3pLqN8cz7fD2WwmnjqCw==" crossorigin="anonymous"></script>
<script>
    let rawSheetData = []; 
	let rawData = [];      
    let headers = [];
    let currentFile = null;
	let isPaused = false;
	let isProcessed = false;
	let firstRowBackup = null;
    let firstDataBackup = null; 
	let rowToDelete = null;
    let timelineDataCache = []; 
    let savingsData = null; 
    let currentProcessingMode = 'original';
	let ispGroups = {};
	let ipCache = {}; 
	
	// --- å½ˆç ç‰©ç†è®Šæ•¸ ---
    let spriteState = {
        x: 0, y: 0,
        vx: 0, vy: 0,        // åˆå§‹é€Ÿåº¦è¨­ç‚º 0
        width: 70, height: 70,
        rafId: null,
        isBouncing: false,
        lastMouseX: 0,
        lastMouseY: 0,
        friction: 0.97       // æ‘©æ“¦ä¿‚æ•¸ (0.9 ~ 0.99ï¼Œè¶Šå°åœè¶Šå¿«)
    };

    // --- ç‰©ç†é‹å‹•è¿´åœˆ (åŠ å…¥æ‘©æ“¦åŠ›) ---
    function runSpritePhysics() {
        if (!spriteState.isBouncing) return;

        const el = document.getElementById('minimizedSprite');
        const winW = window.innerWidth;
        const winH = window.innerHeight;

        // 1. å¥—ç”¨æ‘©æ“¦åŠ› (è®“é€Ÿåº¦æ¼¸æ¼¸è®Šæ…¢)
        spriteState.vx *= spriteState.friction;
        spriteState.vy *= spriteState.friction;

        // 2. æ›´æ–°ä½ç½®
        spriteState.x += spriteState.vx;
        spriteState.y += spriteState.vy;

        // 3. é‚Šç•Œç¢°æ’åå½ˆ (åå½ˆæ™‚ç¨å¾®æè€—æ›´å¤šèƒ½é‡ * 0.8)
        if (spriteState.x + spriteState.width >= winW) {
            spriteState.x = winW - spriteState.width;
            spriteState.vx = -spriteState.vx * 0.8;
        } else if (spriteState.x <= 0) {
            spriteState.x = 0;
            spriteState.vx = -spriteState.vx * 0.8;
        }

        if (spriteState.y + spriteState.height >= winH) {
            spriteState.y = winH - spriteState.height;
            spriteState.vy = -spriteState.vy * 0.8;
        } else if (spriteState.y <= 0) {
            spriteState.y = 0;
            spriteState.vy = -spriteState.vy * 0.8;
        }

        // 4. [é—œéµ] åœæ­¢åˆ¤å®šï¼šå¦‚æœé€Ÿåº¦æ¥µæ…¢ï¼Œå°±ç›´æ¥åœä¸‹ä¾†ï¼Œä¸è¦ç¶­æŒå‡é€Ÿ
        if (Math.abs(spriteState.vx) < 0.1 && Math.abs(spriteState.vy) < 0.1) {
            spriteState.isBouncing = false;
            cancelAnimationFrame(spriteState.rafId);
            return;
        }

        el.style.left = spriteState.x + 'px';
        el.style.top = spriteState.y + 'px';

        spriteState.rafId = requestAnimationFrame(runSpritePhysics);
    }
	
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    const dom = {
        dropZone: document.getElementById('dropZone'),
        fileNameDisplay: document.getElementById('fileNameDisplay'),
        fileInput: document.getElementById('fileInput'),
        encodingSelect: document.getElementById('encodingSelect'),
        headerCheck: document.getElementById('headerCheck'),
        resultSection: document.getElementById('resultSection'),
        resultBody: document.getElementById('resultBody'),
        progressContainer: document.getElementById('progressContainer'),
        progressBar: document.getElementById('progressBar'),
        progressText: document.getElementById('progressText'),
        statusEl: document.getElementById('currentApiStatus'),
        delayNotice: document.getElementById('delayNotice'),
        mappingSection: document.getElementById('mappingSection'),
        previewTable: document.getElementById('previewTable'),
        btnProcess: document.getElementById('btnProcess'),
        btnPause: document.getElementById('btnPause'),
        timelineSection: document.getElementById('timelineSection'),
        timelineContainer: document.getElementById('timelineContainer'),
        modeFit: document.getElementById('modeFit'),
        modeScale: document.getElementById('modeScale'),
        savingsSection: document.getElementById('savingsSection'),
        savingsStatsBox: document.getElementById('savingsStatsBox'),
        savingsMin: document.getElementById('savingsMin'),
        savingsCount: document.getElementById('savingsCount'),
        savingsDetailsList: document.getElementById('savingsDetailsList'),
        btnMoneyProcess: document.getElementById('btnMoneyProcess'),
        selects: {
            ip: document.getElementById('selectIP'),
            time: document.getElementById('selectTime'),
            port: document.getElementById('selectPort')
        }
    };

    dom.dropZone.addEventListener('click', () => dom.fileInput.click());
    dom.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dom.dropZone.style.backgroundColor = '#e9ecef'; });
    dom.dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dom.dropZone.style.backgroundColor = '#fff'; });
    dom.dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dom.dropZone.style.backgroundColor = '#fff';
        if (e.dataTransfer.files.length) {
            currentFile = e.dataTransfer.files[0];
            handleFile(currentFile);
        }
    });
	
    dom.fileInput.addEventListener('click', () => { dom.fileInput.value = ''; });
    dom.fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            currentFile = e.target.files[0];
            handleFile(currentFile);
        }
    });
    dom.encodingSelect.addEventListener('change', () => { if(currentFile) handleFile(currentFile); });
    
    Object.values(dom.selects).forEach(el => {
        el.addEventListener('change', function() {
            updateSelectStyle(this);
            updateTimelineAndStats();
            
            if (isProcessed) {
                if (dom.selects.ip.value && dom.selects.time.value) {
                    runProcess(currentProcessingMode === 'moneySaver');
                } else {
                    isProcessed = false;
                    dom.resultBody.innerHTML = '';
                    dom.resultSection.style.display = 'none';
                    dom.progressContainer.style.display = 'none';
                    window.finalProcessedData = [];
                }
            }
        });
    });

    dom.modeFit.addEventListener('change', () => generateTimeline());
    dom.modeScale.addEventListener('change', () => generateTimeline());
    dom.headerCheck.addEventListener('change', function() {
        if (currentFile && rawSheetData.length > 0) {
            const wasResultVisible = dom.resultSection.style.display !== 'none';
            
            reparseData();
            
            if (wasResultVisible && dom.selects.ip.value && dom.selects.time.value) {
                runProcess(currentProcessingMode === 'moneySaver');
            }
        }
    });

	function showToast(text) {
		const toast = document.getElementById('toastNotify');
		toast.innerText = text;
		toast.style.display = 'block';
		toast.style.opacity = '1';
		setTimeout(() => {
			toast.style.opacity = '0';
			setTimeout(() => { toast.style.display = 'none'; }, 1000);
		}, 1000); 
	}
	
    function updateSelectStyle(el) {
        if (el.value) el.classList.add('has-value');
        else el.classList.remove('has-value');
		updateTableHighlight();
    }
	
    function renderIspCellHtml(ispResult, ip) {
        let safeIp = escapeHtml(ip);
        let linkUrl = (ispResult.source === 'ipwho.is') 
            ? `https://ipwho.is/${safeIp}` 
            : `http://ip-api.com/json/${safeIp}`;
        
        const safeSource = escapeHtml(ispResult.source);
        const linkIcon = `<a href="${linkUrl}" target="_blank" class="link-icon" title="æŸ¥çœ‹ä¾†æºè³‡æ–™ (${safeSource})" type="button">ğŸ”—</a>`;
        const apiRawValue = escapeHtml(ispResult.original);
        const displayValue = escapeHtml(ispResult.display);
        
        return `<div><span class="original-data">APIï¼š${apiRawValue}</span></div>
                <div><span class="converted-data">è½‰æ›ï¼š${displayValue}</span></div>${linkIcon}`;
    }

	async function retryRow(btn, ip) {
		const row = btn.closest('tr');
		const ispCell = row.cells[2]; 
		
		btn.disabled = true;
		btn.innerText = 'æŸ¥è©¢ä¸­';
		
		delete ipCache[ip];
		const ispResult = await fetchISP(ip);
		ipCache[ip] = ispResult;
		
		if (ispResult.source === 'ipwho.is') dom.statusEl.innerText = 'ç‹€æ…‹: é‡æ–°å‘¼å« ipwho.is å®Œæˆ';
		else if (ispResult.source === 'ip-api') dom.statusEl.innerText = 'ç‹€æ…‹: é‡æ–°å‘¼å« ip-api å®Œæˆ';
	
        ispCell.innerHTML = renderIspCellHtml(ispResult, ip);
		
		const rowIndex = row.rowIndex - 1; 
		if(window.finalProcessedData && window.finalProcessedData[rowIndex]) {
			window.finalProcessedData[rowIndex]['é›»ä¿¡æ¥­è€…'] = ispResult.isMatched ? ispResult.display : ispResult.original;
		}

		btn.disabled = false;
		btn.innerText = 'é‡å‘¼';
	}
	
	function deleteRow(btn) {
		rowToDelete = btn.closest('tr');
		document.getElementById('deleteConfirmModal').style.display = 'flex';
	}
	
	document.getElementById('btnDoDelete').addEventListener('click', function() {
		if (rowToDelete) {
			const rowIndex = rowToDelete.rowIndex - 1;
			if(window.finalProcessedData) window.finalProcessedData.splice(rowIndex, 1);
            if (timelineDataCache[rowIndex]) {
                 timelineDataCache.splice(rowIndex, 1);
                 generateTimeline(true);
            }
			rowToDelete.remove();
			updateRowIndices();
			rowToDelete = null;
		}
		document.getElementById('deleteConfirmModal').style.display = 'none';
	});

	document.getElementById('btnCancelDelete').addEventListener('click', function() {
		document.getElementById('deleteConfirmModal').style.display = 'none';
		rowToDelete = null;
	});
    
    function updateRowIndices() {
        Array.from(dom.resultBody.rows).forEach((r, idx) => { r.cells[0].innerText = idx + 1; });
    }

	function updateTableHighlight() {
		const ipVal = dom.selects.ip.value;
		const timeVal = dom.selects.time.value;
		const portVal = dom.selects.port.value;
		const selectedHeaders = [ipVal, timeVal, portVal].filter(v => v !== "");
		const targetIndices = selectedHeaders.map(h => headers.findIndex(header => String(header) === String(h)));

		if (!dom.previewTable) return;
		dom.previewTable.querySelectorAll('tr').forEach(row => {
			row.querySelectorAll('th, td').forEach((cell, idx) => {
				if (targetIndices.includes(idx)) cell.classList.add('highlight-column');
				else cell.classList.remove('highlight-column');
			});
		});
	}

    function handleFile(file, retainResults = false) {
        if (!retainResults) {
            rawSheetData = [];
            resetAppState();
            dom.fileNameDisplay.innerText = `${file.name}`;
        }
		
        const reader = new FileReader();
        const encoding = dom.encodingSelect.value;
        
        reader.onload = function(e) {
            let workbook;
            try {
                if (file.name.endsWith('.csv')) {
                    workbook = XLSX.read(e.target.result, {type: 'string'});
                } else {
                    workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                }

                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                rawSheetData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if (rawSheetData.length === 0) { alert("æª”æ¡ˆå…§å®¹ç‚ºç©º"); return; }
                
                reparseData();

				setTimeout(() => {
                    if (!retainResults) {
                        dom.mappingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            } catch (err) {
                console.error(err);
                alert("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æˆ–å˜—è©¦æ›´æ›ç·¨ç¢¼");
            }
        };

        if (file.name.endsWith('.csv')) {
            reader.readAsText(file, encoding);
        } else {
            reader.readAsArrayBuffer(file);
        }
    }

    function resetAppState(clearRawSheet = true) {
        isProcessed = false;
        firstRowBackup = null;
        firstDataBackup = null;
        if(clearRawSheet) rawSheetData = [];
        rawData = [];
        window.finalProcessedData = [];
        timelineDataCache = [];
        savingsData = null;
        dom.resultBody.innerHTML = '';
        dom.resultSection.style.display = 'none';
        dom.timelineSection.style.display = 'none'; 
        dom.savingsSection.style.display = 'none';
        dom.progressContainer.style.display = 'none';
        dom.progressBar.style.width = '0%';
        dom.progressText.innerText = '0%';
        dom.statusEl.innerText = 'ç­‰å¾…è™•ç†ä¸­...';
    }

    function reparseData() {
        const hasHeader = dom.headerCheck.checked;
        
        if (hasHeader) {
            headers = rawSheetData[0];
            const dataRows = rawSheetData.slice(1);
            rawData = dataRows.map(row => {
                let obj = {};
                headers.forEach((h, index) => { obj[h] = row[index]; });
                return obj;
            });
        } else {
            const maxCols = rawSheetData[0].length;
            headers = Array.from({length: maxCols}, (_, i) => `ç¬¬${i+1}æ¬„`);
            rawData = rawSheetData.map(row => {
                let obj = {};
                headers.forEach((h, index) => { obj[h] = row[index]; });
                return obj;
            });
        }

        renderMappingSection(headers, rawData.slice(0, 5));
        
        if(dom.selects.ip.value && dom.selects.time.value) {
            updateTimelineAndStats();
        }
    }

    function renderMappingSection(headers, previewData) {
		const prevIdx = {
            ip: dom.selects.ip.selectedIndex,
            time: dom.selects.time.selectedIndex,
            port: dom.selects.port.selectedIndex
        };

		dom.mappingSection.style.display = 'block';
		
		const updateSelect = (el, allowEmpty) => {
			el.innerHTML = '<option value="" selected disabled>è«‹é¸æ“‡æ¬„ä½</option>';
			if (allowEmpty) el.innerHTML += '<option value="">(ç„¡ / æœªæä¾›)</option>';
			
			headers.forEach((h) => {
				const opt = document.createElement('option');
				opt.value = h;
				let firstVal = (rawData[0] && rawData[0][h] !== undefined) ? rawData[0][h] : "";
				opt.text = `${h} (${firstVal})`; 
				el.appendChild(opt);
			});
		};
        
		updateSelect(dom.selects.ip, false);
		updateSelect(dom.selects.time, false);
		updateSelect(dom.selects.port, true);
		
		if (prevIdx.ip > 0 && prevIdx.ip < dom.selects.ip.options.length) dom.selects.ip.selectedIndex = prevIdx.ip;
		if (prevIdx.time > 0 && prevIdx.time < dom.selects.time.options.length) dom.selects.time.selectedIndex = prevIdx.time;
		if (prevIdx.port > 0 && prevIdx.port < dom.selects.port.options.length) dom.selects.port.selectedIndex = prevIdx.port;

		renderPreviewTable(headers, previewData);
		updateTableHighlight();
	}

	function renderPreviewTable(headers, data) {
        dom.previewTable.innerHTML = "";
        const thead = dom.previewTable.createTHead();
        const headerRow = thead.insertRow();
        headers.forEach(h => {
            const th = document.createElement('th');
            th.innerText = h;
            headerRow.appendChild(th);
        });

        const tbody = dom.previewTable.createTBody();
        data.forEach(row => {
            const tr = tbody.insertRow();
            headers.forEach(h => {
                tr.insertCell().innerText = row[h] || '';
            });
        });
    }

    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
	
    function formatDateForDisplay(date) {
        const pad = (n) => String(n).padStart(2, '0');
        return `${date.getFullYear()}/${pad(date.getMonth()+1)}/${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }
	
    function parseFlexibleDate(input) {
        if (!input) return null;
        const str = String(input).trim();
        if (!isNaN(input) || (!isNaN(str) && str.length < 12 && !str.includes(':'))) {
             const serial = parseFloat(input);
             if (serial > 25569 && serial < 1000000) { 
                 return new Date(Math.round((serial - 25569) * 86400 * 1000));
             }
        }
        if (/^\d{14}$/.test(str)) {
            const y = str.substring(0, 4), m = str.substring(4, 6), d = str.substring(6, 8);
            const h = str.substring(8, 10), min = str.substring(10, 12), s = str.substring(12, 14);
            return new Date(y, m-1, d, h, min, s);
        }
        const parts = str.replace(/[å¹´æœˆæ—¥æ™‚åˆ†ç§’/\-:]/g, ' ').replace(/\s+/g, ' ').trim().split(' ');
        if (parts.length >= 6) {
            return new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4], parts[5]);
        }
        const d = new Date(input);
        return isNaN(d.getTime()) ? null : d;
    }

    function updateTimelineAndStats() {
        const ipCol = dom.selects.ip.value;
        const timeCol = dom.selects.time.value;
        const portCol = dom.selects.port.value;

        if (!ipCol || !timeCol || rawData.length === 0) return;

        timelineDataCache = [];
        
        rawData.forEach(row => {
            const originalIP = row[ipCol] || '';
            const originalTime = row[timeCol];
            const formattedIP = portCol && row[portCol] ? `${originalIP}:${row[portCol]}` : originalIP;

            if (originalIP && originalTime) {
                let dateObj = parseFlexibleDate(originalTime);
                if (dateObj) {
                    const dMinus = new Date(dateObj.getTime() - 30 * 60000);
                    const dPlus = new Date(dateObj.getTime() + 30 * 60000);
                    timelineDataCache.push({
                        key: formattedIP,
						rawIP: originalIP,
                        timeObj: dateObj,
                        tMinusObj: dMinus,
                        tPlusObj: dPlus,
                        originalTimeString: originalTime 
                    });
                }
            }
        });

        generateTimeline(true);
        calculateSavings(); 
    }

    function calculateSavings() {
        if (timelineDataCache.length === 0) {
            dom.savingsSection.style.display = 'none';
            return;
        }

        const groups = {};
        timelineDataCache.forEach(d => {
            if (!groups[d.key]) groups[d.key] = [];
            groups[d.key].push(d);
        });

        let totalOriginalMinutes = 0;
        let totalMergedMinutes = 0;
        let originalCount = 0;
        let mergedCount = 0;
        let mergedGroups = []; 
        let detailsHtml = '<ul class="mb-0" style="padding-left: 0; list-style: none;">';

        for (const [key, items] of Object.entries(groups)) {
            originalCount += items.length;
            const originalMins = items.length * 60;
            totalOriginalMinutes += originalMins;

            const intervals = items.map(item => ({
                start: item.tMinusObj.getTime(),
                end: item.tPlusObj.getTime(),
                originalTime: item.originalTimeString,
                obj: item
            }));
            intervals.sort((a, b) => a.start - b.start);

            const merged = [];
            if (intervals.length > 0) {
                let current = { 
                    start: intervals[0].start, 
                    end: intervals[0].end, 
                    originalTimes: [intervals[0].originalTime]
                };
                for (let i = 1; i < intervals.length; i++) {
                    if (intervals[i].start < current.end) {
                        current.end = Math.max(current.end, intervals[i].end);
                        current.originalTimes.push(intervals[i].originalTime);
                    } else {
                        merged.push(current);
                        current = { 
                            start: intervals[i].start, 
                            end: intervals[i].end, 
                            originalTimes: [intervals[i].originalTime]
                        };
                    }
                }
                merged.push(current);
            }

            mergedCount += merged.length;
            let mergedMins = 0;
            merged.forEach(m => {
                const duration = (m.end - m.start) / 60000;
                mergedMins += duration;
                
                mergedGroups.push({
                    key: key,
					rawIP: items[0].rawIP,
                    start: m.start,
                    end: m.end,
                    originalTimes: m.originalTimes
                });
            });
            totalMergedMinutes += mergedMins;

            if (items.length > merged.length) {
                const savedMins = Math.round(originalMins - mergedMins);
                detailsHtml += `
                    <li class="savings-list-item">
                        <div class="savings-row-top">
                            <span class="savings-ip">${escapeHtml(key)}</span>
                        </div>
                        <div class="savings-row-bottom">
                            <span class="savings-badge">çœ ${savedMins} åˆ†é˜</span>
                            <span class="savings-desc">åŸå§‹ ${items.length} ç­† &rarr; åˆä½µå¾Œ ${merged.length} ç­†</span>
                        </div>
                    </li>`;
            }
        }
        detailsHtml = `<ul class="savings-list-container">${detailsHtml}</ul>`;

        const savedMinutes = Math.round(totalOriginalMinutes - totalMergedMinutes);
        const reducedRequests = originalCount - mergedCount;

        dom.savingsMin.innerText = savedMinutes;
        dom.savingsCount.innerText = reducedRequests;
        dom.savingsDetailsList.innerHTML = detailsHtml;

        dom.savingsSection.style.display = 'block';
        savingsData = mergedGroups; 
    }

    function generateTimeline(useCache = true) {
        const container = dom.timelineContainer;
        const mode = document.querySelector('input[name="timelineMode"]:checked').value;
        container.innerHTML = '';
        
        let dataToProcess = useCache && timelineDataCache.length > 0 ? timelineDataCache : timelineDataCache;
        if (dataToProcess.length === 0) return;

        let minTime = Infinity;
        let maxTime = -Infinity;
        
        dataToProcess.forEach(d => {
            if (d.tMinusObj.getTime() < minTime) minTime = d.tMinusObj.getTime();
            if (d.tPlusObj.getTime() > maxTime) maxTime = d.tPlusObj.getTime();
        });

        minTime -= 10 * 60000;
        maxTime += 10 * 60000;

        let stepMs;
        if (mode === 'scale') {
            stepMs = 30 * 60 * 1000; 
        } else {
            const totalDurationRaw = maxTime - minTime;
            if (totalDurationRaw < 60 * 60 * 1000) stepMs = 5 * 60 * 1000; 
            else if (totalDurationRaw < 6 * 60 * 60 * 1000) stepMs = 30 * 60 * 1000;
            else if (totalDurationRaw < 24 * 60 * 60 * 1000) stepMs = 60 * 60 * 1000; 
            else stepMs = 6 * 60 * 60 * 1000;
        }

        let startTime = Math.floor(minTime / stepMs) * stepMs;
        if(mode === 'fit') startTime -= stepMs; 

        let endTime = Math.ceil(maxTime / stepMs) * stepMs;
        if(mode === 'fit') endTime += stepMs;
        
        const totalDuration = endTime - startTime;

        const groups = {};
        dataToProcess.forEach(d => {
            if (!groups[d.key]) groups[d.key] = [];
            groups[d.key].push(d);
        });

        let trackWidthStyle = '100%';
        let trackBgStyle = '';

        if (mode === 'scale') {
            const minutes = totalDuration / 60000;
            const pxPerMin = 2; 
            const totalPx = Math.max(minutes * pxPerMin, container.offsetWidth);
            trackWidthStyle = `${totalPx}px`;
            const bgSizePct = (stepMs / totalDuration) * 100;
            trackBgStyle = `background-image: linear-gradient(to right, #f2f2f2 1px, transparent 1px); background-size: ${bgSizePct}% 100%;`;
        }

        const axisRow = document.createElement('div');
        axisRow.className = 'timeline-axis-row';
        
        const axisLabel = document.createElement('div');
        axisLabel.className = 'timeline-axis-label-area';
        axisLabel.innerHTML = '<span class="tl-idx" style="background:transparent; border:none; font-size:0.75rem;">#</span><span style="padding:4px; font-weight:bold; color:#495057; font-size:0.75rem;">IP/Port</span>';
        
        const resizer = document.createElement('div');
        resizer.className = 'timeline-resizer';
        setupResizer(resizer);
        axisLabel.appendChild(resizer);

        axisRow.appendChild(axisLabel);
        
        const axisTrack = document.createElement('div');
        axisTrack.className = 'timeline-axis-track';
        axisTrack.style.width = trackWidthStyle;
        if(mode === 'scale') {
            axisTrack.style.minWidth = trackWidthStyle;
            axisTrack.style.cssText += trackBgStyle; 
        }

        let currTick = startTime;
        while(currTick <= endTime) {
            const pct = ((currTick - startTime) / totalDuration) * 100;
            if(pct >= 0 && pct <= 100) {
                const tick = document.createElement('div');
                tick.className = 'axis-tick';
                tick.style.left = `${pct}%`;
                
                const d = new Date(currTick);
                const h = String(d.getHours()).padStart(2,'0');
                const m = String(d.getMinutes()).padStart(2,'0');
                
                let text = `${h}:${m}`;
                if (currTick === startTime || (d.getHours() === 0 && d.getMinutes() === 0)) {
                    text = `${d.getMonth()+1}/${d.getDate()} ${text}`;
                }

                const txt = document.createElement('span');
                txt.className = 'axis-tick-text';
                txt.innerText = text;
                tick.appendChild(txt);

                axisTrack.appendChild(tick);
            }
            currTick += stepMs;
        }
        axisRow.appendChild(axisTrack);
        container.appendChild(axisRow);

        const fmt = (d) => formatDateForDisplay(d);

        let groupIndex = 1;
        for (const [key, items] of Object.entries(groups)) {
            const row = document.createElement('div');
            row.className = 'timeline-row';
            
            const label = document.createElement('div');
            label.className = 'timeline-label';
            const safeKey = escapeHtml(key);
            label.innerHTML = `<span class="tl-idx">${groupIndex}</span><span class="tl-key" title="${safeKey}">${safeKey}</span>`;
            row.appendChild(label);
            groupIndex++;

            const track = document.createElement('div');
            track.className = 'timeline-track-area';
            track.style.width = trackWidthStyle;
            if(mode === 'scale') {
                track.style.minWidth = trackWidthStyle;
                track.style.cssText += trackBgStyle; 
            }

            const intervals = items.map(item => ({
                start: item.tMinusObj.getTime(),
                end: item.tPlusObj.getTime()
            }));
            intervals.sort((a, b) => a.start - b.start);
            
            let overlaps = [];
            if (intervals.length > 1) {
                let mergedIntervals = [];
                let currM = { s: intervals[0].start, e: intervals[0].end };
                for(let i=1; i<intervals.length; i++){
                    if(intervals[i].start < currM.e) {
                        currM.e = Math.max(currM.e, intervals[i].end);
                    } else {
                        mergedIntervals.push(currM);
                        currM = { s: intervals[i].start, e: intervals[i].end };
                    }
                }
                mergedIntervals.push(currM);

                let points = [];
                intervals.forEach(i => {
                    points.push({t: i.start, type: 1});
                    points.push({t: i.end, type: -1});
                });
                points.sort((a, b) => a.t - b.t || b.type - a.type); 

                let activeCount = 0;
                let overlapStart = null;
                
                points.forEach(p => {
                    let prevCount = activeCount;
                    activeCount += p.type;
                    
                    if (prevCount < 2 && activeCount >= 2) overlapStart = p.t;
                    else if (prevCount >= 2 && activeCount < 2 && overlapStart !== null) {
                         const parentUnion = mergedIntervals.find(m => overlapStart >= m.s && p.t <= m.e);
                         overlaps.push({
                             start: overlapStart, 
                             end: p.t,
                             unionStart: parentUnion ? parentUnion.s : overlapStart,
                             unionEnd: parentUnion ? parentUnion.e : p.t
                         });
                         overlapStart = null;
                    }
                });
            }

            items.forEach(item => {
                const startPct = ((item.tMinusObj.getTime() - startTime) / totalDuration) * 100;
                const widthPct = ((item.tPlusObj.getTime() - item.tMinusObj.getTime()) / totalDuration) * 100;
                const centerPct = ((item.timeObj.getTime() - startTime) / totalDuration) * 100;
                const tooltipText = `åŒ¯å…¥æ™‚é–“ï¼š${fmt(item.timeObj)}\næ™‚é–“å€é–“ï¼š${fmt(item.tMinusObj)} ~ ${fmt(item.tPlusObj)}\né‡è¤‡æ™‚æ®µï¼šç„¡`;
                const bar = document.createElement('div');
				
                bar.className = 'tl-bar';
                bar.style.left = `${startPct}%`;
                bar.style.width = `${widthPct}%`;
                bar.title = tooltipText;
                track.appendChild(bar);

                const dot = document.createElement('div');
                dot.className = 'tl-dot';
                dot.style.left = `${centerPct}%`;
                dot.title = tooltipText;
                track.appendChild(dot);
            });

            overlaps.forEach(ov => {
                const startPct = ((ov.start - startTime) / totalDuration) * 100;
                const widthPct = ((ov.end - ov.start) / totalDuration) * 100;
                const unionStartStr = fmt(new Date(ov.unionStart));
                const unionEndStr = fmt(new Date(ov.unionEnd));
                const ovTooltip = `åŒ¯å…¥æ™‚é–“ï¼š(å¤šç­†é‡ç–Š)\næ™‚é–“å€é–“ï¼š${unionStartStr} ~ ${unionEndStr}\né‡è¤‡æ™‚æ®µï¼š${unionStartStr} ~ ${unionEndStr}`;
                const ovBar = document.createElement('div');
                
				ovBar.className = 'tl-overlap';
                ovBar.style.left = `${startPct}%`;
                ovBar.style.width = `${widthPct}%`;
                ovBar.title = ovTooltip;
                track.appendChild(ovBar);
            });

            row.appendChild(track);
            container.appendChild(row);
        }
        
        dom.timelineSection.style.display = 'block';
    }

    function setupResizer(resizer) {
        let isResizing = false;
        let startX, startWidth;

        resizer.addEventListener('mousedown', function(e) {
            isResizing = true;
            startX = e.pageX;
            const currentWidthStr = getComputedStyle(document.documentElement).getPropertyValue('--label-width').trim();
            startWidth = parseInt(currentWidthStr, 10) || 280;
            
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize'; 
            e.preventDefault(); 
        });

        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            const diff = e.pageX - startX;
            const newWidth = Math.max(100, startWidth + diff);
            document.documentElement.style.setProperty('--label-width', `${newWidth}px`);
        });

        document.addEventListener('mouseup', function() {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = '';
            }
        });
    }

    dom.btnProcess.addEventListener('click', async () => {
        runProcess(false);
    });

    dom.btnMoneyProcess.addEventListener('click', async () => {
        runProcess(true);
    });
	
    function formatTimeNoMs(dateObj) {
        if (!dateObj || isNaN(dateObj.getTime())) return "";
        const pad = (n) => String(n).padStart(2, '0');
        return `${dateObj.getFullYear()}/${pad(dateObj.getMonth()+1)}/${pad(dateObj.getDate())} ${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}:${pad(dateObj.getSeconds())}`;
    }
	
	function formatDuration(ms) {
        let seconds = Math.floor(ms / 1000);
        let hours = Math.floor(seconds / 3600);
        seconds %= 3600;
        let minutes = Math.floor(seconds / 60);
        seconds %= 60;
        const pad = (n) => String(n).padStart(2, '0');
        return `${pad(hours)}æ™‚${pad(minutes)}åˆ†${pad(seconds)}ç§’`;
    }

    async function runProcess(isMoneySaving) {
        currentProcessingMode = isMoneySaving ? 'moneySaver' : 'original';
        generateTimeline();

        const ipCol = dom.selects.ip.value;
        const timeCol = dom.selects.time.value;
        const portCol = dom.selects.port.value;

        if (!ipCol || !timeCol) { alert("è«‹é¸æ“‡ IP èˆ‡æ™‚é–“æ¬„ä½"); return; }

        dom.btnProcess.disabled = true;
        dom.btnMoneyProcess.disabled = true;
        
        dom.btnPause.style.display = 'inline-block';
        dom.btnPause.innerText = 'â¸ æš«åœè™•ç†';
        dom.btnPause.className = 'btn btn-warning w-100'; 
        isPaused = false;
        
        dom.progressContainer.style.display = 'block';
        dom.resultSection.style.display = 'block';
        dom.resultBody.innerHTML = '';
        
		ispGroups = {}; 
        document.getElementById('ispSidebar').style.display = 'none'; 
		
        let exportData = [];
        window.finalProcessedData = [];
        firstDataBackup = null; 
        let processItems = [];
        
        if (isMoneySaving) {
            if (!savingsData) calculateSavings(); 
            processItems = savingsData; 
        } else {
            processItems = rawData.map(row => {
                const originalIP = row[ipCol] || '';
                const originalTime = row[timeCol];
                const formattedIP = portCol && row[portCol] ? `${originalIP}:${row[portCol]}` : originalIP;
                
                let dateObj = parseFlexibleDate(originalTime);
                let tMinus = "æ ¼å¼éŒ¯èª¤", tPlus = "æ ¼å¼éŒ¯èª¤";
                if (dateObj) {
                     const dMinus = new Date(dateObj.getTime() - 30 * 60000);
                     const dPlus = new Date(dateObj.getTime() + 30 * 60000);
                     tMinus = formatDate(dMinus);
                     tPlus = formatDate(dPlus);
                }
                return {
                    ip: originalIP,
                    formattedKey: formattedIP,
                    originalTimeStr: originalTime, 
                    originalTimes: [originalTime],
                    tMinus: tMinus,
                    tPlus: tPlus,
                    start: dateObj ? dateObj.getTime() - 30 * 60000 : 0,
                    end: dateObj ? dateObj.getTime() + 30 * 60000 : 0
                };
            });
        }

        const total = processItems.length;

        for (let i = 0; i < total; i++) {
            while (isPaused) await sleep(200);
			
            const item = processItems[i];
            const originalIP = isMoneySaving ? item.rawIP : item.ip; 
			const formattedIP = isMoneySaving ? item.key : item.formattedKey;

            let tMinus, tPlus, tMinusVisual, tPlusVisual, originalTimeDisplay;
            let durationHtml = ''; // ç”¨æ–¼å­˜æ”¾ç´…å­—æç¤º
            let tsStart = 0; // ç”¨æ–¼ç´€éŒ„å¯¦éš›é–‹å§‹æ™‚é–“æˆ³è¨˜ (çœéŒ¢æ¨¡å¼ç”¨)
            let tsEnd = 0;   // ç”¨æ–¼ç´€éŒ„å¯¦éš›çµæŸæ™‚é–“æˆ³è¨˜ (çœéŒ¢æ¨¡å¼ç”¨)
            
            if (isMoneySaving) {
                tsStart = item.start;
                tsEnd = item.end;
                const dStart = new Date(tsStart);
                const dEnd = new Date(tsEnd);
                tMinus = formatDate(dStart);
                tPlus = formatDate(dEnd);
                tMinusVisual = formatDateForDisplay(dStart);
                tPlusVisual = formatDateForDisplay(dEnd);
                
                originalTimeDisplay = `<div class="original-time-stack">` + 
                    item.originalTimes.map(t => {
                        let d = parseFlexibleDate(t);
                        let displayT = d ? formatTimeNoMs(d) : t;
                        return `<span class="tag-original">${escapeHtml(displayT)}</span>`;
                    }).join('') + 
                    `</div>`;

                // --- è¨ˆç®—æ™‚é–“å·®ä¸¦ç”Ÿæˆæç¤ºæ–‡å­— ---
                const diff = tsEnd - tsStart;
                const durationStr = formatDuration(diff);
                const oneHourMs = 3600000;

                if (diff > oneHourMs) {
                    const splitCount = Math.ceil(diff / oneHourMs);
                    durationHtml = `<div style="color: #dc3545; font-size: 0.85em; font-weight: bold; margin: 4px 0;">æ™‚é–“å€é–“ç‚º${durationStr} â†’ æ‹†åˆ†æˆ${splitCount}ç­†è³‡æ–™</div>`;
                } else {
                    durationHtml = `<div style="color: #dc3545; font-size: 0.85em; font-weight: bold; margin: 4px 0;">æ™‚é–“å€é–“ç‚º${durationStr}</div>`;
                }

            } else {
                tMinus = item.tMinus;
                tPlus = item.tPlus;
                
                if (tMinus !== "æ ¼å¼éŒ¯èª¤") {
                    const dStart = parseFlexibleDate(item.originalTimeStr); 
                    const dMinusD = new Date(dStart.getTime() - 30 * 60000);
                    const dPlusD = new Date(dStart.getTime() + 30 * 60000);
                    tMinusVisual = formatDateForDisplay(dMinusD);
                    tPlusVisual = formatDateForDisplay(dPlusD);
                } else {
                    tMinusVisual = ""; tPlusVisual = "";
                }
				
				let dOriginal = parseFlexibleDate(item.originalTimeStr);
                let cleanOriginalTime = dOriginal ? formatTimeNoMs(dOriginal) : item.originalTimeStr;
				
                originalTimeDisplay = `<div><span class="tag-original">åŸå§‹æ™‚é–“ï¼š${escapeHtml(cleanOriginalTime)}</span></div>`;
            }

            let ispResult = { original: "ç„¡æ•ˆIP", display: "æ ¼å¼éŒ¯èª¤", isMatched: false, source: 'none' };
            
            if (originalIP && isValidIP(originalIP)) {
                if (ipCache[originalIP]) {
                    ispResult = ipCache[originalIP];
					dom.statusEl.innerText = `ç•¶å‰ç‹€æ…‹: å¿«å–å‘½ä¸­ (${originalIP})`;
                } else {
                    ispResult = await fetchISP(originalIP);
					if (ispResult.source === 'ipwho.is') await sleep(500);
					else if (ispResult.source === 'ip-api') await sleep(1500);
                    ipCache[originalIP] = ispResult; 
                }
            }
			
			const rawKey = ispResult.original || "Unknown";
            if (!ispGroups[rawKey]) {
                ispGroups[rawKey] = {
                    display: ispResult.display, 
                    isError: !ispResult.success && ispResult.original !== "Unknown" && !ispResult.isMatched, 
                    indices: []
                };
            }
            ispGroups[rawKey].indices.push(i);

			let exportRow = {
				'é¡åˆ¥': 'IP',
				'é›»ä¿¡æ¥­è€…': ispResult.isMatched ? ispResult.display : ispResult.original,
				'IP:Port': formattedIP,
				'æ™‚é–“-30åˆ†': tMinus,
				'æ™‚é–“+30åˆ†': tPlus,
				'å‚™è¨»': 'é€šè¨Šä½¿ç”¨è€…è³‡æ–™'
			};
            
            // --- è‹¥ç‚ºçœéŒ¢æ¨¡å¼ï¼Œç´€éŒ„æ™‚é–“æˆ³è¨˜ä¾›åŒ¯å‡ºæ‹†åˆ†ä½¿ç”¨ ---
            if (isMoneySaving) {
                exportRow._tsStart = tsStart;
                exportRow._tsEnd = tsEnd;
            }
			
            exportData.push(exportRow);

			const tr = dom.resultBody.insertRow();
			tr.insertCell().innerText = i + 1;
			tr.insertCell().innerText = 'IP';
			tr.insertCell().innerHTML = renderIspCellHtml(ispResult, originalIP);
			tr.insertCell().innerText = formattedIP;
			
			const tdTime = tr.insertCell();
			tdTime.colSpan = 2;
            // --- æ’å…¥ durationHtml ---
			tdTime.innerHTML = `${originalTimeDisplay}
                                ${durationHtml}
								<div class="time-group">
									<div class="time-cell-half">
										<div class="text-visual">${tMinusVisual}</div>
										<div>${tMinus}</div>
									</div>
									<div class="time-cell-half">
										<div class="text-visual">${tPlusVisual}</div>
										<div>${tPlus}</div>
									</div>
								</div>`;
			tr.insertCell().innerText = 'é€šè¨Šä½¿ç”¨è€…è³‡æ–™';
			
			tr.insertCell().innerHTML = `
                <div class="btn-action-group">
                    <button type="button" class="btn btn-retry btn-action-sm" onclick="retryRow(this, '${originalIP}')">é‡å‘¼</button>
                    <button type="button" class="btn btn-delete btn-action-sm" onclick="deleteRow(this)">åˆªé™¤</button>
                </div>`;

			const percent = Math.round(((i + 1) / total) * 100);
			dom.progressBar.style.width = `${percent}%`;
			dom.progressText.innerText = `${percent}%`;
		}

        window.finalProcessedData = exportData;
        isProcessed = true;

        updateRowIndices();

        renderSidebar(); 

		if (typeof spriteState !== 'undefined') {
			spriteState.isBouncing = false;
			if (spriteState.rafId) cancelAnimationFrame(spriteState.rafId);
		}

		document.getElementById('minimizedSprite').style.display = 'none';
		document.getElementById('ispSidebar').style.display = 'flex';

        dom.statusEl.innerText = 'è™•ç†å®Œæˆ';
        dom.btnProcess.disabled = false;
        dom.btnMoneyProcess.disabled = false;
        dom.btnPause.style.display = 'none';
    }

    async function fetchISP(ip) {
		try {
			dom.delayNotice.innerText = "â€» ç‚ºé˜²æ­¢è¢«é– IPï¼Œæ¯ç­†æŸ¥è©¢é–“éš” 0.5 ç§’";
			dom.statusEl.innerText = `ç•¶å‰ API: ipwho.is (è™•ç† IP: ${ip})`;
			const response = await fetch(`https://ipwho.is/${ip}`);
			const data = await response.json();
			
			if (data.success) {
				const originalText = data.connection?.org || data.org || "Unknown";
				// const originalText = data.connection?.isp || data.isp || data.connection?.org || data.org || "Unknown";
				// å°ç£å›ºç¶²ç‚ºå°ç£å¤§å“¥å¤§é—œä¿‚ä¼æ¥­ï¼Œéš¸å±¬æ–¼å°ç£å¤§å“¥å¤§é›†åœ˜ï¼Œæ‰€ä»¥å–®çœ‹ISPæœƒéŒ¯
				const result = translateISP(originalText);
				return { 
					original: originalText, 
					display: result.text,
					isMatched: result.matched,
					source: 'ipwho.is',
					success: true
				};
			}
		} catch (e) { console.warn('ipwho.is å¤±æ•—', e); }

		try {
			dom.delayNotice.innerText = "â€» ç‚ºé˜²æ­¢è¢«é– IPï¼Œæ¯ç­†æŸ¥è©¢é–“éš” 1.5 ç§’";
			dom.statusEl.innerText = `ç•¶å‰ API: ip-api.com (å‚™æ´ä¸­: ${ip})`;
			const response = await fetch(`http://ip-api.com/json/${ip}?fields=status,isp,org`);
			const data = await response.json();
			
			if (data.status === 'success') {
				const originalText = data.isp || "Unknown";
				const result = translateISP(originalText);
				return { 
					original: originalText, 
					display: result.text,
					isMatched: result.matched, 
					source: 'ip-api',
					success: true
				};
			}
		} catch (e) { console.error('ip-api å¤±æ•—', e); }
		
		return { original: "Error", display: "æŸ¥è©¢å¤±æ•—", isMatched: false, source: 'none', success: false };
	}

    function translateISP(text) {
        const lower = text.toLowerCase();
        if (lower.includes("taiwan fixed network")) return { text: "å°ç£å›ºç¶²", matched: true };
        if (lower.includes("chunghwa") || lower.includes("hinet")) return { text: "ä¸­è¯é›»ä¿¡ç¶²è·¯", matched: true };
        if (lower.includes("taiwan mobile") || lower.includes("taiwanmobile")) return { text: "å°ç£å¤§å“¥å¤§", matched: true };
        if (lower.includes("far eastone") || lower.includes("fareastone") || lower.includes("far easttone")) return { text: "é å‚³é›»ä¿¡è‚¡ä»½æœ‰é™å…¬å¸", matched: true };
        
        if (text === "Error" || text === "ç„¡æ•ˆIP" || text === "Unknown") return { text: "æŸ¥è©¢å¤±æ•—", matched: false };
        
        return { text: text, matched: false };
    }

    function isValidIP(ip) { return /^[0-9.]/.test(ip) || /^[0-9a-fA-F:]/.test(ip); }
    function formatDate(date) {
        const pad = (n) => String(n).padStart(2, '0');
        return `${date.getFullYear()}${pad(date.getMonth()+1)}${pad(date.getDate())}${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`;
    }

    window.exportFile = function(type) {
        let rawData = window.finalProcessedData || [];
        if (rawData.length === 0) { alert("ç„¡è³‡æ–™å¯åŒ¯å‡º"); return; }
        
        // --- åŒ¯å‡ºå‰æª¢æŸ¥æ˜¯å¦éœ€è¦æ‹†åˆ†è³‡æ–™ (çœéŒ¢æ¨¡å¼è¶…é1å°æ™‚) ---
        let expandedData = [];
        const oneHourMs = 3600000;

        rawData.forEach(row => {
            // æª¢æŸ¥æ˜¯å¦æœ‰æ¨™è¨˜æ™‚é–“æˆ³è¨˜ (ç”± runProcess åœ¨çœéŒ¢æ¨¡å¼ä¸‹ç”¢ç”Ÿ) ä¸”é•·åº¦è¶…é 1 å°æ™‚
            if (row._tsStart && row._tsEnd && (row._tsEnd - row._tsStart > oneHourMs)) {
                let curr = row._tsStart;
                let end = row._tsEnd;
                
                while (curr < end) {
                    // ä¸‹ä¸€å€‹åˆ‡åˆ†é»ï¼šç›®å‰æ™‚é–“ + 1å°æ™‚ï¼Œæˆ–æ˜¯ç¸½çµæŸæ™‚é–“ (å–è¼ƒå°è€…)
                    let next = Math.min(curr + oneHourMs, end);
                    
                    // è¤‡è£½åŸå§‹è³‡æ–™
                    let newRow = Object.assign({}, row);
                    
                    // æ›´æ–°æ™‚é–“æ¬„ä½æ ¼å¼
                    newRow['æ™‚é–“-30åˆ†'] = formatDate(new Date(curr));
                    newRow['æ™‚é–“+30åˆ†'] = formatDate(new Date(next));
                    
                    // ç§»é™¤å…§éƒ¨ä½¿ç”¨çš„æ¨™è¨˜ï¼Œé¿å…åŒ¯å‡ºåˆ° Excel
                    delete newRow._tsStart;
                    delete newRow._tsEnd;
                    
                    expandedData.push(newRow);
                    
                    curr = next;
                }
            } else {
                // ä¸éœ€è¦æ‹†åˆ†ï¼Œç›´æ¥ä½¿ç”¨ï¼Œä½†è¦ç§»é™¤å…§éƒ¨æ¨™è¨˜
                let cleanRow = Object.assign({}, row);
                delete cleanRow._tsStart;
                delete cleanRow._tsEnd;
                expandedData.push(cleanRow);
            }
        });
        
        // å°‡è™•ç†å°è±¡æŒ‡å‘æ“´å±•å¾Œçš„è³‡æ–™
        rawData = expandedData;

        const needPad = document.getElementById('chkIpv6Pad').checked;
        const needUpper = document.getElementById('chkIpv6Upper').checked;
        const hasPort = dom.selects.port.value !== ""; 
        const needSplit = document.getElementById('chkSplitFile').checked;
        const splitBaseStr = document.getElementById('txtSplitBase').value;
        let splitBase = parseInt(splitBaseStr);
        if (isNaN(splitBase) || splitBase < 1) splitBase = 200; 

        const processedData = rawData.map(row => {
            let newRow = Object.assign({}, row);
            let ipStr = newRow['IP:Port'];

            if (ipStr && ipStr.indexOf(':') > -1) {
                let parts = ipStr.split(':');
                let ipSegments = hasPort ? parts.slice(0, -1) : parts;
                let portSegment = hasPort ? parts[parts.length - 1] : null;

                ipSegments = ipSegments.map(seg => {
                    if (seg.length === 0 || seg.includes('.')) return seg;
                    let newSeg = seg;
                    if (needPad) newSeg = newSeg.padStart(4, '0');
                    if (needUpper) newSeg = newSeg.toUpperCase();
                    return newSeg;
                });

                let formattedIP = ipSegments.join(':');
                if (hasPort && portSegment) formattedIP += ':' + portSegment;
                newRow['IP:Port'] = formattedIP;
            }
            return newRow;
        });
        
        const baseName = `result_${Date.now()}`;
        
        const downloadAnsi = (ws, filename) => {
            const csv = XLSX.utils.sheet_to_csv(ws);
            const data = (typeof cptable !== 'undefined') 
                         ? cptable.utils.encode(950, csv) 
                         : new TextEncoder().encode(csv); 
			const blob = new Blob([new Uint8Array(data)], { type: "application/octet-stream" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        if (needSplit && processedData.length > splitBase) {
            let partCount = 0;
            for (let i = 0; i < processedData.length; i += splitBase) {
                partCount++;
                const chunk = processedData.slice(i, i + splitBase);
                const ws_chunk = XLSX.utils.json_to_sheet(chunk, { skipHeader: true }); 
                
                setTimeout(() => {
                    if (type === 'csv') {
                        downloadAnsi(ws_chunk, `${baseName}_part${partCount}.csv`);
                    } else {
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws_chunk, "Result");
                        XLSX.writeFile(wb, `${baseName}_part${partCount}.xlsx`, { bookType: 'xlsx' });
                    }
                }, partCount * 500);
            }
            showToast(`å·²é–‹å§‹ä¸‹è¼‰ ${partCount} å€‹åˆ†å‰²æª”æ¡ˆ`);
        } else {
            const ws = XLSX.utils.json_to_sheet(processedData, { skipHeader: true }); 
            
            if (type === 'csv') {
                downloadAnsi(ws, `${baseName}.csv`);
            } else {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Result");
                XLSX.writeFile(wb, `${baseName}.${type}`, { bookType: 'xlsx' });
            }
        }
    }
	
    dom.btnPause.addEventListener('click', function() {
        isPaused = !isPaused;
        if (isPaused) {
            this.innerText = 'â–¶ æ¥çºŒè™•ç†';
            this.className = 'btn btn-success w-100';
        } else {
            this.innerText = 'â¸ æš«åœè™•ç†';
            this.className = 'btn btn-warning w-100';
        }
    });

    const helpModal = document.getElementById('helpModal');
    document.getElementById('btnHelp').addEventListener('click', () => helpModal.style.display = 'flex');
    helpModal.addEventListener('click', () => helpModal.style.display = 'none');
	
    function renderSidebar() {
        const container = document.getElementById('ispSidebarContent');
        container.innerHTML = '';

        const sortedKeys = Object.keys(ispGroups).sort((a, b) => {
            if (ispGroups[a].isError && !ispGroups[b].isError) return -1;
            if (!ispGroups[a].isError && ispGroups[b].isError) return 1;
            return a.localeCompare(b);
        });

        if (sortedKeys.length === 0) {
            container.innerHTML = '<div class="text-muted text-center mt-3">ç„¡è³‡æ–™</div>';
            return;
        }

        sortedKeys.forEach(rawKey => {
            const group = ispGroups[rawKey];
            const isErrorClass = group.isError ? 'is-error' : '';
            const div = document.createElement('div');
            div.className = `isp-group-item ${isErrorClass}`;
            
            let tagsHtml = '';
			group.indices.forEach(idx => {
                tagsHtml += `<span class="idx-tag" onclick="highlightRow(${idx})">${idx + 1}</span>`;
            });

            div.innerHTML = `
                <div class="isp-raw-name" title="${escapeHtml(rawKey)}">API: ${escapeHtml(rawKey)}</div>
                <input type="text" class="isp-edit-input" 
                       value="${escapeHtml(group.display)}" 
                       oninput="updateGlobalIspName('${escapeHtml(rawKey).replace(/'/g, "\\'")}', this.value)"
                       placeholder="è¼¸å…¥ä¸­æ–‡å°ç…§åç¨±">
                <div class="tag-container">${tagsHtml}</div>
            `;
            container.appendChild(div);
        });
    }

    window.updateGlobalIspName = function(rawKey, newName) {
        if (!ispGroups[rawKey]) return;

        ispGroups[rawKey].display = newName;

        const indices = ispGroups[rawKey].indices;
        const resultBody = document.getElementById('resultBody');
        
        indices.forEach(rowIndex => {
            if (resultBody.rows[rowIndex]) {
                const row = resultBody.rows[rowIndex];
                const cell = row.cells[2];
                const convertedSpan = cell.querySelector('.converted-data');
                if (convertedSpan) {
                    convertedSpan.innerText = `è½‰æ›ï¼š${newName}`;
                } else {
                     cell.innerHTML = cell.innerHTML.replace(/>[^<]+<\/div>$/, `>${escapeHtml(newName)}</div>`); 
                }
            }
            
            if (window.finalProcessedData && window.finalProcessedData[rowIndex]) {
                window.finalProcessedData[rowIndex]['é›»ä¿¡æ¥­è€…'] = newName;
            }
        });
    };

    window.highlightRow = function(rowIndex) {
        const row = document.getElementById('resultBody').rows[rowIndex];
        if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.style.backgroundColor = '#ffffd0';
            setTimeout(() => { row.style.backgroundColor = ''; }, 2000);
        }
    };
    
    const ispSidebar = document.getElementById('ispSidebar');
    const minimizedSprite = document.getElementById('minimizedSprite');
    const sidebarHeader = document.getElementById('sidebarHeader');

    window.toggleSidebar = function(show) {
        if (show) {
            // é–‹å•Ÿå´é‚Šæ¬„ï¼šåœæ­¢å½ˆå°„ï¼Œéš±è—åœ“åœˆ
            spriteState.isBouncing = false;
            if (spriteState.rafId) cancelAnimationFrame(spriteState.rafId);

            const rect = minimizedSprite.getBoundingClientRect();
            minimizedSprite.style.display = 'none';
            ispSidebar.style.display = 'flex';
            ispSidebar.style.left = rect.left + 'px';
            ispSidebar.style.top = rect.top + 'px';
            ensureInViewport(ispSidebar);
            
        } else {
            // é—œé–‰å´é‚Šæ¬„ï¼ˆé¡¯ç¤ºå°åœ“åœˆï¼‰ï¼šè¨­å®šåˆå§‹ä½ç½®ä¸¦é–‹å§‹å½ˆå°„
            const rect = ispSidebar.getBoundingClientRect();
            ispSidebar.style.display = 'none';
            minimizedSprite.style.display = 'flex';
            
            // åŒæ­¥ä½ç½®è®Šæ•¸
            spriteState.x = rect.left;
            spriteState.y = rect.top;
            
            // çµ¦äºˆä¸€å€‹éš¨æ©Ÿçš„åˆå§‹é€Ÿåº¦ (è®“å®ƒå™´å‡ºå»)
            spriteState.vx = 0;
            spriteState.vy = 0;
            
            ensureInViewport(minimizedSprite);
            
            // é›–ç„¶é€Ÿåº¦æ˜¯ 0 é‚„æ˜¯å¯ä»¥å‘¼å«ä¸€ä¸‹ update ä½ç½®ï¼Œä½†ä¸å•Ÿå‹•è¿´åœˆä»¥ç¯€çœè³‡æº
            minimizedSprite.style.left = spriteState.x + 'px';
            minimizedSprite.style.top = spriteState.y + 'px';
        }
    };

    let isDraggingSprite = false;
    minimizedSprite.addEventListener('click', function(e) {
        if (!isDraggingSprite) {
            toggleSidebar(true);
        }
        isDraggingSprite = false; 
    });

    function makeDraggable(element, handle, isSprite = false) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        let isDragStarted = false;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            // å…è¨±å³éµæˆ–ä¸­éµæ“ä½œä¸è§¸ç™¼æ‹–æ›³(é¸æ“‡æ€§)ï¼Œé€™è£¡ç¶­æŒåŸæ¨£åªæ“‹éå·¦éµ
            if (e.button !== 0) return;
            
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            if (isSprite) {
                spriteState.isBouncing = false;
                if (spriteState.rafId) cancelAnimationFrame(spriteState.rafId);
                // è¨˜éŒ„æŠ“å–æ™‚çš„æ»‘é¼ ä½ç½®ï¼Œç”¨æ–¼è¨ˆç®—æŠ•æ“²é€Ÿåº¦
                spriteState.lastMouseX = e.clientX;
                spriteState.lastMouseY = e.clientY;
            }

            isDragStarted = false;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            
            isDragStarted = true;
            if (isSprite) {
                isDraggingSprite = true;
                // --- è¨ˆç®—æŠ•æ“²é€Ÿåº¦ (ç•¶å‰ä½ç½® - ä¸Šæ¬¡ä½ç½®) ---
                spriteState.vx = e.clientX - spriteState.lastMouseX;
                spriteState.vy = e.clientY - spriteState.lastMouseY;
                spriteState.lastMouseX = e.clientX;
                spriteState.lastMouseY = e.clientY;
            }

            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            const newTop = (element.offsetTop - pos2);
            const newLeft = (element.offsetLeft - pos1);

            element.style.top = newTop + "px";
            element.style.left = newLeft + "px";
            
            // å¦‚æœæ˜¯ Spriteï¼ŒåŒæ­¥æ›´æ–°ç‰©ç†ä½ç½®è®Šæ•¸ï¼Œé¿å…æ”¾é–‹ç¬é–“è·³å‹•
            if (isSprite) {
                spriteState.x = newLeft;
                spriteState.y = newTop;
            }
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
            
            // --- æ”¾é–‹æ»‘é¼ å¾Œçš„ç‰©ç†è¡Œç‚º ---
            if (isSprite && isDragStarted) {
                // é™åˆ¶æœ€å¤§æŠ•æ“²é€Ÿåº¦
                spriteState.vx = Math.max(Math.min(spriteState.vx, 20), -20);
                spriteState.vy = Math.max(Math.min(spriteState.vy, 20), -20);
                
                // åªæœ‰ç•¶é€Ÿåº¦å¤ å¿«æ™‚(æœ‰ç”©å‹•)ï¼Œæ‰å•Ÿå‹•ç‰©ç†å‹•ç•«
                if (Math.abs(spriteState.vx) > 1 || Math.abs(spriteState.vy) > 1) {
                    spriteState.isBouncing = true;
                    runSpritePhysics();
                } else {
                    // æ²’ç”©å‹•å‰‡éœæ­¢
                    spriteState.vx = 0;
                    spriteState.vy = 0;
                    spriteState.isBouncing = false;
                }
            }
        }
    }

    makeDraggable(ispSidebar, sidebarHeader); 
    makeDraggable(minimizedSprite, minimizedSprite, true);

    function ensureInViewport(el) {
        const rect = el.getBoundingClientRect();
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        
        let newLeft = rect.left;
        let newTop = rect.top;

        if (newLeft < 0) newLeft = 10;
        if (newLeft + 50 > winW) newLeft = winW - 100;
        if (newTop < 0) newTop = 10;
        if (newTop + 50 > winH) newTop = winH - 100;

        el.style.left = newLeft + 'px';
        el.style.top = newTop + 'px';
    }
</script>
</body>
</html>
