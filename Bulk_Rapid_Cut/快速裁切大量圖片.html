<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片快速大量裁切工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #main-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            position: relative;
        }
        #control-panel {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 320px;
            background-color: white;
            padding: 2rem;
            box-shadow: 5px 0 15px -3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* 啟用滾動功能 */
        }
        #control-panel.visible {
            transform: translateX(0);
        }
        #toggle-btn {
            position: fixed;
            top: 2rem;
            left: 2rem;
            z-index: 20;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3b82f6;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease-in-out;
            cursor: pointer;
        }
        #toggle-btn.panel-visible {
            transform: translateX(320px);
        }
        #canvas-wrapper {
            position: relative;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        canvas {
            display: block;
        }
        #crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .crop-rect {
            position: absolute;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        .step-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .step-section h2 {
            font-weight: bold;
            color: #4b5563;
        }
        .step-section label, .step-section p {
            font-size: 0.875rem;
        }

        /* 新增：回到首頁按鈕固定於右下角 */
        .back-home-btn {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            z-index: 300;
            background: #2563eb;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 14px rgba(37,99,235,0.18);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        .back-home-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 6px 18px rgba(37,99,235,0.28);
        }
    </style>
</head>
<body>
    <div id="main-container">
        <!-- 顯示/隱藏控制面板的按鈕 -->
        <button id="toggle-btn">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- 左側控制台 -->
        <div id="control-panel">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">圖片快速大量裁切工具</h1>
            
            <div class="step-section">
                <h2>步驟 1: 設定儲存命名</h2>
                <div class="flex items-center gap-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="naming-type" value="time" checked class="form-radio text-blue-600 rounded-full">
                        <span class="ml-2 text-sm text-gray-700">時間命名</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="naming-type" value="name" class="form-radio text-blue-600 rounded-full">
                        <span class="ml-2 text-sm text-gray-700">固定名稱命名</span>
                    </label>
                </div>
                <div id="name-options" class="hidden">
                    <div class="flex items-center gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="name-position" value="prefix" checked class="form-radio text-blue-600 rounded-full">
                            <span class="ml-2 text-sm text-gray-700">固定名稱在前</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="name-position" value="suffix" class="form-radio text-blue-600 rounded-full">
                            <span class="ml-2 text-sm text-gray-700">固定名稱在後</span>
                        </label>
                    </div>
                    <input type="text" id="fixed-name-input" placeholder="請輸入固定名稱" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="step-section">
                <h2>步驟 2: 選擇圖片類型</h2>
                <select id="file-type-select" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="image/png">PNG (.png)</option>
                    <option value="image/jpeg">JPG (.jpg)</option>
                    <option value="image/gif">GIF (.gif)</option>
                </select>
            </div>

            <div class="step-section">
                <h2>步驟 3: 匯入圖片</h2>
                <label for="image-input" class="block text-sm font-medium text-gray-700 mb-2">點擊下方按鈕以匯入圖片</label>
                <input type="file" id="image-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer rounded-full p-2 border border-gray-300">
            </div>
            
            <div class="step-section">
                <h2>步驟 4: 啟動裁切</h2>
                <button id="start-crop-btn" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" disabled>
                    開始裁切
                </button>
                <div id="status-message" class="text-sm p-3 bg-blue-50 text-blue-800 rounded-lg text-center">
                    請匯入一張圖片
                </div>
            </div>

            <!-- 使用說明 -->
            <div class="step-section">
                <h2>使用說明</h2>
                <p class="text-gray-600 text-sm">
                    使用滑鼠滾輪<span class="font-bold text-black">放大/縮小</span>，點擊左鍵<span class="font-bold text-black">拖曳圖片</span><br>
                    <br>
                    裁切模式下，點擊並拖曳滑鼠以選擇裁切區域。<br>
                    完成後，請使用鍵盤：<br>
                    <span class="font-bold text-green-600">D鍵</span> 或 <span class="font-bold text-green-600">→鍵</span>：快速儲存圖片<br>
                    <span class="font-bold text-red-600">A鍵</span> 或 <span class="font-bold text-red-600">←鍵</span>：重新選擇裁切區域<br>
                    <span class="font-bold text-purple-600">X鍵</span>：切換裁切模式<br>
                </p>
            </div>
        </div>
        
        <!-- 右側畫布區域 -->
        <div id="canvas-container" class="w-full h-full flex flex-col items-center justify-center p-8">
            <div id="canvas-wrapper">
                <canvas id="main-canvas"></canvas>
                <div id="crop-overlay"></div>
            </div>
        </div>
    </div>

    <!-- 回到首頁按鈕 -->
    <a href="https://mygodcatisfat.github.io" class="back-home-btn" title="回到首頁">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h3m10-11v11a1 1 0 01-1 1h-3m-4 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1" />
        </svg>
        回到首頁
    </a>

    <script>
        // DOM 元素
        const imageInput = document.getElementById('image-input');
        const startCropBtn = document.getElementById('start-crop-btn');
        const mainCanvas = document.getElementById('main-canvas');
        const statusMessage = document.getElementById('status-message');
        const fileTypeSelect = document.getElementById('file-type-select');
        const nameOptions = document.getElementById('name-options');
        const fixedNameInput = document.getElementById('fixed-name-input');
        const namingRadios = document.querySelectorAll('input[name="naming-type"]');
        const cropOverlay = document.getElementById('crop-overlay');
        const controlPanel = document.getElementById('control-panel');
        const toggleBtn = document.getElementById('toggle-btn');
        const ctx = mainCanvas.getContext('2d');

        // 狀態變數
        let img = new Image();
        let scale = 1;
        let pan = { x: 0, y: 0 };
        let startPan = { x: 0, y: 0 };
        let isPan = false;
        let isImageLoaded = false;
        let isCropping = false;
        let isCropAreaSelected = false;
        let cropRect = { x: 0, y: 0, width: 0, height: 0 };
        let sequentialNumber = 1; // 裁切序號
        let startCropPoint = null;
        let isDrawingCrop = false;

        // 調整畫布尺寸以適應容器
        function resizeCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            mainCanvas.width = wrapper.clientWidth;
            mainCanvas.height = wrapper.clientHeight;
            if (isImageLoaded) {
                fitImageToCanvas();
            }
            draw();
        }

        // 將圖片填滿畫布
        function fitImageToCanvas() {
            const canvasRatio = mainCanvas.width / mainCanvas.height;
            const imageRatio = img.width / img.height;
            
            if (imageRatio > canvasRatio) {
                scale = mainCanvas.height / img.height;
                pan.x = (mainCanvas.width - img.width * scale) / 2;
                pan.y = 0;
            } else {
                scale = mainCanvas.width / img.width;
                pan.y = (mainCanvas.height - img.height * scale) / 2;
                pan.x = 0;
            }
        }
        
        // 監聽窗口大小變化
        window.addEventListener('resize', resizeCanvas);

        // 監聽命名方式的變化
        namingRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'name') {
                    nameOptions.classList.remove('hidden');
                } else {
                    nameOptions.classList.add('hidden');
                }
            });
        });

        // 圖片載入事件
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                img.onload = () => {
                    isImageLoaded = true;
                    sequentialNumber = 1; // 重置序號
                    startCropBtn.disabled = false;
                    statusMessage.textContent = '圖片載入成功。請使用滑鼠滾輪縮放或拖曳圖片。';
                    
                    resizeCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // 繪製圖片和裁切框
        function draw() {
            ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            if (isImageLoaded) {
                ctx.drawImage(img, pan.x, pan.y, img.width * scale, img.height * scale);
            }

            const rectElement = cropOverlay.querySelector('.crop-rect') || document.createElement('div');
            rectElement.className = 'crop-rect';
            
            if (isCropping && isDrawingCrop) {
                const x = Math.min(startCropPoint.x, event.offsetX);
                const y = Math.min(startCropPoint.y, event.offsetY);
                const width = Math.abs(event.offsetX - startCropPoint.x);
                const height = Math.abs(event.offsetY - startCropPoint.y);

                rectElement.style.left = `${x}px`;
                rectElement.style.top = `${y}px`;
                rectElement.style.width = `${width}px`;
                rectElement.style.height = `${height}px`;
                if (!cropOverlay.contains(rectElement)) {
                    cropOverlay.appendChild(rectElement);
                }
            } else if (isCropping && isCropAreaSelected) {
                rectElement.style.left = `${cropRect.x}px`;
                rectElement.style.top = `${cropRect.y}px`;
                rectElement.style.width = `${cropRect.width}px`;
                rectElement.style.height = `${cropRect.height}px`;
                if (!cropOverlay.contains(rectElement)) {
                    cropOverlay.appendChild(rectElement);
                }
            } else {
                if (cropOverlay.contains(rectElement)) {
                    rectElement.remove();
                }
            }
        }

        // 縮放功能
        mainCanvas.addEventListener('wheel', (e) => {
            if (!isImageLoaded || isCropping) return;
            e.preventDefault();
            const oldScale = scale;
            const zoomFactor = e.deltaY < 0 ? 1.1 : 1 / 1.1; // 放大或縮小
            scale *= zoomFactor;
            
            // 保持圖片中心點不變
            pan.x = e.offsetX - ((e.offsetX - pan.x) / oldScale) * scale;
            pan.y = e.offsetY - ((e.offsetY - pan.y) / oldScale) * scale;
            
            draw();
        });

        // 拖曳平移功能
        mainCanvas.addEventListener('mousedown', (e) => {
            if (!isImageLoaded || isCropping) return;
            isPan = true;
            startPan.x = e.offsetX - pan.x;
            startPan.y = e.offsetY - pan.y;
            mainCanvas.style.cursor = 'grabbing';
        });

        mainCanvas.addEventListener('mousemove', (e) => {
            if (isPan) {
                pan.x = e.offsetX - startPan.x;
                pan.y = e.offsetY - startPan.y;
                draw();
            }
        });

        mainCanvas.addEventListener('mouseup', () => {
            isPan = false;
            mainCanvas.style.cursor = 'move';
        });
        
        // 裁切模式下的滑鼠事件 (監聽在遮罩層上)
        cropOverlay.addEventListener('mousedown', (e) => {
            if (!isCropping) return;
            isCropAreaSelected = false;
            isDrawingCrop = true;
            startCropPoint = { x: e.offsetX, y: e.offsetY };
            statusMessage.textContent = '正在選擇裁切區域...';
        });

        cropOverlay.addEventListener('mousemove', (e) => {
            if (!isDrawingCrop) return;
            const x = Math.min(startCropPoint.x, e.offsetX);
            const y = Math.min(startCropPoint.y, e.offsetY);
            const width = Math.abs(e.offsetX - startCropPoint.x);
            const height = Math.abs(e.offsetY - startCropPoint.y);
            cropRect = { x, y, width, height };
            draw();
        });

        cropOverlay.addEventListener('mouseup', () => {
            if (!isDrawingCrop) return;
            isDrawingCrop = false;
            if (cropRect.width > 0 && cropRect.height > 0) {
                isCropAreaSelected = true;
                statusMessage.textContent = '已選擇裁切區域。請使用鍵盤控制。';
            } else {
                statusMessage.textContent = '裁切區域太小，請重新選擇。';
                resetCropMode();
            }
        });

        // 啟動/停止裁切模式
        startCropBtn.addEventListener('click', () => {
            toggleCropMode();
        });
        
        function toggleCropMode() {
            isCropping = !isCropping;
            isCropAreaSelected = false;
            isDrawingCrop = false;
            startCropPoint = null;
            if (isCropping) {
                startCropBtn.textContent = '停止裁切 (X)';
                statusMessage.textContent = '點擊並拖曳滑鼠以選擇裁切區域。';
                mainCanvas.style.cursor = 'crosshair';
                cropOverlay.style.pointerEvents = 'auto'; // Enable pointer events for overlay
            } else {
                startCropBtn.textContent = '開始裁切 (X)';
                statusMessage.textContent = '裁切模式已停止。現在可以拖曳或縮放圖片。';
                mainCanvas.style.cursor = 'move';
                cropOverlay.style.pointerEvents = 'none'; // Disable pointer events for overlay
            }
            draw();
        }

        // 鍵盤控制
        window.addEventListener('keydown', (e) => {
            if (!isImageLoaded) return;
            
            // 儲存
            if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
                if (isCropping && isCropAreaSelected) {
                    saveCroppedImage();
                }
            }
            // 重新選擇
            else if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
                if (isCropping && isCropAreaSelected) {
                    resetCropMode();
                }
            }
            // 切換裁切模式
            else if (e.key.toLowerCase() === 'x') {
                toggleCropMode();
            }
        });

        function resetCropMode() {
            isCropAreaSelected = false;
            isDrawingCrop = false;
            isCropping = true;
            statusMessage.textContent = '請重新選擇裁切區域。';
            mainCanvas.style.cursor = 'crosshair';
            draw(); // 清除裁切框
        }

        // 儲存圖片
        function saveCroppedImage() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // 根據裁切框調整新 canvas 尺寸
            tempCanvas.width = cropRect.width;
            tempCanvas.height = cropRect.height;
            
            // 轉換裁切區域的座標和尺寸到原始圖片的比例
            const sourceX = (cropRect.x - pan.x) / scale;
            const sourceY = (cropRect.y - pan.y) / scale;
            const sourceWidth = cropRect.width / scale;
            const sourceHeight = cropRect.height / scale;

            // 將裁切區域繪製到新 canvas
            tempCtx.drawImage(
                img,
                sourceX, sourceY, sourceWidth, sourceHeight,
                0, 0, tempCanvas.width, tempCanvas.height
            );

            // 產生檔名
            const namingType = document.querySelector('input[name="naming-type"]:checked').value;
            const fileType = fileTypeSelect.value;
            let fileName = '';

            if (namingType === 'time') {
                const now = new Date();
                const pad = (num) => num.toString().padStart(2, '0');
                const padSeq = (num) => num.toString().padStart(2, '0');
                const year = now.getFullYear();
                const month = pad(now.getMonth() + 1);
                const day = pad(now.getDate());
                const hours = pad(now.getHours());
                const minutes = pad(now.getMinutes());
                const seconds = pad(now.getSeconds());
                fileName = `${year}${month}${day}${hours}${minutes}${seconds}${padSeq(sequentialNumber)}`;
            } else {
                const namePosition = document.querySelector('input[name="name-position"]:checked').value;
                const fixedName = fixedNameInput.value || 'cropped-image';
                const padSeq = (num) => num.toString().padStart(8, '0');
                const seq = padSeq(sequentialNumber);
                if (namePosition === 'prefix') {
                    fileName = `${fixedName}${seq}`;
                } else {
                    fileName = `${seq}${fixedName}`;
                }
            }

            // 加上副檔名
            const extension = fileType.split('/')[1].replace('jpeg', 'jpg');
            fileName += `.${extension}`;

            // 觸發下載
            const dataURL = tempCanvas.toDataURL(fileType);
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            statusMessage.textContent = `圖片已下載：${fileName}`;
            sequentialNumber++; // 序號遞增
            resetCropMode(); // 重新進入裁切模式
        }

        // 控制面板顯示/隱藏功能
        let isPanelVisible = false;
        toggleBtn.addEventListener('click', () => {
            isPanelVisible = !isPanelVisible;
            if (isPanelVisible) {
                controlPanel.classList.add('visible');
                toggleBtn.classList.add('panel-visible');
            } else {
                controlPanel.classList.remove('visible');
                toggleBtn.classList.remove('panel-visible');
            }
        });
        
        // 頁面載入時先執行一次
        window.onload = resizeCanvas;
    </script>
</body>
</html>

