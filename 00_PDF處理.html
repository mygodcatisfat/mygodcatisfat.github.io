<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ç·¨è¼¯å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.296/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }

        .tab-button.active {
            @apply border-b-2 border-blue-500 text-blue-500 font-semibold;
        }

        .thumb-container::-webkit-scrollbar {
            height: 8px;
        }
        .thumb-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .thumb-container::-webkit-scrollbar-track {
            background-color: #e2e8f0;
            border-radius: 4px;
        }
        
        .cut-marker {
            width: 1.5rem;
            height: 1.5rem;
            background-color: white;
            border: 2px solid #60a5fa; /* Blue-400 */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .cut-marker:hover {
            transform: scale(1.1);
        }
        
        .cut-marker.active {
            background-color: #22c55e; /* Green-500 */
            border-color: #22c55e;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .split-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .split-overlay-content {
            position: relative;
        }

        .overlay-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            z-index: 110;
        }
        .overlay-nav-button.left {
            left: 20px;
        }
        .overlay-nav-button.right {
            right: 20px;
        }

        .sortable-item {
            cursor: grab;
        }

        .sortable-item:active {
            cursor: grabbing;
        }

        .info-tooltip-container {
            @apply relative ml-4;
        }
        .info-tooltip-icon {
            @apply text-gray-500 cursor-pointer text-xl flex items-center justify-center border border-gray-500 rounded-full w-6 h-6;
        }

        .selected-thumbnail {
            @apply ring-2 ring-blue-500;
        }

        /* æ–°å¢ï¼šå›åˆ°é¦–é æŒ‰éˆ•å›ºå®šæ–¼å³ä¸‹è§’ */
        .back-home-btn {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            z-index: 300;
            background: #2563eb;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 14px rgba(37,99,235,0.18);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        .back-home-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 6px 18px rgba(37,99,235,0.28);
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-10">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">PDF ç·¨è¼¯å·¥å…·</h1>

        <!-- æ–‡ä»¶ä¸Šå‚³å€å¡Š -->
        <div class="mb-8 p-6 border-2 border-dashed border-gray-300 rounded-lg text-center">
            <label for="fileInput" class="cursor-pointer text-blue-500 hover:text-blue-700">
                <p class="text-lg font-medium mb-2">é»æ“Šæ­¤è™•æˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p>
                <p id="fileStatus" class="text-sm text-gray-500">æ”¯æ´ .pdf æ ¼å¼</p>
            </label>
            <input type="file" id="fileInput" class="hidden" multiple accept=".pdf">
        </div>

        <!-- é ç±¤å°è¦½ -->
        <div class="flex border-b border-gray-200 mb-6 space-x-4">
            <button id="tabSplit" class="tab-button p-2 active">è£åˆ‡</button>
            <button id="tabMerge" class="tab-button p-2">åˆæˆ</button>
            <button id="tabPageNumber" class="tab-button p-2">ç·¨é ç¢¼</button>
            <button id="tabRotate" class="tab-button p-2">æ—‹è½‰</button>
        </div>

        <!-- è£åˆ‡åŠŸèƒ½å€å¡Š -->
        <div id="sectionSplit" class="tool-section">
            <div class="relative flex items-center mb-6">
                <h2 class="text-xl font-semibold">è£åˆ‡åŠŸèƒ½</h2>
                <div class="info-tooltip-container">
                    <span class="info-tooltip-icon" data-tooltip="split">ğŸ’¬</span>
                </div>
            </div>
            
            <div id="splitTextInput" class="mb-6 space-y-4">
                <div class="flex items-center space-x-4">
                    <label class="font-medium text-gray-700">å¾ç¬¬</label>
                    <input type="number" id="splitStartPage" placeholder="é ç¢¼" class="w-24 p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                    <label class="font-medium text-gray-700">é è£åˆ‡åˆ°ç¬¬</label>
                    <input type="number" id="splitEndPage" placeholder="é ç¢¼" class="w-24 p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                    <label class="font-medium text-gray-700">é </label>
                </div>
            </div>

            <div id="splitImageSelection" class="mb-6">
                <div id="splitThumbnails" class="flex items-center overflow-x-auto thumb-container pb-4 px-4">
                    <!-- PDF ç¸®åœ–æœƒåœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <div id="splitAction" class="flex justify-end mt-8">
                <button id="splitNext" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-600 transition disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- åˆæˆåŠŸèƒ½å€å¡Š -->
        <div id="sectionMerge" class="tool-section hidden">
            <div class="relative flex items-center mb-6">
                <h2 class="text-xl font-semibold">åˆæˆåŠŸèƒ½</h2>
                <div class="info-tooltip-container">
                    <span class="info-tooltip-icon" data-tooltip="merge">ğŸ’¬</span>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-4">æª”æ¡ˆæ¸…å–®</h3>
                <ul id="mergeFileList" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[100px] space-y-2">
                    <!-- æª”æ¡ˆæ¸…å–®æœƒåœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
                    <li class="text-gray-400 text-center py-4">è«‹åŒ¯å…¥ PDF æª”æ¡ˆä»¥é€²è¡Œåˆæˆ</li>
                </ul>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="deleteFile" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 transition disabled:bg-red-300 disabled:cursor-not-allowed" disabled>åˆªé™¤</button>
                <button id="mergeNext" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-600 transition disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- ç·¨é ç¢¼åŠŸèƒ½å€å¡Š -->
        <div id="sectionPageNumber" class="tool-section hidden">
            <div class="relative flex items-center mb-6">
                <h2 class="text-xl font-semibold">ç·¨é ç¢¼åŠŸèƒ½</h2>
                <div class="info-tooltip-container">
                    <span class="info-tooltip-icon" data-tooltip="pageNumber">ğŸ’¬</span>
                </div>
            </div>
            <div id="pageNumberInput" class="mb-6 space-y-4">
                <div class="flex items-center space-x-4">
                    <label class="font-medium text-gray-700">èµ·å§‹æ•¸å­—ï¼š</label>
                    <input type="number" id="pageNumberStart" placeholder="1" value="1" class="w-24 p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                </div>
                <div class="flex items-center space-x-4">
                    <label class="font-medium text-gray-700">å¾ç¬¬å¹¾é é–‹å§‹ç·¨ï¼š</label>
                    <input type="number" id="pageNumberFromPage" placeholder="é ç¢¼" class="w-24 p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                </div>
                <div class="flex items-center space-x-4">
                    <label class="font-medium text-gray-700">èµ·å§‹é ç¢¼ä½ç½®ï¼š</label>
                    <select id="pageNumberPosition" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                        <option value="left">å·¦</option>
                        <option value="right">å³</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end mt-8">
                <button id="pageNumberNext" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-600 transition disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- æ—‹è½‰åŠŸèƒ½å€å¡Š -->
        <div id="sectionRotate" class="tool-section hidden">
            <div class="relative flex items-center mb-6">
                <h2 class="text-xl font-semibold">æ—‹è½‰åŠŸèƒ½</h2>
                <div class="info-tooltip-container">
                    <span class="info-tooltip-icon" data-tooltip="rotate">ğŸ’¬</span>
                </div>
            </div>

            <div id="rotateImageSelection" class="mb-6">
                <div id="rotateThumbnails" class="flex items-center overflow-x-auto thumb-container pb-4 px-4">
                    <!-- PDF ç¸®åœ–æœƒåœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <div id="rotateAction" class="flex justify-end space-x-4 mt-8">
                <button id="rotatePageBtn" class="bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-yellow-600 transition disabled:bg-yellow-300 disabled:cursor-not-allowed" disabled>æ—‹è½‰</button>
                <button id="rotateNext" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-600 transition disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- å½ˆå‡ºå¼è¨Šæ¯/æç¤ºæ¡† (å–ä»£ alert()) -->
        <div id="messageBox" class="fixed inset-0 flex items-center justify-center p-4 z-[200] hidden">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
                <p id="messageText" class="text-lg font-medium mb-4"></p>
                <button id="messageOk" class="bg-blue-500 text-white px-6 py-2 rounded-lg">ç¢ºå®š</button>
            </div>
        </div>

        <!-- è£åˆ‡é»é¸æ“‡ç¢ºèªæ¡† -->
        <div id="splitSelectionBox" class="fixed inset-0 flex items-center justify-center p-4 z-[200] hidden">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm text-center">
                <p class="text-lg font-medium mb-4">å·²é¸æ“‡è¶…éå…©å€‹è£åˆ‡é»ï¼Œè«‹é¸æ“‡æ“ä½œï¼š</p>
                <div class="flex flex-col space-y-2">
                    <button id="selectFirst" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">åˆªé™¤å‰è£åˆ‡é»</button>
                    <button id="selectLast" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition">åˆªé™¤å¾Œè£åˆ‡é»</button>
                    <button id="selectCancel" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šå…¨è¢å¹•æç¤ºå½ˆçª— -->
        <div id="tooltipModal" class="fixed inset-0 flex items-center justify-center p-4 z-[200] hidden bg-gray-900 bg-opacity-70 backdrop-blur-sm">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full">
                <h3 id="tooltipTitle" class="text-2xl font-bold text-blue-600 mb-4"></h3>
                <div id="tooltipContentArea" class="prose max-w-none text-gray-800">
                    <!-- Content will be injected here dynamically -->
                </div>
                <div class="mt-6 text-right">
                    <button id="tooltipOk" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">é—œé–‰</button>
                </div>
            </div>
        </div>

        <!-- å…¨è¢å¹•é è¦½è¦–çª— -->
        <div id="fullScreenPreview" class="split-overlay hidden">
            <div class="split-overlay-content relative">
                <button id="previewPrev" class="overlay-nav-button left">â®</button>
                <img id="previewImage" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-lg" src="" alt="PDF Preview">
                <button id="previewNext" class="overlay-nav-button right">â¯</button>
            </div>
        </div>
    </div>

    <!-- å›åˆ°é¦–é æŒ‰éˆ• -->
    <a href="https://mygodcatisfat.github.io" class="back-home-btn" title="å›åˆ°é¦–é ">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h3m10-11v11a1 1 0 01-1 1h-3m-4 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1" />
        </svg>
        å›åˆ°é¦–é 
    </a>

<script>
    // è¨­å®š PDF.js worker çš„è·¯å¾‘
	const pdfjsLib = window["pdfjsLib"];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.296/pdf.worker.min.js'; //2.16.105

    // å–å¾— HTML å…ƒç´ 
    const fileInput = document.getElementById('fileInput');
    const tabs = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('.tool-section');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageOk = document.getElementById('messageOk');
    const fileStatus = document.getElementById('fileStatus');

    const splitTextInput = document.getElementById('splitTextInput');
    const splitImageSelection = document.getElementById('splitImageSelection');
    const splitStartPage = document.getElementById('splitStartPage');
    const splitEndPage = document.getElementById('splitEndPage');
    const splitThumbnails = document.getElementById('splitThumbnails');
    const splitNextBtn = document.getElementById('splitNext');
    const splitSelectionBox = document.getElementById('splitSelectionBox');

    const mergeFileList = document.getElementById('mergeFileList');
    const deleteFileBtn = document.getElementById('deleteFile');
    const mergeNextBtn = document.getElementById('mergeNext');
    
    const pageNumberStart = document.getElementById('pageNumberStart');
    const pageNumberFromPage = document.getElementById('pageNumberFromPage');
    const pageNumberPosition = document.getElementById('pageNumberPosition');
    const pageNumberNextBtn = document.getElementById('pageNumberNext');

    const rotateThumbnails = document.getElementById('rotateThumbnails');
    const rotatePageBtn = document.getElementById('rotatePageBtn');
    const rotateNextBtn = document.getElementById('rotateNext');

    const tooltipModal = document.getElementById('tooltipModal');
    const tooltipTitle = document.getElementById('tooltipTitle');
    const tooltipContentArea = document.getElementById('tooltipContentArea');
    const tooltipOk = document.getElementById('tooltipOk');

    const fullScreenPreview = document.getElementById('fullScreenPreview');
    const previewImage = document.getElementById('previewImage');
    const previewPrevBtn = document.getElementById('previewPrev');
    const previewNextBtn = document.getElementById('previewNext');

    let currentMode = 'split';
    let loadedPDF = null;
    let splitPoints = [];
    let filesForMerge = [];
    let selectedFileIndex = -1;
    let fullScreenPDF = null;
    let fullScreenPage = 0;
    let rotateRotations = [];
    let selectedRotatePage = -1;

    // æç¤ºå…§å®¹è³‡æ–™
    const tooltipData = {
        split: {
            title: 'è£åˆ‡åŠŸèƒ½èªªæ˜',
            content: `
                <p>åŒ¯å…¥ PDF å¾Œï¼Œæ‚¨å¯ä»¥é€é<strong class="text-green-500">åœ–åƒä»‹é¢</strong>æˆ–<strong class="text-green-500">è¼¸å…¥æ¡†</strong>é¸æ“‡è£åˆ‡ç¯„åœï¼Œå…©è€…æœƒè‡ªå‹•åŒæ­¥ã€‚</p>
                <p>é»æ“Š<strong class="text-green-500">ç¶ è‰²æ¨™è¨˜</strong>æˆ–åœ¨è¼¸å…¥æ¡†ä¸­è¼¸å…¥é ç¢¼ä¾†é¸æ“‡è£åˆ‡é»ã€‚</p>
                <p>ç•¶æ‚¨é¸æ“‡è¶…éå…©å€‹è£åˆ‡é»æ™‚ï¼Œç³»çµ±æœƒæç¤ºæ‚¨é¸æ“‡ä¿ç•™<strong class="text-blue-500">æœ€å‰</strong>æˆ–<strong class="text-red-500">æœ€å¾Œ</strong>çš„è£åˆ‡é»ã€‚</p>
                <p><strong class="text-green-500">è£åˆ‡é»æ¨™è¨˜</strong>ï¼š</p>
                <ul class="list-disc list-inside">
                    <li>ç¬¬ä¸€é **å‰**çš„è£åˆ‡é»ä»£è¡¨å¾ç¬¬ä¸€é é–‹å§‹ã€‚</li>
                    <li>æœ€å¾Œä¸€é **å¾Œ**çš„è£åˆ‡é»ä»£è¡¨è£åˆ‡åˆ°æœ€å¾Œä¸€é ã€‚</li>
                </ul>
            `
        },
        merge: {
            title: 'åˆæˆåŠŸèƒ½èªªæ˜',
            content: `
                <p>æ‚¨å¯ä»¥åŒ¯å…¥<strong class="text-blue-500">å¤šå€‹</strong> PDF æª”æ¡ˆã€‚</p>
                <p>é€é**é»æ“Š**æˆ–**æ‹–æ›³**æ¸…å–®ä¾†èª¿æ•´æª”æ¡ˆé †åºã€‚</p>
                <p>é»æ“Šæ¸…å–®ä¸­çš„æª”æ¡ˆå¯å±•é–‹<strong class="text-green-500">é è¦½</strong>ã€‚</p>
                <p>é è¦½åœ–æ”¯æ´**æ©«å‘æ»¾å‹•**ï¼Œé»æ“Šå¯é–‹å•Ÿ**å…¨è¢å¹•é è¦½**ã€‚</p>
                <p>ä½¿ç”¨<strong class="text-green-500">éµç›¤</strong>å¿«æ·éµï¼š</p>
                <ul class="list-disc list-inside">
                    <li>æŒ‰ <strong class="text-red-500">Delete</strong> éµï¼šåˆªé™¤é¸å–çš„æª”æ¡ˆã€‚</li>
                    <li>æŒ‰ <strong class="text-blue-500">ä¸Š/ä¸‹ç®­é ­</strong> éµï¼šç§»å‹•é¸å–æª”æ¡ˆçš„é †åºã€‚</li>
                </ul>
            `
        },
        pageNumber: {
            title: 'ç·¨é ç¢¼åŠŸèƒ½èªªæ˜',
            content: `
                <p>è«‹åŒ¯å…¥ PDF æª”æ¡ˆï¼Œç„¶å¾Œè¨­å®šç·¨ç¢¼çš„**èµ·å§‹æ•¸å­—**ã€**èµ·å§‹é ç¢¼**åŠ**é ç¢¼ä½ç½®**ã€‚</p>
                <p>é ç¢¼å°‡æœƒå¾æ‚¨æŒ‡å®šçš„é ç¢¼é–‹å§‹ä¾åºç·¨å¯«ï¼Œä¸¦åœ¨é é¢å·¦å³<strong class="text-green-500">äº¤æ›¿å‡ºç¾</strong>ã€‚</p>
                <p>ä¾‹å¦‚ï¼šè‹¥èµ·å§‹ä½ç½®è¨­å®šç‚ºã€Œå·¦ã€ï¼Œå‰‡ç¬¬ä¸€çµ„é ç¢¼æœƒå‡ºç¾åœ¨å·¦ä¸‹è§’ï¼Œç¬¬äºŒçµ„æœƒå‡ºç¾åœ¨å³ä¸‹è§’ï¼Œä¾æ­¤é¡æ¨ã€‚</p>
            `
        },
        rotate: {
            title: 'æ—‹è½‰åŠŸèƒ½èªªæ˜',
            content: `
                <p>è«‹åŒ¯å…¥ PDF æª”æ¡ˆï¼Œç„¶å¾Œé»æ“Šé é¢ç¸®åœ–ä¾†é¸å–ã€‚</p>
                <p>é»æ“Š<strong class="text-green-500">ã€Œæ—‹è½‰ã€</strong>æŒ‰éˆ•æˆ–æŒ‰ä¸‹éµç›¤ **<strong class="text-red-500">R</strong>** éµ**ï¼Œå³å¯å°‡é¸å–çš„é é¢é †æ™‚é‡æ—‹è½‰ 90 åº¦ã€‚</p>
                <p>æ‚¨å¯ä»¥é‡è¤‡æ“ä½œä¾†é”åˆ°æ‰€éœ€çš„æ—‹è½‰è§’åº¦ã€‚</p>
            `
        }
    };

    // é¡¯ç¤ºè¨Šæ¯æ¡†
    function showMessage(text) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
    }

    messageOk.addEventListener('click', () => {
        messageBox.classList.add('hidden');
    });

    // é¡¯ç¤ºæç¤ºå½ˆçª—
    function showTooltip(mode) {
        const data = tooltipData[mode];
        if (data) {
            tooltipTitle.textContent = data.title;
            tooltipContentArea.innerHTML = data.content;
            tooltipModal.classList.remove('hidden');
        }
    }

    // é—œé–‰æç¤ºå½ˆçª—
    tooltipOk.addEventListener('click', () => {
        tooltipModal.classList.add('hidden');
    });

    // è™•ç†æç¤ºåœ–ç¤ºé»æ“Šäº‹ä»¶
    document.querySelectorAll('.info-tooltip-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            const mode = icon.dataset.tooltip;
            showTooltip(mode);
        });
    });

    // åˆ‡æ›é ç±¤
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            sections.forEach(s => s.classList.add('hidden'));
            const sectionId = `section${tab.id.replace('tab', '')}`;
            document.getElementById(sectionId).classList.remove('hidden');
            currentMode = tab.id.replace('tab', '').toLowerCase();
            fileStatus.textContent = 'æ”¯æ´ .pdf æ ¼å¼';
            fileInput.value = '';
            
            if (currentMode === 'pagenumber') {
                // ä¿®æ­£ï¼šç•¶åˆ‡æ›åˆ°æ­¤é ç±¤æ™‚ï¼Œæ ¹æ“š loadedPDF çš„ç‹€æ…‹ä¾†ç¦ç”¨æˆ–å•Ÿç”¨æŒ‰éˆ•
                pageNumberNextBtn.disabled = loadedPDF === null;
            } else if (currentMode === 'merge') {
                mergeNextBtn.disabled = filesForMerge.length === 0;
            } else if (currentMode === 'split') {
                splitNextBtn.disabled = loadedPDF === null || splitPoints.length !== 2;
            } else if (currentMode === 'rotate') {
                rotateNextBtn.disabled = loadedPDF === null;
            }
        });
    });

    // è™•ç†æª”æ¡ˆåŒ¯å…¥
    fileInput.addEventListener('change', async (event) => {
        const files = event.target.files;
        if (!files.length) {
            fileStatus.textContent = 'æ”¯æ´ .pdf æ ¼å¼';
            return;
        }
        
        if (currentMode === 'split' || currentMode === 'pagenumber' || currentMode === 'rotate') {
            if (files.length > 1) {
                showMessage('æ­¤åŠŸèƒ½ä¸€æ¬¡åªèƒ½è™•ç†ä¸€å€‹PDFæª”æ¡ˆã€‚');
                fileInput.value = '';
                return;
            }
            loadedPDF = null;
            const arrayBuffer = await files[0].arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            loadedPDF = pdfDoc;
            fileStatus.textContent = `å·²è¼‰å…¥æª”æ¡ˆï¼š${files[0].name}`;
            
            if (currentMode === 'split') {
                splitPoints = [];
                await renderSplitThumbnails(pdfDoc);
                updateSplitUI();
            } else if (currentMode === 'pagenumber') {
                // ä¿®æ­£ï¼šè¼‰å…¥æª”æ¡ˆå¾Œå•Ÿç”¨ç·¨é ç¢¼çš„ã€Œä¸‹ä¸€æ­¥ã€æŒ‰éˆ•
                pageNumberNextBtn.disabled = false;
                pageNumberFromPage.placeholder = `1 - ${loadedPDF.numPages}`;
            } else if (currentMode === 'rotate') {
                rotateRotations = Array(loadedPDF.numPages).fill(0);
                await renderRotateThumbnails(pdfDoc);
                rotateNextBtn.disabled = false;
                rotatePageBtn.disabled = true; // Initially disabled until a page is selected
            }

        } else if (currentMode === 'merge') {
            await handleMergeFiles(files);
            fileStatus.textContent = `å·²è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆã€‚`;
        } else {
            showMessage('è«‹é¸æ“‡é ç±¤ä¾†åŒ¯å…¥æª”æ¡ˆã€‚');
            fileInput.value = '';
        }
    });

    // ==================== è£åˆ‡åŠŸèƒ½ ====================

    // æ¸²æŸ“ PDF ç¸®åœ–
    async function renderSplitThumbnails(pdfDoc) {
        splitThumbnails.innerHTML = '';
        const numPages = pdfDoc.numPages;

        const cutMarkerStart = document.createElement('div');
        cutMarkerStart.className = 'cut-marker mx-2 flex-shrink-0';
        cutMarkerStart.dataset.page = 0;
        cutMarkerStart.addEventListener('click', () => toggleSplitPoint(0));
        splitThumbnails.appendChild(cutMarkerStart);

        for (let i = 1; i <= numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 0.3 });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const context = canvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;

            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'relative flex-shrink-0 p-2 border border-gray-200 rounded-md';
            const pageNum = document.createElement('div');
            pageNum.textContent = i;
            pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
            
            thumbWrapper.appendChild(canvas);
            thumbWrapper.appendChild(pageNum);
            splitThumbnails.appendChild(thumbWrapper);
            
            canvas.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));

            if (i < numPages) {
                const cutMarker = document.createElement('div');
                cutMarker.className = 'cut-marker mx-2 flex-shrink-0';
                cutMarker.dataset.page = i;
                cutMarker.addEventListener('click', () => toggleSplitPoint(parseInt(cutMarker.dataset.page)));
                splitThumbnails.appendChild(cutMarker);
            }
        }

        const cutMarkerEnd = document.createElement('div');
        cutMarkerEnd.className = 'cut-marker mx-2 flex-shrink-0';
        cutMarkerEnd.dataset.page = numPages;
        cutMarkerEnd.addEventListener('click', () => toggleSplitPoint(numPages));
        splitThumbnails.appendChild(cutMarkerEnd);
    }

    function toggleSplitPoint(page) {
        const index = splitPoints.indexOf(page);
        if (index > -1) {
            splitPoints.splice(index, 1);
        } else {
            if (splitPoints.length >= 2) {
                splitSelectionBox.classList.remove('hidden');
                document.getElementById('selectFirst').onclick = () => {
                    splitPoints.shift();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectLast').onclick = () => {
                    splitPoints.pop();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectCancel').onclick = () => {
                    splitSelectionBox.classList.add('hidden');
                };
                return;
            }
            splitPoints.push(page);
            splitPoints.sort((a, b) => a - b);
        }
        updateSplitUI();
    }

    function updateSplitUI() {
        const cutMarkers = document.querySelectorAll('.cut-marker');
        cutMarkers.forEach(marker => {
            const page = parseInt(marker.dataset.page);
            if (splitPoints.includes(page)) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });

        if (splitPoints.length === 2) {
            splitStartPage.value = splitPoints[0] + 1;
            splitEndPage.value = splitPoints[1];
        } else {
            splitStartPage.value = '';
            splitEndPage.value = '';
        }

        splitNextBtn.disabled = splitPoints.length !== 2;
    }
    
    splitStartPage.addEventListener('input', updateSplitPointsFromText);
    splitEndPage.addEventListener('input', updateSplitPointsFromText);

    function updateSplitPointsFromText() {
        if (!loadedPDF) {
            showMessage('è«‹å…ˆåŒ¯å…¥ PDF æª”æ¡ˆã€‚');
            splitStartPage.value = '';
            splitEndPage.value = '';
            splitNextBtn.disabled = true;
            return;
        }

        const start = parseInt(splitStartPage.value);
        const end = parseInt(splitEndPage.value);
        const numPages = loadedPDF.numPages;

        splitPoints = [];

        if (isNaN(start) || start < 1 || start > numPages) {
            splitNextBtn.disabled = true;
            return;
        }
        
        if (isNaN(end) || end < 1 || end > numPages) {
            splitNextBtn.disabled = true;
            return;
        }

        if (start > end) {
            showMessage('çµæŸé ç¢¼ä¸èƒ½å°æ–¼èµ·å§‹é ç¢¼ã€‚');
            splitNextBtn.disabled = true;
            return;
        }

        splitPoints.push(start - 1);
        splitPoints.push(end);
        updateSplitUI();
    }

    // ä¸‹ä¸€æ­¥ - è£åˆ‡
    splitNextBtn.addEventListener('click', async () => {
        const file = fileInput.files[0];
        if (!file || splitPoints.length !== 2) {
            showMessage('è«‹åŒ¯å…¥PDFæª”æ¡ˆä¸¦é¸æ“‡2å€‹è£åˆ‡é»ã€‚');
            return;
        }

        const startPage = splitPoints[0] + 1;
        const endPage = splitPoints[1];

        if (startPage > endPage) {
            showMessage('èµ·å§‹é ç¢¼ä¸èƒ½å¤§æ–¼çµæŸé ç¢¼ã€‚');
            return;
        }

        const actionArea = document.getElementById('splitAction');
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="splitFilename" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400" value="åˆ†å‰²-${formatDate(new Date())}">
                </div>
                <button id="exportSplit" class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-600 transition w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;

        document.getElementById('exportSplit').onclick = async () => {
            try {
                const fileToUse = fileInput.files[0];
				if (!fileToUse) {
					showMessage('æ‰¾ä¸åˆ°å·²è¼‰å…¥çš„æª”æ¡ˆï¼Œè«‹é‡æ–°åŒ¯å…¥ PDFã€‚');
					return;
				}

				// å„ªå…ˆä½¿ç”¨ç›®å‰çš„ splitPointsï¼ˆç•¶ä½¿ç”¨è€…é€éç¸®åœ–é»é¸ï¼‰ï¼Œè‹¥æ²’æœ‰å† fallback åˆ°è¼¸å…¥æ¬„ä½
				let startPage, endPage;
				if (Array.isArray(splitPoints) && splitPoints.length === 2) {
					startPage = splitPoints[0] + 1;
					endPage = splitPoints[1];
				} else {
					startPage = parseInt(splitStartPage.value, 10);
					endPage = parseInt(splitEndPage.value, 10);
				}

				if (isNaN(startPage) || isNaN(endPage)) {
					showMessage('è«‹é¸æ“‡æˆ–è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹èˆ‡çµæŸé ç¢¼ã€‚');
					return;
				}
				if (startPage > endPage) {
					showMessage('èµ·å§‹é ç¢¼ä¸èƒ½å¤§æ–¼çµæŸé ç¢¼ã€‚');
					return;
				}
			
				const pdfBytes = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const newPdfDoc = await PDFLib.PDFDocument.create();

                const pagesToKeep = Array.from({ length: endPage - startPage + 1 }, (_, i) => i + startPage - 1);
                const pages = await newPdfDoc.copyPages(pdfDoc, pagesToKeep);
                pages.forEach(page => newPdfDoc.addPage(page));

                const newPdfBytes = await newPdfDoc.save();
                const filename = document.getElementById('splitFilename').value;
                downloadPDF(newPdfBytes, filename);
                
                showMessage('PDF è£åˆ‡ä¸¦åŒ¯å‡ºæˆåŠŸï¼');

            } catch (error) {
                console.error('Error splitting PDF:', error);
                showMessage('PDF è£åˆ‡æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
            }
        };
    });

    // ==================== åˆæˆåŠŸèƒ½ ====================

    // è™•ç†åˆæˆæª”æ¡ˆåŒ¯å…¥
    async function handleMergeFiles(files) {
        for (const file of files) {
            filesForMerge.push(file);
        }
        renderMergeFileList();
        mergeNextBtn.disabled = filesForMerge.length === 0;
    }

    // æ¸²æŸ“åˆæˆæª”æ¡ˆæ¸…å–®
    function renderMergeFileList() {
        mergeFileList.innerHTML = '';
        if (filesForMerge.length === 0) {
            mergeFileList.innerHTML = '<li class="text-gray-400 text-center py-4">è«‹åŒ¯å…¥ PDF æª”æ¡ˆä»¥é€²è¡Œåˆæˆ</li>';
            deleteFileBtn.disabled = true;
            mergeNextBtn.disabled = true;
            return;
        }

        filesForMerge.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'sortable-item p-3 border rounded-md bg-white hover:bg-gray-50 flex flex-col transition';
            li.draggable = true;
            li.dataset.index = index;

            // æª”æ¡ˆè³‡è¨Š
            const fileHeader = document.createElement('div');
            fileHeader.className = 'flex items-center justify-between mb-2';

            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            const orderNumber = document.createElement('div');
            orderNumber.className = 'bg-blue-500 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold text-lg mr-4 flex-shrink-0';
            orderNumber.textContent = index + 1;
            const fileNameSpan = document.createElement('span');
            fileNameSpan.textContent = file.name;
            fileInfo.appendChild(orderNumber);
            fileInfo.appendChild(fileNameSpan);

            fileHeader.appendChild(fileInfo);
            li.appendChild(fileHeader);
            
            // é è¦½å€å¡Š
            const previewContainer = document.createElement('div');
            previewContainer.className = 'thumb-container overflow-x-auto flex flex-nowrap space-x-2 hidden';
            li.appendChild(previewContainer);

            li.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', index);
            });
            li.addEventListener('dragover', (e) => e.preventDefault());
            li.addEventListener('drop', (e) => {
                e.preventDefault();
                const fromIndex = e.dataTransfer.getData('text/plain');
                const toIndex = index;
                const fileToMove = filesForMerge.splice(fromIndex, 1)[0];
                filesForMerge.splice(toIndex, 0, fileToMove);
                renderMergeFileList();
            });

            li.addEventListener('click', async (event) => {
                event.stopPropagation();
                const isSelected = li.classList.contains('ring-2');

                document.querySelectorAll('.sortable-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-blue-500');
                    const container = item.querySelector('.thumb-container');
                    if (container) {
                        container.classList.add('hidden');
                    }
                });
                
                if (!isSelected) {
                    li.classList.add('ring-2', 'ring-blue-500');
                    selectedFileIndex = index;
                    deleteFileBtn.disabled = false;
                    await renderPreviewThumbnails(file, previewContainer);
                    previewContainer.classList.remove('hidden');
                } else {
                    selectedFileIndex = -1;
                    deleteFileBtn.disabled = true;
                }
            });

            mergeFileList.appendChild(li);
        });
        
        if (selectedFileIndex !== -1 && filesForMerge.length > 0) {
             document.querySelectorAll('.sortable-item')[selectedFileIndex].classList.add('ring-2', 'ring-blue-500');
        } else {
             selectedFileIndex = -1;
             deleteFileBtn.disabled = true;
        }
    }

    async function renderPreviewThumbnails(file, container) {
        container.innerHTML = '';
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            const numPagesToPreview = pdfDoc.numPages;
            for (let i = 1; i <= numPagesToPreview; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 0.2 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                const renderContext = { canvasContext: context, viewport: viewport };
                await page.render(renderContext).promise;

                const thumbWrapper = document.createElement('div');
                thumbWrapper.className = 'flex-shrink-0 p-2 border rounded-md cursor-pointer hover:bg-gray-100 transition';
                const pageNum = document.createElement('div');
                pageNum.textContent = `é ç¢¼ ${i}`;
                pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
                thumbWrapper.appendChild(canvas);
                thumbWrapper.appendChild(pageNum);
                container.appendChild(thumbWrapper);
                
                thumbWrapper.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));
            }
        } catch (error) {
            console.error('Error loading PDF for preview:', error);
            showMessage('é è¦½æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
        }
    }

    // åˆªé™¤æª”æ¡ˆ
    deleteFileBtn.addEventListener('click', () => {
        if (selectedFileIndex !== -1) {
            filesForMerge.splice(selectedFileIndex, 1);
            selectedFileIndex = -1;
            renderMergeFileList();
        }
    });

    // ä¸‹ä¸€æ­¥ - åˆæˆ
    mergeNextBtn.addEventListener('click', async () => {
        if (filesForMerge.length === 0) {
            showMessage('è«‹åŒ¯å…¥è‡³å°‘ä¸€å€‹æª”æ¡ˆé€²è¡Œåˆæˆã€‚');
            return;
        }

        const actionArea = document.getElementById('mergeNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="mergeFilename" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400" value="åˆæˆ-${formatDate(new Date())}">
                </div>
                <button id="exportMerge" class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-600 transition w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;

        document.getElementById('exportMerge').addEventListener('click', async () => {
            try {
                const mergedPdf = await PDFLib.PDFDocument.create();
                for (const file of filesForMerge) {
                    const pdfBytes = await file.arrayBuffer();
                    const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                    const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const mergedPdfBytes = await mergedPdf.save();
                const filename = document.getElementById('mergeFilename').value;
                downloadPDF(mergedPdfBytes, filename);
                
                showMessage('PDF åˆæˆä¸¦åŒ¯å‡ºæˆåŠŸï¼');

            } catch (error) {
                console.error('Error merging PDFs:', error);
                showMessage('PDF åˆæˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
            }
        });
    });
    
    // ==================== ç·¨é ç¢¼åŠŸèƒ½ ====================
    // ä¿®æ­£ï¼šç•¶æª”æ¡ˆè¼‰å…¥å¾Œï¼Œæ‰å•Ÿç”¨ã€Œä¸‹ä¸€æ­¥ã€æŒ‰éˆ•
    fileInput.addEventListener('change', () => {
        if (currentMode === 'pagenumber' && fileInput.files.length > 0) {
            pageNumberNextBtn.disabled = false;
        } else if (currentMode === 'pagenumber') {
            pageNumberNextBtn.disabled = true;
        }
    });

    // ä¿®æ­£ï¼šç§»é™¤å¤šé¤˜çš„äº‹ä»¶ç›£è½å™¨ï¼Œé¿å…è¡çª
    pageNumberNextBtn.addEventListener('click', () => {
        if (!loadedPDF) {
            showMessage('è«‹å…ˆåŒ¯å…¥PDFæª”æ¡ˆã€‚');
            return;
        }
        
        const actionArea = document.getElementById('pageNumberNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="pageNumberFilename" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400" value="é ç¢¼-${formatDate(new Date())}">
                </div>
                <button id="exportPageNumber" class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-600 transition w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;
        document.getElementById('exportPageNumber').addEventListener('click', handlePageNumberExport);
    });

    async function handlePageNumberExport() {
        if (!loadedPDF) {
            showMessage('è«‹å…ˆåŒ¯å…¥PDFæª”æ¡ˆã€‚');
            return;
        }

        const startNumber = parseInt(pageNumberStart.value) || 1;
        const fromPage = parseInt(pageNumberFromPage.value);
        const position = pageNumberPosition.value;
        const filename = document.getElementById('pageNumberFilename').value;

        if (isNaN(fromPage) || fromPage < 1 || fromPage > loadedPDF.numPages) {
            showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹é ç¢¼ã€‚');
            return;
        }

        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await fileInput.files[0].arrayBuffer());
            const pages = pdfDoc.getPages();
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            
            const startPageIndex = fromPage - 1;

            for (let i = startPageIndex; i < pages.length; i++) {
                const page = pages[i];
                const { width, height } = page.getSize();
                const pageNum = startNumber + (i - startPageIndex);
                const text = pageNum.toString();
                const textSize = 18;
                const textWidth = font.widthOfTextAtSize(text, textSize);
                const margin = 30;

                let xPosition;
                if (position === 'left') {
                    // Start on left, then alternate
                    xPosition = (pageNum % 2 !== 0) ? margin : width - textWidth - margin;
                } else {
                    // Start on right, then alternate
                    xPosition = (pageNum % 2 !== 0) ? width - textWidth - margin : margin;
                }

                page.drawText(text, {
                    x: xPosition,
                    y: margin,
                    size: textSize,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('é ç¢¼ç·¨å¯«ä¸¦åŒ¯å‡ºæˆåŠŸï¼');

        } catch (error) {
            console.error('Error adding page numbers:', error);
            showMessage('é ç¢¼ç·¨å¯«æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
        }
    }
    
    // ==================== æ—‹è½‰åŠŸèƒ½ ====================
    async function renderRotateThumbnails(pdfDoc) {
        rotateThumbnails.innerHTML = '';
        const numPages = pdfDoc.numPages;
        
        for (let i = 1; i <= numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 0.3, rotation: rotateRotations[i - 1] });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const context = canvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;

            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = `relative flex-shrink-0 p-2 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-100 transition`;
            thumbWrapper.dataset.page = i - 1;

            const pageNum = document.createElement('div');
            pageNum.textContent = i;
            pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
            
            thumbWrapper.appendChild(canvas);
            thumbWrapper.appendChild(pageNum);
            rotateThumbnails.appendChild(thumbWrapper);

            thumbWrapper.addEventListener('click', () => {
                document.querySelectorAll('#rotateThumbnails .selected-thumbnail').forEach(t => t.classList.remove('selected-thumbnail'));
                thumbWrapper.classList.add('selected-thumbnail');
                selectedRotatePage = i - 1;
                rotatePageBtn.disabled = false;
            });
        }
        
        // ä¿®æ­£ï¼šåœ¨é‡æ–°æ¸²æŸ“å¾Œï¼Œä¿ç•™é¸å–ç‹€æ…‹
        if (selectedRotatePage !== -1) {
            const currentSelectedThumb = document.querySelector(`[data-page="${selectedRotatePage}"]`);
            if (currentSelectedThumb) {
                currentSelectedThumb.classList.add('selected-thumbnail');
            }
        }
    }

    rotatePageBtn.addEventListener('click', async () => {
        if (selectedRotatePage === -1) {
            showMessage('è«‹å…ˆé¸æ“‡è¦æ—‹è½‰çš„é é¢ã€‚');
            return;
        }
        rotateRotations[selectedRotatePage] = (rotateRotations[selectedRotatePage] + 90) % 360;
        await renderRotateThumbnails(loadedPDF);
    });

    rotateNextBtn.addEventListener('click', () => {
        const actionArea = document.getElementById('rotateNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="rotateFilename" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400" value="æ—‹è½‰-${formatDate(new Date())}">
                </div>
                <button id="exportRotate" class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-600 transition w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;
        document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
    });

    async function handleRotateExport() {
        if (!loadedPDF) {
            showMessage('è«‹å…ˆåŒ¯å…¥PDFæª”æ¡ˆã€‚');
            return;
        }

        const filename = document.getElementById('rotateFilename').value;
        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await fileInput.files[0].arrayBuffer());
            const pages = pdfDoc.getPages();

            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                if (rotateRotations[i] !== 0) {
                    const existingRotation = page.getRotation();
                    const newRotation = (existingRotation.angle + rotateRotations[i]) % 360;
                    page.setRotation(PDFLib.degrees(newRotation));
                }
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('PDF æ—‹è½‰ä¸¦åŒ¯å‡ºæˆåŠŸï¼');

        } catch (error) {
            console.error('Error rotating PDF:', error);
            showMessage('PDF æ—‹è½‰æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
        }
    }

    // è™•ç†éµç›¤äº‹ä»¶ (ç”¨æ–¼åˆæˆåŠŸèƒ½å’Œæ—‹è½‰åŠŸèƒ½)
    document.addEventListener('keydown', (event) => {
        if (currentMode === 'merge') {
            if (event.key === 'Delete' && selectedFileIndex !== -1) {
                deleteFileBtn.click();
            } else if (event.key === 'ArrowUp' && selectedFileIndex > 0) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex - 1, 0, fileToMove);
                selectedFileIndex--;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            } else if (event.key === 'ArrowDown' && selectedFileIndex < filesForMerge.length - 1 && selectedFileIndex !== -1) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex + 1, 0, fileToMove);
                selectedFileIndex++;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            }
        } else if (currentMode === 'rotate' && (event.key === 'r' || event.key === 'R') && selectedRotatePage !== -1) {
            rotatePageBtn.click();
        }
    });

    // å…¨è¢å¹•é è¦½åŠŸèƒ½
    async function showFullScreenPreview(pdfDoc, pageNum) {
        fullScreenPDF = pdfDoc;
        fullScreenPage = pageNum;
        await renderFullScreenPage();
        fullScreenPreview.classList.remove('hidden');

        // ç¶å®šéµç›¤äº‹ä»¶
        document.addEventListener('keydown', handleFullScreenKeys);
    }
    
    async function renderFullScreenPage() {
        if (!fullScreenPDF) return;

        const page = await fullScreenPDF.getPage(fullScreenPage);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const context = canvas.getContext('2d');
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        previewImage.src = canvas.toDataURL();
    }

    function closeFullScreenPreview() {
        fullScreenPreview.classList.add('hidden');
        fullScreenPDF = null;
        fullScreenPage = 0;
        document.removeEventListener('keydown', handleFullScreenKeys);
    }

    function handleFullScreenKeys(e) {
        if (e.key === 'Escape') {
            closeFullScreenPreview();
        } else if (e.key === 'ArrowLeft') {
            navigatePreview(-1);
        } else if (e.key === 'ArrowRight') {
            navigatePreview(1);
        }
    }

    function navigatePreview(direction) {
        const newPage = fullScreenPage + direction;
        if (newPage >= 1 && newPage <= fullScreenPDF.numPages) {
            fullScreenPage = newPage;
            renderFullScreenPage();
        }
    }

    previewPrevBtn.addEventListener('click', () => navigatePreview(-1));
    previewNextBtn.addEventListener('click', () => navigatePreview(1));

    fullScreenPreview.addEventListener('click', (e) => {
        if (e.target === fullScreenPreview) {
            closeFullScreenPreview();
        }
    });


    // é€šç”¨å‡½æ•¸
    function downloadPDF(pdfBytes, filename) {
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function formatDate(date) {
        const yyyy = date.getFullYear().toString();
        const mm = (date.getMonth() + 1).toString().padStart(2, '0');
        const dd = date.getDate().toString().padStart(2, '0');
        const hh = date.getHours().toString().padStart(2, '0');
        const min = date.getMinutes().toString().padStart(2, '0');
        const ss = date.getSeconds().toString().padStart(2, '0');
        return `${yyyy}${mm}${dd}${hh}${min}${ss}`;
    }
</script>

</body>
</html>



