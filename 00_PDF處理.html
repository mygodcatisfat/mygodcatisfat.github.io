<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ç·¨è¼¯å·¥å…·</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb; 
            --primary-light: #93c5fd;
            --primary-bg: #eff6ff;
            
            --success: #22c55e;
            --success-hover: #16a34a;
            --success-light: #86efac;
            
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fca5a5;
            
            --warning: #eab308;
            --warning-hover: #ca8a04;
            --warning-light: #fde047;

            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            --font-main: 'Inter', sans-serif;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: var(--font-main);
            background-color: var(--gray-100);
            color: var(--gray-800);
            padding: 2rem;
            margin: 0;
        }

        .container {
            max-width: 72rem;
            margin: 0 auto;
        }

        .card {
            background-color: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
        }
        @media (min-width: 768px) {
            .card { padding: 2.5rem; }
        }

        .main-title {
            font-size: 1.875rem; 
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary-hover);
        }

        .section-header {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .section-title {
            font-size: 1.25rem; 
            font-weight: 600;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { display: flex; flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .justify-start { justify-content: flex-start; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .font-medium { font-weight: 500; }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-gray-700 { color: var(--gray-700); }
        
        .drop-zone {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            text-align: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone label {
            cursor: pointer;
            color: var(--primary);
        }
        .drop-zone label:hover {
            color: var(--primary-hover);
        }
        .drop-zone-text-main {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .drop-zone.border-blue-500 { border-color: var(--primary); }
        .drop-zone.bg-blue-50 { background-color: var(--primary-bg); }

        .tabs-container {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        .tab-button {
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--gray-600);
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            color: white;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:disabled {
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-lg { padding: 0.75rem 1.5rem; }

        .btn-blue { background-color: var(--primary); }
        .btn-blue:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-blue:disabled { background-color: var(--primary-light); }

        .btn-red { background-color: var(--danger); }
        .btn-red:hover:not(:disabled) { background-color: var(--danger-hover); }
        .btn-red:disabled { background-color: var(--danger-light); }

        .btn-yellow { background-color: var(--warning); }
        .btn-yellow:hover:not(:disabled) { background-color: var(--warning-hover); }
        .btn-yellow:disabled { background-color: var(--warning-light); }
        
        .btn-green { background-color: var(--success); }
        .btn-green:hover:not(:disabled) { background-color: var(--success-hover); }
        .btn-green:disabled { background-color: var(--success-light); }
        
        .btn-gray { background-color: var(--gray-500); }
        .btn-gray:hover { background-color: var(--gray-600); }

        .form-input {
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            transition: all 0.2s;
            outline: none;
        }
        .form-input:focus {
            ring: 2px;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* blue-400 */
            border-color: rgba(59, 130, 246, 0.5);
        }
        .w-24 { width: 6rem; }
        
        .thumb-container {
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            scrollbar-width: thin;
        }
        .thumb-container::-webkit-scrollbar {
            height: 8px;
        }
        .thumb-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .thumb-container::-webkit-scrollbar-track {
            background-color: #e2e8f0;
            border-radius: 4px;
        }

        .punc-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            color: var(--gray-700);
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .punc-btn:hover { background-color: var(--gray-50); }
        .punc-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .punc-btn.active:hover { background-color: var(--primary-hover); }

        .cut-marker {
            width: 1.5rem;
            height: 1.5rem;
            background-color: white;
            border: 2px solid #60a5fa; /* Blue-400 */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin: 0 0.5rem;
            flex-shrink: 0;
        }
        .cut-marker:hover {
            transform: scale(1.1);
        }
        .cut-marker.active {
            background-color: var(--success);
            border-color: var(--success);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .info-tooltip-container {
            position: relative;
        }
        .info-tooltip-icon {
            color: var(--gray-500);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: auto;
            height: auto;
            padding: 0 0.25rem;
            border: none;
        }

        #mergeFileList li {
            list-style-type: none;
        }

        .preview-canvas {
            filter: blur(5px);
            opacity: 0.6;
            transition: filter 0.4s ease, opacity 0.4s ease;
            display: block;
        }
        .preview-canvas.loaded {
            filter: blur(0);
            opacity: 1;
        }

        .sortable-item {
            cursor: grab;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: white;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
        }
        .sortable-item:hover { background-color: var(--gray-50); }
        .sortable-item:active { cursor: grabbing; }

        .ring-2 { box-shadow: 0 0 0 2px var(--primary); }
        .ring-blue-500 { /* Helper for JS compatibility */ }
        .selected-thumbnail { box-shadow: 0 0 0 2px var(--primary); }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
			background-color: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(2px);
        }
        .overlay-bg {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            max-width: 24rem;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .split-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .split-overlay-content { position: relative; }
        .overlay-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            z-index: 110;
            border: none;
        }
        .overlay-nav-button.left { left: 20px; }
        .overlay-nav-button.right { right: 20px; }
        #previewImage {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        #tooltipModal {
            background-color: rgba(17, 24, 39, 0.7); /* gray-900 opacity 70 */
            backdrop-filter: blur(4px);
        }
        .tooltip-card {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            max-width: 32rem; /* lg */
            width: 100%;
        }
        .tooltip-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-hover);
            margin-bottom: 1rem;
        }
        .prose p { margin-bottom: 0.5em; }
        .prose ul { margin-left: 1.5em; list-style-type: disc; }
        .text-green-500 { color: var(--success); }
        .text-blue-500 { color: var(--primary); }
        .text-red-500 { color: var(--danger); }
        .text-orange-500 { color: #f97316; }

        .back-home-btn {
            position: fixed;
            right: 16px;
            top: 10px;
            z-index: 300;
            background: #2563eb;
            color: #fff;
            padding: 6px 8px;
            border-radius: 9px;
            box-shadow: 0 4px 14px rgba(37,99,235,0.18);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            gap: 0.5em;
            text-decoration: none;
        }
        .back-home-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 6px 18px rgba(37,99,235,0.28);
        }

        #copyNotification {
            position: fixed;
            top: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--gray-800);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 300;
            opacity: 0;
            transition: opacity 1s;
        }

        #ocrResultText {
            width: 100%;
            height: 16rem;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: var(--gray-50);
            resize: vertical;
            box-sizing: border-box;
            outline: none;
        }
        .ocr-progress-container {
            width: 100%;
            background-color: var(--gray-200);
            border-radius: 9999px;
            height: 0.625rem;
            margin-bottom: 1rem;
        }
        .ocr-progress-bar {
            background-color: var(--primary-hover);
            height: 0.625rem;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        .fieldset-border {
            border: 1px solid var(--gray-300);
            padding: 0.75rem;
            border-radius: var(--radius-md);
        }
        legend { font-size: 0.875rem; font-weight: 500; color: var(--gray-700); padding: 0 0.5rem; }

        .thumb-wrapper {
            position: relative;
            flex-shrink: 0;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
        }
		
        .ml-auto { margin-left: auto; }

        .btn-text-red {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: background-color 0.2s;
        }
        .btn-text-red:hover {
            background-color: #fee2e2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="main-title">PDF ç·¨è¼¯å·¥å…·</h1>

            <div id="dropZone" class="drop-zone">
                <label for="fileInput">
                    <p class="drop-zone-text-main">é»æ“Šæ­¤è™•æˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p>
                    <p id="fileStatus" class="text-sm text-gray-500">æ”¯æ´ .pdf æ ¼å¼</p>
                </label>
                <input type="file" id="fileInput" class="hidden" multiple accept=".pdf">
            </div>

            <div class="tabs-container">
                <button id="tabSplit" class="tab-button active">è£åˆ‡</button>
                <button id="tabMerge" class="tab-button">åˆæˆ</button>
                <button id="tabPageNumber" class="tab-button">ç·¨é ç¢¼</button>
                <button id="tabRotate" class="tab-button">æ—‹è½‰</button>
                <button id="tabOcr" class="tab-button">æ–‡å­—è¾¨è­˜(å‰ç«¯)</button>
            </div>

            <div id="sectionSplit" class="tool-section">
                <div class="section-header">
                    <h2 class="section-title">è£åˆ‡åŠŸèƒ½</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="split">ğŸ’¬</span>
                    </div>
					<button id="clearSplit" class="btn-text-red ml-auto">æ¸…é™¤è³‡æ–™</button>
                </div>
                
                <div id="splitTextInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">å¾ç¬¬</label>
                        <input type="number" id="splitStartPage" placeholder="é ç¢¼" class="form-input w-24">
                        <label class="font-medium text-gray-700">é è£åˆ‡åˆ°ç¬¬</label>
                        <input type="number" id="splitEndPage" placeholder="é ç¢¼" class="form-input w-24">
                        <label class="font-medium text-gray-700">é </label>
                    </div>
                </div>

                <div id="splitImageSelection" class="mb-6">
                    <div id="splitThumbnails" class="thumb-container">
                        </div>
                </div>

                <div id="splitAction" class="flex justify-end mt-8">
                    <button id="splitNext" class="btn btn-blue btn-lg" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <div id="sectionMerge" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">åˆæˆåŠŸèƒ½</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="merge">ğŸ’¬</span>
                    </div>
					<button id="clearMerge" class="btn-text-red ml-auto">æ¸…é™¤è³‡æ–™</button>
                </div>

                <div class="mb-6">
                    <h3 class="section-title mb-4">æª”æ¡ˆæ¸…å–®</h3>
                    <ul id="mergeFileList" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[100px] space-y-2" style="background-color: var(--gray-50); border-radius: var(--radius-lg); border: 1px solid var(--gray-200); min-height: 100px; padding: 1rem;">
                        <li class="text-gray-400 text-center py-4">è«‹åŒ¯å…¥ PDF æª”æ¡ˆä»¥é€²è¡Œåˆæˆ</li>
                    </ul>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="deleteFile" class="btn btn-red" disabled>åˆªé™¤</button>
                    <button id="mergeNext" class="btn btn-blue btn-lg" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <div id="sectionPageNumber" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">ç·¨é ç¢¼åŠŸèƒ½</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="pageNumber">ğŸ’¬</span>
                    </div>
					<button id="clearPageNumber" class="btn-text-red ml-auto">æ¸…é™¤è³‡æ–™</button>
                </div>
                <div id="pageNumberInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">èµ·å§‹æ•¸å­—ï¼š</label>
                        <input type="number" id="pageNumberStart" placeholder="1" value="1" class="form-input w-24">
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">å¾ç¬¬å¹¾é é–‹å§‹ç·¨ï¼š</label>
                        <input type="number" id="pageNumberFromPage" placeholder="é ç¢¼" class="form-input w-24">
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">èµ·å§‹é ç¢¼ä½ç½®ï¼š</label>
                        <select id="pageNumberPosition" class="form-input">
                            <option value="left">å·¦</option>
                            <option value="right">å³</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">é ç¢¼å‘ˆç¾é¡å‹ï¼š</label>
                        <select id="pageNumberType" class="form-input">
                            <option value="same">åŒå´</option>
                            <option value="alternate">äº¤å‰</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="pageNumberNext" class="btn btn-blue btn-lg" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <div id="sectionRotate" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">æ—‹è½‰åŠŸèƒ½</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="rotate">ğŸ’¬</span>
                    </div>
					<button id="clearRotate" class="btn-text-red ml-auto">æ¸…é™¤è³‡æ–™</button>
                </div>

                <div class="mb-4">
                    <button id="rotatePageBtn" class="btn btn-yellow" disabled>æ—‹è½‰</button>
                </div>

                <div id="rotateImageSelection" class="mb-6">
                    <div id="rotateThumbnails" class="thumb-container">
                    </div>
                </div>

                <div id="rotateAction" class="flex justify-end space-x-4 mt-8">
                    <button id="rotateNext" class="btn btn-blue btn-lg" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <div id="sectionOcr" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">æ–‡å­—è¾¨è­˜åŠŸèƒ½ (OCR)</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="ocr">ğŸ’¬</span>
                    </div>
					<button id="clearOcr" class="btn-text-red ml-auto">æ¸…é™¤è³‡æ–™</button>
                </div>

                <div id="ocrTextInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">å¾ç¬¬</label>
                        <input type="number" id="ocrStartPage" placeholder="é ç¢¼" class="form-input w-24">
                        <label class="font-medium text-gray-700">é è¾¨è­˜åˆ°ç¬¬</label>
                        <input type="number" id="ocrEndPage" placeholder="é ç¢¼" class="form-input w-24">
                        <label class="font-medium text-gray-700">é </label>
                    </div>
                </div>
                <div id="ocrImageSelection" class="mb-6">
                    <div id="ocrThumbnails" class="thumb-container" style="background-color: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-lg); min-height: 100px;">
                    </div>
                </div>
                <div id="ocrAction" class="flex justify-start space-x-4 mt-8">
                     <button id="ocrStartBtn" class="btn btn-blue" disabled>é–‹å§‹è¾¨è­˜</button>
                </div>
                <div id="ocrStatus" class="my-4 text-gray-600 hidden">
                </div>
                <div id="ocrProgressContainer" class="ocr-progress-container hidden">
                    <div id="ocrProgressBar" class="ocr-progress-bar" style="width: 0%"></div>
                </div>
                <div id="ocrResultTools" class="my-4 space-y-2 hidden">
                    <fieldset class="fieldset-border">
                        <legend>æ¨™é»ç¬¦è™Ÿæ”¹ç‚ºå…¨å‹</legend>
                        <div id="punctuationSubButtons" class="flex space-x-2">
                            <button id="btnPuncColon" class="punc-btn" data-type="colon">å†’è™Ÿ ( : )</button>
                            <button id="btnPuncComma" class="punc-btn" data-type="comma">é€—è™Ÿ ( , )</button>
                            <button id="btnPuncParen" class="punc-btn" data-type="paren">æ‹¬è™Ÿ ( )</button>
                        </div>
                    </fieldset>
                </div>
                <div id="ocrResultAreaWrapper" class="mb-6">
                    <label class="font-medium text-gray-700 mb-2 block">è¾¨è­˜çµæœï¼š</label>
                    <textarea id="ocrResultText" readonly placeholder="è¾¨è­˜çµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="copyOcrTextBtn" class="btn btn-green text-sm" disabled>è¤‡è£½æ–‡å­—</button>
                    </div>
                </div>
            </div>

            <div id="messageBox" class="overlay hidden">
                <div class="overlay-bg">
                    <p id="messageText" class="text-lg font-medium mb-4"></p>
                    <button id="messageOk" class="btn btn-blue">ç¢ºå®š</button>
                </div>
            </div>

            <div id="splitSelectionBox" class="overlay hidden">
                <div class="overlay-bg">
                    <p class="text-lg font-medium mb-4">å·²é¸æ“‡è¶…éå…©å€‹è£åˆ‡é»ï¼Œè«‹é¸æ“‡æ“ä½œï¼š</p>
                    <div class="flex flex-col space-y-2">
                        <button id="selectFirst" class="btn btn-blue">åˆªé™¤å‰è£åˆ‡é»</button>
                        <button id="selectLast" class="btn btn-yellow">åˆªé™¤å¾Œè£åˆ‡é»</button>
                        <button id="selectCancel" class="btn btn-gray">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            
            <div id="tooltipModal" class="overlay hidden">
                <div class="tooltip-card">
                    <h3 id="tooltipTitle" class="tooltip-title"></h3>
                    <div id="tooltipContentArea" class="prose text-gray-800">
                        </div>
                    <div class="mt-6 text-right">
                        <button id="tooltipOk" class="btn btn-blue">é—œé–‰</button>
                    </div>
                </div>
            </div>
            
            <div id="copyNotification" style="display: none;">
                å·²è¤‡è£½æ–‡å­—ï¼
            </div>

            <div id="fullScreenPreview" class="split-overlay hidden">
                <div class="split-overlay-content">
                    <button id="previewPrev" class="overlay-nav-button left">â®</button>
                    <img id="previewImage" src="" alt="PDF Preview">
                    <button id="previewNext" class="overlay-nav-button right">â¯</button>
                </div>
            </div>
        </div>

        <a href="https://mygodcatisfat.github.io" class="back-home-btn" title="å›åˆ°é¦–é ">
            å›åˆ°é¦–é 
        </a>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js" integrity="sha256-H8KU7v2mAuWRoGwdWvNhyuI3VrWjNPwkIdX5rMzgOOU=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" integrity="sha256-D5pcrQeUHwgmWGyU4InYm5GMRuXBfPLVo8b2ZuO8aU8=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
	pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    const fileInput = document.getElementById('fileInput');
    const tabs = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('.tool-section');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageOk = document.getElementById('messageOk');
    const fileStatus = document.getElementById('fileStatus');
    const splitTextInput = document.getElementById('splitTextInput');
    const splitImageSelection = document.getElementById('splitImageSelection');
    const splitStartPage = document.getElementById('splitStartPage');
    const splitEndPage = document.getElementById('splitEndPage');
    const splitThumbnails = document.getElementById('splitThumbnails');
    const splitNextBtn = document.getElementById('splitNext');
    const splitSelectionBox = document.getElementById('splitSelectionBox');
    const mergeFileList = document.getElementById('mergeFileList');
    const deleteFileBtn = document.getElementById('deleteFile');
    const mergeNextBtn = document.getElementById('mergeNext');
    const pageNumberStart = document.getElementById('pageNumberStart');
    const pageNumberFromPage = document.getElementById('pageNumberFromPage');
    const pageNumberPosition = document.getElementById('pageNumberPosition');
	const pageNumberType = document.getElementById('pageNumberType'); 
    const pageNumberNextBtn = document.getElementById('pageNumberNext');
    const rotateThumbnails = document.getElementById('rotateThumbnails');
    let rotatePageBtn = document.getElementById('rotatePageBtn');
    let rotateNextBtn = document.getElementById('rotateNext');
    const tooltipModal = document.getElementById('tooltipModal');
    const tooltipTitle = document.getElementById('tooltipTitle');
    const tooltipContentArea = document.getElementById('tooltipContentArea');
    const tooltipOk = document.getElementById('tooltipOk');
    const fullScreenPreview = document.getElementById('fullScreenPreview');
    const previewImage = document.getElementById('previewImage');
    const previewPrevBtn = document.getElementById('previewPrev');
    const previewNextBtn = document.getElementById('previewNext');
	let currentRenderId = 0; 

    let currentMode = 'split';
    let loadedPDF = null;
    let splitPoints = [];
    let filesForMerge = [];
    let selectedFileIndex = -1;
    let fullScreenPDF = null;
    let fullScreenPage = 0;
    let rotateRotations = [];
    let selectedRotatePage = -1;
	let ocrSplitPoints = []; 
	let singleLoadedFile = null;
    let ocrWorker = null; 
    let originalOcrText = ""; 
    let puncToggles = { colon: false, comma: false, paren: false }; 
	
	// å»ºç«‹ IntersectionObserver ç”¨æ–¼å»¶é²è¼‰å…¥
	const thumbnailObserver = new IntersectionObserver((entries, observer) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				const container = entry.target;
				// åŸ·è¡Œé å…ˆç¶å®šçš„æ¸²æŸ“å‡½å¼
				if (container.renderFunction) {
					container.renderFunction();
					// æ¸²æŸ“å¾Œå°±ä¸éœ€è¦å†è§€å¯Ÿäº†ï¼Œé‡‹æ”¾è³‡æº
					container.renderFunction = null; 
				}
				observer.unobserve(container);
			}
		});
	}, {
		root: null, 
		rootMargin: '100px', // é å…ˆè¼‰å…¥è¦–çª—é‚Šç·£å¤– 100px çš„å…§å®¹
		threshold: 0.01
	});

    const tooltipData = {
        split: {
            title: 'è£åˆ‡åŠŸèƒ½èªªæ˜',
            content: `
                <p>åŒ¯å…¥ PDF å¾Œï¼Œæ‚¨å¯ä»¥é€é<strong class="text-green-500">åœ–åƒä»‹é¢</strong>æˆ–<strong class="text-green-500">è¼¸å…¥æ¡†</strong>é¸æ“‡è£åˆ‡ç¯„åœï¼Œå…©è€…æœƒè‡ªå‹•åŒæ­¥ã€‚</p>
                <p>é»æ“Š<strong class="text-green-500">ç¶ è‰²æ¨™è¨˜</strong>æˆ–åœ¨è¼¸å…¥æ¡†ä¸­è¼¸å…¥é ç¢¼ä¾†é¸æ“‡è£åˆ‡é»ã€‚</p>
                <p>ç•¶æ‚¨é¸æ“‡è¶…éå…©å€‹è£åˆ‡é»æ™‚ï¼Œç³»çµ±æœƒæç¤ºæ‚¨é¸æ“‡ä¿ç•™<strong class="text-blue-500">æœ€å‰</strong>æˆ–<strong class="text-red-500">æœ€å¾Œ</strong>çš„è£åˆ‡é»ã€‚</p>
                <p><strong class="text-green-500">è£åˆ‡é»æ¨™è¨˜</strong>ï¼š</p>
                <ul class="list-disc list-inside">
                    <li>ç¬¬ä¸€é **å‰**çš„è£åˆ‡é»ä»£è¡¨å¾ç¬¬ä¸€é é–‹å§‹ã€‚</li>
                    <li>æœ€å¾Œä¸€é **å¾Œ**çš„è£åˆ‡é»ä»£è¡¨è£åˆ‡åˆ°æœ€å¾Œä¸€é ã€‚</li>
                </ul>
            `
        },
        merge: {
            title: 'åˆæˆåŠŸèƒ½èªªæ˜',
            content: `
                <p>æ‚¨å¯ä»¥åŒ¯å…¥<strong class="text-blue-500">å¤šå€‹</strong> PDF æª”æ¡ˆã€‚</p>
                <p>é€é**é»æ“Š**æˆ–**æ‹–æ›³**æ¸…å–®ä¾†èª¿æ•´æª”æ¡ˆé †åºã€‚</p>
                <p>é»æ“Šæ¸…å–®ä¸­çš„æª”æ¡ˆå¯å±•é–‹<strong class="text-green-500">é è¦½</strong>ã€‚</p>
                <p>é è¦½åœ–æ”¯æ´**æ©«å‘æ»¾å‹•**ï¼Œé»æ“Šå¯é–‹å•Ÿ**å…¨è¢å¹•é è¦½**ã€‚</p>
                <p>ä½¿ç”¨<strong class="text-green-500">éµç›¤</strong>å¿«æ·éµï¼š</p>
                <ul class="list-disc list-inside">
                    <li>æŒ‰ <strong class="text-red-500">Delete</strong> éµï¼šåˆªé™¤é¸å–çš„æª”æ¡ˆã€‚</li>
                    <li>æŒ‰ <strong class="text-blue-500">ä¸Š/ä¸‹ç®­é ­</strong> éµï¼šç§»å‹•é¸å–æª”æ¡ˆçš„é †åºã€‚</li>
                </ul>
            `
        },
        pageNumber: {
            title: 'ç·¨é ç¢¼åŠŸèƒ½èªªæ˜',
            content: `
                <p>è«‹åŒ¯å…¥ PDF æª”æ¡ˆï¼Œç„¶å¾Œè¨­å®šç·¨ç¢¼çš„**èµ·å§‹æ•¸å­—**ã€**èµ·å§‹é ç¢¼**ã€**é ç¢¼ä½ç½®**åŠ**é ç¢¼å‘ˆç¾é¡å‹**ã€‚</p>
                <p>é ç¢¼ä½ç½®é è¨­ç‚º<strong class="text-green-500">ã€ŒåŒå´ã€</strong>ï¼šä¸è«–é ç¢¼ç·¨åˆ°å“ªä¸€é ï¼Œéƒ½æœƒå›ºå®šåœ¨æ‚¨é¸æ“‡çš„èµ·å§‹ä½ç½®ã€‚</p>
                <p>è‹¥é¸æ“‡<strong class="text-blue-500">ã€Œäº¤å‰ã€</strong>ï¼šé ç¢¼æœƒå¾æ‚¨æŒ‡å®šçš„é ç¢¼é–‹å§‹ä¾åºç·¨å¯«ï¼Œä¸¦åœ¨é é¢å·¦å³<strong class="text-red-500">äº¤æ›¿å‡ºç¾</strong>ã€‚</p>
                <p>ä¾‹å¦‚ï¼šè‹¥èµ·å§‹ä½ç½®è¨­å®šç‚ºã€Œå·¦ã€ï¼Œå‘ˆç¾é¡å‹ç‚ºã€Œäº¤å‰ã€ï¼Œå‰‡ç¬¬ä¸€çµ„é ç¢¼æœƒå‡ºç¾åœ¨å·¦ä¸‹è§’ï¼Œç¬¬äºŒçµ„æœƒå‡ºç¾åœ¨å³ä¸‹è§’ï¼Œä¾æ­¤é¡æ¨ã€‚</p>
            `
        },
        rotate: {
            title: 'æ—‹è½‰åŠŸèƒ½èªªæ˜',
            content: `
                <p>è«‹åŒ¯å…¥ PDF æª”æ¡ˆï¼Œç„¶å¾Œé»æ“Šé é¢ç¸®åœ–ä¾†é¸å–ã€‚</p>
                <p>é»æ“Š<strong class="text-green-500">ã€Œæ—‹è½‰ã€</strong>æŒ‰éˆ•æˆ–æŒ‰ä¸‹éµç›¤ **<strong class="text-red-500">R</strong>** éµ**ï¼Œå³å¯å°‡é¸å–çš„é é¢é †æ™‚é‡æ—‹è½‰ 90 åº¦ã€‚</p>
                <p>æ‚¨å¯ä»¥é‡è¤‡æ“ä½œä¾†é”åˆ°æ‰€éœ€çš„æ—‹è½‰è§’åº¦ã€‚</p>
            `
        },
		ocr: {
            title: 'æ–‡å­—è¾¨è­˜åŠŸèƒ½ (OCR) èªªæ˜',
            content: `
                <p>åŒ¯å…¥ PDF å¾Œï¼Œæ‚¨å¯ä»¥é€é<strong class="text-green-500">åœ–åƒä»‹é¢</strong>æˆ–<strong class="text-green-500">è¼¸å…¥æ¡†</strong>é¸æ“‡è¾¨è­˜çš„<strong class="text-blue-500">é ç¢¼å€é–“</strong>ã€‚</p>
                <p>æ­¤åŠŸèƒ½æœƒä½¿ç”¨ Tesseract.js å¼•æ“ä¾†è¾¨è­˜é é¢ä¸Šçš„<strong class="text-green-500">ç¹é«”ä¸­æ–‡</strong>èˆ‡<strong class="text-green-500">è‹±æ–‡</strong>ã€‚</p>
                <p>è¾¨è­˜å®Œæˆå¾Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<strong class="text-orange-500">ã€Œæ¨™é»ç¬¦è™Ÿæ”¹ç‚ºå…¨å‹ã€</strong>åŠŸèƒ½ï¼Œå°‡åŠå‹æ¨™é»è½‰æ›ç‚ºå…¨å‹ã€‚</p>
                <p>è¾¨è­˜éœ€è¦ä¸€äº›æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚è¾¨è­˜çµæœå°‡é¡¯ç¤ºåœ¨ä¸‹æ–¹çš„æ–‡å­—æ¡†ä¸­ã€‚</p>
                <p><strong class="text-red-500">æ³¨æ„ï¼š</strong>è¾¨è­˜è¤‡é›œæ’ç‰ˆæˆ–ä½è§£æåº¦åœ–ç‰‡æ™‚ï¼Œæº–ç¢ºåº¦å¯èƒ½æœƒä¸‹é™ã€‚</p>
            `
        }
    };

    // é¡¯ç¤ºè¨Šæ¯æ¡†
    function showMessage(text) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
    }

    messageOk.addEventListener('click', () => {
        messageBox.classList.add('hidden');
    });

    // é¡¯ç¤ºæç¤ºå½ˆçª—
    function showTooltip(mode) {
        const data = tooltipData[mode];
        if (data) {
            tooltipTitle.textContent = data.title;
            tooltipContentArea.innerHTML = data.content;
            tooltipModal.classList.remove('hidden');
        }
    }

    // é—œé–‰æç¤ºå½ˆçª—
    tooltipOk.addEventListener('click', () => {
        tooltipModal.classList.add('hidden');
    });

    // è™•ç†æç¤ºåœ–ç¤ºé»æ“Šäº‹ä»¶
    document.querySelectorAll('.info-tooltip-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            const mode = icon.dataset.tooltip;
            showTooltip(mode);
        });
    });

    // åˆ‡æ›é ç±¤
    tabs.forEach(tab => {
        tab.addEventListener('click', async () => {
            if (ocrWorker && currentMode === 'ocr' && tab.id !== 'tabOcr') {
                console.log('Terminating OCR worker...');
                await ocrWorker.terminate();
                ocrWorker = null;
                const ocrStatus = document.getElementById('ocrStatus');
                if (ocrStatus) {
                    ocrStatus.classList.add('hidden');
                    ocrStatus.textContent = '';
                }
				ocrSplitPoints = [];
            }
			
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            sections.forEach(s => s.classList.add('hidden'));
            const sectionId = `section${tab.id.replace('tab', '')}`;
            document.getElementById(sectionId).classList.remove('hidden');
            currentMode = tab.id.replace('tab', '').toLowerCase();
            fileStatus.textContent = 'æ”¯æ´ .pdf æ ¼å¼';
            fileInput.value = '';
			singleLoadedFile = null;
			
			if (currentMode === 'merge') {
                fileInput.multiple = true;
            } else {
                fileInput.multiple = false;
            }
            
            if (currentMode === 'pagenumber') {
                pageNumberNextBtn.disabled = loadedPDF === null;
            } else if (currentMode === 'merge') {
                mergeNextBtn.disabled = filesForMerge.length === 0;
            } else if (currentMode === 'split') {
                splitNextBtn.disabled = loadedPDF === null || splitPoints.length !== 2;
            } else if (currentMode === 'rotate') {
                rotateNextBtn.disabled = loadedPDF === null;
            } else if (currentMode === 'ocr') {
                const ocrBtn = document.getElementById('ocrStartBtn');
                if (ocrBtn) ocrBtn.disabled = loadedPDF === null;
                
                const ocrThumbs = document.getElementById('ocrThumbnails');
                if (ocrThumbs) ocrThumbs.innerHTML = ''; 
                ocrSplitPoints = []; // ä¿®æ”¹æ­¤è¡Œ
                document.getElementById('ocrResultTools').classList.add('hidden');
            }
        });
    });

	// ==================== è£åˆ‡åŠŸèƒ½ ====================
    async function processFiles(files) {
        if (!files.length) {
            fileStatus.textContent = 'æ”¯æ´ .pdf æ ¼å¼';
            return;
        }
		
		currentRenderId++;
        
        if (currentMode === 'split' || currentMode === 'pagenumber' || currentMode === 'rotate' || currentMode === 'ocr') {
            if (files.length > 1) {
                showMessage('æ­¤åŠŸèƒ½ä¸€æ¬¡åªèƒ½è™•ç†ä¸€å€‹PDFæª”æ¡ˆã€‚');
                fileInput.value = '';
                singleLoadedFile = null; 
                return;
            }
            
            singleLoadedFile = files[0]; 
            loadedPDF = null;
            const arrayBuffer = await singleLoadedFile.arrayBuffer(); 
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            loadedPDF = pdfDoc;
            fileStatus.textContent = `å·²è¼‰å…¥æª”æ¡ˆï¼š${singleLoadedFile.name}`; 
            
            if (currentMode === 'split') {
                splitPoints = [];
                await renderSplitThumbnails(pdfDoc);
                updateSplitUI();
            } else if (currentMode === 'pagenumber') {
                pageNumberNextBtn.disabled = false;
                pageNumberFromPage.placeholder = `1 - ${loadedPDF.numPages}`;
            } else if (currentMode === 'rotate') {
                rotateRotations = Array(loadedPDF.numPages).fill(0);

                const rotateActionArea = document.getElementById('rotateAction');
                rotateActionArea.innerHTML = `
                    <button id="rotateNext" class="btn btn-blue btn-lg" disabled>ä¸‹ä¸€æ­¥</button>
                `;

                rotateNextBtn = document.getElementById('rotateNext');
                rotateNextBtn.addEventListener('click', () => {
                    const actionArea = document.getElementById('rotateNext').parentNode;
                    actionArea.innerHTML = `
                        <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                            <div class="flex items-center space-x-2">
                                <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                                <input type="text" id="rotateFilename" class="form-input" value="æ—‹è½‰-${formatDate(new Date())}">
                            </div>
                            <button id="exportRotate" class="btn btn-green w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
                        </div>
                    `;
                    document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
                });

                await renderRotateThumbnails(pdfDoc);
                rotateNextBtn.disabled = false;
                
                // å› ç‚º rotatePageBtn å·²ç¶“åœ¨å¤–éƒ¨ï¼Œæ‰€ä»¥å®ƒæœƒä¿ç•™ï¼Œæˆ‘å€‘åªéœ€è¦æ›´æ–°å®ƒçš„ç‹€æ…‹
                rotatePageBtn.disabled = true;
            
            } else if (currentMode === 'ocr') {
				ocrSplitPoints = [];
                await renderOcrThumbnails(pdfDoc);
                updateOcrUI();
				document.getElementById('ocrResultText').value = '';
                document.getElementById('ocrStatus').classList.add('hidden');
                document.getElementById('ocrResultTools').classList.add('hidden');
            }

        } else if (currentMode === 'merge') {
            await handleMergeFiles(files);
            fileStatus.textContent = `å·²è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆã€‚`;
        } else {
            showMessage('è«‹é¸æ“‡é ç±¤ä¾†åŒ¯å…¥æª”æ¡ˆã€‚');
            fileInput.value = '';
            singleLoadedFile = null; 
        }
    }
	
    fileInput.addEventListener('change', async (event) => {
        await processFiles(event.target.files); 
    });
	
	const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (event) => {
        event.preventDefault(); 
        dropZone.classList.add('border-blue-500', 'bg-blue-50'); 
    });

    dropZone.addEventListener('dragleave', (event) => {
        event.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50'); 
    });

    dropZone.addEventListener('drop', async (event) => {
        event.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50'); 
        const files = event.dataTransfer.files;   
        fileInput.value = '';
        await processFiles(files);
    });

	async function renderSplitThumbnails(pdfDoc) {
		splitThumbnails.innerHTML = '';
		const numPages = pdfDoc.numPages;
		
		const thisRenderId = currentRenderId;

		const cutMarkerStart = document.createElement('div');
		cutMarkerStart.className = 'cut-marker';
		cutMarkerStart.dataset.page = 0;
		cutMarkerStart.addEventListener('click', () => toggleSplitPoint(0));
		splitThumbnails.appendChild(cutMarkerStart);

		for (let i = 1; i <= numPages; i++) {
			if (thisRenderId !== currentRenderId) return;
			
			// å»ºç«‹å®¹å™¨
			const thumbWrapper = document.createElement('div');
			thumbWrapper.className = 'thumb-wrapper';
			// è¨­å®šå›ºå®šé«˜åº¦æˆ–æœ€å°é«˜åº¦ï¼Œç¢ºä¿å·è»¸èƒ½æ­£ç¢ºç”¢ç”Ÿï¼Œé€™å° Lazy Load å¾ˆé‡è¦
			thumbWrapper.style.minHeight = '150px'; 
			thumbWrapper.style.minWidth = '120px';
			thumbWrapper.style.display = 'flex';
			thumbWrapper.style.flexDirection = 'column';
			thumbWrapper.style.alignItems = 'center';
			thumbWrapper.style.justifyContent = 'center';

			const pageNum = document.createElement('div');
			pageNum.textContent = i;
			pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
			
			// å®šç¾©æ¸²æŸ“é‚è¼¯ï¼Œä½†ä¸ç«‹å³åŸ·è¡Œ
			thumbWrapper.renderFunction = async () => {
				if (thisRenderId !== currentRenderId) return; // å†æ¬¡æª¢æŸ¥ ID é˜²æ­¢éåŒæ­¥è¡çª
				try {
					const page = await pdfDoc.getPage(i);
					const viewport = page.getViewport({ scale: 0.3 });
					const canvas = document.createElement('canvas');
					canvas.width = viewport.width;
					canvas.height = viewport.height;
					const context = canvas.getContext('2d');
					
					// é»æ“Šé è¦½
					canvas.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));
					
					// æ¸²æŸ“
					await page.render({ canvasContext: context, viewport: viewport }).promise;
					
					// å°‡ canvas æ’å…¥ wrapper æœ€å‰é¢
					thumbWrapper.prepend(canvas);
					
					// ç§»é™¤æœ€å°å¯¬é«˜é™åˆ¶ï¼Œè®“å…§å®¹æ’é–‹
					thumbWrapper.style.minHeight = '';
					thumbWrapper.style.minWidth = '';
				} catch (e) {
					console.error(`Page ${i} render error`, e);
				}
			};

			thumbWrapper.appendChild(pageNum);
			splitThumbnails.appendChild(thumbWrapper);
			
			// åŠ å…¥è§€å¯Ÿæ¸…å–®
			thumbnailObserver.observe(thumbWrapper);

			if (i < numPages) {
				const cutMarker = document.createElement('div');
				cutMarker.className = 'cut-marker';
				cutMarker.dataset.page = i;
				cutMarker.addEventListener('click', () => toggleSplitPoint(parseInt(cutMarker.dataset.page)));
				splitThumbnails.appendChild(cutMarker);
			}
		}

		const cutMarkerEnd = document.createElement('div');
		cutMarkerEnd.className = 'cut-marker';
		cutMarkerEnd.dataset.page = numPages;
		cutMarkerEnd.addEventListener('click', () => toggleSplitPoint(numPages));
		splitThumbnails.appendChild(cutMarkerEnd);
	}

    function toggleSplitPoint(page) {
        const index = splitPoints.indexOf(page);
        if (index > -1) {
            splitPoints.splice(index, 1);
        } else {
            if (splitPoints.length >= 2) {
                splitSelectionBox.classList.remove('hidden');
                document.getElementById('selectFirst').onclick = () => {
                    splitPoints.shift();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectLast').onclick = () => {
                    splitPoints.pop();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectCancel').onclick = () => {
                    splitSelectionBox.classList.add('hidden');
                };
                return;
            }
            splitPoints.push(page);
            splitPoints.sort((a, b) => a - b);
        }
        updateSplitUI();
    }

    function updateSplitUI() {
        const cutMarkers = document.querySelectorAll('.cut-marker');
        cutMarkers.forEach(marker => {
            const page = parseInt(marker.dataset.page);
            if (splitPoints.includes(page)) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });

        if (splitPoints.length === 2) {
            splitStartPage.value = splitPoints[0] + 1;
            splitEndPage.value = splitPoints[1];
        } else {
            splitStartPage.value = '';
            splitEndPage.value = '';
        }
        splitNextBtn.disabled = splitPoints.length !== 2;
    }
    
    splitStartPage.addEventListener('input', updateSplitPointsFromText);
    splitEndPage.addEventListener('input', updateSplitPointsFromText);

    function updateSplitPointsFromText() {
        if (!loadedPDF) {
            showMessage('è«‹å…ˆåŒ¯å…¥ PDF æª”æ¡ˆã€‚');
            splitStartPage.value = '';
            splitEndPage.value = '';
            splitNextBtn.disabled = true;
            return;
        }

        const start = parseInt(splitStartPage.value);
        const end = parseInt(splitEndPage.value);
        const numPages = loadedPDF.numPages;

        splitPoints = [];

        if (isNaN(start) || start < 1 || start > numPages) {
            splitNextBtn.disabled = true;
            return;
        }
        if (isNaN(end) || end < 1 || end > numPages) {
            splitNextBtn.disabled = true;
            return;
        }
        if (start > end) {
            showMessage('çµæŸé ç¢¼ä¸èƒ½å°æ–¼èµ·å§‹é ç¢¼ã€‚');
            splitNextBtn.disabled = true;
            return;
        }
        splitPoints.push(start - 1);
        splitPoints.push(end);
        updateSplitUI();
    }

    splitNextBtn.addEventListener('click', async () => {
        const file = singleLoadedFile;
        if (!file || splitPoints.length !== 2) {
            showMessage('è«‹åŒ¯å…¥PDFæª”æ¡ˆä¸¦é¸æ“‡2å€‹è£åˆ‡é»ã€‚');
            return;
        }

        const startPage = splitPoints[0] + 1;
        const endPage = splitPoints[1];

        if (startPage > endPage) {
            showMessage('èµ·å§‹é ç¢¼ä¸èƒ½å¤§æ–¼çµæŸé ç¢¼ã€‚');
            return;
        }

        const actionArea = document.getElementById('splitAction');
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="splitFilename" class="form-input" value="åˆ†å‰²-${formatDate(new Date())}">
                </div>
                <button id="exportSplit" class="btn btn-green w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;

        document.getElementById('exportSplit').onclick = async () => {
            try {
                const fileToUse = singleLoadedFile;
				if (!fileToUse) {
					showMessage('æ‰¾ä¸åˆ°å·²è¼‰å…¥çš„æª”æ¡ˆï¼Œè«‹é‡æ–°åŒ¯å…¥ PDFã€‚');
					return;
				}

				let startPage, endPage;
				if (Array.isArray(splitPoints) && splitPoints.length === 2) {
					startPage = splitPoints[0] + 1;
					endPage = splitPoints[1];
				} else {
					startPage = parseInt(splitStartPage.value, 10);
					endPage = parseInt(splitEndPage.value, 10);
				}

				if (isNaN(startPage) || isNaN(endPage)) {
					showMessage('è«‹é¸æ“‡æˆ–è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹èˆ‡çµæŸé ç¢¼ã€‚');
					return;
				}
				if (startPage > endPage) {
					showMessage('èµ·å§‹é ç¢¼ä¸èƒ½å¤§æ–¼çµæŸé ç¢¼ã€‚');
					return;
				}
			
				const pdfBytes = await fileToUse.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const newPdfDoc = await PDFLib.PDFDocument.create();
                const pagesToKeep = Array.from({ length: endPage - startPage + 1 }, (_, i) => i + startPage - 1);
                const pages = await newPdfDoc.copyPages(pdfDoc, pagesToKeep);
                pages.forEach(page => newPdfDoc.addPage(page));
                const newPdfBytes = await newPdfDoc.save();
                const filename = document.getElementById('splitFilename').value;
                downloadPDF(newPdfBytes, filename);
                showMessage('PDF è£åˆ‡ä¸¦åŒ¯å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('Error splitting PDF:', error);
                showMessage('PDF è£åˆ‡æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
            }
        };
    });

    // ==================== åˆæˆåŠŸèƒ½ ====================
    async function handleMergeFiles(files) {
        for (const file of files) {
            filesForMerge.push(file);
        }
        renderMergeFileList();
        mergeNextBtn.disabled = filesForMerge.length === 0;
    }

    function renderMergeFileList() {
        mergeFileList.innerHTML = '';
        if (filesForMerge.length === 0) {
            mergeFileList.innerHTML = '<li class="text-gray-400 text-center py-4">è«‹åŒ¯å…¥ PDF æª”æ¡ˆä»¥é€²è¡Œåˆæˆ</li>';
            deleteFileBtn.disabled = true;
            mergeNextBtn.disabled = true;
            return;
        }

        filesForMerge.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'sortable-item';
            li.draggable = true;
            li.dataset.index = index;

            const fileHeader = document.createElement('div');
            fileHeader.className = 'flex items-center justify-between mb-2';

            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            
            const orderNumber = document.createElement('div');
            orderNumber.className = 'flex items-center justify-center font-bold text-lg mr-4 flex-shrink-0';
            
            orderNumber.style.backgroundColor = 'var(--primary)';
            orderNumber.style.color = 'white';
            orderNumber.style.width = '2rem';
            orderNumber.style.height = '2rem';
            orderNumber.style.borderRadius = '6px';
            
            orderNumber.textContent = index + 1;
            const fileNameSpan = document.createElement('span');
            fileNameSpan.textContent = file.name;
            fileInfo.appendChild(orderNumber);
            fileInfo.appendChild(fileNameSpan);

            fileHeader.appendChild(fileInfo);
            li.appendChild(fileHeader);
            
            const previewContainer = document.createElement('div');
            previewContainer.className = 'thumb-container hidden';
            li.appendChild(previewContainer);

            li.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', index); });
            li.addEventListener('dragover', (e) => e.preventDefault());
            li.addEventListener('drop', (e) => {
                 e.preventDefault();
                 const fromIndex = e.dataTransfer.getData('text/plain');
                 const toIndex = index;
                 const fileToMove = filesForMerge.splice(fromIndex, 1)[0];
                 filesForMerge.splice(toIndex, 0, fileToMove);
                 renderMergeFileList();
            });

            li.addEventListener('click', async (event) => {
                event.stopPropagation();
                const isSelected = li.classList.contains('ring-2');

                document.querySelectorAll('.sortable-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-blue-500');
                    const container = item.querySelector('.thumb-container');
                    if (container) {
                        container.classList.add('hidden');
                    }
                });
                
                if (!isSelected) {
                    li.classList.add('ring-2', 'ring-blue-500');
                    selectedFileIndex = index;
                    deleteFileBtn.disabled = false;
                    renderPreviewThumbnails(file, previewContainer);
                    previewContainer.classList.remove('hidden');
                } else {
                    selectedFileIndex = -1;
                    deleteFileBtn.disabled = true;
                }
            });
            mergeFileList.appendChild(li);
        });
        
        if (selectedFileIndex !== -1 && filesForMerge.length > 0) {
             document.querySelectorAll('.sortable-item')[selectedFileIndex].classList.add('ring-2', 'ring-blue-500');
        } else {
             selectedFileIndex = -1;
             deleteFileBtn.disabled = true;
        }
    }

	async function renderPreviewThumbnails(file, container) {
		currentRenderId++;
		const thisRenderId = currentRenderId;
		container.innerHTML = '';
		
		try {
			const arrayBuffer = await file.arrayBuffer();
			const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
			
			// åŸæœ¬é™åˆ¶ 5 é ï¼Œç¾åœ¨å› ç‚ºæœ‰æ•ˆèƒ½å„ªåŒ–ï¼Œæ‚¨å¯ä»¥è€ƒæ…®æ”¾å¯¬ï¼Œ
			// ä½†ç‚ºäº†ä¿æŒä»‹é¢ç°¡æ½”ï¼Œç¶­æŒ 5 é æˆ–é©åº¦å¢åŠ çš†å¯ã€‚
			const maxPreviewPages = 5; 
			const numPagesToPreview = Math.min(pdfDoc.numPages, maxPreviewPages);

			for (let i = 1; i <= numPagesToPreview; i++) {
				if (thisRenderId !== currentRenderId) return;

				const thumbWrapper = document.createElement('div');
				thumbWrapper.style.flexShrink = '0';
				thumbWrapper.style.padding = '0.5rem';
				thumbWrapper.style.border = '1px solid var(--gray-200)';
				thumbWrapper.style.borderRadius = 'var(--radius-md)';
				thumbWrapper.style.cursor = 'pointer';
				thumbWrapper.style.transition = 'background-color 0.2s';
				thumbWrapper.style.width = '120px'; 
				thumbWrapper.style.height = '160px';
				thumbWrapper.style.display = 'flex';
				thumbWrapper.style.flexDirection = 'column';
				thumbWrapper.style.alignItems = 'center';
				thumbWrapper.style.justifyContent = 'center';

				thumbWrapper.onmouseover = function() { this.style.backgroundColor = 'var(--gray-100)'; };
				thumbWrapper.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

				const pageNum = document.createElement('div');
				pageNum.textContent = `é ç¢¼ ${i}`;
				pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';

				// å»¶é²æ¸²æŸ“é‚è¼¯
				thumbWrapper.renderFunction = async () => {
					if (thisRenderId !== currentRenderId) return;
					try {
						const page = await pdfDoc.getPage(i);
						const targetScale = 0.2;
						const viewport = page.getViewport({ scale: targetScale });
						const canvas = document.createElement('canvas');
						canvas.width = viewport.width;
						canvas.height = viewport.height;
						
						const ctx = canvas.getContext('2d');
						await page.render({ canvasContext: ctx, viewport: viewport }).promise;
						
						// é»æ“Šäº‹ä»¶
						thumbWrapper.addEventListener('click', (e) => {
							e.stopPropagation(); 
							showFullScreenPreview(pdfDoc, i);
						});
						
						// æ’å…¥ canvas (æ”¾åœ¨ pageNum ä¹‹å‰)
						thumbWrapper.insertBefore(canvas, pageNum);
						
						// ç§»é™¤ä½”ä½æ¨£å¼
						thumbWrapper.style.width = '';
						thumbWrapper.style.height = '';
					} catch(e) { console.error(e); }
				};

				thumbWrapper.appendChild(pageNum);
				container.appendChild(thumbWrapper);
				
				// åŠ å…¥è§€å¯Ÿ
				thumbnailObserver.observe(thumbWrapper);
			}

			if (pdfDoc.numPages > numPagesToPreview) {
				const moreInfo = document.createElement('div');
				moreInfo.className = 'flex items-center justify-center p-2 text-sm text-gray-500';
				moreInfo.textContent = `(å°šæœ‰ ${pdfDoc.numPages - numPagesToPreview} é )`;
				container.appendChild(moreInfo);
			}

		} catch (error) {
			console.error('Error loading PDF for preview:', error);
			if (container.children.length === 0) {
				 showMessage('é è¦½æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
			}
		}
	}

    async function drawPageAsync(page, canvas, targetViewport, renderId) {
        try {
            // å¦‚æœç™¼ç¾æ§åˆ¶å°å°å‡º "Render ID is NaN"ï¼Œè«‹æª¢æŸ¥è®Šæ•¸å®£å‘Š
            if (Number.isNaN(renderId)) {
                console.warn('Render ID is NaN! è«‹æª¢æŸ¥ let currentRenderId = 0;');
            }

            const ctx = canvas.getContext('2d');

            // æ¥µé€Ÿæ¸²æŸ“ (æ¨¡ç³Šç‰ˆ)
            const lowResScale = targetViewport.scale / 5; 
            const lowResViewport = page.getViewport({ scale: lowResScale });
            
            canvas.width = lowResViewport.width;
            canvas.height = lowResViewport.height;

            await page.render({ canvasContext: ctx, viewport: lowResViewport }).promise;
            
            // å»¶é²å¾Œæ¸²æŸ“æ¸…æ™°ç‰ˆ
            setTimeout(async () => {
                // æª¢æŸ¥ï¼šå¦‚æœ renderId æœ‰å€¼ä¸”èˆ‡ç•¶å‰ ID ä¸ç¬¦ï¼Œæ‰åœæ­¢
                // (é€™è£¡åŠ ä¸Šé˜²å‘†ï¼šå¦‚æœ renderId æ˜¯ç„¡æ•ˆçš„ï¼Œæˆ‘å€‘é¸æ“‡ç¹¼çºŒç•«ï¼Œé¿å…æ°¸é æ¨¡ç³Š)
                if (renderId !== undefined && !Number.isNaN(renderId) && renderId !== currentRenderId) {
                    return;
                }

                // é‡è¨­å°ºå¯¸ (é€™æœƒæ¸…ç©ºç•«å¸ƒ)
                canvas.width = targetViewport.width;
                canvas.height = targetViewport.height;
                
                // æ¸²æŸ“æ¸…æ™°åœ–
                await page.render({ canvasContext: ctx, viewport: targetViewport }).promise;
                
                // ç§»é™¤æ¨¡ç³Šæ¿¾é¡
                canvas.classList.add('loaded');
            }, 50);

        } catch (err) {
            console.warn('Page render error:', err);
        }
    }

    // åˆªé™¤æª”æ¡ˆ
    deleteFileBtn.addEventListener('click', () => {
        if (selectedFileIndex !== -1) {
            filesForMerge.splice(selectedFileIndex, 1);
            selectedFileIndex = -1;
            renderMergeFileList();
        }
    });

    mergeNextBtn.addEventListener('click', async () => {
        if (filesForMerge.length === 0) {
            showMessage('è«‹åŒ¯å…¥è‡³å°‘ä¸€å€‹æª”æ¡ˆé€²è¡Œåˆæˆã€‚');
            return;
        }

        const actionArea = document.getElementById('mergeNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="mergeFilename" class="form-input" value="åˆæˆ-${formatDate(new Date())}">
                </div>
                <div id="mergeProgress" class="text-sm text-blue-600 font-medium hidden">æº–å‚™ä¸­...</div>
                <button id="exportMerge" class="btn btn-green w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;

        document.getElementById('exportMerge').addEventListener('click', async () => {
            const btn = document.getElementById('exportMerge');
            const progressDiv = document.getElementById('mergeProgress');
            const filename = document.getElementById('mergeFilename').value;
            
            // é–å®šæŒ‰éˆ•ä¸¦é¡¯ç¤ºé€²åº¦
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';
            progressDiv.classList.remove('hidden');

            try {
                const mergedPdf = await PDFLib.PDFDocument.create();
                
                for (let i = 0; i < filesForMerge.length; i++) {
                    const file = filesForMerge[i];
                    
                    progressDiv.textContent = `æ­£åœ¨è™•ç†ç¬¬ ${i + 1} / ${filesForMerge.length} å€‹æª”æ¡ˆï¼š${file.name}`;
                    
                    await new Promise(resolve => setTimeout(resolve, 10));

                    const pdfBytes = await file.arrayBuffer();
                    const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                    const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }
                
                progressDiv.textContent = 'æ­£åœ¨å„²å­˜æª”æ¡ˆ...';
                await new Promise(resolve => setTimeout(resolve, 10)); 

                const mergedPdfBytes = await mergedPdf.save();
                downloadPDF(mergedPdfBytes, filename);
                
                showMessage('PDF åˆæˆä¸¦åŒ¯å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('Error merging PDFs:', error);
                showMessage('PDF åˆæˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                btn.disabled = false;
                btn.textContent = 'åŒ¯å‡ºæª”æ¡ˆ';
                progressDiv.classList.add('hidden');
            }
        });
    });
    
    // ==================== ç·¨é ç¢¼åŠŸèƒ½ ====================
    // ç•¶æª”æ¡ˆè¼‰å…¥å¾Œï¼Œæ‰å•Ÿç”¨ã€Œä¸‹ä¸€æ­¥ã€æŒ‰éˆ•
    fileInput.addEventListener('change', () => {
        if (currentMode === 'pagenumber' && fileInput.files.length > 0) {
            pageNumberNextBtn.disabled = false;
        } else if (currentMode === 'pagenumber') {
            pageNumberNextBtn.disabled = true;
        }
    });

    pageNumberNextBtn.addEventListener('click', () => {
        if (!loadedPDF) {
            showMessage('è«‹å…ˆåŒ¯å…¥PDFæª”æ¡ˆã€‚');
            return;
        }
        const actionArea = document.getElementById('pageNumberNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="pageNumberFilename" class="form-input" value="é ç¢¼-${formatDate(new Date())}">
                </div>
                <button id="exportPageNumber" class="btn btn-green w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;
        document.getElementById('exportPageNumber').addEventListener('click', handlePageNumberExport);
    });

    async function handlePageNumberExport() {
        if (!loadedPDF || !singleLoadedFile) { 
            showMessage('è«‹å…ˆåŒ¯å…¥PDFæª”æ¡ˆã€‚');
            return;
        }
        const startNumber = parseInt(pageNumberStart.value) || 1;
        const fromPage = parseInt(pageNumberFromPage.value);
        const position = pageNumberPosition.value;
		const type = pageNumberType.value; 
        const filename = document.getElementById('pageNumberFilename').value;

        if (isNaN(fromPage) || fromPage < 1 || fromPage > loadedPDF.numPages) {
            showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹é ç¢¼ã€‚');
            return;
        }

        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await singleLoadedFile.arrayBuffer());
            const pages = pdfDoc.getPages();
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            
            const startPageIndex = fromPage - 1;

            for (let i = startPageIndex; i < pages.length; i++) {
                const page = pages[i];
                const { width, height } = page.getSize();
                const pageNum = startNumber + (i - startPageIndex);
                const text = pageNum.toString();
                const textSize = 18;
                const textWidth = font.widthOfTextAtSize(text, textSize);
                const margin = 30;
                let xPosition;
				
				if (type === 'same') {
					// ã€ŒåŒå´ã€ï¼šå›ºå®šåœ¨èµ·å§‹ä½ç½®
					xPosition = (position === 'left') ? margin : width - textWidth - margin;
				} else {
					// ã€Œäº¤å‰ã€ï¼šäº¤æ›¿å‡ºç¾ (å¥‡æ•¸é /å¶æ•¸é æ±ºå®š)
					const isOddPage = (pageNum % 2 !== 0);
					
					if (position === 'left') {
						// Start on left, then alternate (Odd=Left, Even=Right)
						xPosition = isOddPage ? margin : width - textWidth - margin;
					} else {
						// Start on right, then alternate (Odd=Right, Even=Left)
						xPosition = isOddPage ? width - textWidth - margin : margin;
					}
				}

                page.drawText(text, {
                    x: xPosition,
                    y: margin,
                    size: textSize,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('é ç¢¼ç·¨å¯«ä¸¦åŒ¯å‡ºæˆåŠŸï¼');

        } catch (error) {
            console.error('Error adding page numbers:', error);
            showMessage('é ç¢¼ç·¨å¯«æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
        }
    }
    
    // ==================== æ—‹è½‰åŠŸèƒ½ ====================
	async function renderRotateThumbnails(pdfDoc) {
		rotateThumbnails.innerHTML = '';
		const numPages = pdfDoc.numPages;
		const thisRenderId = currentRenderId;
		
		for (let i = 1; i <= numPages; i++) {
			if (thisRenderId !== currentRenderId) return;

			const thumbWrapper = document.createElement('div');
			thumbWrapper.className = `thumb-wrapper`;
			thumbWrapper.style.cursor = 'pointer';
			thumbWrapper.style.minHeight = '150px';
			thumbWrapper.style.minWidth = '120px';
			thumbWrapper.style.display = 'flex';
			thumbWrapper.style.flexDirection = 'column';
			thumbWrapper.style.alignItems = 'center';
			
			thumbWrapper.onmouseover = function() { this.style.backgroundColor = 'var(--gray-100)'; };
			thumbWrapper.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

			thumbWrapper.dataset.page = i - 1;
			const pageNum = document.createElement('div');
			pageNum.textContent = i;
			pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
			
			// å»¶é²æ¸²æŸ“é‚è¼¯
			thumbWrapper.renderFunction = async () => {
				if (thisRenderId !== currentRenderId) return;
				try {
					const page = await pdfDoc.getPage(i);
					const viewport = page.getViewport({ scale: 0.3, rotation: rotateRotations[i - 1] });
					const canvas = document.createElement('canvas');
					canvas.width = viewport.width;
					canvas.height = viewport.height;
					const context = canvas.getContext('2d');
					await page.render({ canvasContext: context, viewport: viewport }).promise;
					
					thumbWrapper.prepend(canvas);
					thumbWrapper.style.minHeight = '';
					thumbWrapper.style.minWidth = '';
				} catch (e) {
					console.error(e);
				}
			};

			thumbWrapper.appendChild(pageNum);
			rotateThumbnails.appendChild(thumbWrapper);

			// ç¶å®šé»æ“Šäº‹ä»¶ (é¸å–é é¢)
			thumbWrapper.addEventListener('click', () => {
				document.querySelectorAll('#rotateThumbnails .selected-thumbnail').forEach(t => t.classList.remove('selected-thumbnail'));
				thumbWrapper.classList.add('selected-thumbnail');
				selectedRotatePage = i - 1;
				rotatePageBtn.disabled = false;
			});

			// åŠ å…¥è§€å¯Ÿ
			thumbnailObserver.observe(thumbWrapper);
		}
		
		// å¦‚æœæœ‰å·²é¸å–çš„é é¢ï¼Œé‡æ–°æ¨™è¨˜
		if (selectedRotatePage !== -1) {
			// é€™è£¡éœ€è¦ç¨å¾®å»¶é²æˆ–ç­‰å¾… DOM æ›´æ–°ï¼Œç°¡å–®è™•ç†å³å¯
			setTimeout(() => {
				const currentSelectedThumb = document.querySelector(`[data-page="${selectedRotatePage}"]`);
				if (currentSelectedThumb) {
					currentSelectedThumb.classList.add('selected-thumbnail');
				}
			}, 100);
		}
	}

    rotatePageBtn.addEventListener('click', async () => {
        if (selectedRotatePage === -1) {
            showMessage('è«‹å…ˆé¸æ“‡è¦æ—‹è½‰çš„é é¢ã€‚');
            return;
        }
        
        // æ›´æ–°æ—‹è½‰è§’åº¦
        rotateRotations[selectedRotatePage] = (rotateRotations[selectedRotatePage] + 90) % 360;

        // æ‰¾åˆ°ç•¶å‰è¢«é¸ä¸­çš„ç¸®åœ–åŒ…è£ (çˆ¶å…ƒç´ )
        const thumbWrapper = document.querySelector(`#rotateThumbnails .selected-thumbnail`);
        
        if (!thumbWrapper || thumbWrapper.dataset.page != selectedRotatePage) {
            console.warn('Selected thumbnail sync issue, falling back to full render.');
            await renderRotateThumbnails(loadedPDF);
            return;
        }

        const oldCanvas = thumbWrapper.querySelector('canvas');
        if (!oldCanvas) {
            console.error('No canvas found in selected thumbnail.');
            await renderRotateThumbnails(loadedPDF); // Fallback
            return;
        }

        try {
            const pageNum = selectedRotatePage + 1;
            const page = await loadedPDF.getPage(pageNum);
            const newRotation = rotateRotations[selectedRotatePage];
            const viewport = page.getViewport({ scale: 0.3, rotation: newRotation });
            const newCanvas = document.createElement('canvas');
			
            newCanvas.width = viewport.width;
            newCanvas.height = viewport.height;
            
            const context = newCanvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            
            await page.render(renderContext).promise;

            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);

        } catch (error) {
            console.error('Error re-rendering single rotated thumbnail:', error);
            await renderRotateThumbnails(loadedPDF);
        }
    });

    rotateNextBtn.addEventListener('click', () => {
        const actionArea = document.getElementById('rotateNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                    <input type="text" id="rotateFilename" class="form-input" value="æ—‹è½‰-${formatDate(new Date())}">
                </div>
                <button id="exportRotate" class="btn btn-green w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
            </div>
        `;
        document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
    });

    async function handleRotateExport() {
        if (!loadedPDF || !singleLoadedFile) {
            showMessage('è«‹å…ˆåŒ¯å…¥PDFæª”æ¡ˆã€‚');
            return;
        }

        const filename = document.getElementById('rotateFilename').value;
        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await singleLoadedFile.arrayBuffer());
            const pages = pdfDoc.getPages();
            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                if (rotateRotations[i] !== 0) {
                    const existingRotation = page.getRotation();
                    const newRotation = (existingRotation.angle + rotateRotations[i]) % 360;
                    page.setRotation(PDFLib.degrees(newRotation));
                }
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('PDF æ—‹è½‰ä¸¦åŒ¯å‡ºæˆåŠŸï¼');

        } catch (error) {
            console.error('Error rotating PDF:', error);
            showMessage('PDF æ—‹è½‰æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
        }
    }
	
	// ==================== OCR ç¸®åœ–æ¸²æŸ“ ====================
	async function renderOcrThumbnails(pdfDoc) {
		const ocrThumbnails = document.getElementById('ocrThumbnails');
		ocrThumbnails.innerHTML = '';
		const numPages = pdfDoc.numPages;
		const thisRenderId = currentRenderId;

		const cutMarkerStart = document.createElement('div');
		cutMarkerStart.className = 'cut-marker';
		cutMarkerStart.dataset.page = 0;
		cutMarkerStart.addEventListener('click', () => toggleOcrSplitPoint(0));
		ocrThumbnails.appendChild(cutMarkerStart);

		for (let i = 1; i <= numPages; i++) {
			if (thisRenderId !== currentRenderId) return;
			
			const thumbWrapper = document.createElement('div');
			thumbWrapper.className = 'thumb-wrapper';
			thumbWrapper.style.minHeight = '150px';
			thumbWrapper.style.minWidth = '120px';
			thumbWrapper.style.display = 'flex';
			thumbWrapper.style.flexDirection = 'column';
			thumbWrapper.style.alignItems = 'center';

			const pageNum = document.createElement('div');
			pageNum.textContent = i;
			pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
			
			// å»¶é²æ¸²æŸ“é‚è¼¯
			thumbWrapper.renderFunction = async () => {
				if (thisRenderId !== currentRenderId) return;
				try {
					const page = await pdfDoc.getPage(i);
					const viewport = page.getViewport({ scale: 0.3 });
					const canvas = document.createElement('canvas');
					canvas.width = viewport.width;
					canvas.height = viewport.height;
					const context = canvas.getContext('2d');
					
					canvas.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));
					
					await page.render({ canvasContext: context, viewport: viewport }).promise;
					
					thumbWrapper.prepend(canvas);
					thumbWrapper.style.minHeight = '';
					thumbWrapper.style.minWidth = '';
				} catch (e) { console.error(e); }
			};
			
			thumbWrapper.appendChild(pageNum);
			ocrThumbnails.appendChild(thumbWrapper);
			
			// åŠ å…¥è§€å¯Ÿ
			thumbnailObserver.observe(thumbWrapper);

			if (i < numPages) {
				const cutMarker = document.createElement('div');
				cutMarker.className = 'cut-marker';
				cutMarker.dataset.page = i;
				cutMarker.addEventListener('click', () => toggleOcrSplitPoint(parseInt(cutMarker.dataset.page)));
				ocrThumbnails.appendChild(cutMarker);
			}
		}

		const cutMarkerEnd = document.createElement('div');
		cutMarkerEnd.className = 'cut-marker';
		cutMarkerEnd.dataset.page = numPages;
		cutMarkerEnd.addEventListener('click', () => toggleOcrSplitPoint(numPages));
		ocrThumbnails.appendChild(cutMarkerEnd);
		
		updateOcrUI();
	}

    function toggleOcrSplitPoint(page) {
        const index = ocrSplitPoints.indexOf(page);
        if (index > -1) {
            ocrSplitPoints.splice(index, 1);
        } else {
            if (ocrSplitPoints.length >= 2) {
                splitSelectionBox.classList.remove('hidden');
                document.getElementById('selectFirst').onclick = () => {
                    ocrSplitPoints.shift();
                    ocrSplitPoints.push(page);
                    ocrSplitPoints.sort((a, b) => a - b);
                    updateOcrUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectLast').onclick = () => {
                    ocrSplitPoints.pop();
                    ocrSplitPoints.push(page);
                    ocrSplitPoints.sort((a, b) => a - b);
                    updateOcrUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectCancel').onclick = () => {
                    splitSelectionBox.classList.add('hidden');
                };
                return;
            }
            ocrSplitPoints.push(page);
            ocrSplitPoints.sort((a, b) => a - b);
        }
        updateOcrUI();
    }

    function updateOcrUI() {
        const ocrStartPage = document.getElementById('ocrStartPage');
        const ocrEndPage = document.getElementById('ocrEndPage');
        const ocrStartBtn = document.getElementById('ocrStartBtn');
        
        const cutMarkers = document.querySelectorAll('#ocrThumbnails .cut-marker');
        cutMarkers.forEach(marker => {
            const page = parseInt(marker.dataset.page);
            if (ocrSplitPoints.includes(page)) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });

        if (ocrSplitPoints.length === 2) {
            ocrStartPage.value = ocrSplitPoints[0] + 1;
            ocrEndPage.value = ocrSplitPoints[1];
        } else {
            ocrStartPage.value = '';
            ocrEndPage.value = '';
        }

        ocrStartBtn.disabled = ocrSplitPoints.length !== 2;
    }
    
    // ç¶å®šæ–‡å­—è¼¸å…¥æ¡†
    document.getElementById('ocrStartPage').addEventListener('input', updateOcrSplitPointsFromText);
    document.getElementById('ocrEndPage').addEventListener('input', updateOcrSplitPointsFromText);

    function updateOcrSplitPointsFromText() {
        if (!loadedPDF) {
            showMessage('è«‹å…ˆåŒ¯å…¥ PDF æª”æ¡ˆã€‚');
            document.getElementById('ocrStartPage').value = '';
            document.getElementById('ocrEndPage').value = '';
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }

        const start = parseInt(document.getElementById('ocrStartPage').value);
        const end = parseInt(document.getElementById('ocrEndPage').value);
        const numPages = loadedPDF.numPages;

        ocrSplitPoints = [];

        if (isNaN(start) || start < 1 || start > numPages) {
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }
        if (isNaN(end) || end < 1 || end > numPages) {
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }
        if (start > end) {
            showMessage('çµæŸé ç¢¼ä¸èƒ½å°æ–¼èµ·å§‹é ç¢¼ã€‚');
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }

        ocrSplitPoints.push(start - 1);
        ocrSplitPoints.push(end);
        updateOcrUI();
    }
	
	const ocrPageNumber = document.getElementById('ocrPageNumber');
    const ocrStartBtn = document.getElementById('ocrStartBtn');
    const ocrStatus = document.getElementById('ocrStatus');
    const ocrResultText = document.getElementById('ocrResultText');

    async function initializeOcrWorker() {
        ocrStatus.classList.remove('hidden');
        ocrStatus.textContent = 'æ­£åœ¨åˆå§‹åŒ–è¾¨è­˜å¼•æ“... (é€™åœ¨é¦–æ¬¡ä½¿ç”¨æ™‚éœ€è¦å¹¾ç§’é˜)';
		
		const progressContainer = document.getElementById('ocrProgressContainer');
        const progressBar = document.getElementById('ocrProgressBar');
        
        ocrWorker = await Tesseract.createWorker('eng+chi_tra', 1, {
            logger: m => {
                console.log(m);
				ocrStatus.classList.remove('text-green-500');
                if (m.status === 'recognizing text') {
                    // é¡¯ç¤ºé€²åº¦æ¢ä¸¦æ›´æ–°å¯¬åº¦
                    progressContainer.classList.remove('hidden');
                    const progressValue = (m.progress * 100).toFixed(0);
                    progressBar.style.width = `${progressValue}%`;
                    ocrStatus.textContent = `è¾¨è­˜ä¸­... (${progressValue}%)`;
                    
                } else if (m.status === 'loading language training data' || m.status === 'initializing api') {
                    // è¼‰å…¥æ¨¡å‹æ™‚éš±è—é€²åº¦æ¢ (å› ç‚ºé€™æ²’æœ‰é€²åº¦ç™¾åˆ†æ¯”)
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    ocrStatus.textContent = `æ­£åœ¨è¼‰å…¥èªè¨€æ¨¡å‹...`;
                } else {
                    progressContainer.classList.add('hidden');
                    ocrStatus.textContent = `ç‹€æ…‹: ${m.status}`;
                }
            }
        });

        ocrStatus.textContent = 'è¾¨è­˜å¼•æ“æº–å‚™å°±ç·’ã€‚';
		ocrStatus.classList.remove('text-green-500');
        progressContainer.classList.add('hidden');
        progressBar.style.width = '0%';
        
        return ocrWorker;
    }

    ocrStartBtn.addEventListener('click', async () => {
        // é©—è­‰é ç¢¼å€é–“
        let startPageNum, endPageNum;
        if (ocrSplitPoints.length === 2) {
            startPageNum = ocrSplitPoints[0] + 1;
            endPageNum = ocrSplitPoints[1];
        } else {
            startPageNum = parseInt(document.getElementById('ocrStartPage').value);
            endPageNum = parseInt(document.getElementById('ocrEndPage').value);
        }

        if (isNaN(startPageNum) || isNaN(endPageNum) || startPageNum < 1 || endPageNum > loadedPDF.numPages || startPageNum > endPageNum) {
            showMessage(`è«‹é¸æ“‡æœ‰æ•ˆçš„é ç¢¼å€é–“ (1 - ${loadedPDF.numPages})ã€‚`);
            return;
        }

        const progressContainer = document.getElementById('ocrProgressContainer');
        const progressBar = document.getElementById('ocrProgressBar');

        ocrStartBtn.disabled = true;
        ocrResultText.value = '';
        originalOcrText = '';
        ocrStatus.classList.remove('text-green-500'); 
        document.getElementById('ocrResultTools').classList.add('hidden'); 
        document.getElementById('copyOcrTextBtn').disabled = true;

        puncToggles = { colon: false, comma: false, paren: false };
        document.querySelectorAll('.punc-btn').forEach(btn => btn.classList.remove('active'));

        let fullText = ""; // ç”¨æ–¼å„²å­˜æ‰€æœ‰é é¢çš„æ–‡å­—

        try {
            // åˆå§‹åŒ– Tesseract Worker
            if (!ocrWorker) {
                ocrWorker = await initializeOcrWorker();
            }
            
            ocrStatus.classList.remove('hidden');

            // è¿´åœˆè¾¨è­˜æ¯ä¸€é 
            for (let i = startPageNum; i <= endPageNum; i++) {
                ocrStatus.textContent = `æ­£åœ¨æ¸²æŸ“ç¬¬ ${i} / ${endPageNum} é ...`;
                ocrStatus.classList.remove('text-green-500');
                
                const page = await loadedPDF.getPage(i);
                const scale = 3.0; 
                const viewport = page.getViewport({ scale: scale });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                ocrStatus.textContent = `æ­£åœ¨è¾¨è­˜ç¬¬ ${i} / ${endPageNum} é ...`;
                const { data: { text } } = await ocrWorker.recognize(canvas);

                fullText += `--- è¾¨è­˜é ç¢¼ ${i} ---\n\n`;
                fullText += text.replace(/ /g, '') + "\n\n";
            }

            // é¡¯ç¤ºæœ€çµ‚çµæœ
            originalOcrText = fullText; 
            applyPunctuationFilters(); 
            
            ocrStatus.textContent = 'è¾¨è­˜å®Œæˆã€‚';
            ocrStatus.classList.add('text-green-500'); 
            
            progressBar.style.width = '100%';
            document.getElementById('ocrResultTools').classList.remove('hidden'); // é¡¯ç¤ºæ¨™é»æŒ‰éˆ•
            document.getElementById('copyOcrTextBtn').disabled = originalOcrText.length === 0;

        } catch (error) {
            console.error('OCR Error:', error);
            showMessage('æ–‡å­—è¾¨è­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
            ocrStatus.textContent = `éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`;
            ocrStatus.classList.remove('text-green-500');
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        } finally {
            ocrStartBtn.disabled = false;
        }
    });
    
    // æ‡‰ç”¨éæ¿¾å™¨ä¸¦æ›´æ–° textarea
    function applyPunctuationFilters() {
        let tempText = originalOcrText;
        
        if (puncToggles.colon) {
            tempText = tempText.replace(/:/g, 'ï¼š');
        }
        if (puncToggles.comma) {
            tempText = tempText.replace(/,/g, 'ï¼Œ');
        }
        if (puncToggles.paren) {
            tempText = tempText.replace(/\(/g, 'ï¼ˆ').replace(/\)/g, 'ï¼‰');
        }
        
        ocrResultText.value = tempText;
    }

    document.querySelectorAll('.punc-btn').forEach(button => {
        button.addEventListener('click', () => {
            const type = button.dataset.type;
            if (type in puncToggles) {
                puncToggles[type] = !puncToggles[type];
                button.classList.toggle('active', puncToggles[type]);
                applyPunctuationFilters();
            }
        });
    });
	
    const copyOcrTextBtn = document.getElementById('copyOcrTextBtn');
    copyOcrTextBtn.addEventListener('click', () => {
        const textToCopy = document.getElementById('ocrResultText').value;
        if (!textToCopy) {
            showMessage('æ²’æœ‰æ–‡å­—å¯è¤‡è£½ã€‚');
            return;
        }

        navigator.clipboard.writeText(textToCopy).then(() => {
            const notification = document.getElementById('copyNotification');
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);

            // 1ç§’å¾Œé–‹å§‹æ·¡åŒ–
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 1010); // 10ms + 1000ms

            // å†1ç§’å¾Œæ¶ˆå¤±
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2010); // 1010ms + 1000ms
            
        }).catch(err => {
            console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
            showMessage('è¤‡è£½æ–‡å­—å¤±æ•—ã€‚');
        });
    });

    document.addEventListener('keydown', (event) => {
        const targetElement = event.target;
        if (targetElement) {
            const tagName = targetElement.tagName.toUpperCase();
            if (tagName === 'INPUT' || tagName === 'TEXTAREA' || tagName === 'SELECT') {
                return;
            }
        }

        if (currentMode === 'merge') {
            if (event.key === 'Delete' && selectedFileIndex !== -1) {
                deleteFileBtn.click();
            } else if (event.key === 'ArrowUp' && selectedFileIndex > 0) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex - 1, 0, fileToMove);
                selectedFileIndex--;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            } else if (event.key === 'ArrowDown' && selectedFileIndex < filesForMerge.length - 1 && selectedFileIndex !== -1) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex + 1, 0, fileToMove);
                selectedFileIndex++;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            }
        } else if (currentMode === 'rotate' && (event.key === 'r' || event.key === 'R') && selectedRotatePage !== -1) {
            rotatePageBtn.click();
        }
    });

    // å…¨è¢å¹•é è¦½åŠŸèƒ½
    async function showFullScreenPreview(pdfDoc, pageNum) {
        fullScreenPDF = pdfDoc;
        fullScreenPage = pageNum;
        await renderFullScreenPage();
        fullScreenPreview.classList.remove('hidden');

        // ç¶å®šéµç›¤äº‹ä»¶
        document.addEventListener('keydown', handleFullScreenKeys);
    }
    
    async function renderFullScreenPage() {
        if (!fullScreenPDF) return;

        const page = await fullScreenPDF.getPage(fullScreenPage);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const context = canvas.getContext('2d');
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        previewImage.src = canvas.toDataURL();
    }

    function closeFullScreenPreview() {
        fullScreenPreview.classList.add('hidden');
        fullScreenPDF = null;
        fullScreenPage = 0;
        document.removeEventListener('keydown', handleFullScreenKeys);
    }

    function handleFullScreenKeys(e) {
        if (e.key === 'Escape') {
            closeFullScreenPreview();
        } else if (e.key === 'ArrowLeft') {
            navigatePreview(-1);
        } else if (e.key === 'ArrowRight') {
            navigatePreview(1);
        }
    }

    function navigatePreview(direction) {
        const newPage = fullScreenPage + direction;
        if (newPage >= 1 && newPage <= fullScreenPDF.numPages) {
            fullScreenPage = newPage;
            renderFullScreenPage();
        }
    }

    previewPrevBtn.addEventListener('click', () => navigatePreview(-1));
    previewNextBtn.addEventListener('click', () => navigatePreview(1));

    fullScreenPreview.addEventListener('click', (e) => {
        if (e.target === fullScreenPreview) {
            closeFullScreenPreview();
        }
    });

    function downloadPDF(pdfBytes, filename) {
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function formatDate(date) {
        const yyyy = date.getFullYear().toString();
        const mm = (date.getMonth() + 1).toString().padStart(2, '0');
        const dd = date.getDate().toString().padStart(2, '0');
        const hh = date.getHours().toString().padStart(2, '0');
        const min = date.getMinutes().toString().padStart(2, '0');
        const ss = date.getSeconds().toString().padStart(2, '0');
        return `${yyyy}${mm}${dd}${hh}${min}${ss}`;
    }
	
    function resetFileStatus() {
		currentRenderId++;
        loadedPDF = null;
        singleLoadedFile = null;
        fileInput.value = '';
        fileStatus.textContent = 'æ”¯æ´ .pdf æ ¼å¼';
    }

    // æ¸…é™¤è£åˆ‡ (Split) è³‡æ–™
    const clearSplitBtn = document.getElementById('clearSplit');
    if (clearSplitBtn) {
        clearSplitBtn.addEventListener('click', () => {
            // é‡ç½®å…¨åŸŸæª”æ¡ˆç‹€æ…‹
            resetFileStatus();
            
            // æ¸…ç©ºç¸®åœ–å®¹å™¨ (è¦–è¦ºä¸Šç§»é™¤ PDF)
            splitThumbnails.innerHTML = '';
            
            // é‡ç½®è¼¸å…¥æ¡†èˆ‡è®Šæ•¸
            document.getElementById('splitStartPage').value = '';
            document.getElementById('splitEndPage').value = '';
            splitPoints = [];
            
            // ç¦ç”¨æŒ‰éˆ•
            splitNextBtn.disabled = true;
        });
    }

    // æ¸…é™¤åˆæˆ (Merge) è³‡æ–™
    const clearMergeBtn = document.getElementById('clearMerge');
    if (clearMergeBtn) {
        clearMergeBtn.addEventListener('click', () => {
            // åˆæˆæ¨¡å¼æœ‰è‡ªå·±çš„æª”æ¡ˆé™£åˆ—ï¼Œéœ€ç¨ç«‹è™•ç†
            filesForMerge = [];
            selectedFileIndex = -1;
            
            // é‡ç½®æ¸…å–®é¡¯ç¤º
            renderMergeFileList(); // é€™æœƒè‡ªå‹•é¡¯ç¤ºã€Œè«‹åŒ¯å…¥ PDF...ã€
            
            // é‡ç½®ç‹€æ…‹æ–‡å­—èˆ‡ Input
            fileStatus.textContent = 'æ”¯æ´ .pdf æ ¼å¼';
            fileInput.value = '';
            
            // ç¦ç”¨æŒ‰éˆ•
            mergeNextBtn.disabled = true;
        });
    }

    // æ¸…é™¤é ç¢¼ (PageNumber) è³‡æ–™
    const clearPageNumberBtn = document.getElementById('clearPageNumber');
    if (clearPageNumberBtn) {
        clearPageNumberBtn.addEventListener('click', () => {
            // é‡ç½®å…¨åŸŸæª”æ¡ˆç‹€æ…‹
            resetFileStatus();
            
            // é‡ç½®è¼¸å…¥æ¡†ç‚ºé è¨­å€¼
            document.getElementById('pageNumberStart').value = '1';
            document.getElementById('pageNumberFromPage').value = '';
            document.getElementById('pageNumberFromPage').placeholder = 'é ç¢¼'; // é‡ç½® placeholder
            document.getElementById('pageNumberPosition').value = 'left';
            document.getElementById('pageNumberType').value = 'same';
            
            // ç¦ç”¨æŒ‰éˆ•
            pageNumberNextBtn.disabled = true;
        });
    }

    // æ¸…é™¤æ—‹è½‰ (Rotate) è³‡æ–™
    const clearRotateBtn = document.getElementById('clearRotate');
    if (clearRotateBtn) {
        clearRotateBtn.addEventListener('click', () => {
            // é‡ç½®å…¨åŸŸæª”æ¡ˆç‹€æ…‹
            resetFileStatus();
            
            // æ¸…ç©ºç¸®åœ–å®¹å™¨
            rotateThumbnails.innerHTML = '';
            
            // é‡ç½®è®Šæ•¸
            rotateRotations = [];
            selectedRotatePage = -1;
            
            // é‡ç½®æ“ä½œå€åŸŸ (å¦‚æœå·²ç¶“è®ŠæˆåŒ¯å‡ºä»‹é¢ï¼Œè¦é‚„åŸå›ã€Œä¸‹ä¸€æ­¥ã€æŒ‰éˆ•)
            const rotateActionArea = document.getElementById('rotateAction');
            rotateActionArea.innerHTML = `
                <button id="rotateNext" class="btn btn-blue btn-lg" disabled>ä¸‹ä¸€æ­¥</button>
            `;
            // é‡æ–°æŠ“å– DOM ä¸¦ç¶å®šäº‹ä»¶ (å› ç‚ºè¢« innerHTML è¦†è“‹äº†)
            rotateNextBtn = document.getElementById('rotateNext');
            // ç¶å®šäº‹ä»¶é‚è¼¯ (èˆ‡åŸæœ¬é‚è¼¯ç›¸åŒ)
            rotateNextBtn.addEventListener('click', () => {
                const actionArea = document.getElementById('rotateNext').parentNode;
                actionArea.innerHTML = `
                    <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                        <div class="flex items-center space-x-2">
                            <label class="font-medium text-gray-700">æª”æ¡ˆåç¨±:</label>
                            <input type="text" id="rotateFilename" class="form-input" value="æ—‹è½‰-${formatDate(new Date())}">
                        </div>
                        <button id="exportRotate" class="btn btn-green w-full md:w-auto">åŒ¯å‡ºæª”æ¡ˆ</button>
                    </div>
                `;
                document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
            });

            // ç¦ç”¨æŒ‰éˆ•
            rotatePageBtn.disabled = true;
            rotateNextBtn.disabled = true;
        });
    }

    // æ¸…é™¤ OCR è³‡æ–™
    const clearOcrBtn = document.getElementById('clearOcr');
    if (clearOcrBtn) {
        clearOcrBtn.addEventListener('click', () => {
            // é‡ç½®å…¨åŸŸæª”æ¡ˆç‹€æ…‹
            resetFileStatus();
            
            // æ¸…ç©ºç¸®åœ–å®¹å™¨
            document.getElementById('ocrThumbnails').innerHTML = '';
            
            // é‡ç½®è¼¸å…¥æ¡†èˆ‡è®Šæ•¸
            document.getElementById('ocrStartPage').value = '';
            document.getElementById('ocrEndPage').value = '';
            ocrSplitPoints = [];
            
            // æ¸…ç©ºçµæœèˆ‡éš±è—å·¥å…·åˆ—
            const ocrResultText = document.getElementById('ocrResultText');
            if (ocrResultText) ocrResultText.value = '';
            originalOcrText = '';
            
            document.getElementById('ocrStatus').classList.add('hidden');
            document.getElementById('ocrStatus').textContent = '';
            document.getElementById('ocrResultTools').classList.add('hidden');
            document.getElementById('copyOcrTextBtn').disabled = true;
            document.getElementById('ocrProgressContainer').classList.add('hidden');
            document.getElementById('ocrProgressBar').style.width = '0%';

            // é‡ç½®æ¨™é»ç¬¦è™ŸæŒ‰éˆ•
            puncToggles = { colon: false, comma: false, paren: false };
            document.querySelectorAll('.punc-btn').forEach(btn => btn.classList.remove('active'));
            
            // ç¦ç”¨é–‹å§‹æŒ‰éˆ•
            document.getElementById('ocrStartBtn').disabled = true;
        });
    }
</script>
</body>
</html>
