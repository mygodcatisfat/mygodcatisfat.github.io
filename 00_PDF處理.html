<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 蝺刻摩撌亙</title>
    <style>
        :root {
            --primary: #3b82f6; /* blue-500 */
            --primary-hover: #2563eb; /* blue-600 */
            --primary-light: #93c5fd; /* blue-300 */
            --primary-bg: #eff6ff; /* blue-50 */
            
            --success: #22c55e; /* green-500 */
            --success-hover: #16a34a; /* green-600 */
            --success-light: #86efac; /* green-300 */
            
            --danger: #ef4444; /* red-500 */
            --danger-hover: #dc2626; /* red-600 */
            --danger-light: #fca5a5; /* red-300 */
            
            --warning: #eab308; /* yellow-500 */
            --warning-hover: #ca8a04; /* yellow-600 */
            --warning-light: #fde047; /* yellow-300 */

            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            --font-main: 'Inter', sans-serif;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: var(--font-main);
            background-color: var(--gray-100);
            color: var(--gray-800);
            padding: 2rem;
            margin: 0;
        }

        /* Layout & Containers */
        .container {
            max-width: 72rem; /* 6xl */
            margin: 0 auto;
        }

        .card {
            background-color: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
        }
        @media (min-width: 768px) {
            .card { padding: 2.5rem; }
        }

        .main-title {
            font-size: 1.875rem; /* 3xl */
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary-hover);
        }

        .section-header {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .section-title {
            font-size: 1.25rem; /* xl */
            font-weight: 600;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { display: flex; flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .justify-start { justify-content: flex-start; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .font-medium { font-weight: 500; }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-gray-700 { color: var(--gray-700); }
        
        /* Drop Zone */
        .drop-zone {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            text-align: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone label {
            cursor: pointer;
            color: var(--primary);
        }
        .drop-zone label:hover {
            color: var(--primary-hover);
        }
        .drop-zone-text-main {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        /* JS toggled classes */
        .drop-zone.border-blue-500 { border-color: var(--primary); }
        .drop-zone.bg-blue-50 { background-color: var(--primary-bg); }

        /* Tabs */
        .tabs-container {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        .tab-button {
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--gray-600);
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        /* Buttons (General) */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            color: white;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:disabled {
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-lg { padding: 0.75rem 1.5rem; }

        .btn-blue { background-color: var(--primary); }
        .btn-blue:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-blue:disabled { background-color: var(--primary-light); }

        .btn-red { background-color: var(--danger); }
        .btn-red:hover:not(:disabled) { background-color: var(--danger-hover); }
        .btn-red:disabled { background-color: var(--danger-light); }

        .btn-yellow { background-color: var(--warning); }
        .btn-yellow:hover:not(:disabled) { background-color: var(--warning-hover); }
        .btn-yellow:disabled { background-color: var(--warning-light); }
        
        .btn-green { background-color: var(--success); }
        .btn-green:hover:not(:disabled) { background-color: var(--success-hover); }
        .btn-green:disabled { background-color: var(--success-light); }
        
        .btn-gray { background-color: var(--gray-500); }
        .btn-gray:hover { background-color: var(--gray-600); }

        /* Inputs */
        .form-input {
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            transition: all 0.2s;
            outline: none;
        }
        .form-input:focus {
            ring: 2px;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* blue-400 */
            border-color: rgba(59, 130, 246, 0.5);
        }
        .w-24 { width: 6rem; }
        
        /* Thumbnails Container */
        .thumb-container {
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            scrollbar-width: thin;
        }
        .thumb-container::-webkit-scrollbar {
            height: 8px;
        }
        .thumb-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .thumb-container::-webkit-scrollbar-track {
            background-color: #e2e8f0;
            border-radius: 4px;
        }

        /* OCR & Punctuation Buttons */
        .punc-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            color: var(--gray-700);
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .punc-btn:hover { background-color: var(--gray-50); }
        .punc-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .punc-btn.active:hover { background-color: var(--primary-hover); }

        /* Custom UI Elements */
        .cut-marker {
            width: 1.5rem;
            height: 1.5rem;
            background-color: white;
            border: 2px solid #60a5fa; /* Blue-400 */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin: 0 0.5rem;
            flex-shrink: 0;
        }
        .cut-marker:hover {
            transform: scale(1.1);
        }
        .cut-marker.active {
            background-color: var(--success);
            border-color: var(--success);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Tooltip Icon */
        .info-tooltip-container {
            position: relative;
            margin-left: 1rem;
        }
        .info-tooltip-icon {
            color: var(--gray-500);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--gray-500);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Sortable List */
        .sortable-item {
            cursor: grab;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: white;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
        }
        .sortable-item:hover { background-color: var(--gray-50); }
        .sortable-item:active { cursor: grabbing; }

        /* Selected State (JS Toggled) */
        .ring-2 { box-shadow: 0 0 0 2px var(--primary); }
        .ring-blue-500 { /* Helper for JS compatibility */ }
        .selected-thumbnail { box-shadow: 0 0 0 2px var(--primary); }

        /* Modals & Overlays */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .overlay-bg {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            max-width: 24rem;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Full Screen Preview */
        .split-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .split-overlay-content { position: relative; }
        .overlay-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            z-index: 110;
            border: none;
        }
        .overlay-nav-button.left { left: 20px; }
        .overlay-nav-button.right { right: 20px; }
        #previewImage {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        /* Tooltip Modal */
        #tooltipModal {
            background-color: rgba(17, 24, 39, 0.7); /* gray-900 opacity 70 */
            backdrop-filter: blur(4px);
        }
        .tooltip-card {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            max-width: 32rem; /* lg */
            width: 100%;
        }
        .tooltip-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-hover);
            margin-bottom: 1rem;
        }
        /* Styles for injected tooltip content */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { margin-left: 1.5em; list-style-type: disc; }
        .text-green-500 { color: var(--success); }
        .text-blue-500 { color: var(--primary); }
        .text-red-500 { color: var(--danger); }
        .text-orange-500 { color: #f97316; }

        /* Back Home Button */
        .back-home-btn {
            position: fixed;
            right: 16px;
            top: 10px;
            z-index: 300;
            background: #2563eb;
            color: #fff;
            padding: 6px 8px;
            border-radius: 9px;
            box-shadow: 0 4px 14px rgba(37,99,235,0.18);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            gap: 0.5em;
            text-decoration: none;
        }
        .back-home-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 6px 18px rgba(37,99,235,0.28);
        }

        /* Notification */
        #copyNotification {
            position: fixed;
            top: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--gray-800);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 300;
            opacity: 0;
            transition: opacity 1s;
        }

        /* OCR Result Area */
        #ocrResultText {
            width: 100%;
            height: 16rem;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: var(--gray-50);
            resize: vertical;
            box-sizing: border-box;
            outline: none;
        }
        .ocr-progress-container {
            width: 100%;
            background-color: var(--gray-200);
            border-radius: 9999px;
            height: 0.625rem;
            margin-bottom: 1rem;
        }
        .ocr-progress-bar {
            background-color: var(--primary-hover);
            height: 0.625rem;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        .fieldset-border {
            border: 1px solid var(--gray-300);
            padding: 0.75rem;
            border-radius: var(--radius-md);
        }
        legend { font-size: 0.875rem; font-weight: 500; color: var(--gray-700); padding: 0 0.5rem; }

        /* Thumb Wrapper inside JS */
        .thumb-wrapper {
            position: relative;
            flex-shrink: 0;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="main-title">PDF 蝺刻摩撌亙</h1>

            <div id="dropZone" class="drop-zone">
                <label for="fileInput">
                    <p class="drop-zone-text-main">暺?甇方????單?獢甇?/p>
                    <p id="fileStatus" class="text-sm text-gray-500">?舀 .pdf ?澆?</p>
                </label>
                <input type="file" id="fileInput" class="hidden" multiple accept=".pdf">
            </div>

            <div class="tabs-container">
                <button id="tabSplit" class="tab-button active">鋆?</button>
                <button id="tabMerge" class="tab-button">??</button>
                <button id="tabPageNumber" class="tab-button">蝺券?蝣?/button>
                <button id="tabRotate" class="tab-button">??</button>
                <button id="tabOcr" class="tab-button">??颲刻?(?垢)</button>
            </div>

            <div id="sectionSplit" class="tool-section">
                <div class="section-header">
                    <h2 class="section-title">鋆??</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="split">?</span>
                    </div>
                </div>
                
                <div id="splitTextInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">敺洵</label>
                        <input type="number" id="splitStartPage" placeholder="?Ⅳ" class="form-input w-24">
                        <label class="font-medium text-gray-700">???蝚?/label>
                        <input type="number" id="splitEndPage" placeholder="?Ⅳ" class="form-input w-24">
                        <label class="font-medium text-gray-700">??/label>
                    </div>
                </div>

                <div id="splitImageSelection" class="mb-6">
                    <div id="splitThumbnails" class="thumb-container">
                        </div>
                </div>

                <div id="splitAction" class="flex justify-end mt-8">
                    <button id="splitNext" class="btn btn-blue btn-lg" disabled>銝?甇?/button>
                </div>
            </div>

            <div id="sectionMerge" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">???</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="merge">?</span>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="section-title mb-4">瑼?皜</h3>
                    <ul id="mergeFileList" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[100px] space-y-2" style="background-color: var(--gray-50); border-radius: var(--radius-lg); border: 1px solid var(--gray-200); min-height: 100px; padding: 1rem;">
                        <li class="text-gray-400 text-center py-4">隢??PDF 瑼?隞仿脰???</li>
                    </ul>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="deleteFile" class="btn btn-red" disabled>?芷</button>
                    <button id="mergeNext" class="btn btn-blue btn-lg" disabled>銝?甇?/button>
                </div>
            </div>

            <div id="sectionPageNumber" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">蝺券?蝣澆???/h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="pageNumber">?</span>
                    </div>
                </div>
                <div id="pageNumberInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">韏瑕??詨?嚗?/label>
                        <input type="number" id="pageNumberStart" placeholder="1" value="1" class="form-input w-24">
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">敺洵撟暸???蝺剁?</label>
                        <input type="number" id="pageNumberFromPage" placeholder="?Ⅳ" class="form-input w-24">
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">韏瑕??Ⅳ雿蔭嚗?/label>
                        <select id="pageNumberPosition" class="form-input">
                            <option value="left">撌?/option>
                            <option value="right">??/option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">?Ⅳ?憿?嚗?/label>
                        <select id="pageNumberType" class="form-input">
                            <option value="same">?</option>
                            <option value="alternate">鈭文?</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="pageNumberNext" class="btn btn-blue btn-lg" disabled>銝?甇?/button>
                </div>
            </div>

            <div id="sectionRotate" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">???</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="rotate">?</span>
                    </div>
                </div>

                <div class="mb-4">
                    <button id="rotatePageBtn" class="btn btn-yellow" disabled>??</button>
                </div>

                <div id="rotateImageSelection" class="mb-6">
                    <div id="rotateThumbnails" class="thumb-container">
                    </div>
                </div>

                <div id="rotateAction" class="flex justify-end space-x-4 mt-8">
                    <button id="rotateNext" class="btn btn-blue btn-lg" disabled>銝?甇?/button>
                </div>
            </div>

            <div id="sectionOcr" class="tool-section hidden">
                <div class="section-header">
                    <h2 class="section-title">??颲刻?? (OCR)</h2>
                    <div class="info-tooltip-container">
                        <span class="info-tooltip-icon" data-tooltip="ocr">?</span>
                    </div>
                </div>

                <div id="ocrTextInput" class="mb-6 space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="font-medium text-gray-700">敺洵</label>
                        <input type="number" id="ocrStartPage" placeholder="?Ⅳ" class="form-input w-24">
                        <label class="font-medium text-gray-700">?儘霅蝚?/label>
                        <input type="number" id="ocrEndPage" placeholder="?Ⅳ" class="form-input w-24">
                        <label class="font-medium text-gray-700">??/label>
                    </div>
                </div>
                <div id="ocrImageSelection" class="mb-6">
                    <div id="ocrThumbnails" class="thumb-container" style="background-color: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-lg); min-height: 100px;">
                    </div>
                </div>
                <div id="ocrAction" class="flex justify-start space-x-4 mt-8">
                     <button id="ocrStartBtn" class="btn btn-blue" disabled>??颲刻?</button>
                </div>
                <div id="ocrStatus" class="my-4 text-gray-600 hidden">
                </div>
                <div id="ocrProgressContainer" class="ocr-progress-container hidden">
                    <div id="ocrProgressBar" class="ocr-progress-bar" style="width: 0%"></div>
                </div>
                <div id="ocrResultTools" class="my-4 space-y-2 hidden">
                    <fieldset class="fieldset-border">
                        <legend>璅?蝚西??寧?典?</legend>
                        <div id="punctuationSubButtons" class="flex space-x-2">
                            <button id="btnPuncColon" class="punc-btn" data-type="colon">?? ( : )</button>
                            <button id="btnPuncComma" class="punc-btn" data-type="comma">?? ( , )</button>
                            <button id="btnPuncParen" class="punc-btn" data-type="paren">?祈? ( )</button>
                        </div>
                    </fieldset>
                </div>
                <div id="ocrResultAreaWrapper" class="mb-6">
                    <label class="font-medium text-gray-700 mb-2 block">颲刻?蝯?嚗?/label>
                    <textarea id="ocrResultText" readonly placeholder="颲刻?蝯?撠＊蝷箸甇?.."></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="copyOcrTextBtn" class="btn btn-green text-sm" disabled>銴ˊ??</button>
                    </div>
                </div>
            </div>

            <div id="messageBox" class="overlay hidden">
                <div class="overlay-bg">
                    <p id="messageText" class="text-lg font-medium mb-4"></p>
                    <button id="messageOk" class="btn btn-blue">蝣箏?</button>
                </div>
            </div>

            <div id="splitSelectionBox" class="overlay hidden">
                <div class="overlay-bg">
                    <p class="text-lg font-medium mb-4">撌脤???????嚗??豢???嚗?/p>
                    <div class="flex flex-col space-y-2">
                        <button id="selectFirst" class="btn btn-blue">?芷????</button>
                        <button id="selectLast" class="btn btn-yellow">?芷敺???</button>
                        <button id="selectCancel" class="btn btn-gray">??</button>
                    </div>
                </div>
            </div>
            
            <div id="tooltipModal" class="overlay hidden">
                <div class="tooltip-card">
                    <h3 id="tooltipTitle" class="tooltip-title"></h3>
                    <div id="tooltipContentArea" class="prose text-gray-800">
                        </div>
                    <div class="mt-6 text-right">
                        <button id="tooltipOk" class="btn btn-blue">??</button>
                    </div>
                </div>
            </div>
            
            <div id="copyNotification" style="display: none;">
                撌脰?鋆賣?摮?
            </div>

            <div id="fullScreenPreview" class="split-overlay hidden">
                <div class="split-overlay-content">
                    <button id="previewPrev" class="overlay-nav-button left">??/button>
                    <img id="previewImage" src="" alt="PDF Preview">
                    <button id="previewNext" class="overlay-nav-button right">??/button>
                </div>
            </div>
        </div>

        <a href="https://mygodcatisfat.github.io" class="back-home-btn" title="?擐?">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" style="width:1.25rem; height:1.25rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h3m10-11v11a1 1 0 01-1 1h-3m-4 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1" />
            </svg>
            ?擐?
        </a>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js" integrity="sha256-H8KU7v2mAuWRoGwdWvNhyuI3VrWjNPwkIdX5rMzgOOU=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" integrity="sha256-D5pcrQeUHwgmWGyU4InYm5GMRuXBfPLVo8b2ZuO8aU8=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
	pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    const fileInput = document.getElementById('fileInput');
    const tabs = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('.tool-section');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageOk = document.getElementById('messageOk');
    const fileStatus = document.getElementById('fileStatus');
    const splitTextInput = document.getElementById('splitTextInput');
    const splitImageSelection = document.getElementById('splitImageSelection');
    const splitStartPage = document.getElementById('splitStartPage');
    const splitEndPage = document.getElementById('splitEndPage');
    const splitThumbnails = document.getElementById('splitThumbnails');
    const splitNextBtn = document.getElementById('splitNext');
    const splitSelectionBox = document.getElementById('splitSelectionBox');
    const mergeFileList = document.getElementById('mergeFileList');
    const deleteFileBtn = document.getElementById('deleteFile');
    const mergeNextBtn = document.getElementById('mergeNext');
    const pageNumberStart = document.getElementById('pageNumberStart');
    const pageNumberFromPage = document.getElementById('pageNumberFromPage');
    const pageNumberPosition = document.getElementById('pageNumberPosition');
	const pageNumberType = document.getElementById('pageNumberType'); 
    const pageNumberNextBtn = document.getElementById('pageNumberNext');
    const rotateThumbnails = document.getElementById('rotateThumbnails');
    let rotatePageBtn = document.getElementById('rotatePageBtn');
    let rotateNextBtn = document.getElementById('rotateNext');
    const tooltipModal = document.getElementById('tooltipModal');
    const tooltipTitle = document.getElementById('tooltipTitle');
    const tooltipContentArea = document.getElementById('tooltipContentArea');
    const tooltipOk = document.getElementById('tooltipOk');
    const fullScreenPreview = document.getElementById('fullScreenPreview');
    const previewImage = document.getElementById('previewImage');
    const previewPrevBtn = document.getElementById('previewPrev');
    const previewNextBtn = document.getElementById('previewNext');

    let currentMode = 'split';
    let loadedPDF = null;
    let splitPoints = [];
    let filesForMerge = [];
    let selectedFileIndex = -1;
    let fullScreenPDF = null;
    let fullScreenPage = 0;
    let rotateRotations = [];
    let selectedRotatePage = -1;
	let ocrSplitPoints = []; 
	let singleLoadedFile = null;
    let ocrWorker = null; 
    let originalOcrText = ""; 
    let puncToggles = { colon: false, comma: false, paren: false }; // 璅?蝚西???

    const tooltipData = {
        split: {
            title: '鋆??隤芣?',
            content: `
                <p>?臬 PDF 敺??典隞仿?<strong class="text-green-500">??隞</strong>??strong class="text-green-500">頛詨獢?/strong>?豢?鋆?蝭?嚗???芸??郊??/p>
                <p>暺?<strong class="text-green-500">蝬璅?</strong>?頛詨獢葉頛詨?Ⅳ靘??????/p>
                <p>?嗆?豢?頞??拙?????蝟餌絞??蝷箸?豢?靽?<strong class="text-blue-500">???/strong>??strong class="text-red-500">?敺?/strong>??????/p>
                <p><strong class="text-green-500">鋆?暺?閮?/strong>嚗?/p>
                <ul class="list-disc list-inside">
                    <li>蝚砌???*??*????隞?”敺洵銝??憪?/li>
                    <li>?敺???*敺?*????隞?”鋆??唳?敺???/li>
                </ul>
            `
        },
        merge: {
            title: '???隤芣?',
            content: `
                <p>?典隞亙??strong class="text-blue-500">憭?/strong> PDF 瑼???/p>
                <p>??**暺?**??*?**皜靘矽?湔?獢?摨?/p>
                <p>暺?皜銝剔?瑼??臬???strong class="text-green-500">?汗</strong>??/p>
                <p>?汗???*璈怠?皛曉?**嚗????**?刻撟?閬?*??/p>
                <p>雿輻<strong class="text-green-500">?萇</strong>敹急?蛛?</p>
                <ul class="list-disc list-inside">
                    <li>??<strong class="text-red-500">Delete</strong> ?蛛??芷?詨???獢?/li>
                    <li>??<strong class="text-blue-500">銝?銝悌??/strong> ?蛛?蝘餃??詨?瑼???摨?/li>
                </ul>
            `
        },
        pageNumber: {
            title: '蝺券?蝣澆??質牧??,
            content: `
                <p>隢??PDF 瑼?嚗敺身摰楊蝣潛?**韏瑕??詨?**??*韏瑕??Ⅳ**??*?Ⅳ雿蔭**??*?Ⅳ?憿?**??/p>
                <p>?Ⅳ雿蔭?身??strong class="text-green-500">???氬?/strong>嚗?隢?蝣潛楊?啣銝???賣??箏??冽?豢??絲憪?蝵柴?/p>
                <p>?仿??strong class="text-blue-500">?漱??/strong>嚗?蝣潭?敺????蝣潮?憪?摨楊撖恬?銝血?撌血<strong class="text-red-500">鈭斗?箇</strong>??/p>
                <p>靘?嚗韏瑕?雿蔭閮剖??箝椰???憿??箝漱???洵銝蝯?蝣潭??箇?典椰銝?嚗洵鈭???曉?喃?閫?靘迨憿??/p>
            `
        },
        rotate: {
            title: '???隤芣?',
            content: `
                <p>隢??PDF 瑼?嚗敺????Ｙ葬???詨???/p>
                <p>暺?<strong class="text-green-500">??頧?/strong>????銝??**<strong class="text-red-500">R</strong>** ??*嚗?臬??詨????ａ????? 90 摨艾?/p>
                <p>?典隞仿?銴?雿??????頧?摨艾?/p>
            `
        },
		ocr: {
            title: '??颲刻?? (OCR) 隤芣?',
            content: `
                <p>?臬 PDF 敺??典隞仿?<strong class="text-green-500">??隞</strong>??strong class="text-green-500">頛詨獢?/strong>?豢?颲刻???strong class="text-blue-500">?Ⅳ???/strong>??/p>
                <p>甇文??賣?雿輻 Tesseract.js 撘?靘儘霅??Ｖ???strong class="text-green-500">蝜?銝剜?</strong>??strong class="text-green-500">?望?</strong>??/p>
                <p>颲刻?摰?敺??典隞乩蝙??strong class="text-orange-500">??暺泵??箏??/strong>?嚗???璅?頧??箏??/p>
                <p>颲刻??閬?鈭???隢?蝑儘霅???憿舐內?其??寧???獢葉??/p>
                <p><strong class="text-red-500">瘜冽?嚗?/strong>颲刻?銴?????閫??摨血???嚗?蝣箏漲?航????/p>
            `
        }
    };

    // 憿舐內閮獢?
    function showMessage(text) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
    }

    messageOk.addEventListener('click', () => {
        messageBox.classList.add('hidden');
    });

    // 憿舐內?內敶?
    function showTooltip(mode) {
        const data = tooltipData[mode];
        if (data) {
            tooltipTitle.textContent = data.title;
            tooltipContentArea.innerHTML = data.content;
            tooltipModal.classList.remove('hidden');
        }
    }

    // ???內敶?
    tooltipOk.addEventListener('click', () => {
        tooltipModal.classList.add('hidden');
    });

    // ???內?內暺?鈭辣
    document.querySelectorAll('.info-tooltip-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            const mode = icon.dataset.tooltip;
            showTooltip(mode);
        });
    });

    // ???惜
    tabs.forEach(tab => {
        tab.addEventListener('click', async () => {
            // 蝯迫 OCR worker (憒?摮銝?芋撘 ocr)
            if (ocrWorker && currentMode === 'ocr' && tab.id !== 'tabOcr') {
                console.log('Terminating OCR worker...');
                await ocrWorker.terminate();
                ocrWorker = null;
                const ocrStatus = document.getElementById('ocrStatus');
                if (ocrStatus) {
                    ocrStatus.classList.add('hidden');
                    ocrStatus.textContent = '';
                }
				ocrSplitPoints = [];
            }
			
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            sections.forEach(s => s.classList.add('hidden'));
            const sectionId = `section${tab.id.replace('tab', '')}`;
            document.getElementById(sectionId).classList.remove('hidden');
            currentMode = tab.id.replace('tab', '').toLowerCase();
            fileStatus.textContent = '?舀 .pdf ?澆?';
            fileInput.value = '';
			singleLoadedFile = null;
			
			if (currentMode === 'merge') {
                fileInput.multiple = true;
            } else {
                fileInput.multiple = false;
            }
            
            if (currentMode === 'pagenumber') {
                pageNumberNextBtn.disabled = loadedPDF === null;
            } else if (currentMode === 'merge') {
                mergeNextBtn.disabled = filesForMerge.length === 0;
            } else if (currentMode === 'split') {
                splitNextBtn.disabled = loadedPDF === null || splitPoints.length !== 2;
            } else if (currentMode === 'rotate') {
                rotateNextBtn.disabled = loadedPDF === null;
            } else if (currentMode === 'ocr') {
                const ocrBtn = document.getElementById('ocrStartBtn');
                if (ocrBtn) ocrBtn.disabled = loadedPDF === null;
                
                const ocrThumbs = document.getElementById('ocrThumbnails');
                if (ocrThumbs) ocrThumbs.innerHTML = ''; 
                ocrSplitPoints = []; // 靽格甇方?
                document.getElementById('ocrResultTools').classList.add('hidden');
            }
        });
    });

	// ==================== 鋆?? ====================
    async function processFiles(files) {
        if (!files.length) {
            fileStatus.textContent = '?舀 .pdf ?澆?';
            return;
        }
        
        if (currentMode === 'split' || currentMode === 'pagenumber' || currentMode === 'rotate' || currentMode === 'ocr') {
            if (files.length > 1) {
                showMessage('甇文??賭?甈∪?質????DF瑼???);
                fileInput.value = '';
                singleLoadedFile = null; 
                return;
            }
            
            singleLoadedFile = files[0]; 
            loadedPDF = null;
            const arrayBuffer = await singleLoadedFile.arrayBuffer(); 
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            loadedPDF = pdfDoc;
            fileStatus.textContent = `撌脰??交?獢?${singleLoadedFile.name}`; 
            
            if (currentMode === 'split') {
                splitPoints = [];
                await renderSplitThumbnails(pdfDoc);
                updateSplitUI();
            } else if (currentMode === 'pagenumber') {
                pageNumberNextBtn.disabled = false;
                pageNumberFromPage.placeholder = `1 - ${loadedPDF.numPages}`;
            } else if (currentMode === 'rotate') {
                rotateRotations = Array(loadedPDF.numPages).fill(0);

                // ?蔭 "rotateAction" ???(?曉?芸???"銝?甇? ??)
                const rotateActionArea = document.getElementById('rotateAction');
                rotateActionArea.innerHTML = `
                    <button id="rotateNext" class="btn btn-blue btn-lg" disabled>銝?甇?/button>
                `;

                // ?撠??銝行??'let' 霈
                rotateNextBtn = document.getElementById('rotateNext');
                
                // ?蝬? "銝?甇? ????隞嗥?賢 (銴ˊ????line 1018 ??頛?
                rotateNextBtn.addEventListener('click', () => {
                    const actionArea = document.getElementById('rotateNext').parentNode;
                    actionArea.innerHTML = `
                        <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                            <div class="flex items-center space-x-2">
                                <label class="font-medium text-gray-700">瑼??迂:</label>
                                <input type="text" id="rotateFilename" class="form-input" value="??-${formatDate(new Date())}">
                            </div>
                            <button id="exportRotate" class="btn btn-green w-full md:w-auto">?臬瑼?</button>
                        </div>
                    `;
                    document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
                });

                await renderRotateThumbnails(pdfDoc);
                rotateNextBtn.disabled = false;
                
                // ? rotatePageBtn 撌脩??典??剁??隞亙???????閬?啣?????
                rotatePageBtn.disabled = true;
            
            } else if (currentMode === 'ocr') {
				ocrSplitPoints = [];
                await renderOcrThumbnails(pdfDoc); // ?澆?啁?皜脫??賢?
                updateOcrUI();
				document.getElementById('ocrResultText').value = ''; // 皜征????
                document.getElementById('ocrStatus').classList.add('hidden'); // ?梯????
                document.getElementById('ocrResultTools').classList.add('hidden');
            }

        } else if (currentMode === 'merge') {
            await handleMergeFiles(files);
            fileStatus.textContent = `撌脰???${files.length} ??獢;
        } else {
            showMessage('隢??蝐支??臬瑼???);
            fileInput.value = '';
            singleLoadedFile = null; 
        }
    }
	
    // ??瑼??臬
    fileInput.addEventListener('change', async (event) => {
        await processFiles(event.target.files); 
    });
	
	const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (event) => {
        event.preventDefault(); 
        dropZone.classList.add('border-blue-500', 'bg-blue-50'); 
    });

    dropZone.addEventListener('dragleave', (event) => {
        event.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50'); 
    });

    dropZone.addEventListener('drop', async (event) => {
        event.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50'); 
        const files = event.dataTransfer.files;   
        fileInput.value = '';
        await processFiles(files);
    });

    // 皜脫? PDF 蝮桀?
    async function renderSplitThumbnails(pdfDoc) {
        splitThumbnails.innerHTML = '';
        const numPages = pdfDoc.numPages;

        const cutMarkerStart = document.createElement('div');
        cutMarkerStart.className = 'cut-marker';
        cutMarkerStart.dataset.page = 0;
        cutMarkerStart.addEventListener('click', () => toggleSplitPoint(0));
        splitThumbnails.appendChild(cutMarkerStart);

        for (let i = 1; i <= numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 0.3 });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const context = canvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;

            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'thumb-wrapper';
            const pageNum = document.createElement('div');
            pageNum.textContent = i;
            pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
            
            thumbWrapper.appendChild(canvas);
            thumbWrapper.appendChild(pageNum);
            splitThumbnails.appendChild(thumbWrapper);
            
            canvas.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));

            if (i < numPages) {
                const cutMarker = document.createElement('div');
                cutMarker.className = 'cut-marker';
                cutMarker.dataset.page = i;
                cutMarker.addEventListener('click', () => toggleSplitPoint(parseInt(cutMarker.dataset.page)));
                splitThumbnails.appendChild(cutMarker);
            }
        }

        const cutMarkerEnd = document.createElement('div');
        cutMarkerEnd.className = 'cut-marker';
        cutMarkerEnd.dataset.page = numPages;
        cutMarkerEnd.addEventListener('click', () => toggleSplitPoint(numPages));
        splitThumbnails.appendChild(cutMarkerEnd);
    }

    function toggleSplitPoint(page) {
        const index = splitPoints.indexOf(page);
        if (index > -1) {
            splitPoints.splice(index, 1);
        } else {
            if (splitPoints.length >= 2) {
                splitSelectionBox.classList.remove('hidden');
                document.getElementById('selectFirst').onclick = () => {
                    splitPoints.shift();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectLast').onclick = () => {
                    splitPoints.pop();
                    splitPoints.push(page);
                    splitPoints.sort((a, b) => a - b);
                    updateSplitUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectCancel').onclick = () => {
                    splitSelectionBox.classList.add('hidden');
                };
                return;
            }
            splitPoints.push(page);
            splitPoints.sort((a, b) => a - b);
        }
        updateSplitUI();
    }

    function updateSplitUI() {
        const cutMarkers = document.querySelectorAll('.cut-marker');
        cutMarkers.forEach(marker => {
            const page = parseInt(marker.dataset.page);
            if (splitPoints.includes(page)) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });

        if (splitPoints.length === 2) {
            splitStartPage.value = splitPoints[0] + 1;
            splitEndPage.value = splitPoints[1];
        } else {
            splitStartPage.value = '';
            splitEndPage.value = '';
        }
        splitNextBtn.disabled = splitPoints.length !== 2;
    }
    
    splitStartPage.addEventListener('input', updateSplitPointsFromText);
    splitEndPage.addEventListener('input', updateSplitPointsFromText);

    function updateSplitPointsFromText() {
        if (!loadedPDF) {
            showMessage('隢??臬 PDF 瑼???);
            splitStartPage.value = '';
            splitEndPage.value = '';
            splitNextBtn.disabled = true;
            return;
        }

        const start = parseInt(splitStartPage.value);
        const end = parseInt(splitEndPage.value);
        const numPages = loadedPDF.numPages;

        splitPoints = [];

        if (isNaN(start) || start < 1 || start > numPages) {
            splitNextBtn.disabled = true;
            return;
        }
        if (isNaN(end) || end < 1 || end > numPages) {
            splitNextBtn.disabled = true;
            return;
        }
        if (start > end) {
            showMessage('蝯??Ⅳ銝撠韏瑕??Ⅳ??);
            splitNextBtn.disabled = true;
            return;
        }
        splitPoints.push(start - 1);
        splitPoints.push(end);
        updateSplitUI();
    }

    splitNextBtn.addEventListener('click', async () => {
        const file = singleLoadedFile;
        if (!file || splitPoints.length !== 2) {
            showMessage('隢?仙DF瑼?銝阡????????);
            return;
        }

        const startPage = splitPoints[0] + 1;
        const endPage = splitPoints[1];

        if (startPage > endPage) {
            showMessage('韏瑕??Ⅳ銝憭扳蝯??Ⅳ??);
            return;
        }

        const actionArea = document.getElementById('splitAction');
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">瑼??迂:</label>
                    <input type="text" id="splitFilename" class="form-input" value="?-${formatDate(new Date())}">
                </div>
                <button id="exportSplit" class="btn btn-green w-full md:w-auto">?臬瑼?</button>
            </div>
        `;

        document.getElementById('exportSplit').onclick = async () => {
            try {
                const fileToUse = singleLoadedFile;
				if (!fileToUse) {
					showMessage('?曆??啣歇頛??獢?隢??啣??PDF??);
					return;
				}

				let startPage, endPage;
				if (Array.isArray(splitPoints) && splitPoints.length === 2) {
					startPage = splitPoints[0] + 1;
					endPage = splitPoints[1];
				} else {
					startPage = parseInt(splitStartPage.value, 10);
					endPage = parseInt(splitEndPage.value, 10);
				}

				if (isNaN(startPage) || isNaN(endPage)) {
					showMessage('隢??頛詨???絲憪?蝯??Ⅳ??);
					return;
				}
				if (startPage > endPage) {
					showMessage('韏瑕??Ⅳ銝憭扳蝯??Ⅳ??);
					return;
				}
			
				const pdfBytes = await fileToUse.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const newPdfDoc = await PDFLib.PDFDocument.create();
                const pagesToKeep = Array.from({ length: endPage - startPage + 1 }, (_, i) => i + startPage - 1);
                const pages = await newPdfDoc.copyPages(pdfDoc, pagesToKeep);
                pages.forEach(page => newPdfDoc.addPage(page));
                const newPdfBytes = await newPdfDoc.save();
                const filename = document.getElementById('splitFilename').value;
                downloadPDF(newPdfBytes, filename);
                showMessage('PDF 鋆?銝血?箸???');
            } catch (error) {
                console.error('Error splitting PDF:', error);
                showMessage('PDF 鋆???隤扎?);
            }
        };
    });

    // ==================== ??? ====================
    // ????瑼??臬
    async function handleMergeFiles(files) {
        for (const file of files) {
            filesForMerge.push(file);
        }
        renderMergeFileList();
        mergeNextBtn.disabled = filesForMerge.length === 0;
    }

    // 皜脫???瑼?皜
    function renderMergeFileList() {
        mergeFileList.innerHTML = '';
        if (filesForMerge.length === 0) {
            mergeFileList.innerHTML = '<li class="text-gray-400 text-center py-4">隢??PDF 瑼?隞仿脰???</li>';
            deleteFileBtn.disabled = true;
            mergeNextBtn.disabled = true;
            return;
        }

        filesForMerge.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'sortable-item';
            li.draggable = true;
            li.dataset.index = index;

            // 瑼?鞈?
            const fileHeader = document.createElement('div');
            fileHeader.className = 'flex items-center justify-between mb-2';

            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            const orderNumber = document.createElement('div');
            orderNumber.className = 'flex items-center justify-center rounded-full font-bold text-lg mr-4 flex-shrink-0';
            orderNumber.style.backgroundColor = 'var(--primary)';
            orderNumber.style.color = 'white';
            orderNumber.style.width = '2rem';
            orderNumber.style.height = '2rem';
            
            orderNumber.textContent = index + 1;
            const fileNameSpan = document.createElement('span');
            fileNameSpan.textContent = file.name;
            fileInfo.appendChild(orderNumber);
            fileInfo.appendChild(fileNameSpan);

            fileHeader.appendChild(fileInfo);
            li.appendChild(fileHeader);
            
            // ?汗?憛?
            const previewContainer = document.createElement('div');
            previewContainer.className = 'thumb-container hidden';
            li.appendChild(previewContainer);

            li.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', index);
            });
            li.addEventListener('dragover', (e) => e.preventDefault());
            li.addEventListener('drop', (e) => {
                e.preventDefault();
                const fromIndex = e.dataTransfer.getData('text/plain');
                const toIndex = index;
                const fileToMove = filesForMerge.splice(fromIndex, 1)[0];
                filesForMerge.splice(toIndex, 0, fileToMove);
                renderMergeFileList();
            });

            li.addEventListener('click', async (event) => {
                event.stopPropagation();
                const isSelected = li.classList.contains('ring-2');

                document.querySelectorAll('.sortable-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-blue-500');
                    const container = item.querySelector('.thumb-container');
                    if (container) {
                        container.classList.add('hidden');
                    }
                });
                
                if (!isSelected) {
                    li.classList.add('ring-2', 'ring-blue-500');
                    selectedFileIndex = index;
                    deleteFileBtn.disabled = false;
                    await renderPreviewThumbnails(file, previewContainer);
                    previewContainer.classList.remove('hidden');
                } else {
                    selectedFileIndex = -1;
                    deleteFileBtn.disabled = true;
                }
            });
            mergeFileList.appendChild(li);
        });
        
        if (selectedFileIndex !== -1 && filesForMerge.length > 0) {
             document.querySelectorAll('.sortable-item')[selectedFileIndex].classList.add('ring-2', 'ring-blue-500');
        } else {
             selectedFileIndex = -1;
             deleteFileBtn.disabled = true;
        }
    }

    async function renderPreviewThumbnails(file, container) {
        container.innerHTML = '';
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            const numPagesToPreview = pdfDoc.numPages;
            for (let i = 1; i <= numPagesToPreview; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 0.2 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                const renderContext = { canvasContext: context, viewport: viewport };
                await page.render(renderContext).promise;
                const thumbWrapper = document.createElement('div');
                // Use inline style or a class for hover effect
                thumbWrapper.style.flexShrink = '0';
                thumbWrapper.style.padding = '0.5rem';
                thumbWrapper.style.border = '1px solid var(--gray-200)';
                thumbWrapper.style.borderRadius = 'var(--radius-md)';
                thumbWrapper.style.cursor = 'pointer';
                thumbWrapper.style.transition = 'background-color 0.2s';
                thumbWrapper.onmouseover = function() { this.style.backgroundColor = 'var(--gray-100)'; };
                thumbWrapper.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

                const pageNum = document.createElement('div');
                pageNum.textContent = `?Ⅳ ${i}`;
                pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
                thumbWrapper.appendChild(canvas);
                thumbWrapper.appendChild(pageNum);
                container.appendChild(thumbWrapper);
                thumbWrapper.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));
            }
        } catch (error) {
            console.error('Error loading PDF for preview:', error);
            showMessage('?汗瑼???隤扎?);
        }
    }

    // ?芷瑼?
    deleteFileBtn.addEventListener('click', () => {
        if (selectedFileIndex !== -1) {
            filesForMerge.splice(selectedFileIndex, 1);
            selectedFileIndex = -1;
            renderMergeFileList();
        }
    });

    mergeNextBtn.addEventListener('click', async () => {
        if (filesForMerge.length === 0) {
            showMessage('隢?亥撠???獢脰?????);
            return;
        }

        const actionArea = document.getElementById('mergeNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">瑼??迂:</label>
                    <input type="text" id="mergeFilename" class="form-input" value="??-${formatDate(new Date())}">
                </div>
                <button id="exportMerge" class="btn btn-green w-full md:w-auto">?臬瑼?</button>
            </div>
        `;

        document.getElementById('exportMerge').addEventListener('click', async () => {
            try {
                const mergedPdf = await PDFLib.PDFDocument.create();
                for (const file of filesForMerge) {
                    const pdfBytes = await file.arrayBuffer();
                    const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                    const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const mergedPdfBytes = await mergedPdf.save();
                const filename = document.getElementById('mergeFilename').value;
                downloadPDF(mergedPdfBytes, filename);
                showMessage('PDF ??銝血?箸???');
            } catch (error) {
                console.error('Error merging PDFs:', error);
                showMessage('PDF ????隤扎?);
            }
        });
    });
    
    // ==================== 蝺券?蝣澆???====================
    // ?嗆?獢??亙?嚗????銝甇乓???
    fileInput.addEventListener('change', () => {
        if (currentMode === 'pagenumber' && fileInput.files.length > 0) {
            pageNumberNextBtn.disabled = false;
        } else if (currentMode === 'pagenumber') {
            pageNumberNextBtn.disabled = true;
        }
    });

    pageNumberNextBtn.addEventListener('click', () => {
        if (!loadedPDF) {
            showMessage('隢??臬PDF瑼???);
            return;
        }
        const actionArea = document.getElementById('pageNumberNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">瑼??迂:</label>
                    <input type="text" id="pageNumberFilename" class="form-input" value="?Ⅳ-${formatDate(new Date())}">
                </div>
                <button id="exportPageNumber" class="btn btn-green w-full md:w-auto">?臬瑼?</button>
            </div>
        `;
        document.getElementById('exportPageNumber').addEventListener('click', handlePageNumberExport);
    });

    async function handlePageNumberExport() {
        if (!loadedPDF || !singleLoadedFile) { 
            showMessage('隢??臬PDF瑼???);
            return;
        }
        const startNumber = parseInt(pageNumberStart.value) || 1;
        const fromPage = parseInt(pageNumberFromPage.value);
        const position = pageNumberPosition.value;
		const type = pageNumberType.value; 
        const filename = document.getElementById('pageNumberFilename').value;

        if (isNaN(fromPage) || fromPage < 1 || fromPage > loadedPDF.numPages) {
            showMessage('隢撓?交???韏瑕??Ⅳ??);
            return;
        }

        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await singleLoadedFile.arrayBuffer());
            const pages = pdfDoc.getPages();
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            
            const startPageIndex = fromPage - 1;

            for (let i = startPageIndex; i < pages.length; i++) {
                const page = pages[i];
                const { width, height } = page.getSize();
                const pageNum = startNumber + (i - startPageIndex);
                const text = pageNum.toString();
                const textSize = 18;
                const textWidth = font.widthOfTextAtSize(text, textSize);
                const margin = 30;
                let xPosition;
				
				if (type === 'same') {
					// ???氬??箏??刻絲憪?蝵?
					xPosition = (position === 'left') ? margin : width - textWidth - margin;
				} else {
					// ?漱??鈭斗?箇 (憟???嗆?捱摰?
					const isOddPage = (pageNum % 2 !== 0);
					
					if (position === 'left') {
						// Start on left, then alternate (Odd=Left, Even=Right)
						xPosition = isOddPage ? margin : width - textWidth - margin;
					} else {
						// Start on right, then alternate (Odd=Right, Even=Left)
						xPosition = isOddPage ? width - textWidth - margin : margin;
					}
				}

                page.drawText(text, {
                    x: xPosition,
                    y: margin,
                    size: textSize,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('?Ⅳ蝺典神銝血?箸???');

        } catch (error) {
            console.error('Error adding page numbers:', error);
            showMessage('?Ⅳ蝺典神??隤扎?);
        }
    }
    
    // ==================== ??? ====================
    async function renderRotateThumbnails(pdfDoc) {
        rotateThumbnails.innerHTML = '';
        const numPages = pdfDoc.numPages;
        
        for (let i = 1; i <= numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 0.3, rotation: rotateRotations[i - 1] });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const context = canvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;
            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = `thumb-wrapper`;
            // Add hover effect via style or keep CSS class
            thumbWrapper.style.cursor = 'pointer';
            thumbWrapper.onmouseover = function() { this.style.backgroundColor = 'var(--gray-100)'; };
            thumbWrapper.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

            thumbWrapper.dataset.page = i - 1;
            const pageNum = document.createElement('div');
            pageNum.textContent = i;
            pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
            
            thumbWrapper.appendChild(canvas);
            thumbWrapper.appendChild(pageNum);
            rotateThumbnails.appendChild(thumbWrapper);
            thumbWrapper.addEventListener('click', () => {
                document.querySelectorAll('#rotateThumbnails .selected-thumbnail').forEach(t => t.classList.remove('selected-thumbnail'));
                thumbWrapper.classList.add('selected-thumbnail');
                selectedRotatePage = i - 1;
                rotatePageBtn.disabled = false;
            });
        }
        if (selectedRotatePage !== -1) {
            const currentSelectedThumb = document.querySelector(`[data-page="${selectedRotatePage}"]`);
            if (currentSelectedThumb) {
                currentSelectedThumb.classList.add('selected-thumbnail');
            }
        }
    }

    rotatePageBtn.addEventListener('click', async () => {
        if (selectedRotatePage === -1) {
            showMessage('隢??豢?閬?頧????);
            return;
        }
        
        // ?湔??閫漲
        rotateRotations[selectedRotatePage] = (rotateRotations[selectedRotatePage] + 90) % 360;

        // ?曉?嗅?鋡恍銝剔?蝮桀??? (?嗅?蝝?
        const thumbWrapper = document.querySelector(`#rotateThumbnails .selected-thumbnail`);
        
        if (!thumbWrapper || thumbWrapper.dataset.page != selectedRotatePage) {
            console.warn('Selected thumbnail sync issue, falling back to full render.');
            await renderRotateThumbnails(loadedPDF);
            return;
        }

        // ?曉*??* (?嗅??航??? canvas
        const oldCanvas = thumbWrapper.querySelector('canvas');
        if (!oldCanvas) {
            console.error('No canvas found in selected thumbnail.');
            await renderRotateThumbnails(loadedPDF); // Fallback
            return;
        }

        try {
            // ??撠???PDF ? (getPage ??1-based)
            const pageNum = selectedRotatePage + 1;
            const page = await loadedPDF.getPage(pageNum);
            
            // 雿輻?啁???閫漲閮?閬?
            const newRotation = rotateRotations[selectedRotatePage];
            const viewport = page.getViewport({ scale: 0.3, rotation: newRotation });

            // === [?詨?靽格] 撱箇?銝???啁?* (in-memory) canvas ===
            const newCanvas = document.createElement('canvas');
            newCanvas.width = viewport.width;
            newCanvas.height = viewport.height;
            
            // ???啁?* canvas 銝葡??(???蔣?輻??
            const context = newCanvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            
            // 蝑???canvas 蝜芾ˊ摰?
            await page.render(renderContext).promise;

            // === 皜脫?摰?敺?*?踵?*?? canvas ===
            //    ??甇交????嚗?????
            //    ???oldCanvas嚗???thumbWrapper嚗?隞?.selected-thumbnail 璅??????
            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);

        } catch (error) {
            console.error('Error re-rendering single rotated thumbnail:', error);
            // 憒??桅??湔憭望?嚗???寞?隞亦Ⅱ靽??賣迤撣?
            await renderRotateThumbnails(loadedPDF);
        }
    });

    rotateNextBtn.addEventListener('click', () => {
        const actionArea = document.getElementById('rotateNext').parentNode;
        actionArea.innerHTML = `
            <div class="flex flex-col items-end space-y-4 w-full md:w-auto">
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700">瑼??迂:</label>
                    <input type="text" id="rotateFilename" class="form-input" value="??-${formatDate(new Date())}">
                </div>
                <button id="exportRotate" class="btn btn-green w-full md:w-auto">?臬瑼?</button>
            </div>
        `;
        document.getElementById('exportRotate').addEventListener('click', handleRotateExport);
    });

    async function handleRotateExport() {
        if (!loadedPDF || !singleLoadedFile) {
            showMessage('隢??臬PDF瑼???);
            return;
        }

        const filename = document.getElementById('rotateFilename').value;
        try {
            const pdfDoc = await PDFLib.PDFDocument.load(await singleLoadedFile.arrayBuffer());
            const pages = pdfDoc.getPages();
            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                if (rotateRotations[i] !== 0) {
                    const existingRotation = page.getRotation();
                    const newRotation = (existingRotation.angle + rotateRotations[i]) % 360;
                    page.setRotation(PDFLib.degrees(newRotation));
                }
            }

            const newPdfBytes = await pdfDoc.save();
            downloadPDF(newPdfBytes, filename);
            showMessage('PDF ??銝血?箸???');

        } catch (error) {
            console.error('Error rotating PDF:', error);
            showMessage('PDF ????隤扎?);
        }
    }
	
	// ==================== OCR 蝮桀?皜脫? ====================
    async function renderOcrThumbnails(pdfDoc) {
        const ocrThumbnails = document.getElementById('ocrThumbnails');
        ocrThumbnails.innerHTML = '';
        const numPages = pdfDoc.numPages;

        const cutMarkerStart = document.createElement('div');
        cutMarkerStart.className = 'cut-marker';
        cutMarkerStart.dataset.page = 0;
        cutMarkerStart.addEventListener('click', () => toggleOcrSplitPoint(0));
        ocrThumbnails.appendChild(cutMarkerStart);

        for (let i = 1; i <= numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 0.3 });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const context = canvas.getContext('2d');
            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;
            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'thumb-wrapper';
            const pageNum = document.createElement('div');
            pageNum.textContent = i;
            pageNum.className = 'text-center text-sm font-medium text-gray-600 mt-1';
            
            thumbWrapper.appendChild(canvas);
            thumbWrapper.appendChild(pageNum);
            ocrThumbnails.appendChild(thumbWrapper);
            
            canvas.addEventListener('click', () => showFullScreenPreview(pdfDoc, i));

            if (i < numPages) {
                const cutMarker = document.createElement('div');
                cutMarker.className = 'cut-marker';
                cutMarker.dataset.page = i;
                cutMarker.addEventListener('click', () => toggleOcrSplitPoint(parseInt(cutMarker.dataset.page)));
                ocrThumbnails.appendChild(cutMarker);
            }
        }

        const cutMarkerEnd = document.createElement('div');
        cutMarkerEnd.className = 'cut-marker';
        cutMarkerEnd.dataset.page = numPages;
        cutMarkerEnd.addEventListener('click', () => toggleOcrSplitPoint(numPages));
        ocrThumbnails.appendChild(cutMarkerEnd);
        
        updateOcrUI();
    }

    function toggleOcrSplitPoint(page) {
        const index = ocrSplitPoints.indexOf(page);
        if (index > -1) {
            ocrSplitPoints.splice(index, 1);
        } else {
            if (ocrSplitPoints.length >= 2) {
                splitSelectionBox.classList.remove('hidden');
                document.getElementById('selectFirst').onclick = () => {
                    ocrSplitPoints.shift();
                    ocrSplitPoints.push(page);
                    ocrSplitPoints.sort((a, b) => a - b);
                    updateOcrUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectLast').onclick = () => {
                    ocrSplitPoints.pop();
                    ocrSplitPoints.push(page);
                    ocrSplitPoints.sort((a, b) => a - b);
                    updateOcrUI();
                    splitSelectionBox.classList.add('hidden');
                };
                document.getElementById('selectCancel').onclick = () => {
                    splitSelectionBox.classList.add('hidden');
                };
                return;
            }
            ocrSplitPoints.push(page);
            ocrSplitPoints.sort((a, b) => a - b);
        }
        updateOcrUI();
    }

    function updateOcrUI() {
        const ocrStartPage = document.getElementById('ocrStartPage');
        const ocrEndPage = document.getElementById('ocrEndPage');
        const ocrStartBtn = document.getElementById('ocrStartBtn');
        
        const cutMarkers = document.querySelectorAll('#ocrThumbnails .cut-marker');
        cutMarkers.forEach(marker => {
            const page = parseInt(marker.dataset.page);
            if (ocrSplitPoints.includes(page)) {
                marker.classList.add('active');
            } else {
                marker.classList.remove('active');
            }
        });

        if (ocrSplitPoints.length === 2) {
            ocrStartPage.value = ocrSplitPoints[0] + 1;
            ocrEndPage.value = ocrSplitPoints[1];
        } else {
            ocrStartPage.value = '';
            ocrEndPage.value = '';
        }

        ocrStartBtn.disabled = ocrSplitPoints.length !== 2;
    }
    
    // 蝬???頛詨獢?
    document.getElementById('ocrStartPage').addEventListener('input', updateOcrSplitPointsFromText);
    document.getElementById('ocrEndPage').addEventListener('input', updateOcrSplitPointsFromText);

    function updateOcrSplitPointsFromText() {
        if (!loadedPDF) {
            showMessage('隢??臬 PDF 瑼???);
            document.getElementById('ocrStartPage').value = '';
            document.getElementById('ocrEndPage').value = '';
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }

        const start = parseInt(document.getElementById('ocrStartPage').value);
        const end = parseInt(document.getElementById('ocrEndPage').value);
        const numPages = loadedPDF.numPages;

        ocrSplitPoints = [];

        if (isNaN(start) || start < 1 || start > numPages) {
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }
        if (isNaN(end) || end < 1 || end > numPages) {
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }
        if (start > end) {
            showMessage('蝯??Ⅳ銝撠韏瑕??Ⅳ??);
            document.getElementById('ocrStartBtn').disabled = true;
            return;
        }

        ocrSplitPoints.push(start - 1);
        ocrSplitPoints.push(end);
        updateOcrUI();
    }
	
	const ocrPageNumber = document.getElementById('ocrPageNumber');
    const ocrStartBtn = document.getElementById('ocrStartBtn');
    const ocrStatus = document.getElementById('ocrStatus');
    const ocrResultText = document.getElementById('ocrResultText');

    async function initializeOcrWorker() {
        ocrStatus.classList.remove('hidden');
        ocrStatus.textContent = '甇????儘霅???.. (?擐活雿輻??閬嗾蝘?)';
		
		const progressContainer = document.getElementById('ocrProgressContainer');
        const progressBar = document.getElementById('ocrProgressBar');
        
        ocrWorker = await Tesseract.createWorker('eng+chi_tra', 1, {
            logger: m => {
                console.log(m);
				ocrStatus.classList.remove('text-green-500');
                if (m.status === 'recognizing text') {
                    // 憿舐內?脣漲璇蒂?湔撖砍漲
                    progressContainer.classList.remove('hidden');
                    const progressValue = (m.progress * 100).toFixed(0);
                    progressBar.style.width = `${progressValue}%`;
                    ocrStatus.textContent = `颲刻?銝?.. (${progressValue}%)`;
                    
                } else if (m.status === 'loading language training data' || m.status === 'initializing api') {
                    // 頛璅∪???脣漲璇?(????脣漲?曉?瘥?
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    ocrStatus.textContent = `甇?頛隤?璅∪?...`;
                } else {
                    progressContainer.classList.add('hidden');
                    ocrStatus.textContent = `??? ${m.status}`;
                }
            }
        });

        ocrStatus.textContent = '颲刻?撘?皞?撠梁???;
		ocrStatus.classList.remove('text-green-500');
        progressContainer.classList.add('hidden');
        progressBar.style.width = '0%';
        
        return ocrWorker;
    }

    ocrStartBtn.addEventListener('click', async () => {
        // 撽??Ⅳ???
        let startPageNum, endPageNum;
        if (ocrSplitPoints.length === 2) {
            startPageNum = ocrSplitPoints[0] + 1;
            endPageNum = ocrSplitPoints[1];
        } else {
            startPageNum = parseInt(document.getElementById('ocrStartPage').value);
            endPageNum = parseInt(document.getElementById('ocrEndPage').value);
        }

        if (isNaN(startPageNum) || isNaN(endPageNum) || startPageNum < 1 || endPageNum > loadedPDF.numPages || startPageNum > endPageNum) {
            showMessage(`隢?????Ⅳ???(1 - ${loadedPDF.numPages})?);
            return;
        }

        // 皞? UI
        const progressContainer = document.getElementById('ocrProgressContainer');
        const progressBar = document.getElementById('ocrProgressBar');

        ocrStartBtn.disabled = true;
        ocrResultText.value = '';
        originalOcrText = '';
        ocrStatus.classList.remove('text-green-500'); 
        document.getElementById('ocrResultTools').classList.add('hidden'); // ?梯?璅???
        document.getElementById('copyOcrTextBtn').disabled = true;

        // ?身璅??????
        puncToggles = { colon: false, comma: false, paren: false };
        document.querySelectorAll('.punc-btn').forEach(btn => btn.classList.remove('active'));

        let fullText = ""; // ?冽?脣?????Ｙ???

        try {
            // ????Tesseract Worker
            if (!ocrWorker) {
                ocrWorker = await initializeOcrWorker();
            }
            
            ocrStatus.classList.remove('hidden');

            // 餈游?颲刻?瘥???
            for (let i = startPageNum; i <= endPageNum; i++) {
                ocrStatus.textContent = `甇?皜脫?蝚?${i} / ${endPageNum} ??..`;
                ocrStatus.classList.remove('text-green-500');
                
                const page = await loadedPDF.getPage(i);
                const scale = 3.0; 
                const viewport = page.getViewport({ scale: scale });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                ocrStatus.textContent = `甇?颲刻?蝚?${i} / ${endPageNum} ??..`;
                const { data: { text } } = await ocrWorker.recognize(canvas);

                fullText += `--- 颲刻??Ⅳ ${i} ---\n\n`;
                fullText += text.replace(/ /g, '') + "\n\n";
            }

            // 憿舐內?蝯???
            originalOcrText = fullText; 
            applyPunctuationFilters(); 
            
            ocrStatus.textContent = '颲刻?摰???;
            ocrStatus.classList.add('text-green-500'); 
            
            progressBar.style.width = '100%';
            document.getElementById('ocrResultTools').classList.remove('hidden'); // 憿舐內璅???
            document.getElementById('copyOcrTextBtn').disabled = originalOcrText.length === 0;

        } catch (error) {
            console.error('OCR Error:', error);
            showMessage('??颲刻???隤扎?);
            ocrStatus.textContent = `?航炊: ${error.message || '?芰?航炊'}`;
            ocrStatus.classList.remove('text-green-500');
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        } finally {
            ocrStartBtn.disabled = false;
        }
    });
    
    // ??蕪?其蒂?湔 textarea
    function applyPunctuationFilters() {
        let tempText = originalOcrText;
        
        if (puncToggles.colon) {
            tempText = tempText.replace(/:/g, '嚗?);
        }
        if (puncToggles.comma) {
            tempText = tempText.replace(/,/g, '嚗?);
        }
        if (puncToggles.paren) {
            tempText = tempText.replace(/\(/g, '嚗?).replace(/\)/g, '嚗?);
        }
        
        ocrResultText.value = tempText;
    }

    // 摮???(???????
    document.querySelectorAll('.punc-btn').forEach(button => {
        button.addEventListener('click', () => {
            const type = button.dataset.type;
            if (type in puncToggles) {
                // ?????
                puncToggles[type] = !puncToggles[type];
                // ??閬死
                button.classList.toggle('active', puncToggles[type]);
                // ???蕪
                applyPunctuationFilters();
            }
        });
    });
	
    const copyOcrTextBtn = document.getElementById('copyOcrTextBtn');
    copyOcrTextBtn.addEventListener('click', () => {
        const textToCopy = document.getElementById('ocrResultText').value;
        if (!textToCopy) {
            showMessage('瘝????航?鋆賬?);
            return;
        }

        navigator.clipboard.writeText(textToCopy).then(() => {
            const notification = document.getElementById('copyNotification');
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);

            // 1蝘???瘛∪?
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 1010); // 10ms + 1000ms

            // ??蝘?瘨仃
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2010); // 1010ms + 1000ms
            
        }).catch(err => {
            console.error('?⊥?銴ˊ??: ', err);
            showMessage('銴ˊ??憭望???);
        });
    });

    document.addEventListener('keydown', (event) => {
        
        // === [?啣?] ??嚗炎?乩?隞嗥璅?蝝?===
        const targetElement = event.target;
        if (targetElement) {
            // 撠?蝐文?蝔望?皞??箏之撖?
            const tagName = targetElement.tagName.toUpperCase();
            
            // 憒?雿輻?迤?刻?頛詨獢?摮?????桐?????閫貊隞颱?敹急??
            if (tagName === 'INPUT' || tagName === 'TEXTAREA' || tagName === 'SELECT') {
                return;
            }
        }

        if (currentMode === 'merge') {
            if (event.key === 'Delete' && selectedFileIndex !== -1) {
                deleteFileBtn.click();
            } else if (event.key === 'ArrowUp' && selectedFileIndex > 0) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex - 1, 0, fileToMove);
                selectedFileIndex--;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            } else if (event.key === 'ArrowDown' && selectedFileIndex < filesForMerge.length - 1 && selectedFileIndex !== -1) {
                const fileToMove = filesForMerge.splice(selectedFileIndex, 1)[0];
                filesForMerge.splice(selectedFileIndex + 1, 0, fileToMove);
                selectedFileIndex++;
                renderMergeFileList();
                const newSelection = document.querySelectorAll('.sortable-item')[selectedFileIndex];
                newSelection.classList.add('ring-2', 'ring-blue-500');
            }
        } else if (currentMode === 'rotate' && (event.key === 'r' || event.key === 'R') && selectedRotatePage !== -1) {
            rotatePageBtn.click();
        }
    });

    // ?刻撟?閬賢???
    async function showFullScreenPreview(pdfDoc, pageNum) {
        fullScreenPDF = pdfDoc;
        fullScreenPage = pageNum;
        await renderFullScreenPage();
        fullScreenPreview.classList.remove('hidden');

        // 蝬??萇鈭辣
        document.addEventListener('keydown', handleFullScreenKeys);
    }
    
    async function renderFullScreenPage() {
        if (!fullScreenPDF) return;

        const page = await fullScreenPDF.getPage(fullScreenPage);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const context = canvas.getContext('2d');
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        previewImage.src = canvas.toDataURL();
    }

    function closeFullScreenPreview() {
        fullScreenPreview.classList.add('hidden');
        fullScreenPDF = null;
        fullScreenPage = 0;
        document.removeEventListener('keydown', handleFullScreenKeys);
    }

    function handleFullScreenKeys(e) {
        if (e.key === 'Escape') {
            closeFullScreenPreview();
        } else if (e.key === 'ArrowLeft') {
            navigatePreview(-1);
        } else if (e.key === 'ArrowRight') {
            navigatePreview(1);
        }
    }

    function navigatePreview(direction) {
        const newPage = fullScreenPage + direction;
        if (newPage >= 1 && newPage <= fullScreenPDF.numPages) {
            fullScreenPage = newPage;
            renderFullScreenPage();
        }
    }

    previewPrevBtn.addEventListener('click', () => navigatePreview(-1));
    previewNextBtn.addEventListener('click', () => navigatePreview(1));

    fullScreenPreview.addEventListener('click', (e) => {
        if (e.target === fullScreenPreview) {
            closeFullScreenPreview();
        }
    });

    function downloadPDF(pdfBytes, filename) {
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function formatDate(date) {
        const yyyy = date.getFullYear().toString();
        const mm = (date.getMonth() + 1).toString().padStart(2, '0');
        const dd = date.getDate().toString().padStart(2, '0');
        const hh = date.getHours().toString().padStart(2, '0');
        const min = date.getMinutes().toString().padStart(2, '0');
        const ss = date.getSeconds().toString().padStart(2, '0');
        return `${yyyy}${mm}${dd}${hh}${min}${ss}`;
    }
</script>
</body>
</html>
