<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案管理工具原型</title>
    <style>
        :root {
            --primary-color: #5A67D8;
            --primary-light: #C3DAFE;
            --secondary-color: #4A5568;
            --bg-color: #F7FAFC;
            --sidebar-color: #FFFFFF;
            --card-bg: #FFFFFF;
            --text-color: #2D3748;
            --sub-text-color: #718096;
            --border-color: #EDF2F7;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        #drop-zone-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 100, 255, 0.1);
            border: 3px dashed var(--primary-color);
            border-radius: 10px;
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: var(--primary-color);
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }

        #drop-zone-overlay p {
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin-top: 15px;
        }
        
        #drop-zone-overlay.active {
            opacity: 1;
        }

        .sidebar {
            width: 250px;
            background-color: var(--sidebar-color);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            padding: 24px;
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100%;
            z-index: 10;
            left: -300px;
            transition: left 0.3s ease-in-out;
        }

        .sidebar.show {
            left: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 32px;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .main-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--sub-text-color);
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav-item a:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }

        .nav-item.active a {
            background-color: var(--primary-color);
            color: white;
        }

        .main-content {
            flex-grow: 1;
            padding: 32px;
            transition: margin-left 0.3s ease-in-out;
            margin-left: 0;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }

        .hamburger-btn {
            display: block;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-size: 24px;
            color: var(--secondary-color);
            margin-right: 16px;
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-add {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-add:hover {
            background-color: #434190;
        }

        .btn-save {
            background-color: #4CAF50;
            color: white;
        }
        .btn-save:hover {
            background-color: #45a049;
        }
		
		.btn-help {
            background-color: #3182CE; /* 資訊藍色 */
            color: white;
            margin-left: 10px; /* 與旁邊按鈕的間距 */
        }
        .btn-help:hover {
            background-color: #2B6CB0;
        }
		
		.btn-undo-complete {
            background-color: #FFC107;
            color: #000000;
        }
        .btn-undo-complete:hover {
            background-color: #e6ac00;
        }
        .btn:disabled {
            background-color: #A0AEC0;
            cursor: not-allowed;
            color: #E2E8F0;
        }
        
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 20;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal.show {
			display: flex;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
			
			border: 1px solid var(--border-color);
			max-height: 90vh; 
			display: flex;
			flex-direction: column;
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-content h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--secondary-color);
			
			margin-bottom: 24px;
			padding-bottom: 16px;
			border-bottom: 1px solid var(--border-color);
			flex-shrink: 0; 
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 24px;
			
			padding-top: 24px;
			border-top: 1px solid var(--border-color);
			flex-shrink: 0; 
        }

        .btn-cancel {
            background-color: transparent;
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-cancel:hover {
            background-color: var(--bg-color);
        }

        .btn-submit {
            background-color: var(--primary-color);
            color: white;
        }
        
        .dashboard-widgets {
            max-width: 900px;
            margin: 0 auto;
        }

        .settings-container {
            max-width: 900px; 
            margin: 0 auto; 
        }
        .settings-container h2 {
            margin-bottom: 24px;
            font-size: 2rem;
            color: var(--secondary-color);
        }
        .settings-section {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        .settings-section h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.2rem;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .file-info {
            background-color: var(--bg-color);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--sub-text-color);
        }
        .auto-save-timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 8px;
        }

        .project-grid {
            display: grid; 
            gap: 24px;
            max-width: 900px; 
            margin: 0 auto; 
        }
        .project-card {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .project-card h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }
        .project-card p {
            font-size: 0.9em;
            color: var(--sub-text-color);
        }

        .project-editor {
            max-width: 900px; 
            margin: 0 auto; 
        }
        .project-editor h1 {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .project-editor .editable-title, .project-editor .editable-description {
            cursor: pointer;
            border: 1px solid transparent;
            padding: 5px;
            border-radius: 4px;
        }
        .project-editor .editable-title:hover, .project-editor .editable-description:hover {
            border-color: var(--border-color);
        }
        .project-editor .editable-title:focus, .project-editor .editable-description:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        .project-editor .description-area {
            font-size: 1rem;
            color: var(--sub-text-color);
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .task-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        .task-list li:hover .task-actions {
            opacity: 1;
        }
        .task-actions {
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 4px;
        }
        .task-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--sub-text-color);
            font-size: 1rem;
        }
        .task-actions button:hover {
            color: var(--secondary-color);
        }
        
        .flow-container {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 24px;
        }
        .flow-container h3 {
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .add-flow-input-container {
            display: none;
			flex-direction: column;
            gap: 8px;
            margin-top: 16px;
			margin-bottom: 24px;
            border: 1px dashed var(--primary-color);
            padding: 16px;
            border-radius: 8px;
            background: #fdfdff;
        }
        .add-flow-input-container input,
        .add-flow-input-container textarea {
            flex-grow: 1;
			padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
		.add-flow-input-container textarea {
            resize: vertical;
            min-height: 60px;
        }
        .flow-list {
            position: relative;
            padding-top: 24px; 
        }
        
        .flow-item {
            display: grid;
            grid-template-columns: 30px 1fr 90px;
            gap: 16px;
			align-items: start;
            padding: 16px 0;
            position: relative;
            background-color: var(--card-bg);
            transition: opacity 0.2s ease-in-out;
        }

        .flow-item::before {
            content: '';
            position: absolute;
            left: 14px; 
            top: -2px;
            height: 100%;
            width: 2px;
            background-color: var(--border-color);
            z-index: 0;
        }
        .flow-item:first-child::before {
             top: -24px; 
             height: calc(100% + 24px);
        }
        .flow-item.last-flow-item::before,
        .flow-item:last-child::before {
            height: calc(50% - 12px);
        }
        
        .flow-item .flow-status-dot {
            grid-column: 1; 
            justify-self: center; 
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--sub-text-color);
            border: 2px solid var(--card-bg);
            position: relative; 
            z-index: 1; 
        }
        .flow-item.completed .flow-status-dot {
            background-color: #4CAF50;
        }

        .flow-item-details {
            grid-column: 2;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 12px;
            min-width: 0; 
			align-items: center;
        }
        .flow-item-details h4 {
			grid-column: 1 / -1;
            margin: 0;
            font-size: 1.1rem;
			word-break: break-word;
        }
		.flow-item-details label {
            font-size: 0.9em;
            color: var(--sub-text-color);
            font-weight: 600; 
            text-align: right; 
            padding-right: 4px; 
        }
		.flow-item-details .flow-value {
            font-size: 0.9em;
            color: var(--text-color);
            word-break: break-word; 
            
            cursor: text;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .flow-item-details .flow-value:hover {
            border-color: var(--border-color);
            background-color: var(--bg-color);
        }
        .flow-item-details .flow-value:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        .flow-item-details .completed-at-text {
            grid-column: 1 / -1;
            font-size: 0.9em;
            color: #4CAF50;
            margin-top: 4px;
        }
        .flow-item-actions {
            grid-column: 3; 
            display: flex;
            gap: 8px;
            justify-content: flex-end;
			align-self: start;
			flex-direction: column-reverse;
        }
        .flow-item .btn-complete-flow {
            background-color: #4CAF50;
            color: white;
        }
        .flow-item.completed .btn-complete-flow {
            display: none;
        }

        .initial-setup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .initial-setup .modal-content {
            box-shadow: none; 
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }
        .initial-setup .modal-content h2 {
            font-size: 2rem;
            margin-bottom: 24px;
        }
        .initial-setup .btn-container {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 32px;
        }
        .initial-setup .btn {
            min-width: 150px;
            padding: 12px 24px;
        }
        .template-section-card {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            position: relative; 
            
            /* -- 新增以下 -- */
            min-height: 350px; /* 設定最小高度 */
            display: flex;
            flex-direction: column;
        }
        .template-section-card h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.2rem;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            cursor: pointer;
        }
        .template-item-list {
            list-style: none;
            padding: 0;
            margin: 0;
            
            max-height: 155px; /* 新增：限制最大高度 (約 5 個項目高) */
            overflow-y: auto; /* 內容過多時顯示滾動條 */
            min-height: 50px; /* 避免列表太空時排版跑掉 */
        }
        .template-item-list li {
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
			display: flex; 
            justify-content: space-between;
            align-items: center;
        }
        .template-item-list li:last-child {
            border-bottom: none;
        }
        .template-item-list li:hover {
            background-color: var(--bg-color);
        }
        .btn-cancel-flow {
            background-color: #E53E3E;
            color: white;
        }
        .btn-cancel-flow:hover {
            background-color: #C53030;
        }
        .template-section-card {
            position: relative; 
        }
        .template-item-text {
            flex-grow: 1; 
        }
        .btn-delete-template {
            background: none;
            border: none;
            color: var(--sub-text-color);
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 4px 8px;
            opacity: 0.5;
            transition: opacity 0.2s, color 0.2s;
            flex-shrink: 0; 
        }
        .btn-delete-template:hover {
            color: #E53E3E; 
            opacity: 1;
        }
		
        .btn-delete-section {
            /* Position */
            position: absolute;
            top: -8px; /* 調整位置同 project-card */
            right: -8px; /* 調整位置同 project-card */
            
            /* Size & Shape */
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
            
            /* Color */
            background-color: #E53E3E;
            color: white;
            
            /* Font & Content */
            font-size: 16px; /* 調整字型大小 */
            font-weight: bold;
            line-height: 1; /* 確保 'x' 垂直置中 */
            padding: 0; /* 覆蓋 .btn-delete-template 的 padding */
            
            /* Alignment */
            display: flex; /* 新增 */
            align-items: center; /* 新增 */
            justify-content: center; /* 新增 */
            
            /* Interaction */
            cursor: pointer;
            opacity: 1; /* 覆蓋 .btn-delete-template 的 opacity */
            transition: transform 0.2s, background-color 0.2s;
        }
        .btn-delete-section:hover {
            background-color: #C53030;
            transform: scale(1.1);
            color: white; /* 確保 hover 時也是白色 */
            opacity: 1; /* 確保 hover 時不透明 */
        }
		
        .flow-datetime-input {
            border: 1px solid transparent;
            padding: 4px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9em;
            color: var(--text-color);
            width: 190px; 
        }
        .flow-datetime-input:hover {
            border-color: var(--border-color);
            background-color: var(--bg-color);
        }
        .flow-datetime-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        .template-item-list .template-item-text[contenteditable]:empty::before {
            content: "新項目";
            color: var(--sub-text-color);
            opacity: 0.7;
            font-style: italic;
            pointer-events: none;
        }
		
        .template-item-list .template-item-text[contenteditable="true"]:focus {
            outline: 1px solid var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .template-item-list .template-item-text[contenteditable="true"]:empty {
            background-color: rgba(229, 62, 62, 0.5); 
        }
        .template-section-card h3[contenteditable="true"]:empty {
            background-color: rgba(229, 62, 62, 0.5); 
        }
		.template-section-card h3[contenteditable]:empty::before {
            content: "新板塊標題"; 
            color: var(--sub-text-color);
            opacity: 0.7;
            font-style: italic;
            pointer-events: none; 
        }
        .template-section-card h3[contenteditable]:empty,
        .template-item-list .template-item-text[contenteditable]:empty {
             min-height: 1.2em; 
        }
        .template-item-list .template-item-text[contenteditable] {
             display: block; 
        }
		.template-section-card button[data-action="add-template-item"] {
            margin-top: auto; /* 關鍵：將按鈕推到 flex 容器底部 */
            align-self: flex-end; /* 將按鈕推到右側 */
        }
		
        .more-items-options-container .btn-category {
            background-color: var(--bg-color);
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
        }
        .more-items-options-container .btn-category:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }

        .dynamic-item-block {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            position: relative; 
        }

        .dynamic-item-block .dynamic-item-block {
            margin-left: 24px;
            background-color: var(--card-bg); 
        }

        .dynamic-item-content {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .dynamic-item-content label {
            font-weight: 600;
            color: var(--secondary-color);
            flex-shrink: 0;
        }
        .dynamic-item-content input {
            flex-grow: 1;
        }
        .dynamic-item-content input[type="datetime-local"] {
            flex-grow: 0;
            width: 250px;
        }
		.dynamic-item-content input[type="datetime-local"][data-category="時"],
        .dynamic-item-block .temp-timer-input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .btn-set-timer, .btn-confirm-timer {
            font-size: 0.8rem;
            padding: 4px 8px;
            margin-left: 8px;
        }
        .temp-timer-input {
            margin-top: 8px;
        }

        .dynamic-item-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .dynamic-item-actions .btn,
        .dynamic-item-actions .btn-add-sibling,
        .dynamic-item-actions .btn-add-child {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .dynamic-item-children-options {
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .btn-delete-dynamic-item {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background-color: #E53E3E;
            color: white;
            border: 2px solid var(--card-bg);
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            line-height: 20px;
            text-align: center;
            padding: 0;
            z-index: 2;
            transition: transform 0.2s, background-color 0.2s;
        }
        .btn-delete-dynamic-item:hover {
            background-color: #C53030;
            transform: scale(1.1);
        }
        
        .dynamic-item-grid-container {
            grid-column: 1 / -1; 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .dynamic-item-card {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9em;
        }
        
        .dynamic-card-header-row {
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .dynamic-card-header-row .dynamic-item-category {
            font-size: 1.1em;
            font-weight: 600;
            align-self: center; 
        }
        .dynamic-card-header-row span.dynamic-item-value {
             font-size: 1.1em;
             font-weight: 600;
        }
        
        .dynamic-item-display-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .dynamic-item-display-list .dynamic-item-display-list {
            padding-left: 20px;
            margin-top: 4px;
            border-left: 2px solid var(--primary-light);
        }
        .dynamic-item-display-item {
            padding: 4px 0;
        }
        .dynamic-item-display-row {
            display: flex;
            gap: 8px;
        }
        .dynamic-item-category {
            font-weight: 600;
            color: var(--secondary-color);
            flex-shrink: 0;
            padding: 2px;
        }
        .dynamic-item-value {
            color: var(--text-color);
            word-break: break-word;
            padding: 2px;
        }
        span.dynamic-item-value {
            flex-grow: 1;
        }

        .dynamic-item-empty {
            color: var(--sub-text-color);
            font-style: italic;
        }
        
        .timer-countdown {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 4px;
        }
        .timer-countdown.ended {
            color: #E53E3E;
        }

        .btn-edit-flow {
            background-color: #f0ad4e;
            color: white;
        }
        .btn-edit-flow:hover {
            background-color: #ec971f;
        }

        .flow-timestamps {
            grid-column: 1 / -1;
            font-size: 0.8em;
            color: var(--sub-text-color);
            margin-top: 12px;
            display: flex;
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
            position: relative; 
            min-height: 1.2em;
        }

        .flow-status-dot:hover {
            cursor: grab;
        }
        .flow-item.dragging {
            opacity: 0.5;
            background: var(--bg-color);
        }

        .flow-timestamps span.completed-at-text {
            color: #4CAF50;
            position: absolute;
            right: 0;
            top: 8px;
        }
		
        .dynamic-item-main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }
        .dynamic-item-input-area {
            display: flex;
            flex-direction: column;
        }
        .dynamic-item-template-list-area {
            border-left: 1px solid var(--border-color);
            padding-left: 16px;
            font-size: 0.9em;
        }
        .dynamic-item-template-list-area h5 {
            margin: 0 0 8px 0;
            color: var(--secondary-color);
        }
        .template-link-item {
            display: block;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--primary-color);
            background-color: var(--bg-color);
            margin-bottom: 4px;
            border: 1px solid var(--border-color);
            word-break: break-word;
        }
        .template-link-item:hover {
            background-color: var(--primary-light);
        }

        .dynamic-item-block .form-group { 
            margin-bottom: 0; 
        }
        .dynamic-item-block .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .dynamic-item-template-list-area .template-link-item.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .dynamic-item-content label {
            cursor: text;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .dynamic-item-content label:hover {
            border-color: var(--border-color);
            background-color: var(--card-bg);
        }
        .dynamic-item-content label:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--card-bg);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
		
        .flow-timestamps .flow-timestamp-created {
            position: absolute;
            left: 50px;
            top: 8px;
        }
        .flow-timestamps .flow-timestamp-updated {
            position: absolute;
            right: 0;
            top: 8px;
        }

        .btn-toggle-checkbox, .btn-toggle-hide-title {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
        .btn-toggle-checkbox.active, .btn-toggle-hide-title.active {
            background-color: var(--primary-color);
            color: white;
        }

        .dynamic-item-block[data-has-checkbox="true"] > .dynamic-item-main-content .dynamic-item-content::before {
            content: '☐';
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-right: 8px;
            font-weight: bold;
            line-height: 1.5; 
        }
        .dynamic-item-block[data-hide-label="true"] > .dynamic-item-main-content .dynamic-item-content label[data-label-for-category] {
            display: none;
        }

        .dynamic-item-content label[data-label-for-category="計時器"] {
            display: none !important;
        }

        .dynamic-item-block[data-hide-label="true"] > .dynamic-item-main-content .dynamic-item-content .label-colon,
        .dynamic-item-block[data-hide-label="true"] > .dynamic-item-content .label-colon {
            display: none;
        }

        .dynamic-item-card.all-checked {
            background-color: #DFF0D8;
        }
		
        .project-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            position: relative;
        }
        .project-card-details {
            flex-grow: 1;
            min-width: 150px; 
        }
        .project-card-details h3, .project-card-details p {
            margin: 0;
        }
        .project-card-details h3 {
            margin-bottom: 4px;
        }
        
        .project-card-timeline {
            flex-shrink: 0; 
            display: flex;
            align-items: flex-start;
            position: relative;
            padding: 10px 0;
            max-width: 60%;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 0 5px; 
            position: relative; 
            z-index: 1;
        }
        .timeline-item::before,
        .timeline-item::after {
            content: '';
            position: absolute;
            top: 7px;
            height: 2px;
            background-color: var(--border-color);
            width: 50%;
            z-index: 0;
        }
        .timeline-item::before {
            left: 0;
        }
        .timeline-item::after {
            right: 0;
        }
        .project-card-timeline .timeline-item:first-child::before {
            display: none;
        }
        .project-card-timeline .timeline-item:last-child::after {
            display: none;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background-color: var(--secondary-color);
            border: 2px solid var(--card-bg); 
            border-radius: 50%;
            position: relative; 
            z-index: 1; 
        }

        .timeline-dot.completed {
            background-color: #4CAF50; 
        }

        .timeline-label {
            font-size: 0.8em;
            color: var(--sub-text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px; 
        }
        .timeline-label.completed {
            color: #4CAF50;
        }
		
        .image-preview-modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            cursor: pointer; 
            
            justify-content: center;
            align-items: center;
        }

        .modal-content-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 4px;
            cursor: default; 
        }
		.project-card-actions {
            position: absolute;
            top: -8px;
            right: -8px;
            display: flex;
            gap: 5px; 
            z-index: 2;
        }

        .btn-project-action {
			width: 24px;
			height: 24px;
			border-radius: 50%;
			border: 2px solid var(--card-bg); 
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
			color: white;
			padding: 0;
			transition: transform 0.2s, background-color 0.2s;

			display: flex;
			align-items: center;
			justify-content: center;
			line-height: 1; 
		}
        .btn-project-action:hover {
            transform: scale(1.1);
        }

        .btn-project-delete {
            background-color: #E53E3E;
        }
        .btn-project-delete:hover {
            background-color: #C53030;
        }
        
        .btn-project-to-template {
            background-color: #4CAF50;
        }
        .btn-project-to-template:hover {
            background-color: #45a049;
        }
		
		#template-section-container {
			display: grid; 
			grid-template-columns: repeat(8, 1fr); 
			gap: 24px; 
		}
		
        .flow-minimap {
            width: 120px;
            flex-shrink: 0;
            position: sticky;
            top: 32px; 
            height: calc(100vh - 120px); 
            overflow-y: auto;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow);
        }
        .flow-minimap h4 {
            margin-top: 0;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .flow-minimap-item {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            padding: 4px 0 4px 18px; 
            font-size: 0.9em;
        }
        .flow-minimap-item::before { 
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            width: 2px;
            height: 100%;
            background-color: var(--border-color);
        }
        .flow-minimap-item:first-child::before {
            top: 12px;
            height: calc(100% - 12px);
        }
        .flow-minimap-item:last-child::before {
            height: 12px;
        }
        .flow-minimap-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--sub-text-color);
            border: 2px solid var(--card-bg);
            position: absolute;
            left: 2px;
            top: 10px;
            z-index: 1;
        }
        .flow-minimap-item.completed .flow-minimap-dot {
            background-color: #4CAF50;
        }
        .flow-minimap-item.completed .flow-minimap-name {
            color: #4CAF50;
            text-decoration: line-through;
        }
        .flow-minimap-name {
            word-break: break-all; 
			cursor: pointer;
        }
		.flow-minimap-item.minimap-highlight {
			background-color: #FFFFE0;
			border-radius: 4px;
			box-shadow: 0 0 5px rgba(255, 255, 0, 0.7); 
		}
		
        .dashboard-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
        }
        .stat-card h3 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            color: var(--sub-text-color);
        }
        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--secondary-color);
        }
        .stat-card.overdue .stat-value {
            color: #E53E3E;
        }
        .stat-card.overdue {
            border-left-color: #E53E3E;
        }
        .stat-card.completed .stat-value {
            color: #4CAF50;
        }
        .stat-card.completed {
            border-left-color: #4CAF50;
        }

        .dashboard-widgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 24px;
        }
		
		.dashboard-top-row-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .widget-card {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        .widget-card h3 {
            margin-top: 0;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .widget-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .widget-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .widget-list li:hover {
            background-color: var(--bg-color);
        }
        .widget-list li:last-child {
            border-bottom: none;
        }

        .recent-project-item .project-name {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .progress-bar.completed {
            background-color: #4CAF50;
        }

        .deadline-list-item .flow-name {
            font-weight: 600;
        }
        .deadline-list-item .project-context {
            font-size: 0.9em;
            color: var(--sub-text-color);
        }
        .deadline-list-item .deadline-date {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--primary-color);
        }
        .deadline-list-item.overdue .flow-name,
        .deadline-list-item.overdue .deadline-date {
            color: #E53E3E;
        }
		
		.category-search-item .flow-name {
            font-weight: 600;
        }
        .category-search-item .project-context {
            font-size: 0.9em;
            color: var(--sub-text-color);
        }
        .category-search-item .item-match {
            font-size: 0.9em;
            color: var(--primary-color);
            font-weight: 600;
        }
        .category-search-item .item-match mark {
            background-color: #FFFFE0;
            padding: 0 2px;
        }
		
		#import-template-list li {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        #import-template-list li:last-child {
            border-bottom: none;
        }
        #import-template-list li:hover {
            background-color: var(--bg-color);
        }
        #import-template-list li.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }
        #import-template-list li.empty-item {
            color: var(--sub-text-color);
            cursor: default;
        }
        #import-template-list li.empty-item:hover {
            background-color: transparent;
        }

        .flow-item-actions .btn-flow-action {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-weight: bold;
            line-height: 1;
            transition: width 0.3s ease, border-radius 0.3s ease, background-color 0.2s;
            border: none;
            cursor: pointer;
            position: relative;
            white-space: nowrap; 
        }

        .btn-flow-action .btn-symbol {
            display: inline-block;
            transition: opacity 0.2s 0.1s;
            opacity: 1;
            font-size: 10px; 
        }

        .btn-flow-action .btn-text {
            display: inline-block;
            transition: opacity 0.2s 0.1s;
            opacity: 0;
            font-size: 10px; 
            font-weight: 600;
            position: absolute; 
        }

        .flow-item-actions .btn-flow-action:hover {
            width: 40px; 
            border-radius: 8px; 
        }

        .btn-flow-action:hover .btn-symbol {
            opacity: 0;
        }
        .btn-flow-action:hover .btn-text {
            opacity: 1;
            position: relative;
        }

        .btn-flow-action:disabled:hover {
            width: 16px;
            border-radius: 50%;
            background-color: #A0AEC0;
        }
        .btn-flow-action:disabled:hover .btn-symbol {
            opacity: 1;
        }
        .btn-flow-action:disabled:hover .btn-text {
            opacity: 0;
        }

        .btn-flow-action.btn-delete-flow {
            background-color: #E53E3E;
            color: white;
        }
        .btn-flow-action.btn-delete-flow:hover {
            background-color: #C53030;
        }
        .btn-flow-action.btn-complete-flow {
            background-color: #4CAF50;
            color: white;
        }
        .btn-flow-action.btn-complete-flow:hover {
            background-color: #45a049;
        }
        .btn-flow-action.btn-edit-flow {
            background-color: #f0ad4e;
            color: white;
        }
        .btn-flow-action.btn-edit-flow:hover {
            background-color: #ec971f;
        }
        .btn-flow-action.btn-undo-complete {
            background-color: #FFC107;
            color: #000000;
        }
        .btn-flow-action.btn-undo-complete:hover {
            background-color: #e6ac00;
        }
        
        .flow-item-actions {
            grid-column: 3;
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            align-self: start;
            flex-direction: row-reverse; 
        }

        .project-card-details {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .project-card-info {
            flex-grow: 1;
        }

        .project-card-drag-handle {
            display: grid;
            grid-template-columns: 4px 4px;
            gap: 3px;
            padding: 4px;
            cursor: grab;
            flex-shrink: 0;
            align-self: center;
        }
        .project-card-drag-handle::before,
        .project-card-drag-handle::after,
        .project-card-drag-handle span::before,
        .project-card-drag-handle span::after {
            content: '';
            width: 4px;
            height: 4px;
            background-color: var(--sub-text-color);
            border-radius: 50%;
        }
        .project-card-drag-handle span {
            display: contents; 
        }
        .project-card-drag-handle:active {
            cursor: grabbing;
        }
        .project-card.dragging {
            opacity: 0.5;
            background: var(--bg-color);
        }
		
		#category-filter-tags-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .category-filter-card {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        .category-filter-card h4 {
            margin: 0 0 8px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--secondary-color);
        }
        .category-filter-list {
            display: flex;
            flex-wrap: wrap; /* 疊磚排列 */
            gap: 6px;
        }
        .category-filter-tag {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 4px 10px;
            border-radius: 12px; /* 圓角方框 */
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            user-select: none; /* 避免點擊時選取文字 */
        }
        .category-filter-tag:hover {
            background-color: var(--primary-light);
        }
        .category-filter-tag.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="initial-setup" id="initial-setup-page">
        <div class="modal-content">
            <h2>專案管理工具</h2>
            <p>請先選擇一個個人檔案來開始管理您的專案。</p>
            <div class="btn-container">
                <button type="button" class="btn btn-add" id="new-json-btn">新增個人檔案</button>
                <button type="button" class="btn btn-save" id="import-json-btn">匯入舊檔案</button>
            </div>
            <div id="import-area" style="display: none; margin-top: 24px;">
                <p>請選擇您的 JSON 專案檔或拖曳到此處。</p>
                <input type="file" id="import-json-file" accept=".json" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;" title="選擇 JSON 檔案">
            </div>
        </div>
    </div>
    <div id="drop-zone-overlay">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="12" x2="12" y2="18"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        <p>將個人 JSON 檔案拖曳到此處匯入</p>
    </div>
    <div class="app-container" style="display: none;">
        <aside class="sidebar" id="sidebar">
            <div class="logo">專案工具</div>
            <nav class="main-nav">
                <ul>
                    <li class="nav-item active" data-target="dashboard-page">
                        <a href="#dashboard">
                            <span>儀表板</span>
                        </a>
                    </li>
                    <li class="nav-item" data-target="project-list-page">
                        <a href="#projects">
                            <span>專案</span>
                        </a>
                    </li>
					<li class="nav-item" data-target="template-page">
                        <a href="#templates">
                            <span>模板</span>
                        </a>
                    </li>
                    <li class="nav-item" data-target="settings-page">
                        <a href="#settings">
                            <span>設定</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <button type="button" class="hamburger-btn" id="hamburger-btn" style="display: block;">☰</button>
                <div class="topbar-actions">
                </div>
            </header>
            <section class="page-content active" id="dashboard-page">
                <div class="dashboard-stats-grid" id="dashboard-stats-grid">
                    <div class="stat-card">
                        <h3>總專案數</h3>
                        <div class="stat-value" id="stat-total-projects">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>總流程數</h3>
                        <div class="stat-value" id="stat-total-flows">0</div>
                    </div>
                    <div class="stat-card completed">
                        <h3>已完成流程</h3>
                        <div class="stat-value" id="stat-completed-flows">0</div>
                    </div>
                    <div class="stat-card overdue">
                        <h3>已逾期流程</h3>
                        <div class="stat-value" id="stat-overdue-flows">0</div>
                    </div>
                </div>
				<div class="dashboard-top-row-grid">
                    
                    <div class="widget-card" id="dashboard-projects-widget">
                        <h3>我的專案</h3>
                        <div class="project-grid" id="dashboard-project-grid-container" style="max-height: 400px; overflow-y: auto; padding: 5px;">
                            </div>
                    </div>

                    <div class="widget-card" id="category-tracker-widget">
                        <h3>全局項目控管 (人,事,地,物)</h3>
                        <div class="form-group" style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <select id="category-template-select" title="項目類別過濾" style="flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;">
                                <option value="all">所有類別</option>
                            </select>
                            <input type="text" id="category-search-input" placeholder="輸入搜尋關鍵字..." style="flex-grow: 2; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;">
                            <button type="button" class="btn btn-add" id="category-search-btn" style="padding: 10px 16px;">搜尋</button>
                        </div>
						<div id="category-filter-tags-container" style="margin-top: 16px;">
                            <div class="category-filter-card">
                                <h4>人</h4>
                                <div class="category-filter-list" id="filter-list-person"></div>
                            </div>
                            <div class="category-filter-card">
                                <h4>事</h4>
                                <div class="category-filter-list" id="filter-list-event"></div>
                            </div>
                            <div class="category-filter-card">
                                <h4>地</h4>
                                <div class="category-filter-list" id="filter-list-place"></div>
                            </div>
                            <div class="category-filter-card">
                                <h4>物</h4>
                                <div class="category-filter-list" id="filter-list-object"></div>
                            </div>
                        </div>
                        <ul class="widget-list" id="category-search-results">
                            <li style="color: var(--sub-text-color); cursor: default;">請先執行搜尋。</li>
                        </ul>
                    </div>
                
                </div> <div class="dashboard-widgets-grid">
                    
                    <div class="widget-card" id="upcoming-deadlines-widget">
                        <h3>即將到期 / 逾期</h3>
                        <ul class="widget-list" id="upcoming-deadlines-list">
                        </ul>
                    </div>
					<div class="widget-card" id="active-timers-widget">
                        <h3>活躍中計時器</h3>
                        <ul class="widget-list" id="active-timers-list">
                            </ul>
                    </div>
                </div>
            </section>
            <section class="page-content" id="project-list-page">
                <div class="project-list-header">
					<button type="button" class="btn btn-add" id="add-btn" style="margin-top: 16px; margin-bottom: 16px;">
                        <span>新增專案</span> </button>
                    <button type="button" class="btn btn-save" id="import-from-template-btn" style="margin-top: 16px; margin-bottom: 16px; margin-left: 10px;">匯入模板</button>
                    <button type="button" class="btn btn-help" id="help-btn-project-list" style="margin-top: 16px; margin-bottom: 16px;">功能說明</button>
                </div>
                <div class="project-grid" style="display: grid; gap: 24px;">
                    </div>
            </section>
            <section class="page-content" id="project-editor-page">
                <div class="project-editor">
					<button class="btn btn-cancel" id="back-to-projects-btn" style="margin-bottom: 16px;">&lt; 返回所有專案</button>
                    <button type="button" class="btn btn-help" id="help-btn-project-editor" style="margin-bottom: 16px;">功能說明</button>
					<h1 id="project-editor-title" contenteditable="true"></h1>
					<p id="project-editor-description" class="description-area" contenteditable="true"></p>
					<div style="display: flex; gap: 24px; align-items: flex-start;">
						<div class="flow-container" style="flex-grow: 1;">
							<h3>專案流程 <button class="btn btn-add" id="add-flow-btn">新增流程</button></h3>
							<div id="flow-list">
							</div>
						</div>
						<aside id="flow-minimap-aside" class="flow-minimap">
							<h4>流程總覽</h4>
							<div id="flow-minimap-content">
								</div>
						</aside>
					</div>
				</div>
            </section>
            <section class="page-content" id="settings-page">
                <div style="text-align: right; margin-bottom: 16px;">
                    <button type="button" class="btn btn-help" id="help-btn-settings">功能說明</button>
                </div>

                <div class="settings-container">
                    <!--h2>設定</h2-->
                    <div class="settings-section">
                        <h3>當前個人檔案</h3>
                        <p>檔案名稱：<span id="file-path" class="file-info">未匯入或新增檔案</span></p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;"> 
                        <div class="settings-section" style="margin-bottom: 0;">
                            <h3>自動儲存</h3>
                            <p>設定專案資料的自動儲存頻率。</p>
                            <div class="form-group" style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <label for="auto-save-interval" style="font-weight: 600; color: var(--secondary-color); white-space: nowrap;">儲存頻率：</label>
                                <select id="auto-save-interval" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;">
                                    <option value="0">關閉</option>
                                    <option value="1">每 1 分鐘</option>
                                    <option value="5" selected>每 5 分鐘</option>
                                    <option value="10">每 10 分鐘</option>
                                </select>
                            </div>
                            <div class="auto-save-timer" id="auto-save-timer">自動儲存已關閉</div>
                        </div>
                        <div class="settings-section" style="margin-bottom: 0;">
                            <h3>手動儲存</h3>
                            <p>將目前所有專案資料立即儲存到您的檔案中。</p>
                            <button class="btn btn-save" id="manual-save-btn" disabled>立即儲存</button>
                        </div>
                    </div>
                </div>
            </section>
			<section class="page-content" id="template-page">
				<div class="template-page-header">
					<!--h1 style="margin-top: 0px">模板</h1-->
				</div>
				<div class="template-section">
					<h2>項目模板</h2>
					<button class="btn btn-add" id="add-template-section-btn">新增項目板塊</button>
                    <button type="button" class="btn btn-help" id="help-btn-template-item">功能說明</button>
					<div id="template-section-container" style="margin-top: 24px;">
					</div>
				</div>
				<div class="template-section" style="margin-top: 40px;">
					<h2>專案模板</h2>
					<button class="btn btn-add" id="add-project-template-btn">新增專案模板</button>
					<div id="project-template-container" style="margin-top: 24px;">
						<p style="color: var(--sub-text-color); font-style: italic;">(此功能待開發)</p>
					</div>
				</div>
			</section>
        </main>
    </div>
    <div class="modal" id="add-project-modal">
        <div class="modal-content">
            <h2>新增專案</h2>
            <form id="add-project-form">
                <div class="form-group">
                    <label for="project-name">專案名稱</label>
                    <input type="text" id="project-name" required>
                </div>
                <div class="form-group">
                    <label for="project-description">專案描述</label>
                    <textarea id="project-description"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-btn">取消</button>
                    <button type="submit" class="btn btn-submit">新增</button>
                </div>
            </form>
        </div>
    </div>
	<div class="modal" id="add-flow-modal"> 
		<div class="modal-content" style="max-width: 700px;"> <h2 id="flow-modal-title">新增流程</h2>
			<div class="add-flow-input-container" style="display: block; border: none; padding: 0; background: none; margin-bottom: 0; overflow-y: auto; padding-right: 16px; margin-right: -16px;">
				<div class="flow-modal-main-fields" style="display: flex; flex-direction: column; gap: 6px; /*padding-bottom: 24px; margin-bottom: 24px; */border-bottom: 1px solid var(--border-color);">
					<input type="text" id="new-flow-name-input" placeholder="流程項目名稱">
				</div>
				<div class="flow-modal-main-items-section" style="padding-top: 24px; /*margin-top: 24px; */border-top: 1px solid var(--border-color);">
                    <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--secondary-color);">主項目</h4>
                    <div id="main-items-options" class="more-items-options-container" style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
						<button type="button" class="btn btn-category" data-category="人">人</button>
						<button type="button" class="btn btn-category" data-category="事">事</button>
						<button type="button" class="btn btn-category" data-category="時">時</button>
						<button type="button" class="btn btn-category" data-category="地">地</button>
						<button type="button" class="btn btn-category" data-category="物">物</button>
						<button type="button" class="btn btn-category" data-category="圖">圖</button>
						<button type="button" class="btn btn-category" data-category="計時器">計時器</button>
					</div>
					<div id="main-items-container">
					</div>
                </div>

				<div id="flow-modal-sub-items-section" class="flow-modal-dynamic-fields" style="padding-top: 24px; margin-top: 24px; border-top: 1px solid var(--border-color);">
					<h4 style="margin-top: 0; margin-bottom: 12px; color: var(--secondary-color);">子項目</h4>
                    <div id="sub-items-options" class="more-items-options-container" style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
						<button type="button" class="btn btn-category" data-category="人">人</button>
						<button type="button" class="btn btn-category" data-category="事">事</button>
						<button type="button" class="btn btn-category" data-category="時">時</button>
						<button type="button" class="btn btn-category" data-category="地">地</button>
						<button type="button" class="btn btn-category" data-category="物">物</button>
						<button type="button" class="btn btn-category" data-category="圖">圖</button>
						<button type="button" class="btn btn-category" data-category="計時器">計時器</button>
					</div>
					<div id="sub-items-container" style="margin-top: 16px;">
					</div>
				</div>
			</div>
			<div class="form-actions">
				<button type="button" class="btn btn-cancel" id="cancel-flow-btn">取消</button>
				<button class="btn btn-submit" id="submit-flow-btn">確認</button>
			</div>
		</div>
	</div>
	<div class="modal" id="import-template-modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>從模板匯入專案</h2>
            <p>請選擇一個專案模板。將會以此模板為基礎建立一個新專案。</p>
            <div class="form-group">
                <label for="import-template-list" style="margin-bottom: 8px; display: block;">可用的專案模板：</label>
                <ul id="import-template-list" style="list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    </ul>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-import-btn">取消</button>
                <button type="button" class="btn btn-submit" id="confirm-import-btn">匯入</button>
            </div>
        </div>
    </div>
    <div id="image-preview-modal" class="image-preview-modal">
        <img class="modal-content-image" id="modal-image-content" alt="圖片預覽">
    </div>
	
	<div class="modal" id="confirm-modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 id="confirm-modal-title">確認刪除</h2>
            <p id="confirm-modal-message">您確定要刪除此項目嗎？此動作無法復原。</p>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="confirm-modal-cancel">取消</button>
                <button type="button" class="btn btn-submit btn-cancel-flow" id="confirm-modal-confirm">確定</button>
            </div>
        </div>
    </div>
	<div class="modal" id="help-modal">
        <div class="modal-content" id="help-modal-content" style="max-width: 600px;">
            <h2 id="help-modal-title" style="margin-bottom: 16px;">功能說明</h2>
            <div id="help-modal-body" style="white-space: pre-wrap; line-height: 1.6; max-height: 60vh; overflow-y: auto;">
                </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialSetupPage = document.getElementById('initial-setup-page');
            const appContainer = document.querySelector('.app-container');
            const newJsonBtn = document.getElementById('new-json-btn');
            const importJsonBtn = document.getElementById('import-json-btn');
            const importArea = document.getElementById('import-area');
            const importJsonFile = document.getElementById('import-json-file');
            const navItems = document.querySelectorAll('.nav-item');
            const pageContents = document.querySelectorAll('.page-content');
            const sidebar = document.getElementById('sidebar');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const addBtn = document.getElementById('add-btn');
            const addProjectModal = document.getElementById('add-project-modal');
            const cancelBtn = document.getElementById('cancel-btn');
            const addProjectForm = document.getElementById('add-project-form');
            const dropZoneOverlay = document.getElementById('drop-zone-overlay');
            const filePathDisplay = document.getElementById('file-path');
            const autoSaveInterval = document.getElementById('auto-save-interval');
            const autoSaveTimerDisplay = document.getElementById('auto-save-timer');
            const manualSaveBtn = document.getElementById('manual-save-btn');
            const projectGridContainer = document.querySelector('#project-list-page .project-grid');
            const projectEditorTitle = document.getElementById('project-editor-title');
            const projectEditorDescription = document.getElementById('project-editor-description');
            const flowList = document.getElementById('flow-list');
            const addFlowBtn = document.getElementById('add-flow-btn');
            const addFlowInputContainer = document.querySelector('.add-flow-input-container');
            const newFlowNameInput = document.getElementById('new-flow-name-input');
            const submitFlowBtn = document.getElementById('submit-flow-btn');
			const addTemplateSectionBtn = document.getElementById('add-template-section-btn');
            const templateSectionContainer = document.getElementById('template-section-container');
            
            const backToProjectsBtn = document.getElementById('back-to-projects-btn');

			const imagePreviewModal = document.getElementById('image-preview-modal');
            const modalImageContent = document.getElementById('modal-image-content');

            const mainItemsOptions = document.getElementById('main-items-options');
            const subItemsOptions = document.getElementById('sub-items-options');
            const mainItemsContainer = document.getElementById('main-items-container');
            const subItemsContainer = document.getElementById('sub-items-container');
			
			const addFlowModal = document.getElementById('add-flow-modal');
			const cancelFlowBtn = document.getElementById('cancel-flow-btn');
			const flowModalTitle = document.getElementById('flow-modal-title');
			const flowMinimapContent = document.getElementById('flow-minimap-content');
			
			const addProjectTemplateBtn = document.getElementById('add-project-template-btn');
            const projectTemplateContainer = document.getElementById('project-template-container');

			const importFromTemplateBtn = document.getElementById('import-from-template-btn');
            const importTemplateModal = document.getElementById('import-template-modal');
            const importTemplateList = document.getElementById('import-template-list');
            const cancelImportBtn = document.getElementById('cancel-import-btn');
            const confirmImportBtn = document.getElementById('confirm-import-btn');
			const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmModalConfirm = document.getElementById('confirm-modal-confirm');
            const confirmModalCancel = document.getElementById('confirm-modal-cancel');
			
			const helpBtnProjectList = document.getElementById('help-btn-project-list');
            const helpBtnProjectEditor = document.getElementById('help-btn-project-editor');
            const helpBtnTemplateItem = document.getElementById('help-btn-template-item');
            const helpBtnSettings = document.getElementById('help-btn-settings');
            
			const helpModal = document.getElementById('help-modal');
            const helpModalTitle = document.getElementById('help-modal-title');
            const helpModalBody = document.getElementById('help-modal-body');
			
            let currentConfirmCallback = null; // 用來儲存確認後要執行的動作
			let currentCancelCallback = null; // 用來儲存取消後要執行的動作
			let hasJsonData = false;
            let currentFileName = '未匯入或新增檔案';
            let autoSaveTimer;
            let countdownTimer;
            let projectData = []; 
			let templateData = [];
			let projectTemplateData = [];
            let activeProjectIndex = null;
            let editingFlowId = null; 
			let activeTemplateIndex = null;
            let currentEditorMode = 'project';
            let countdownInterval = null;
            
            const categoryToTemplateType = {
                '人': 'person',
                '事': 'event',
                '時': 'time',
                '地': 'place',
                '物': 'object'
            };
            
            function readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
			
			function getDynamicInputHTML(category) {
                let inputHTML = '';
                if (category === '時') {
                    inputHTML = `<input type="datetime-local" data-category="${category}" style="width: 250px;">`;
                } else if (category === '圖') {
                    inputHTML = `
						<input type="file" data-category="圖" accept="image/*" style="display: none;" class="dynamic-image-upload-input">
						<img class="dynamic-item-preview" src="" style="display: none; width: 125px; height: auto; margin-top: 8px; border-radius: 4px; cursor: pointer;">
					`;
                } else if (category === '計時器') { 
                    inputHTML = `
                        <div class="timer-setup" style="margin-top: 8px;">
                            <input type="datetime-local" class="temp-timer-input" value="">
                            <button type="button" class="btn-confirm-timer">確認</button>
                        </div>
                    `;
                } else {
                    inputHTML = `<input type="text" placeholder="請輸入${category}..." data-category="${category}">`;
                }
                
                if (category === '物') {
                    inputHTML += `
                        <div class="timer-setup" style="display: inline-flex; gap: 8px; margin-left: 8px;">
                            <input type="datetime-local" class="temp-timer-input" value="">
                            <button type="button" class="btn-confirm-timer">確認</button>
                        </div>
                    `;
                }
                return inputHTML;
            }
            
            function createDynamicBlock(category, parentElement, isMainItem = false) {
                const block = document.createElement('div');
                block.className = 'dynamic-item-block';
                block.innerHTML = `<button type="button" class="btn-delete-dynamic-item" title="刪除此項目">×</button>`;

                let inputHTML = getDynamicInputHTML(category);
                let hasInput = true; 
                
                if (category === '圖' || category === '計時器') {
                    hasInput = false;
                }

                const templateType = categoryToTemplateType[category];
                const mainContent = document.createElement('div');
                
                if (templateType) {
                    mainContent.className = 'dynamic-item-main-content';
                    const inputArea = document.createElement('div');
                    inputArea.className = 'dynamic-item-input-area';
                    const content = document.createElement('div');
                    content.className = 'dynamic-item-content';
                    const colonHTML = (category === '圖') ? '' : '<span class="label-colon">:</span>';
                    content.innerHTML = `<label contenteditable="true" data-label-for-category="${category}">${category}</label>${colonHTML}${inputHTML}`;
                    inputArea.appendChild(content);
                    mainContent.appendChild(inputArea);
                    const templateArea = document.createElement('div');
                    templateArea.className = 'dynamic-item-template-list-area';
                    templateArea.innerHTML = renderTemplateLinks(templateType);
                    mainContent.appendChild(templateArea);
                } else {
                    mainContent.className = 'dynamic-item-content';
                    const colonHTML = (category === '圖') ? '' : '<span class="label-colon">:</span>';
                    mainContent.innerHTML = `<label contenteditable="true" data-label-for-category="${category}">${category}</label>${colonHTML}${inputHTML}`;
                }
                
                if (!hasInput) {
                    mainContent.querySelector('label').style.display = 'none';
                }
                
                const actions = document.createElement('div');
                actions.className = 'dynamic-item-actions';
                
				let uploadButtonHTML = (category === '圖') ? `<button type="button" class="btn btn-upload-img" style="font-size: 0.8rem; padding: 4px 8px;">選擇圖片</button>` : '';
                let actionButtonsHTML = `
					${!isMainItem ? '<button type="button" class="btn btn-add-sibling">增加同層區塊</button>' : ''}
					${!isMainItem ? '<button type="button" class="btn btn-add-child">增加子區塊</button>' : ''}
				`;

				if (parentElement.id === 'sub-items-container') {
                    actionButtonsHTML += `
                        <button type="button" class="btn btn-toggle-checkbox">CheckBox XXX</button>
                    `;
                } else {
                    actionButtonsHTML += `
                        <button type="button" class="btn btn-toggle-checkbox">CheckBox</button>
                        <button type="button" class="btn btn-toggle-hide-title">隱藏標題</button>
                    `;
                }
                actions.innerHTML = uploadButtonHTML + actionButtonsHTML;
                
                const childOptions = document.createElement('div');
                childOptions.className = 'dynamic-item-children-options more-items-options-container';
                childOptions.style.display = 'none';
                
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'dynamic-item-children';

                block.appendChild(mainContent); 
                block.appendChild(actions);
                block.appendChild(childrenContainer); 
                block.appendChild(childOptions); 

                parentElement.appendChild(block);
            }

            function parseDynamicItems(container) {
                const items = [];
                const blocks = container.querySelectorAll(':scope > .dynamic-item-block');
                
                blocks.forEach(block => {
                    const content = block.querySelector(':scope > .dynamic-item-content, :scope > .dynamic-item-main-content .dynamic-item-content');
                    const labelEl = content.querySelector('label[data-label-for-category]');
                    const inputEl = content.querySelector('input[data-category], select[data-category]');
                    const childrenContainer = block.querySelector(':scope > .dynamic-item-children');
                    
                    if (labelEl && (inputEl || labelEl.dataset.labelForCategory === '計時器' || labelEl.dataset.labelForCategory === '圖')) { 
                        
                        const category = labelEl.dataset.labelForCategory;
                        const labelText = labelEl.textContent.trim(); 
                        
                        let valueToStore = null; 
                        if (inputEl) { 
                            if (inputEl.type === 'datetime-local') { 
                                valueToStore = inputEl.value ? new Date(inputEl.value).toISOString() : null;
                            } else if (inputEl.type !== 'file') {
                                valueToStore = inputEl.value.trim();
                            }
                        }

                        const itemData = {
                            id: 'dyn-' + Date.now() + '-' + Math.floor(Math.random() * 10000), 
                            category: category,
                            label: labelText,
                            value: valueToStore, 
                            children: []
                        };
                        
                        if (inputEl && inputEl.tagName === 'SELECT' && inputEl.dataset.templateId) {
                            itemData.templateId = inputEl.dataset.templateId;
                        }
                        
                        if (category === '圖' && block.dataset.imageSrc) {
                            itemData.value = block.dataset.imageSrc;
                        }
                        
						if (block.dataset.toggleState) {
                            itemData.toggleState = block.dataset.toggleState;
                        }
						
                        if (block.dataset.timerDeadline) {
                            itemData.timerDeadline = block.dataset.timerDeadline;
                        }
                        
                        if (block.dataset.hasCheckbox === 'true') {
                            itemData.hasCheckbox = true;
                        }
						
                        if (block.dataset.hideLabel === 'true') {
                            itemData.hideLabel = true;
                        }
                        
                        if (childrenContainer) {
                            itemData.children = parseDynamicItems(childrenContainer);
                        }
                        
                        items.push(itemData);
                    }
                });
                return items;
            }

            function rebuildDynamicInputBlocks(items, parentElement, isMainItem = false) {
                if (!items) return;
                
                items.forEach(item => {
                    createDynamicBlock(item.category, parentElement, isMainItem);
                    
                    const newBlock = parentElement.lastElementChild;
                    if (!newBlock) return;
                    
                    if (parentElement.id === 'dynamic-items-container') {
                        newBlock.dataset.itemId = item.id;
                    }

                    if (item.category === '圖' && item.value) {
                        const previewImg = newBlock.querySelector('.dynamic-item-preview');
                        const uploadBtn = newBlock.querySelector('.dynamic-item-actions .btn-upload-img');
                        if (previewImg) {
                            previewImg.src = item.value;
                            previewImg.style.display = 'block';
                        }
                        newBlock.dataset.imageSrc = item.value;
                        if (uploadBtn) {
                            uploadBtn.textContent = "更換圖片";
                        }
                    }

                    const labelEl = newBlock.querySelector('label[data-label-for-category]');
                    if (labelEl && item.label) {
                        labelEl.textContent = item.label;
                    }

                    const inputEl = newBlock.querySelector('input[data-category]');
                    
                    if (inputEl) {
                        if (inputEl.type === 'datetime-local') {
                            inputEl.value = formatISOToLocalInput(item.value);
                        } else if (inputEl.type !== 'file') {
                            inputEl.value = item.value || '';
                        }
                    }

                    if (item.templateId) {
                        const template = templateData.find(t => t.id == item.templateId);
                        if (template && inputEl) { 
                            replaceInputWithSelect(inputEl, template);
                            
                            const newSelect = newBlock.querySelector('select[data-category]');
                            if (newSelect) {
                                newSelect.value = item.value;
                            }
							
                            const link = newBlock.querySelector(`.template-link-item[data-template-id="${item.templateId}"]`);
                            if (link) {
                                link.classList.add('active');
                            }
                        }
                    }
                    
                    if (item.timerDeadline) {
                        newBlock.dataset.timerDeadline = item.timerDeadline;
                        const tempTimerInput = newBlock.querySelector('.temp-timer-input');
                        if (tempTimerInput) {
                            tempTimerInput.value = formatISOToLocalInput(item.timerDeadline);
                        }
                    }
					
                    if (item.toggleState) { 
                        newBlock.dataset.toggleState = item.toggleState;
                        const btn = newBlock.querySelector('.btn-toggle-checkbox');
                        if (btn) {
                            if (item.toggleState === '1') {
                                btn.textContent = 'CheckBox OOO';
                                btn.classList.add('active'); 
                            } else if (item.toggleState === '2') {
                                btn.textContent = 'CheckBox XOO';
                                btn.classList.remove('active');
                            }
                        }
                    }

                    if (item.hasCheckbox) {
                        newBlock.dataset.hasCheckbox = 'true';
                        const btn = newBlock.querySelector('.btn-toggle-checkbox');
                        
                        if (btn && !item.toggleState) { 
                            btn.classList.add('active');
                        }
                    }
					
                    if (item.hideLabel) {
                        newBlock.dataset.hideLabel = 'true';
                        const btn = newBlock.querySelector('.btn-toggle-hide-title');
                        if (btn) btn.classList.add('active');
                    }

                    if (item.children && item.children.length > 0) {
                        const childrenContainer = newBlock.querySelector('.dynamic-item-children');
                        rebuildDynamicInputBlocks(item.children, childrenContainer, false); // Children are never main items
                    }
                });
            }

            newJsonBtn.addEventListener('click', () => {
                hasJsonData = true;
                currentFileName = 'personal_data.json';
                updateFilePathDisplay();
                enterMainApp();
            });

            importJsonBtn.addEventListener('click', () => {
                importArea.style.display = 'block';
            });
            
            importJsonFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileImport(e.target.files[0]);
                }
            });

            function enterMainApp() {
                initialSetupPage.style.display = 'none';
                appContainer.style.display = 'flex';
                switchPage('dashboard-page');
                renderProjectList();
                renderDashboard();

                document.getElementById('category-search-btn').addEventListener('click', renderCategorySearchResults);
                document.getElementById('category-search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        renderCategorySearchResults();
                    }
                });
				
				renderTemplateSections();
				renderProjectTemplates();
                startAutoSave(autoSaveInterval.value);
                
                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(updateAllTimers, 1000);
            }

            function switchPage(targetId) {
                navItems.forEach(nav => nav.classList.remove('active'));
                pageContents.forEach(page => page.classList.remove('active'));
                const targetNav = document.querySelector(`[data-target="${targetId}"]`);
                if (targetNav) targetNav.classList.add('active');
                document.getElementById(targetId).classList.add('active');
                sidebar.classList.remove('show');
                hamburgerBtn.style.display = 'block';
                
                if (targetId !== 'project-editor-page') {
                    resetAndHideFlowForm();
                }
            }

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPage(item.dataset.target);
                    if (item.dataset.target === 'project-list-page') {
                        renderProjectList();
                    } else if (item.dataset.target === 'dashboard-page') {
						renderDashboard(); 
					} else if (item.dataset.target === 'template-page') {
						renderTemplateSections();
						renderProjectTemplates();
					}
                });
            });

            hamburgerBtn.addEventListener('click', () => {
                sidebar.classList.add('show');
                hamburgerBtn.style.display = 'none';
            });
            document.addEventListener('click', (e) => {
                const isClickInsideSidebar = sidebar.contains(e.target);
                const isClickOnHamburger = hamburgerBtn.contains(e.target);
                if (!isClickInsideSidebar && !isClickOnHamburger && sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    hamburgerBtn.style.display = 'block';
                }
            });

            backToProjectsBtn.addEventListener('click', () => {
                if (currentEditorMode === 'template') {
                    switchPage('template-page');
                    renderProjectTemplates(); 
                } else {
                    switchPage('project-list-page');
                    renderProjectList(); 
                }
                activeProjectIndex = null;
                activeTemplateIndex = null;
                currentEditorMode = 'project'; 
            });

            addFlowInputContainer.addEventListener('click', (e) => {
                const target = e.target;

                if (target.classList.contains('dynamic-item-preview')) {
                    showImageModal(target.src);
                    return;
                }
                
                if (target.classList.contains('btn-upload-img')) {
                    const block = target.closest('.dynamic-item-block');
                    const fileInput = block.querySelector('.dynamic-image-upload-input');
                    if (fileInput) {
                        fileInput.click();
                    }
                    return;
                }
                
                if (target.classList.contains('btn-delete-dynamic-item')) {
                    const block = target.closest('.dynamic-item-block');
                    if (block) {
                        block.remove();
                    }
                    return;
                }
                
                if (target.classList.contains('btn-confirm-timer')) {
                    const timerSetupDiv = target.closest('.timer-setup');
                    const block = target.closest('.dynamic-item-block');
                    const tempInput = timerSetupDiv.querySelector('.temp-timer-input');

                    if (tempInput.value) {
                        block.dataset.timerDeadline = new Date(tempInput.value).toISOString();
                    } else {
                        delete block.dataset.timerDeadline;
                    }
                    return;
                }
                
                if (target.classList.contains('btn-confirm-timer')) {
                    const timerSetupDiv = target.closest('.timer-setup');
                    const block = target.closest('.dynamic-item-block');
                    const tempInput = timerSetupDiv.querySelector('.temp-timer-input');
                    const setBtn = block.querySelector('.btn-set-timer');

                    if (tempInput.value) {
                        block.dataset.timerDeadline = new Date(tempInput.value).toISOString();
                        setBtn.textContent = "修改計時";
                    } else {
                        delete block.dataset.timerDeadline;
                        setBtn.textContent = "計時器";
                    }
                    
                    timerSetupDiv.remove();
                    return;
                }

                if (target.classList.contains('btn-category')) {
					const category = target.dataset.category;
					const optionsContainer = target.closest('.more-items-options-container');
					if (!optionsContainer) return;

					let parentElement;
					let isMainItem = false;

					if (optionsContainer.id === 'main-items-options') {
						parentElement = mainItemsContainer;
						isMainItem = true;
					} else if (optionsContainer.id === 'sub-items-options') {
						parentElement = subItemsContainer;
						isMainItem = false;
					} else {
						// This is a "child" options container
						parentElement = optionsContainer.previousElementSibling; // .dynamic-item-children
						isMainItem = false; // Children are never main items
					}

					createDynamicBlock(category, parentElement, isMainItem);
					// optionsContainer.style.display = 'none'; // No longer needed, buttons are always visible or toggled per block

					// Hide the *block's* child options after selection
					if (optionsContainer.id !== 'main-items-options' && optionsContainer.id !== 'sub-items-options') {
						 optionsContainer.style.display = 'none';
					}

					if (category === '計時器') {
                        const newBlock = parentElement.lastElementChild;
                        if (newBlock) {
                            const setTimerBtn = newBlock.querySelector('.btn-set-timer');
                            if (setTimerBtn) {
                                setTimerBtn.click();
                            }
                        }
                    }
                }

                if (target.classList.contains('btn-add-sibling')) {
                    const currentBlock = target.closest('.dynamic-item-block');
                    const parentContainer = currentBlock.parentElement;

                    let optionsContainerToShow;
                    if (parentContainer.id === 'main-items-container') {
						mainItemsOptions.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
						return; // Don't toggle anything
					} else if (parentContainer.id === 'sub-items-container') {
						subItemsOptions.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
						return; // Don't toggle anything
					}
                    
					optionsContainerToShow = parentContainer.nextElementSibling;
					
                    if (optionsContainerToShow && optionsContainerToShow.innerHTML === '') {
						optionsContainerToShow.innerHTML = subItemsOptions.innerHTML; // Use SUB-items options as template
					}
                }

                if (target.classList.contains('btn-add-child')) {
                    const currentBlock = target.closest('.dynamic-item-block');
                    const childOptionsContainer = currentBlock.querySelector('.dynamic-item-children-options');

                    if (childOptionsContainer.innerHTML === '') {
						childOptionsContainer.innerHTML = subItemsOptions.innerHTML; // Use sub-items options as template
					}

                    childOptionsContainer.style.display = childOptionsContainer.style.display === 'none' ? 'flex' : 'none';
                }
				
                // Checkbox Toggles XXX/OOO/XOO)
                if (target.classList.contains('btn-toggle-checkbox')) {
                    const block = target.closest('.dynamic-item-block');
                    if (!block) return;

                    const isTopLevel = block.parentElement.id === 'sub-items-container';

                    if (isTopLevel) {
                        // Top level: XXX -> OOO -> XOO -> XXX
                        let state = block.dataset.toggleState || '0'; // 0=XXX, 1=OOO, 2=XOO
                        
                        const childrenContainer = block.querySelector('.dynamic-item-children');
                        const childBlocks = childrenContainer.querySelectorAll('.dynamic-item-block');
                        const childBtns = childrenContainer.querySelectorAll('.btn-toggle-checkbox');

                        if (state === '0') {
                            // 0 (XXX) -> 1 (OOO)
                            block.dataset.toggleState = '1';
                            target.textContent = 'CheckBox OOO';
                            
                            target.classList.add('active'); 
                            block.dataset.hasCheckbox = 'true';
                            
                            childBtns.forEach(b => {
                                b.classList.add('active');
                            });
                            childBlocks.forEach(b => b.dataset.hasCheckbox = 'true');

                        } else if (state === '1') {
                            // 1 (OOO) -> 2 (XOO)
                            block.dataset.toggleState = '2';
                            target.textContent = 'CheckBox XOO';

                            target.classList.remove('active');
                            delete block.dataset.hasCheckbox;
                            
                            childBtns.forEach(b => {
                                b.classList.add('active');
                            }); 
                            childBlocks.forEach(b => b.dataset.hasCheckbox = 'true');

                        } else {
                            // 2 (XOO) -> 0 (XXX)
                            block.dataset.toggleState = '0';
                            target.textContent = 'CheckBox XXX';
                            
                            target.classList.remove('active');
                            delete block.dataset.hasCheckbox;
                            
                            childBtns.forEach(b => {
                                b.classList.remove('active');
                            });
                            childBlocks.forEach(b => delete b.dataset.hasCheckbox);
                        }

                    } else {
                        if (target.classList.contains('active')) {
                            target.classList.remove('active');
                            delete block.dataset.hasCheckbox;
                        } else {
                            target.classList.add('active');
                            block.dataset.hasCheckbox = 'true';
                        }
                    }
                }
                
                if (target.classList.contains('btn-toggle-hide-title')) {
                    const block = target.closest('.dynamic-item-block');
                    if (block) {
                        target.classList.toggle('active');
                        if (target.classList.contains('active')) {
                            block.dataset.hideLabel = 'true';
                        } else {
                            delete block.dataset.hideLabel;
                        }
                    }
                }
				
                if (target.classList.contains('template-link-item')) {
                    const templateId = target.dataset.templateId;
                    const template = templateData.find(t => t.id == templateId);
                    if (!template) {
                        alert('找不到模板資料');
                        return;
                    }

                    const block = target.closest('.dynamic-item-block');
                    const templateListArea = target.closest('.dynamic-item-template-list-area');
                    if (!block || !templateListArea) return;

                    const elementToManage = block.querySelector('input[data-category], select[data-category]');
                    if (!elementToManage) return;

                    if (target.classList.contains('active')) {
                        target.classList.remove('active');
                        if (elementToManage.tagName === 'SELECT') {
                            replaceSelectWithInput(elementToManage, block);
                        }
                    } else {
                        templateListArea.querySelectorAll('.template-link-item.active').forEach(item => {
                            item.classList.remove('active');
                        });
                        target.classList.add('active');
                        replaceInputWithSelect(elementToManage, template);
                    }
                }
            });
			
			addFlowInputContainer.addEventListener('change', (e) => {
                const target = e.target;
                
                if (target.classList.contains('dynamic-image-upload-input')) {
                    const file = target.files[0];
                    if (!file) return;

                    const block = target.closest('.dynamic-item-block');
                    const previewImg = block.querySelector('.dynamic-item-preview');
                    const uploadBtn = block.querySelector('.dynamic-item-actions .btn-upload-img');

                    readFileAsDataURL(file).then(base64String => {
						if (previewImg) {
							previewImg.src = base64String;
							previewImg.style.display = 'block';
						}
						block.dataset.imageSrc = base64String;
						if (uploadBtn) {
							uploadBtn.textContent = "更換圖片";
						}
					})
					.catch(err => {
						console.error("Error reading image file:", err);
						alert("讀取圖片失敗。");
					});
                }
            });

            addBtn.addEventListener('click', () => {
                addProjectModal.classList.add('show');
            });
            
            cancelBtn.addEventListener('click', () => addProjectModal.classList.remove('show'));
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        modal.classList.remove('show');
                    }
                });
            });
			
            function updateProjectTimestamp(projectIndex) {
                if (projectIndex === null || !projectData[projectIndex]) return;
                projectData[projectIndex].updatedAt = new Date().toISOString();
            }

            addProjectForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const now = new Date().toISOString();
                const newProjectData = {
                    id: Date.now(),
                    name: document.getElementById('project-name').value,
                    description: document.getElementById('project-description').value,
                    flows: [],
                    createdAt: now,
                    updatedAt: now 
                };
                
                projectData.push(newProjectData);
                renderProjectList();
                
                editProject(newProjectData.id);
                
                addProjectModal.classList.remove('show');
            });

            function renderProjectList() {
                projectGridContainer.innerHTML = '';
                if (projectData.length === 0) {
                    projectGridContainer.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">目前沒有任何專案。點擊右上角「新增」來建立一個。</p>';
                } else {
                    projectData.forEach(project => {
                        const projectCard = document.createElement('div');
                        projectCard.className = 'project-card';
                        
                        const flowsToShow = (project.flows || []); 
                        
                        let timelineHTML = '';
                        if (flowsToShow.length > 0) {
                            timelineHTML = flowsToShow.map(flow => {
                                const isCompleted = flow.completed;
                                return `
                                    <div class="timeline-item">
                                        <div class="timeline-dot ${isCompleted ? 'completed' : ''}"></div>
                                        <div class="timeline-label ${isCompleted ? 'completed' : ''}">${flow.name}</div>
                                    </div>
                                `;
                            }).join('');
                        }
						
                        projectCard.innerHTML = `
                            <div class="project-card-actions">
                                <button type="button" class="btn btn-project-action btn-project-to-template" data-id="${project.id}" title="匯入模板">+</button>
                                <button type="button" class="btn btn-project-action btn-project-delete" data-id="${project.id}" title="刪除專案">×</button>
                            </div>
                            <div class="project-card-details">
                                <div class="project-card-drag-handle" draggable="true"><span></span></div>
                                <div class="project-card-info">
                                    <h3>${project.name}</h3>
                                    <p>${project.description || '無描述'}</p>
                                </div>
                            </div>
                            <div class="project-card-timeline">
                                ${timelineHTML}
                            </div>
                        `;
					
                        projectCard.addEventListener('click', (e) => {
                            if (e.target.closest('.btn-project-action')) {
                                return; 
                            }
                            editProject(project.id)
                        });

                        projectCard.querySelector('.btn-project-delete').addEventListener('click', (e) => {
                            e.stopPropagation();
                            const projectId = parseInt(e.currentTarget.dataset.id, 10);
                            
                            showConfirmModal('您確定要刪除此專案嗎？此動作無法復原。', '確認刪除專案', () => {
                                projectData = projectData.filter(p => p.id !== projectId);
                                renderProjectList();
                                
                                if (activeProjectIndex !== null && projectData[activeProjectIndex] && projectData[activeProjectIndex].id === projectId) {
                                    activeProjectIndex = null;
                                }
                            });
                        });
                        
                        projectCard.querySelector('.btn-project-to-template').addEventListener('click', (e) => {
							e.stopPropagation(); 
							const projectId = parseInt(e.currentTarget.dataset.id, 10);
							const projectToImport = projectData.find(p => p.id === projectId);

							if (projectToImport) {

								// 深度複製專案 (確保模板與原專案脫鉤)
								const newProjectTemplate = JSON.parse(JSON.stringify(projectToImport));

								// 給予新 ID
								newProjectTemplate.id = Date.now(); 

								// 存入專案模板陣列
								projectTemplateData.push(newProjectTemplate);

								// 提示使用者
								alert(`專案 "${projectToImport.name}" 已成功儲存至「專案模板」！`);

								// 如果模板頁籤剛好是開啟的，就重繪
								if (document.getElementById('template-page').classList.contains('active')) {
									renderProjectTemplates();
								}
							}
						});
                        projectGridContainer.appendChild(projectCard);
                    });
                }
            }
			
			// (修改點 1) 新增 儀表板專案列表 渲染函式
            function renderDashboardProjectList() {
                const container = document.getElementById('dashboard-project-grid-container');
                if (!container) return;

                container.innerHTML = '';
                if (projectData.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">目前沒有任何專案。</p>';
                } else {
                    projectData.forEach(project => {
                        const projectCard = document.createElement('div');
                        projectCard.className = 'project-card';
                        
                        const flowsToShow = (project.flows || []); 
                        
                        let timelineHTML = '';
                        if (flowsToShow.length > 0) {
                            timelineHTML = flowsToShow.map(flow => {
                                const isCompleted = flow.completed;
                                return `
                                    <div class="timeline-item">
                                        <div class="timeline-dot ${isCompleted ? 'completed' : ''}"></div>
                                        <div class="timeline-label ${isCompleted ? 'completed' : ''}">${flow.name}</div>
                                    </div>
                                `;
                            }).join('');
                        }
						
                        // *** 注意：此處的 HTML 移除了 project-card-actions 和 project-card-drag-handle ***
                        projectCard.innerHTML = `
                            <div class="project-card-details" style="align-items: flex-start;">
                                <div class="project-card-info">
                                    <h3>${project.name}</h3>
                                    <p>${project.description || '無描述'}</p>
                                </div>
                            </div>
                            <div class="project-card-timeline">
                                ${timelineHTML}
                            </div>
                        `;
					
                        // 點擊卡片跳轉至編輯頁
                        projectCard.addEventListener('click', (e) => {
                            editProject(project.id)
                        });

                        container.appendChild(projectCard);
                    });
                }
            }
			
			function renderDashboard() {
                const now = new Date();
                
                let totalProjects = 0;
                let totalFlows = 0;
                let completedFlows = 0;
                let overdueFlows = 0;
                let allUpcomingFlows = [];

                totalProjects = projectData.length;

                projectData.forEach(project => {
                    if (!project.flows) project.flows = [];
                    
                    totalFlows += project.flows.length;

                    project.flows.forEach(flow => {
                        if (flow.completed) {
                            completedFlows++;
                        } else if (flow.estimatedCompletion) {
                            const deadline = new Date(flow.estimatedCompletion);
                            if (deadline < now) {
                                overdueFlows++;
                            }
                            allUpcomingFlows.push({
                                flow: flow,
                                project: project,
                                deadline: deadline
                            });
                        }
                    });
                });

                // 填入 KPO 統計數據
                document.getElementById('stat-total-projects').textContent = totalProjects;
                document.getElementById('stat-total-flows').textContent = totalFlows;
                document.getElementById('stat-completed-flows').textContent = completedFlows;
                document.getElementById('stat-overdue-flows').textContent = overdueFlows;
				
				populateCategoryFilter();
				
				renderDashboardProjectList();

                // 渲染即將到期 & 逾期流程
                const deadlinesList = document.getElementById('upcoming-deadlines-list');
                deadlinesList.innerHTML = '';
                
                const sortedFlows = allUpcomingFlows.sort((a, b) => a.deadline - b.deadline);
                
                if (sortedFlows.length === 0) {
                    deadlinesList.innerHTML = '<li style="cursor: default; color: var(--sub-text-color);">沒有即將到期的流程</li>';
                } else {
                    sortedFlows.forEach(item => {
                        const isOverdue = item.deadline < now;
                        
                        const li = document.createElement('li');
                        li.className = `deadline-list-item ${isOverdue ? 'overdue' : ''}`;
                        li.dataset.projectId = item.project.id;
                        li.innerHTML = `
                            <span class="flow-name">${item.flow.name}</span>
                            <span class="project-context">專案：${item.project.name}</span>
                            <span class="deadline-date">
                                ${isOverdue ? '已逾期：' : '預計：'}
                                ${item.deadline.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}
                            </span>
                        `;
                        
                        li.addEventListener('click', () => {
                            editProject(item.project.id);
                        });
                        deadlinesList.appendChild(li);
                    });
                }
				renderActiveTimersWidget();
				renderFilterTags();
            }

            // 填充儀表板的類別搜尋下拉選單
            function populateCategoryFilter() {
                const select = document.getElementById('category-template-select');
                while (select.options.length > 1) { select.remove(1); } // 清除舊選項

                const typeMap = { 'person': '人', 'event': '事', 'place': '地', 'object': '物' };
                
                templateData.forEach(section => {
                    if (section.type && typeMap[section.type]) {
                            const opt = document.createElement('option');
                            opt.value = section.id; // 透過 template ID 搜尋
                            const typeName = typeMap[section.type] || section.type;
                            opt.textContent = `${section.title || '未命名板塊'} [${typeName}]`;
                            select.appendChild(opt);
                    }
                });
            }

            function searchDynamicItems(items, allSearchTerms, templateId) {
                let results = [];
                if (!items) return results;
                
                // 搜尋詞陣列 (全部轉小寫並過濾空字串)
                const terms = allSearchTerms.map(t => t.toLowerCase()).filter(t => t !== '');
                if (terms.length === 0) return []; // 如果沒有任何搜尋詞 (標籤或輸入框)，則不搜尋

                items.forEach(item => {
                    const itemValue = String(item.value || '').toLowerCase();
                    const itemLabel = String(item.label || '').toLowerCase();
                    
                    let templateMatch = false;
                    // (模板類型比對邏輯... 保持不變)
                    if (templateId === 'all') {
                        const templateTypes = ['person', 'event', 'place', 'object', '人', '事', '地', '物'];
                        if (templateTypes.includes(item.category)) {
                            templateMatch = true;
                        }
                    } else {
                        if (item.templateId == templateId) {
                            templateMatch = true;
                        }
                    }

                    // (修改) 檢查是否符合 "所有" 搜尋詞 (AND 邏輯)
                    let textMatch = terms.every(term => 
                        itemValue.includes(term) || itemLabel.includes(term)
                    );

                    if (textMatch && templateMatch) {
                        results.push({
                            label: item.label,
                            value: item.value,
                            getMatchHTML: () => {
                                // 此函數用於產生高亮標記
                                let highlightedValue = item.value ? String(item.value) : (item.label ? String(item.label) : '');
                                
                                terms.forEach(term => {
                                    if (highlightedValue.toLowerCase().includes(term)) {
                                        const regex = new RegExp(`(${term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                                        highlightedValue = highlightedValue.replace(regex, '<mark>$1</mark>');
                                    }
                                });
                                return highlightedValue;
                            }
                        });
                    }
                    
                    // 遞迴搜尋子項目
                    results = results.concat(searchDynamicItems(item.children, allSearchTerms, templateId));
                });
                return results;
            }

            function renderCategorySearchResults() {
                const select = document.getElementById('category-template-select');
                const input = document.getElementById('category-search-input');
                const resultsList = document.getElementById('category-search-results');
                
                const templateId = select.value; 
                
                // (修改) 整合 搜尋框關鍵字 和 已選標籤
                const searchTerm = input.value.trim();
                const activeTags = Array.from(
                    document.querySelectorAll('#category-filter-tags-container .category-filter-tag.active')
                ).map(tag => tag.textContent);

                // 組合所有篩選條件
                const allSearchTerms = [searchTerm].concat(activeTags).filter(t => t.trim() !== '');

                // (修改) 檢查是否有 "任何" 篩選條件
                if (allSearchTerms.length === 0) {
                    resultsList.innerHTML = '<li style="color: var(--sub-text-color); cursor: default;">請輸入關鍵字或點選標籤。</li>';
                    return;
                }
                
                resultsList.innerHTML = '';
                let foundResults = [];

                projectData.forEach(project => {
                    (project.flows || []).forEach(flow => {
                        
                        // (修改) 搜尋 mainItems 和 dynamicItems
                        const mainMatches = searchDynamicItems(flow.mainItems, allSearchTerms, templateId);
                        const dynamicMatches = searchDynamicItems(flow.dynamicItems, allSearchTerms, templateId);
                        const matches = mainMatches.concat(dynamicMatches);
                        
                        if (matches.length > 0) {
                            foundResults.push({
                                project: project,
                                flow: flow,
                                matches: matches // 傳遞所有符合的項目
                            });
                        }
                    });
                });

                if (foundResults.length === 0) {
                    resultsList.innerHTML = '<li style="color: var(--sub-text-color); cursor: default;">找不到符合條件的項目。</li>';
                    return;
                }

                foundResults.forEach(result => {
                    const li = document.createElement('li');
                    li.className = 'category-search-item';
                    li.dataset.projectId = result.project.id;
                    
                    // (修改) 使用 getMatchHTML() 產生高亮
                    const firstMatch = result.matches[0];
                    const matchHTML = firstMatch.getMatchHTML ? firstMatch.getMatchHTML() : (firstMatch.value || firstMatch.label);
                    
                    li.innerHTML = `
                        <span class="flow-name">${result.flow.name}</span>
                        <span class="project-context">專案：${result.project.name}</span>
                        <span class="item-match">符合項目：${matchHTML}</span>
                    `;
                    
                    li.addEventListener('click', () => {
                        editProject(result.project.id);
                    });
                    resultsList.appendChild(li);
                });
            }
			
			function renderActiveTimersWidget() {
                const timersList = document.getElementById('active-timers-list');
                if (!timersList) return;
                
                timersList.innerHTML = '';
                let allTimers = [];
                const now = new Date();

                // 輔助函數，遞迴尋找所有計時器
                function findTimers(items, project, flow) {
                    if (!items) return;
                    items.forEach(item => {
                        if (item.timerDeadline) {
                            const deadline = new Date(item.timerDeadline);
                            // 只顯示尚未到期的計時器
                            if (deadline > now) {
                                allTimers.push({
                                    projectId: project.id,
                                    projectName: project.name,
                                    flowName: flow.name,
                                    itemName: item.label || item.category,
                                    deadline: deadline,
                                    deadlineISO: item.timerDeadline
                                });
                            }
                        }
                        if (item.children) {
                            findTimers(item.children, project, flow);
                        }
                    });
                }

                // 遍歷所有專案、流程、項目
                projectData.forEach(project => {
                    if (!project.flows) return;
                    project.flows.forEach(flow => {
                        // 掃描 mainItems 和 dynamicItems
                        findTimers(flow.mainItems, project, flow);
                        findTimers(flow.dynamicItems, project, flow);
                    });
                });

                // 依照到期日排序 (最快到期的在最前面)
                allTimers.sort((a, b) => a.deadline - b.deadline);

                if (allTimers.length === 0) {
                    timersList.innerHTML = '<li style="cursor: default; color: var(--sub-text-color);">沒有活躍中的計時器</li>';
                    return;
                }

                // 渲染列表
                allTimers.forEach(timer => {
                    const li = document.createElement('li');
                    li.className = 'timer-list-item'; // 重複使用 CSS 樣式
                    li.dataset.projectId = timer.projectId;
                    li.innerHTML = `
                        <span class="flow-name">${timer.itemName}</span>
                        <span class="project-context">專案：${timer.projectName} / ${timer.flowName}</span>
                        <div class="timer-countdown" data-deadline="${timer.deadlineISO}"></div>
                    `;
                    
                    li.addEventListener('click', () => {
                        editProject(timer.projectId);
                    });
                    timersList.appendChild(li);
                });
                
                // 立即更新一次新加入的計時器
                updateAllTimers();
            }
			
			function renderFilterTags() {
                const itemSets = {
                    '人': new Set(),
                    '事': new Set(),
                    '地': new Set(),
                    '物': new Set()
                };
                // 處理新舊兩種 category 儲存方式 ('人' 或 'person')
                const reverseCategoryMap = { 'person': '人', 'event': '事', 'place': '地', 'object': '物' };
                
                const containers = {
                    '人': document.getElementById('filter-list-person'),
                    '事': document.getElementById('filter-list-event'),
                    '地': document.getElementById('filter-list-place'),
                    '物': document.getElementById('filter-list-object')
                };

                // 1. 清除舊標籤
                Object.values(containers).forEach(c => { if(c) c.innerHTML = ''; });

                // 2. 蒐集所有不重複的項目值
                projectData.forEach(project => {
                    (project.flows || []).forEach(flow => {
                        // 遞迴抓取 mainItems 和 dynamicItems 及其所有子項目
                        const allItems = getAllItemsRecursive(flow.mainItems).concat(getAllItemsRecursive(flow.dynamicItems));
                        
                        allItems.forEach(item => {
                            const categoryKey = item.category; // e.g., '人'
                            const legacyCategoryKey = reverseCategoryMap[item.category]; // e.g., 'person' -> '人'
                            
                            const targetSet = itemSets[categoryKey] || itemSets[legacyCategoryKey];
                            
                            if (targetSet && item.value && item.value.trim() !== '') {
                                targetSet.add(item.value.trim());
                            }
                        });
                    });
                });
                
                // 3. 渲染標籤
                Object.keys(containers).forEach(category => {
                    const container = containers[category];
                    if (!container) return;
                    
                    const sortedItems = Array.from(itemSets[category]).sort();
                    
                    sortedItems.forEach(value => {
                        const tag = document.createElement('span');
                        tag.className = 'category-filter-tag';
                        tag.textContent = value;
                        tag.dataset.category = category;
                        container.appendChild(tag);
                    });
                });
            }

            function editProject(projectId) {
                const projectToEdit = projectData.find(p => p.id === projectId);
                if (projectToEdit) {
                    activeProjectIndex = projectData.indexOf(projectToEdit);
                    activeTemplateIndex = null; 
                    currentEditorMode = 'project'; 

                    projectEditorTitle.textContent = projectToEdit.name;
                    projectEditorDescription.textContent = projectToEdit.description;
                    
                    backToProjectsBtn.innerHTML = '&lt; 返回所有專案'; 

                    renderFlows(); 
					renderFlowMinimap();
                    switchPage('project-editor-page');
                }
            }

            function renderTodayTasks() {
                todayTaskList.innerHTML = '';
                
                const tasks = [
                    { name: '設計網頁原型', project: '網站改版' },
                    { name: '撰寫文案', project: '產品行銷' },
                ];
                
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <label contenteditable="true">${task.name}</label>
                        <span style="color:var(--sub-text-color); font-size: 0.9em;">（專案：${task.project}）</span>
                        <div class="task-actions">
                            <button class="edit-task-btn">編輯</button>
                            <button class="delete-task-btn">刪除</button>
                        </div>
                    `;
                    todayTaskList.appendChild(li);
                });

                const addLi = document.createElement('li');
                addLi.innerHTML = `<button class="add-task-btn">新增</button>`;
                todayTaskList.appendChild(addLi);
                
                todayTaskList.querySelectorAll('.edit-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const label = e.target.closest('li').querySelector('label');
                        label.focus();
                        alert('編輯功能已啟用，可直接修改文字。');
                    });
                });
                todayTaskList.querySelectorAll('.delete-task-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.closest('li').remove();
                        alert('項目已刪除。');
                    });
                });
                todayTaskList.querySelector('.add-task-btn').addEventListener('click', () => {
                    const newTaskName = prompt('請輸入新的待辦事項名稱：');
                    if (newTaskName) {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <label contenteditable="true">${newTaskName}</label>
                            <div class="task-actions">
                                <button class="edit-task-btn">編輯</button>
                                <button class="delete-task-btn">刪除</button>
                            </div>
                        `;
                        todayTaskList.insertBefore(li, todayTaskList.lastElementChild);
                    }
                });
            }
            
            function resetAndHideFlowForm() {
				newFlowNameInput.value = '';
				mainItemsContainer.innerHTML = '';
				subItemsContainer.innerHTML = '';

				addFlowModal.classList.remove('show');

				editingFlowId = null;
				addFlowBtn.classList.remove('btn-cancel-flow');
				addFlowBtn.classList.add('btn-add'); 
				addFlowBtn.textContent = '新增流程';
				submitFlowBtn.textContent = '確認';
			}

            addFlowBtn.addEventListener('click', () => {
				editingFlowId = null;

				newFlowNameInput.value = '';
				mainItemsContainer.innerHTML = '';
				subItemsContainer.innerHTML = '';

				flowModalTitle.textContent = '新增流程';
				submitFlowBtn.textContent = '確認';

				addFlowModal.classList.add('show');
				newFlowNameInput.focus();
			});
			
			cancelFlowBtn.addEventListener('click', () => {
				resetAndHideFlowForm();
				renderFlows();
				renderFlowMinimap();
			});
			
			flowList.addEventListener('click', (e) => {
				const target = e.target;
				const flowItem = target.closest('.flow-item');
				if (!flowItem) return;

				const flowId = parseInt(flowItem.dataset.id, 10);
				if (isNaN(flowId)) return;

				const collection = getCurrentActiveCollection();
				if (!collection) return;

				if (target.closest('.btn-edit-flow')) {
					openFlowEditor(flowId);
					return;
				}
				if (target.closest('.btn-delete-flow')) {
                    showConfirmModal('您確定要刪除此流程項目嗎？此動作無法復原。', '確認刪除流程', () => {
                        collection.flows = collection.flows.filter(f => f.id !== flowId);
						if (currentEditorMode === 'project') updateProjectTimestamp(activeProjectIndex);
						else updateTemplateTimestamp(activeTemplateIndex);
						renderFlows();
						renderFlowMinimap();
                    });
					return;
				}
				if (target.closest('.btn-complete-flow')) {
					if (target.disabled) return;
					updateFlowTimestamp(flowId);
					const flow = collection.flows.find(f => f.id === flowId);
					if (flow) {
						flow.completed = true;
						flow.completedAt = new Date().toISOString();
						if (currentEditorMode === 'project') updateProjectTimestamp(activeProjectIndex);
						else updateTemplateTimestamp(activeTemplateIndex);
						renderFlows();
						renderFlowMinimap();
					}
					return;
				}
				if (target.closest('.btn-undo-complete')) {
					updateFlowTimestamp(flowId);
					const flow = collection.flows.find(f => f.id === flowId);
					if (flow) {
						flow.completed = false;
						flow.completedAt = null;
						if (currentEditorMode === 'project') updateProjectTimestamp(activeProjectIndex);
						else updateTemplateTimestamp(activeTemplateIndex);
						openFlowEditor(flowId);
						renderFlowMinimap();
					}
					return;
				}
				if (target.tagName === 'IMG' && target.closest('.dynamic-item-value')) {
					showImageModal(target.src);
					return;
				}
			});

            flowList.addEventListener('change', (e) => {
                const target = e.target;
                
                const collection = getCurrentActiveCollection();
                if (!collection) return;

                if (target.classList.contains('dynamic-item-display-checkbox')) {
                    const flowId = parseInt(target.dataset.flowId, 10);
                    const itemId = target.dataset.itemId;
                    const isChecked = target.checked;
                    
                    if (!flowId || !itemId) return;

                    const flow = collection.flows.find(f => f.id == flowId);
                    if (flow) {
                        const item = findDynamicItem(flow.dynamicItems, itemId);
                        if (item) {
                            item.isChecked = isChecked;
                        }
                    }
                    
                    updateFlowTimestamp(flowId);
                    if (currentEditorMode === 'project') {
                        updateProjectTimestamp(activeProjectIndex);
                    } else {
                        updateTemplateTimestamp(activeTemplateIndex);
                    }

                    const flowItem = flowList.querySelector(`.flow-item[data-id="${flowId}"]`);
                    if (flowItem) {
                        const updatedEl = flowItem.querySelector('.flow-timestamp-updated');
                        if (updatedEl) {
                            updatedEl.textContent = `(${new Date().toLocaleTimeString()}) ${new Date().toLocaleDateString()}`;
                        }
                    }
                    
                    const card = target.closest('.dynamic-item-card');
                    if (e.target.classList.contains('dynamic-item-top-level-checkbox')) {
                        // 點擊「父」Checkbox -> 同步所有「子」Checkbox
                        const isTopChecked = e.target.checked;
                        if (card) {
                            card.querySelectorAll('.dynamic-item-display-checkbox').forEach(innerChk => {
                                if (innerChk !== e.target) { 
                                    innerChk.checked = isTopChecked;
                                    const innerItemId = innerChk.dataset.itemId;
                                    if (flow && innerItemId) {
                                        const innerItem = findDynamicItem(flow.dynamicItems, innerItemId);
                                        if (innerItem) innerItem.isChecked = isTopChecked;
                                    }
                                }
                            });
                        }
                    } else { 
                        // [功能修改] 點擊「子」Checkbox -> 檢查是否該同步「父」Checkbox
                        const topChk = card.querySelector('.dynamic-item-top-level-checkbox');
                        if (topChk) {
                            // 找到所有子 Checkbox (不包含父 Checkbox)
                            const allChildCheckboxes = Array.from(card.querySelectorAll('.dynamic-item-display-checkbox:not(.dynamic-item-top-level-checkbox)'));
                            
                            // 檢查是否「所有」子 Checkbox 都被勾選了
                            const allChildrenChecked = allChildCheckboxes.length > 0 && allChildCheckboxes.every(chk => chk.checked);

                            // 根據結果更新父 Checkbox
                            topChk.checked = allChildrenChecked;
                            
                            // 更新父 Checkbox 在資料模型中的狀態
                            const topItemId = topChk.dataset.itemId;
                            if (flow && topItemId) {
                                const topItem = findDynamicItem(flow.dynamicItems, topItemId);
                                if (topItem) topItem.isChecked = allChildrenChecked;
                            }

                            // (保留原有邏輯) 如果使用者是「勾選」某個子項目，自動確保父項目的編輯狀態是 OOO
                            if (isChecked) { 
                                const topCardId = topChk.dataset.cardId;
                                const editorBlock = document.querySelector(`#dynamic-items-container > .dynamic-item-block[data-item-id="${topCardId}"]`);
                                if (editorBlock && editorBlock.dataset.toggleState !== '1') {
                                    const btn = editorBlock.querySelector('.btn-toggle-checkbox');
                                    btn.textContent = 'CheckBox OOO';
                                    btn.classList.add('active');
                                    editorBlock.dataset.toggleState = '1';
                                    editorBlock.dataset.hasCheckbox = 'true';
                                    const topItem = findDynamicItem(flow.dynamicItems, topCardId);
                                    if (topItem) {
                                        topItem.toggleState = '1';
                                        topItem.hasCheckbox = true;
                                    }
                                }
                            }
                        }
                    }
                    checkAllCheckboxes(card);
                }
            });
            
            submitFlowBtn.addEventListener('click', async () => {
                const flowName = newFlowNameInput.value.trim();
                if (!flowName) {
                    alert('流程名稱不能為空。');
                    return;
                }
                
                const now = new Date().toISOString();
                const mainItemsData = parseDynamicItems(mainItemsContainer);
				const dynamicItemsData = parseDynamicItems(subItemsContainer);
                let imageBase64Strings = []; // 保留此行以防萬一，但將刪除後續邏輯

                const collection = getCurrentActiveCollection();
                if (!collection) {
                    alert('錯誤：找不到專案或模板。');
                    return;
                }

                if (editingFlowId !== null) {
                    const flowToUpdate = collection.flows.find(f => f.id === editingFlowId);
                    if (flowToUpdate) {
                        flowToUpdate.name = flowName;
                        flowToUpdate.mainItems = mainItemsData;
						flowToUpdate.dynamicItems = dynamicItemsData;
                        flowToUpdate.updatedAt = now;
                        
                    }
                    if (currentEditorMode === 'project') {
                        updateProjectTimestamp(activeProjectIndex);
                    } else {
                        updateTemplateTimestamp(activeTemplateIndex);
                    }
                } else {
                    const newFlow = {
                        id: Date.now(),
                        name: flowName,
                        completed: false,
                        completedAt: null,
                        mainItems: mainItemsData,
						dynamicItems: dynamicItemsData,
                        createdAt: now,
                        updatedAt: now
                    };
                    collection.flows.push(newFlow);
					if (currentEditorMode === 'project') {
                        updateProjectTimestamp(activeProjectIndex);
                    } else {
                        updateTemplateTimestamp(activeTemplateIndex);
                    }
                }
                resetAndHideFlowForm();
                renderFlows();
				renderFlowMinimap();
            });

            function updateFlowTimestamp(flowId) {
                const collection = getCurrentActiveCollection();
                if (!collection) return null;
                
                if (!collection.flows) {
                    collection.flows = [];
                }
                const flow = collection.flows.find(f => f.id === flowId);
                if (flow) {
                    flow.updatedAt = new Date().toISOString();
                }
                return flow; 
            }
			
			function getCurrentActiveCollection() {
                if (currentEditorMode === 'template' && activeTemplateIndex !== null && projectTemplateData[activeTemplateIndex]) {
                    return projectTemplateData[activeTemplateIndex];
                } else if (currentEditorMode === 'project' && activeProjectIndex !== null && projectData[activeProjectIndex]) {
                    return projectData[activeProjectIndex];
                }
                return null;
            }

            function updateTemplateTimestamp(templateIndex) {
                if (templateIndex === null || !projectTemplateData[templateIndex]) return;
                projectTemplateData[templateIndex].updatedAt = new Date().toISOString();
            }

            function editProjectTemplate(templateId) {
                const templateToEdit = projectTemplateData.find(p => p.id === templateId);
                if (templateToEdit) {
                    activeTemplateIndex = projectTemplateData.indexOf(templateToEdit);
                    activeProjectIndex = null; 
                    currentEditorMode = 'template'; 

                    projectEditorTitle.textContent = templateToEdit.name;
                    projectEditorDescription.textContent = templateToEdit.description;
                    
                    backToProjectsBtn.innerHTML = '&lt; 返回模板按鈕'; 

                    renderFlows(); 
					renderFlowMinimap();
                    switchPage('project-editor-page');
                }
            }
            
            function addNewProjectTemplate() {
                const now = new Date().toISOString();
                const newTemplate = {
                    id: Date.now(),
                    name: '新專案模板 (請編輯)',
                    description: '請在此輸入模板描述',
                    flows: [],
                    createdAt: now,
                    updatedAt: now 
                };
                projectTemplateData.push(newTemplate);
                editProjectTemplate(newTemplate.id);
            }
			
			function getTimerHTML(deadlineISO) {
                if (!deadlineISO) return '';
                
                const deadline = new Date(deadlineISO);
                const now = new Date();
                
                if (deadline - now <= 0) {
                    return `<div class="timer-countdown ended" data-deadline="${deadlineISO}">` +
                           `倒數已截止<br><small style="font-weight: normal; color: var(--sub-text-color);">(${deadline.toLocaleString()})</small>` +
                           `</div>`;
                } else {
                    return `<div class="timer-countdown" data-deadline="${deadlineISO}"></div>`;
                }
            }
			
			function getDynamicItemValueHTML(item) {
                const displayValue = item.value ? item.value : '<span class="dynamic-item-empty">(未填寫)</span>';
                
                if (item.category === '時') {
                    return `<span class="dynamic-item-value">${formatISOToDisplayLocale(item.value) || '<span class="dynamic-item-empty">(未設定)</span>'}</span>`;
                } else if (item.category === '圖') {
					if (item.value) {
						return `<span class="dynamic-item-value">
									<img src="${item.value}" alt="uploaded image" style="width: 125px; height: auto; border-radius: 4px; border: 1px solid var(--border-color); margin-top: 4px; cursor: pointer;">
								 </span>`;
					} else {
                        return `<span class="dynamic-item-value"><span class="dynamic-item-empty">(未上傳)</span></span>`;
                    }
                } else if (item.category === '計時器') {
                    return '';
                } else {
                    return `<span class="dynamic-item-value">${displayValue}</span>`;
                }
            }

            function renderDynamicItemsHTML(items, flowId, isFlowCompleted) { 
                if (!items || items.length === 0) {
                    return '';
                }
                
                let html = '<ul class="dynamic-item-display-list">';
                
                items.forEach(item => {
                    html += `<li class="dynamic-item-display-item">`;
                    
                    if (item.category !== '計時器') {
						const labelToShow = item.label || item.category;
						html += `<div class="dynamic-item-display-row">`;
						
						if (item.hasCheckbox) {
							let checkedAttr = item.isChecked ? 'checked' : '';
							let disabledAttr = isFlowCompleted ? 'disabled' : '';
							html += `<input type="checkbox" class="dynamic-item-display-checkbox" data-item-id="${item.id}" data-flow-id="${flowId}" ${checkedAttr} ${disabledAttr} style="margin-right: 4px; accent-color: var(--primary-color);">`;
						}

						if (!item.hideLabel) {
							html += `<span class="dynamic-item-category">${labelToShow}:</span>`;
						}
                        
						html += getDynamicItemValueHTML(item);
						html += `</div>`;
                    }
                    
                    html += getTimerHTML(item.timerDeadline);
                    html += renderDynamicItemsHTML(item.children, flowId, isFlowCompleted);
                    html += `</li>`;
                });
                html += '</ul>';
                return html;
            }
			
			function openFlowEditor(flowId) {
                const collection = getCurrentActiveCollection();
                if (!collection) return;

				const flowData = collection.flows.find(f => f.id === flowId);
				if (!flowData) return;

				editingFlowId = flowId;

				newFlowNameInput.value = flowData.name;

				mainItemsContainer.innerHTML = '';
				subItemsContainer.innerHTML = ''; 
				rebuildDynamicInputBlocks(flowData.mainItems, mainItemsContainer, true);
				rebuildDynamicInputBlocks(flowData.dynamicItems, subItemsContainer, false);

				flowModalTitle.textContent = '編輯流程';
				submitFlowBtn.textContent = '更新';
				addFlowModal.classList.add('show'); 

				renderFlows();
				renderFlowMinimap();
			}

            function renderFlows() {
                const collection = getCurrentActiveCollection();
                if (!collection) {
                    flowList.innerHTML = '';
                    return;
                }

                flowList.innerHTML = '';
                const currentFlows = collection.flows || [];
                
                currentFlows.forEach((flow, index) => {
                    const flowItem = document.createElement('div');
                    flowItem.className = `flow-item ${flow.completed ? 'completed' : ''}`;
                    flowItem.dataset.id = flow.id;
                    
                    if (index === currentFlows.length - 1) {
                         flowItem.classList.add('last-flow-item');
                    }
                    
					let mainItemsHTML = '';
					if (flow.mainItems && flow.mainItems.length > 0) {
						mainItemsHTML = flow.mainItems.map(item => {
							const label = item.label || item.category;
							const valueHTML = getDynamicItemValueHTML(item);

							let checkboxHTML = '';
							if (item.hasCheckbox) {
								let checkedAttr = item.isChecked ? 'checked' : '';
								let disabledAttr = flow.completed ? 'disabled' : '';
								checkboxHTML = `<input type="checkbox" class="dynamic-item-display-checkbox" data-item-id="${item.id}" data-flow-id="${flow.id}" ${checkedAttr} ${disabledAttr} style="margin-right: 4px; accent-color: var(--primary-color);">`;
							}

							let labelHTML = '';
							if (!item.hideLabel) {
								labelHTML = `<label>${label}：</label>`;
							}

							if (item.category === '計時器') {
								return `<div style="grid-column: 1 / -1; margin-top: 8px;">${getTimerHTML(item.timerDeadline)}</div>`;
							}

							let timerHTML = getTimerHTML(item.timerDeadline);
							if (timerHTML) {
								// Display timer on its own row, indented
								timerHTML = `<div style="grid-column: 1 / -1; padding-left: 50px; margin-top: -4px;">${timerHTML}</div>`;
							}

							if (item.category === '圖') {
								return `
									${labelHTML}
									<span class="flow-value" style="display: inline-block;">${checkboxHTML}${valueHTML}</span>
									${timerHTML || ''}
								`;
							}

							return `
								${labelHTML}
								<span class="flow-value">${checkboxHTML}${valueHTML}</span>
								${timerHTML || ''}
							`;
						}).join('');
					}
                    
                    let dynamicRowsHTML = '';
                    if (flow.dynamicItems && flow.dynamicItems.length > 0) {
                        
                        let cardsHTML = '';
                        
                        flow.dynamicItems.forEach(topLevelItem => {
                        
							const childrenHTML = renderDynamicItemsHTML(topLevelItem.children, flow.id, flow.completed);
							cardsHTML += `<div class="dynamic-item-card" data-card-id="${topLevelItem.id}">`;
							
							let headerHTML = '';

							let checkboxHTML = '';
							if (topLevelItem.hasCheckbox) {
								let checkedAttr = topLevelItem.isChecked ? 'checked' : '';
								let disabledAttr = flow.completed ? 'disabled' : ''; 
								checkboxHTML = `<input type="checkbox" class="dynamic-item-display-checkbox dynamic-item-top-level-checkbox" data-item-id="${topLevelItem.id}" data-flow-id="${flow.id}" data-card-id="${topLevelItem.id}" ${checkedAttr} ${disabledAttr} style="margin-right: 4px; accent-color: var(--primary-color);">`;
							}

                            const valueHTML = getDynamicItemValueHTML(topLevelItem);

							if (topLevelItem.category === '時') {
								headerHTML = `
									<span class="dynamic-item-category">${topLevelItem.category}:</span>
									${checkboxHTML} ${valueHTML}`;
							} else if (topLevelItem.category === '計時器') {
								headerHTML = ``; 
							} else {
								headerHTML = `${checkboxHTML} ${valueHTML}`;
							}
							
							if (headerHTML !== '') {
								cardsHTML += `<div class="dynamic-item-display-row dynamic-card-header-row">${headerHTML}</div>`;
							}
							
                            cardsHTML += getTimerHTML(topLevelItem.timerDeadline);
                            cardsHTML += `${childrenHTML}</div>`; 
							
                            setTimeout(() => {
                                const card = flowList.querySelector(`.dynamic-item-card[data-card-id="${topLevelItem.id}"]`);
                                checkAllCheckboxes(card);
                            }, 0);
                        });

                        dynamicRowsHTML = `
                            <div class="dynamic-item-grid-container">
                                ${cardsHTML}
                            </div>
                        `;
                    }
                    
                    flow.createdAt = flow.createdAt || new Date().toISOString();
                    flow.updatedAt = flow.updatedAt || new Date().toISOString();

					flowItem.innerHTML = `
                        <span class="flow-status-dot" draggable="true"></span>
                        <div class="flow-item-details">
                            <h4>${flow.name}</h4>
                            
							${mainItemsHTML}
							${dynamicRowsHTML}

                        </div>
                        <div class="flow-item-actions">
                            ${!flow.completed 
                                ? `<button class="btn btn-flow-action btn-edit-flow" data-id="${flow.id}" title="編輯">
                                        <span class="btn-symbol">■</span>
                                        <span class="btn-text">編輯</span>
                                   </button>` 
                                : ''}

                            ${!flow.completed 
                                ? `<button class="btn btn-flow-action btn-complete-flow" data-id="${flow.id}" ${ (editingFlowId === flow.id) ? 'disabled title="編輯中"' : 'title="完成"' }>
                                        <span class="btn-symbol">●</span>
                                        <span class="btn-text">完成</span>
                                   </button>` 
                                : `<button class="btn btn-flow-action btn-undo-complete" data-id="${flow.id}" title="編輯">
                                        <span class="btn-symbol">■</span>
                                        <span class="btn-text">編輯</span>
                                   </button>`
                            }
                            <button class="btn btn-flow-action btn-cancel-flow btn-delete-flow" data-id="${flow.id}" title="刪除">
                                <span class="btn-symbol">×</span>
                                <span class="btn-text">刪除</span>
                            </button>
                        </div>
						<div class="flow-timestamps">
                            <span class="flow-timestamp-created">建置於：${new Date(flow.createdAt).toLocaleString()}</span>
                            
                            ${flow.completed 
                                ? `<span class="completed-at-text">完成於：${new Date(flow.completedAt).toLocaleString()}</span>` 
                                : `<span class="flow-timestamp-updated">更動於：${new Date(flow.updatedAt).toLocaleString()}</span>`
                            }
                        </div>
                    `;
                    flowList.appendChild(flowItem);
					
					flowItem.addEventListener('mouseover', () => {
						const minimapItem = flowMinimapContent.querySelector(`.flow-minimap-item[data-flow-id="${flow.id}"]`);
						if (minimapItem) {
							minimapItem.classList.add('minimap-highlight');
						}
					});
					flowItem.addEventListener('mouseout', () => {
						const minimapItem = flowMinimapContent.querySelector(`.flow-minimap-item[data-flow-id="${flow.id}"]`);
						if (minimapItem) {
							minimapItem.classList.remove('minimap-highlight');
						}
					});
                });
            }
			
			function createTemplateTypeSelect(section) {
                const types = [
                    { value: 'none', text: '不選擇' },
                    { value: 'person', text: '人' },
                    { value: 'event', text: '事' },
                    { value: 'time', text: '時' },
                    { value: 'place', text: '地' },
                    { value: 'object', text: '物' }
                ];
                
                const currentType = section.type || 'none';

                let optionsHTML = types.map(type => 
                    `<option value="${type.value}" ${currentType === type.value ? 'selected' : ''}>${type.text}</option>`
                ).join('');

                const selectId = `template-type-select-${section.id}`;

                return `
                    <div class="form-group" style="margin-top: 16px; margin-bottom: 16px;">
                        <label for="${selectId}" style="font-weight: 600; color: var(--secondary-color); margin-right: 8px;">模板類型：</label>
                        
                        <select id="${selectId}" class="template-type-select" data-action="update-template-type">
                            ${optionsHTML}
                        </select>
                    </div>
                `;
            }
			
			function formatISOToLocalInput(isoString) {
                if (!isoString) return '';
                try {
                    const date = new Date(isoString);
                    if (isNaN(date.getTime())) return ''; 
                    
                    const y = date.getFullYear();
                    const m = (date.getMonth() + 1).toString().padStart(2, '0');
                    const d = date.getDate().toString().padStart(2, '0');
                    const h = date.getHours().toString().padStart(2, '0');
                    const min = date.getMinutes().toString().padStart(2, '0');
                    
                    return `${y}-${m}-${d}T${h}:${min}`;
                } catch (e) {
                    return ''; 
                }
            }
			
			function formatISOToDisplayLocale(isoString) {
                if (!isoString) return '';
                try {
                    const date = new Date(isoString);
                    if (isNaN(date.getTime())) return '';
                    
                    return date.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: 'numeric',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                } catch (e) {
                    return ''; 
                }
            }
			
            function findDynamicItem(items, id) {
                if (!items) return null;
                for (const item of items) {
                    if (item.id == id) return item;
                    const found = findDynamicItem(item.children, id);
                    if (found) return found;
                }
                return null;
            }
			
			function getAllItemsRecursive(items) {
                let allItems = [];
                if (!items) return allItems;
                
                items.forEach(item => {
                    allItems.push(item);
                    if (item.children && item.children.length > 0) {
                        allItems = allItems.concat(getAllItemsRecursive(item.children));
                    }
                });
                return allItems;
            }
			
            function checkAllCheckboxes(cardElement) {
                if (!cardElement) return;
                const checkboxes = cardElement.querySelectorAll('.dynamic-item-display-checkbox');
                if (checkboxes.length === 0) {
                    cardElement.classList.remove('all-checked');
                    return;
                }
                
                const allChecked = Array.from(checkboxes).every(chk => chk.checked);
                
                if (allChecked) {
                    cardElement.classList.add('all-checked');
                } else {
                    cardElement.classList.remove('all-checked');
                }
            }
			
            function renderTemplateLinks(type) {
                if (!type || !templateData) return '';

                const matchingTemplates = templateData.filter(section => section.type === type);
                
                if (matchingTemplates.length === 0) {
                    return `<h5>模板 (無)</h5>`;
                }

                let linksHTML = matchingTemplates.map(section => {
                    if (!section.title || section.title.trim() === '') return ''; 
                    return `<div class="template-link-item" data-template-id="${section.id}">${section.title}</div>`;
                }).join('');

                return `<h5>套用模板</h5>${linksHTML}`;
            }

            function replaceInputWithSelect(inputEl, template) {
                if (!inputEl || !template || !template.items) return;

                const parent = inputEl.parentNode;
                const category = inputEl.dataset.category;
                
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const select = document.createElement('select');
                select.dataset.category = category; 
                select.dataset.templateId = template.id; 

                let optionsHTML = '<option value="">請選擇...</option>';
                
                optionsHTML += template.items.map(item => {
                    if (!item.text || item.text.trim() === '') return '';
                    return `<option value="${item.text}">${item.text}</option>`;
                }).join('');
                
                select.innerHTML = optionsHTML;
                
                formGroup.appendChild(select);
                
                if (parent.classList.contains('dynamic-item-content')) {
                    parent.replaceChild(formGroup, inputEl);
                    formGroup.style.flex = '1';
                } else {
                     parent.replaceChild(formGroup, inputEl);
                }
            }
			
            function replaceSelectWithInput(selectEl, blockEl) {
                const formGroup = selectEl.closest('.form-group');
                if (!formGroup) return; 

                const contentDiv = blockEl.querySelector('.dynamic-item-content');
                const category = selectEl.dataset.category;

                let inputHTML = getDynamicInputHTML(category);

                formGroup.remove();

                const tempWrapper = document.createElement('div');
                tempWrapper.innerHTML = inputHTML.trim();
                
                while (tempWrapper.firstChild) {
                    contentDiv.appendChild(tempWrapper.firstChild);
                }
            }
            
            function updateAllTimers() {
                document.querySelectorAll('.timer-countdown').forEach(timerEl => {
                    const deadline = new Date(timerEl.dataset.deadline);
                    const now = new Date();
                    const diff = deadline - now;
                    
                    if (diff <= 0) {
                        if (timerEl.classList.contains('ended')) {
                            return;
                        }
                        
                        timerEl.innerHTML = `倒數已截止<br><small style="font-weight: normal; color: var(--sub-text-color);">(${deadline.toLocaleString()})</small>`;
                        timerEl.classList.add('ended');
                        return;
                    }

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    timerEl.textContent = `剩餘: ${days}天 ${hours}時 ${minutes}分 ${seconds}秒`;
                    timerEl.classList.remove('ended');
                });
            }
			
			function renderFlowMinimap() {
                const collection = getCurrentActiveCollection();
				if (!collection) {
					if (flowMinimapContent) flowMinimapContent.innerHTML = '';
					return;
				}

				const currentFlows = collection.flows || [];
				if (currentFlows.length === 0) {
					flowMinimapContent.innerHTML = '<p style="font-size: 0.8em; color: var(--sub-text-color);">無流程</p>';
					return;
				}

				let minimapHTML = '';
				currentFlows.forEach(flow => {
					const isCompleted = flow.completed;
					minimapHTML += `
						<div class="flow-minimap-item ${isCompleted ? 'completed' : ''}" data-flow-id="${flow.id}"> <span class="flow-minimap-dot"></span>
							<span class="flow-minimap-name">${flow.name}</span>
						</div>
					`;
				});
				flowMinimapContent.innerHTML = minimapHTML;
			}

			function handleFileImport(file) {
				const acceptedTypes = ["application/json", "application/octet-stream", "text/plain", ""];
				const extMatch = file && file.name && file.name.toLowerCase().endsWith('.json');

				if (!(acceptedTypes.includes(file.type) || extMatch)) {
					console.warn('handleFileImport: 檔案 MIME/type:', file.type, '，副檔名檢查:', extMatch);
					alert('請選擇 JSON 檔案（副檔名 .json）。如果仍失敗請開啟開發者工具查看 console。');
					return;
				}

				const reader = new FileReader();
				reader.onload = (e) => {
					try {
						let text = e.target.result;
						if (typeof text !== 'string') {
							text = String(text);
						}
						text = text.trim();
						if (text.charCodeAt(0) === 0xFEFF) {
							text = text.slice(1);
						}

						const jsonData = JSON.parse(text);

						projectData = Array.isArray(jsonData.projects) ? jsonData.projects
									 : Array.isArray(jsonData) ? jsonData
									 : Array.isArray(jsonData.data?.projects) ? jsonData.data.projects
									 : [];

						templateData = jsonData.templateSections || jsonData.templates || jsonData.templateData || [];
						projectTemplateData = jsonData.projectTemplates || jsonData.projectTemplatesData || [];

						if (!Array.isArray(projectData)) {
							console.error('handleFileImport: 解析後 projectData 不是陣列', jsonData);
							alert('JSON 結構不符合預期（找不到 projects 陣列）。請確認檔案內容。');
							return;
						}

						hasJsonData = true;
						currentFileName = file.name;
						updateFilePathDisplay();
						enterMainApp();
						console.log('匯入 JSON 成功:', currentFileName);
					} catch (error) {
						console.error('handleFileImport - JSON 解析失敗：', error);
						alert('JSON 檔案格式錯誤或內容無法解析。請確認檔案為正確的 JSON（若含有 BOM 請移除）。詳細請查看 console。');
					}
				};
				reader.onerror = (err) => {
					console.error('FileReader error:', err);
					alert('讀取檔案時發生錯誤，請重試。');
				};
				reader.readAsText(file, 'utf-8');
			}


            window.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (initialSetupPage.style.display !== 'none') {
                    dropZoneOverlay.style.display = 'flex';
                    requestAnimationFrame(() => dropZoneOverlay.classList.add('active'));
                }
            });
            window.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (initialSetupPage.style.display !== 'none' && (e.clientX === 0 || e.clientY === 0 || e.clientX === window.innerWidth || e.clientY === window.innerHeight)) {
                    dropZoneOverlay.classList.remove('active');
                    setTimeout(() => dropZoneOverlay.style.display = 'none', 300);
                }
            });
            window.addEventListener('dragover', (e) => { e.preventDefault(); });
            window.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZoneOverlay.classList.remove('active');
                setTimeout(() => dropZoneOverlay.style.display = 'none', 300);
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    handleFileImport(file);
                }
            });
            
            let draggedItem = null;
            let dragStartDot = null;

            flowList.addEventListener('dragstart', (e) => {
                dragStartDot = e.target.closest('.flow-status-dot');
                const flowItem = e.target.closest('.flow-item');

                if (!dragStartDot || !flowItem) {
                    e.preventDefault();
                    return;
                }
                
                draggedItem = flowItem;
                setTimeout(() => {
                    if (draggedItem) draggedItem.classList.add('dragging');
                }, 0);
                
                e.dataTransfer.setData('text/plain', flowItem.dataset.id);
                e.dataTransfer.effectAllowed = 'move';
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.flow-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            flowList.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedItem || !dragStartDot) return; 

                e.dataTransfer.dropEffect = 'move';
                
                const afterElement = getDragAfterElement(flowList, e.clientY);
                if (afterElement == null) {
                    flowList.appendChild(draggedItem);
                } else {
                    flowList.insertBefore(draggedItem, afterElement);
                }
            });

            flowList.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                }
                
                if (draggedItem && dragStartDot) {
                    const collection = getCurrentActiveCollection();
                    if (collection) {
                        const newIdOrder = Array.from(flowList.querySelectorAll('.flow-item')).map(item => parseInt(item.dataset.id));
                        const currentFlows = collection.flows;
                        
                        collection.flows = newIdOrder.map(id => currentFlows.find(f => f.id === id));

                        const draggedIdText = e.dataTransfer.getData('text/plain');
                        if (draggedIdText) {
                            updateFlowTimestamp(parseInt(draggedIdText, 10));
                        }
						
                        if (currentEditorMode === 'project') {
                            updateProjectTimestamp(activeProjectIndex);
                        } else {
                            updateTemplateTimestamp(activeTemplateIndex);
                        }
                    }
                    renderFlows();
					renderFlowMinimap();
                }

                draggedItem = null;
                dragStartDot = null;
            });
			
			
			
            function showImageModal(src) {
                if (imagePreviewModal && modalImageContent) {
                    modalImageContent.src = src;
                    imagePreviewModal.style.display = 'flex';
                }
            }

            function closeImageModal() {
                if (imagePreviewModal) {
                    imagePreviewModal.style.display = 'none';
                    modalImageContent.src = '';
                }
            }
            
            imagePreviewModal.addEventListener('click', (e) => {
                if (e.target.id === 'image-preview-modal') {
                    closeImageModal();
                }
            });
			
			function updateFilePathDisplay() {
                filePathDisplay.textContent = currentFileName;
            }

            function startAutoSave(minutes) {
                if (autoSaveTimer) clearInterval(autoSaveTimer);
                if (countdownTimer) clearInterval(countdownTimer);

                manualSaveBtn.disabled = !hasJsonData;
                
                if (minutes === '0' || !hasJsonData) {
                    autoSaveTimerDisplay.textContent = '自動儲存已關閉';
                    return;
                }
                
                const saveIntervalInSeconds = parseInt(minutes, 10) * 60;
                let timeLeft = saveIntervalInSeconds;
                
                function updateCountdown() {
                    const minutesLeft = Math.floor(timeLeft / 60);
                    const secondsLeft = timeLeft % 60;
                    autoSaveTimerDisplay.textContent = `${minutesLeft.toString().padStart(2, '0')}:${secondsLeft.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        // 倒數結束，先停止計時器
                        if (countdownTimer) clearInterval(countdownTimer);
                        
                        const onSave = () => {
                            performSave(); // 執行儲存
                            startAutoSave(autoSaveInterval.value); // 重新開始倒數
                        };
                        
                        const onSnooze = () => {
                            startAutoSave(autoSaveInterval.value); // 僅重新開始倒數 (Snooze)
                        };
                        
                        // 呼叫升級後的 Modal
                        showConfirmModal(
                            `檔案名稱：${currentFileName}`,
                            '自動儲存時間已到',
                            onSave,     // (onConfirm) 點擊儲存
                            onSnooze,   // (onCancel) 點擊稍後
                            '立即儲存',  // (confirmText)
                            '稍後儲存',  // (cancelText)
                            'btn-save' // (confirmClass) 綠色按鈕
                        );
                        
                    } else {
                        timeLeft--;
                    }
                }
                
                updateCountdown();
                countdownTimer = setInterval(updateCountdown, 1000);
            }

            function performSave() {
                const dataToSave = {
                    projects: projectData,
					templateSections: templateData,
					projectTemplates: projectTemplateData,
                    lastSaved: new Date().toISOString()
                };
                
                downloadJson(dataToSave, currentFileName);
                console.log(`儲存成功：資料已儲存到 "${currentFileName}"。`);
                // alert(`儲存成功！檔案名稱：${currentFileName}`); // <-- 已移除
            }

            manualSaveBtn.addEventListener('click', () => {
                if (hasJsonData) {
                    performSave();
                } else {
                    alert('請先匯入或建立一個檔案，才能進行儲存。');
                }
            });

            function downloadJson(data, filename) {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            autoSaveInterval.addEventListener('change', (e) => {
                startAutoSave(e.target.value);
            });
            
            projectEditorTitle.addEventListener('blur', (e) => {
                const collection = getCurrentActiveCollection();
                if(collection) {
                    collection.name = e.target.textContent;
                    if (currentEditorMode === 'project') {
                        updateProjectTimestamp(activeProjectIndex);
                    } else {
                        updateTemplateTimestamp(activeTemplateIndex);
                    }
                }
            });
			
            projectEditorDescription.addEventListener('blur', (e) => {
                const collection = getCurrentActiveCollection();
                if(collection) {
                    collection.description = e.target.textContent;
                    if (currentEditorMode === 'project') {
                        updateProjectTimestamp(activeProjectIndex);
                    } else {
                        updateTemplateTimestamp(activeTemplateIndex);
                    }
                }
            });
			
			function renderTemplateSections() {
                templateSectionContainer.innerHTML = '';
                if (!templateData) return;
                
                templateData.forEach(section => {
                    const newSection = document.createElement('div');
                    newSection.className = 'template-section-card';
                    newSection.dataset.sectionId = section.id; 

                    let itemsHTML = '';
                    const items = section.items || []; // 取得項目
                    (items).forEach(item => { // 遍歷項目
						const itemText = (item.text === '新項目') ? '' : (item.text || '');
						
                        itemsHTML += `
                            <li data-item-id="${item.id}"> <span class="template-item-text" contenteditable="true" data-field="text">${itemText}</span>
                                <button class="btn-delete-template" data-action="delete-template-item" title="刪除項目">×</button>
                            </li>
                        `;
                    });
					
					const titleText = (section.title === '新板塊標題') ? '' : (section.title || '');
                    const typeSelectHTML = createTemplateTypeSelect(section);

                    /* --- (請求 1) 的邏輯已移除 --- */

                    newSection.innerHTML = `
                        <button class="btn-delete-template btn-delete-section" data-action="delete-template-section" title="刪除步驟">×</button>
                        <h3 contenteditable="true" data-field="title">${titleText}</h3>
                        ${typeSelectHTML} 
                        <ul class="template-item-list"> ${itemsHTML}
                        </ul>
                        <button class="btn btn-add" data-action="add-template-item">新增項目</button>
                    `;
                    
                    templateSectionContainer.appendChild(newSection);
                });
            }
			
			function renderProjectTemplates() {
				const container = document.getElementById('project-template-container');
				if (!container) return;

				container.innerHTML = ''; 

				if (!projectTemplateData || projectTemplateData.length === 0) {
					container.innerHTML = '<p style="color: var(--sub-text-color); font-style: italic;">目前沒有專案模板。</p>';
					return;
				}

				container.style.display = 'grid';
				container.style.gap = '24px';
				container.style.gridTemplateColumns = 'repeat(4, 1fr)';

				projectTemplateData.forEach(template => {
					const templateCard = document.createElement('div');
					templateCard.className = 'project-card'; 
                    templateCard.dataset.id = template.id; 
					templateCard.style.maxWidth = '100%'; 

					templateCard.innerHTML = `
						<div class="project-card-actions">
                            <button type="button" class="btn btn-project-action btn-project-delete" data-id="${template.id}" title="刪除模板">×</button>
						</div>
						<div class="project-card-details">
							<h3>${template.name}</h3>
							<p>${template.description || '無描述'}</p>
						</div>
					`;
					container.appendChild(templateCard);
				});
			}
			
			// [新增] 產生匯入模板 Modal 中的列表
            function renderTemplateImportList() {
                importTemplateList.innerHTML = '';
                if (!projectTemplateData || projectTemplateData.length === 0) {
                    importTemplateList.innerHTML = '<li class="empty-item">沒有可用的專案模板。</li>';
                    confirmImportBtn.disabled = true;
                    return;
                }
                
                projectTemplateData.forEach(template => {
                    const li = document.createElement('li');
                    li.dataset.templateId = template.id;
                    li.textContent = template.name;
                    
                    li.addEventListener('click', () => {
                        importTemplateList.querySelectorAll('li').forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                    });
                    
                    importTemplateList.appendChild(li);
                });
                
                confirmImportBtn.disabled = false;
            }
			
			addTemplateSectionBtn.addEventListener('click', () => {
                const newSectionData = {
                    id: Date.now(),
                    title: '',
                    type: 'none', 
                    items: [
                        { id: Date.now() + 1, text: '' }
                    ]
                };
                templateData.push(newSectionData);
                
                renderTemplateSections();
            });

            templateSectionContainer.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (!action) return;

                const sectionCard = e.target.closest('.template-section-card');
                const sectionId = sectionCard ? parseInt(sectionCard.dataset.sectionId) : null;
                
                if (action === 'add-template-item') {
                    const section = templateData.find(s => s.id === sectionId);
                    if (section) {
                        section.items.push({
                            id: Date.now(),
                            text: '新項目'
                        });
                        renderTemplateSections(); 
                        
                        const lastSection = templateSectionContainer.querySelector(`[data-section-id="${sectionId}"]`);
                        if (lastSection) {
                            const lastItem = lastSection.querySelector('.template-item-list li:last-child .template-item-text');
                            if(lastItem) lastItem.focus();
                        }
                    }
                } else if (action === 'delete-template-item') {
                    const itemId = parseInt(e.target.closest('li').dataset.itemId);
                    const section = templateData.find(s => s.id === sectionId);
                    if (section) {
                        showConfirmModal('確定要刪除此項目嗎？', '確認刪除項目', () => {
                            section.items = section.items.filter(item => item.id !== itemId);
                            renderTemplateSections(); 
                        });
                    }
                } else if (action === 'delete-template-section') {
                    showConfirmModal('確定要刪除此板塊及其所有項目嗎？', '確認刪除板塊', () => {
                        templateData = templateData.filter(s => s.id !== sectionId);
                        renderTemplateSections(); 
                    });
                } 
            });
			
            templateSectionContainer.addEventListener('blur', (e) => {
                if (e.target.hasAttribute('contenteditable')) {
                    const field = e.target.dataset.field; 
                    const sectionCard = e.target.closest('.template-section-card');
                    if (!sectionCard) return;
                    
                    const sectionId = parseInt(sectionCard.dataset.sectionId);
                    const section = templateData.find(s => s.id === sectionId);
                    if (!section) return;

                    const newText = e.target.textContent.trim();

                    if (field === 'title') {
                        section.title = newText;
                    } else if (field === 'text') {
                        const li = e.target.closest('li');
                        if (!li) return;
                        
                        const itemId = parseInt(li.dataset.itemId);
                        const item = section.items.find(i => i.id === itemId);
                        
                        if (item) {
                            item.text = newText;
                        }
                    }
                }
            }, true); 
			
			templateSectionContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('template-type-select')) {
                    const newType = e.target.value;
                    const sectionCard = e.target.closest('.template-section-card');
                    if (!sectionCard) return;

                    const sectionId = parseInt(sectionCard.dataset.sectionId);
                    const section = templateData.find(s => s.id === sectionId);
                    
                    if (section) {
                        section.type = newType;
                    }
                }
            });
			
			addProjectTemplateBtn.addEventListener('click', () => {
                addNewProjectTemplate();
            });

            projectTemplateContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.btn-project-delete');
                if (deleteBtn) {
                    e.stopPropagation();
                    const templateId = parseInt(deleteBtn.dataset.id, 10);
                    
                    showConfirmModal('您確定要刪除此專案模板嗎？此動作無法復原。', '確認刪除模板', () => {
                        projectTemplateData = projectTemplateData.filter(t => t.id !== templateId);
                        renderProjectTemplates();
                    });
                    return;
                }
				
				const card = e.target.closest('.project-card');
                if (!card) return;

                const templateId = parseInt(card.dataset.id, 10);
                if (templateId) {
                    editProjectTemplate(templateId);
                }
            });
			
            importFromTemplateBtn.addEventListener('click', () => {
                renderTemplateImportList(); 
                importTemplateModal.classList.add('show'); 
            });

            cancelImportBtn.addEventListener('click', () => {
                importTemplateModal.classList.remove('show');
            });
            
            confirmImportBtn.addEventListener('click', () => {
                const selectedItem = importTemplateList.querySelector('li.active');
                if (!selectedItem) {
                    alert('請先選擇一個模板。');
                    return;
                }
                
                const templateId = parseInt(selectedItem.dataset.templateId, 10);
                const selectedTemplate = projectTemplateData.find(t => t.id === templateId);
                
                if (!selectedTemplate) {
                    alert('找不到所選的模板資料。');
                    return;
                }
                
                const newProject = JSON.parse(JSON.stringify(selectedTemplate));
                const now = new Date().toISOString();
                
                newProject.id = Date.now();
                newProject.createdAt = now;
                newProject.updatedAt = now;
                newProject.name = `[匯入] ${newProject.name}`; 
                
                projectData.push(newProject);
                
                renderProjectList();
                
                importTemplateModal.classList.remove('show');
                
                editProject(newProject.id);
            });
			
            flowMinimapContent.addEventListener('click', (e) => {
                const minimapItem = e.target.closest('.flow-minimap-item');
                if (!minimapItem) return; 

                const flowId = minimapItem.dataset.flowId;
                if (!flowId) return;

                const targetFlowItem = flowList.querySelector(`.flow-item[data-id="${flowId}"]`);
                
                if (targetFlowItem) {
                    targetFlowItem.scrollIntoView({
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                }
            });
			
			function showConfirmModal(message, title = '確認刪除', onConfirm, onCancel = null, confirmText = '確定', cancelText = '取消', confirmClass = 'btn-cancel-flow') {
                confirmModalMessage.textContent = message;
                confirmModalTitle.textContent = title;
                
                confirmModalConfirm.textContent = confirmText;
                confirmModalCancel.textContent = cancelText;
                
                // 重設按鈕樣式
                confirmModalConfirm.className = 'btn btn-submit'; 
                if (confirmClass) {
                    confirmModalConfirm.classList.add(confirmClass);
                }
                
                currentConfirmCallback = onConfirm; 
                currentCancelCallback = onCancel; // 儲存取消回呼
                
                confirmModal.classList.add('show');
            }

            confirmModalCancel.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                if (typeof currentCancelCallback === 'function') {
                    currentCancelCallback(); // 執行儲存的取消動作
                }
                currentConfirmCallback = null;
                currentCancelCallback = null;
            });

            confirmModalConfirm.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                if (typeof currentConfirmCallback === 'function') {
                    currentConfirmCallback(); // 執行儲存的動作
                }
                currentConfirmCallback = null;
                currentCancelCallback = null;
            });
			
			// (New listener for filter tags)
            const filterTagContainer = document.getElementById('category-filter-tags-container');
            if (filterTagContainer) {
                filterTagContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('category-filter-tag')) {
                        e.target.classList.toggle('active');
                        
                        // (修改點 2) 如果標籤剛變為 active，則顯示統計視窗
                        if (e.target.classList.contains('active')) {
                            showTagStats(e.target);
                        }

                        // 點擊標籤後，立即重新執行搜尋
                        renderCategorySearchResults();
                    }
                });
            }
			
            let draggedProject = null;
            let dragStartHandle = null;

            projectGridContainer.addEventListener('dragstart', (e) => {
                dragStartHandle = e.target.closest('.project-card-drag-handle');
                const projectCard = e.target.closest('.project-card');

                if (!dragStartHandle || !projectCard) {
                    e.preventDefault();
                    return; 
                }
                
                draggedProject = projectCard;
                setTimeout(() => {
                    if (draggedProject) draggedProject.classList.add('dragging');
                }, 0);
                
                e.dataTransfer.setData('text/plain', projectCard.querySelector('.btn-project-delete').dataset.id); 
                e.dataTransfer.effectAllowed = 'move';
            });

            function getDragAfterElementForProjects(container, y) {
                const draggableElements = [...container.querySelectorAll('.project-card:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            projectGridContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedProject || !dragStartHandle) return; 

                e.dataTransfer.dropEffect = 'move';
                
                const afterElement = getDragAfterElementForProjects(projectGridContainer, e.clientY);
                if (afterElement == null) {
                    projectGridContainer.appendChild(draggedProject);
                } else {
                    projectGridContainer.insertBefore(draggedProject, afterElement);
                }
            });

            projectGridContainer.addEventListener('dragend', (e) => {
                if (draggedProject) {
                    draggedProject.classList.remove('dragging');
                }
                
                if (draggedProject && dragStartHandle) {
                    const newIdOrder = Array.from(projectGridContainer.querySelectorAll('.project-card'))
                                         .map(card => parseInt(card.querySelector('.btn-project-delete').dataset.id));
                    
                    projectData.sort((a, b) => {
                        return newIdOrder.indexOf(a.id) - newIdOrder.indexOf(b.id);
                    });
                }

                draggedProject = null;
                dragStartHandle = null;
            });
			// 1. 專案列表頁
            if (helpBtnProjectList) {
                helpBtnProjectList.addEventListener('click', () => {
                    const title = '專案列表頁 功能說明';
                    const body = '1. 新增專案: 建立一個新的空白專案。\n' +
                               '2. 匯入模板: 從已儲存的「專案模板」建立一個新專案。\n' +
                               '3. 專案卡片: 顯示專案名稱、描述及流程進度。\n' +
                               '   - 點擊卡片: 進入專案編輯頁。\n' +
                               '   - 拖曳圖示 (::): 按住並拖曳以重新排序專案。\n' +
                               '   - (+) 按鈕: 將此專案儲存為一個新的「專案模板」。\n' +
                               '   - (x) 按鈕: 刪除此專案。';
                    showHelpModal(title, body);
                });
            }

            // 2. 專案編輯頁
            if (helpBtnProjectEditor) {
                helpBtnProjectEditor.addEventListener('click', () => {
                    const title = '專案編輯頁 功能說明';
                    const body = '1. 專案標題/描述: 點擊文字可直接編輯。\n' +
                               '2. 新增流程: 開啟彈窗以新增流程步驟。\n' +
                               '3. 流程總覽 (右側): 顯示所有流程的迷你地圖，點擊可跳轉。\n' +
                               '4. 流程卡片:\n' +
                               '   - 圓點 (●): 按住並拖曳以重新排序流程。\n' +
                               '   - 項目/子項目: 顯示流程的詳細資料。\n' +
                               '   - (編輯/■): 打開彈窗以編輯此流程。\n' +
                               '   - (完成/●): 將此流程標記為已完成。\n' +
                               '   - (刪除/x): 刪除此流程。';
                    showHelpModal(title, body);
                });
            }

            // 3. 模板頁
            if (helpBtnTemplateItem) {
                helpBtnTemplateItem.addEventListener('click', () => {
                    const title = '模板頁 功能說明';
                    const body = '## 項目模板 ##\n' +
                               '此區塊用於建立「可重複使用」的資料選項 (例如: 常用的人員、地點清單)。\n' +
                               '1. 新增項目板塊: 建立一個新的資料分類 (例如: 廠商清單)。\n' +
                               '2. 模板類型: 指定此板塊的類型 (人/事/地/物)，以便在「專案編輯」時能被選用。\n' +
                               '3. 新增項目: 在板塊中新增一筆資料 (例如: A廠商)。\n\n' +
                               '## 專案模板 ##\n' +
                               '此區塊用於儲存「完整的專案流程」當作模板。\n' +
                               '1. 新增專案模板: 建立一個空白的專案模板 (功能同專案編輯)。\n' +
                               '2. (您也可以在「專案列表」頁點擊 (+) 將現有專案存為模板)。\n' +
                               '3. 點擊卡片: 編輯此專案模板。\n' +
                               '4. (x) 按鈕: 刪除此專案模板。';
                    showHelpModal(title, body);
                });
            }

            // 4. 設定頁
            if (helpBtnSettings) {
                helpBtnSettings.addEventListener('click', () => {
                    const title = '設定頁 功能說明';
                    const body = '1. 當前個人檔案: 顯示您目前載入的 .json 檔案名稱。\n' +
                               '2. 自動儲存: 設定系統自動下載 .json 備份檔案的頻率。\n' +
                               '   - 倒數計時器: 顯示距離下次自動儲存還剩餘的時間。\n' +
                               '3. 手動儲存: 立即將目前所有資料 (專案、模板等) 下載為 .json 檔案。';
                    showHelpModal(title, body);
                });
            }
			
			// (修改點 1) 新增 顯示標籤統計 的函式
            function showTagStats(tagElement) {
                const tagValue = tagElement.textContent.trim();
                const tagCategory = tagElement.dataset.category; // e.g., "人"
                const mappedCategory = categoryToTemplateType[tagCategory]; // e.g., "person"

                let totalCount = 0;
                let completedCount = 0;
                const projects = new Set();
                const flows = new Set();

                // 遞迴函式，用於搜尋所有子項目
                const searchItems = (items, project, flow) => {
                    if (!items) return;
                    items.forEach(item => {
                        // 檢查分類是否相符 (e.g., "人" 或 "person")
                        const categoryMatch = (item.category === tagCategory || (mappedCategory && item.category === mappedCategory));
                        // 檢查值是否相符
                        const valueMatch = (item.value && item.value.trim() === tagValue);

                        if (categoryMatch && valueMatch) {
                            totalCount++;
                            // 檢查項目是否已勾選 (isChecked)
                            if (item.isChecked === true) { 
                                completedCount++;
                            }
                            projects.add(project.name);
                            flows.add(`- ${project.name} / ${flow.name}`);
                        }
                        
                        // 遞迴搜尋子項目
                        if (item.children) {
                            searchItems(item.children, project, flow);
                        }
                    });
                };

                // 遍歷所有專案資料
                projectData.forEach(project => {
                    (project.flows || []).forEach(flow => {
                        // 搜尋 mainItems 和 dynamicItems
                        searchItems(flow.mainItems, project, flow);
                        searchItems(flow.dynamicItems, project, flow);
                    });
                });

                const incompleteCount = totalCount - completedCount;
                const projectList = projects.size > 0 ? `\n - ${Array.from(projects).join('\n - ')}` : ' (無)';
                const flowList = flows.size > 0 ? `\n${Array.from(flows).join('\n')}` : ' (無)';

                const title = `項目 "${tagValue}" (${tagCategory}) 統計資訊`;
                const body = `總項目個數: ${totalCount}\n` +
                           `已完成項目: ${completedCount} (依據項目勾選狀態)\n` +
                           `未完成項目: ${incompleteCount}\n` +
                           `\n---\n` +
                           `涉及的專案: ${projectList}\n` +
                           `\n---\n` +
                           `涉及的流程: ${flowList}`;

                // 呼叫共用的說明視窗
                showHelpModal(title, body);
            }

            // (修改點) 新增 顯示/隱藏 說明視窗的共用函數
            function showHelpModal(title, body) {
                if (helpModal && helpModalTitle && helpModalBody) {
                    helpModalTitle.textContent = title;
                    helpModalBody.textContent = body; // .textContent 會保留 \n 換行
                    helpModal.classList.add('show');
                }
            }

            // (修改點) 讓使用者點擊視窗任何地方都能關閉
            if (helpModal) {
                helpModal.addEventListener('click', () => {
                    helpModal.classList.remove('show');
                });
            }
        }); // 這是 DOMContentLoaded 的結尾
    </script>
</body>
</html>
